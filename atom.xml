<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>GaryHome</title>
  
  <subtitle>æŠ€æœ¯æ¢ç´¢ä¸ç”Ÿæ´»éšç¬”</subtitle>
  <link href="https://garybyd.github.io/atom.xml" rel="self"/>
  
  <link href="https://garybyd.github.io/"/>
  <updated>2026-01-06T06:18:29.989Z</updated>
  <id>https://garybyd.github.io/</id>
  
  <author>
    <name>Gary Byd</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>æœºå™¨å­¦ä¹ ç¬”è®°</title>
    <link href="https://garybyd.github.io/posts/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <id>https://garybyd.github.io/posts/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</id>
    <published>2026-01-04T07:58:14.000Z</published>
    <updated>2026-01-06T06:18:29.989Z</updated>
    
    <content type="html"><![CDATA[<h1><span id="ç‰¹å¾é¢„å¤„ç†">ç‰¹å¾é¢„å¤„ç†</span></h1><p>ç‰¹å¾é¢„å¤„ç†åˆ†ä¸ºæ ‡å‡†åŒ–å’Œå½’ä¸€åŒ–</p><span id="more"></span><h2><span id="ä¸ºä»€ä¹ˆè¿›è¡Œå½’ä¸€åŒ–-æ ‡å‡†åŒ–">ä¸ºä»€ä¹ˆè¿›è¡Œå½’ä¸€åŒ–ã€æ ‡å‡†åŒ–ï¼Ÿ</span></h2><p>ç‰¹å¾çš„<strong>å•ä½æˆ–è€…å¤§å°ç›¸å·®è¾ƒå¤§ï¼Œæˆ–è€…æŸç‰¹å¾çš„æ–¹å·®ç›¸æ¯”å…¶ä»–çš„ç‰¹å¾è¦å¤§å‡ºå‡ ä¸ªæ•°é‡çº§</strong>ï¼Œ<strong>å®¹æ˜“å½±å“ï¼ˆæ”¯é…ï¼‰ç›®æ ‡ç»“æœ</strong>ï¼Œä½¿å¾—ä¸€äº›æ¨¡å‹ï¼ˆç®—æ³•ï¼‰æ— æ³•å­¦ä¹ åˆ°å…¶å®ƒçš„ç‰¹å¾ã€‚</p><p><img src="assets/image-20260104194656835.png" alt="image-20260104194656835"></p><h2><span id="å½’ä¸€åŒ–">å½’ä¸€åŒ–</span></h2><p>é€šè¿‡å¯¹åŸå§‹æ•°æ®è¿›è¡Œå˜æ¢æŠŠæ•°æ®æ˜ å°„åˆ°ã€mi,mxã€‘(é»˜è®¤ä¸º[0,1])ä¹‹é—´<br>$$<br>\begin{cases}<br>Xâ€™=\frac{x-x_{min}}{x_{max}-x_{min}}\<br>Xâ€™â€™=Xâ€™*(m_x-m_i)+mi<br>\end{cases}<br>$$<br><strong>ç†è§£:</strong></p><p>Xâ€™æ˜¯ä¸ºäº†æ‹¿åˆ°x_minåˆ°x_maxçš„é•¿åº¦å æ¯”</p><p>Xâ€™'æ˜¯ä¸ºäº†æ‹¿åˆ°æ–°çš„åŒºé—´å†…é•¿åº¦+ä¸Šå·¦åŒºé—´=æ–°çš„xå€¼</p><p><strong>api:</strong></p><p>æ•°æ®å½’ä¸€åŒ–çš„APIå®ç°</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">sklearn</span>.preprocessing.MinMaxScaler (feature_range=(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)â€¦ )<br></code></pre></td></tr></table></figure><p>feature_range ç¼©æ”¾åŒºé—´</p><ul><li>è°ƒç”¨ fit_transform(X) å°†ç‰¹å¾è¿›è¡Œå½’ä¸€åŒ–ç¼©æ”¾</li></ul><h2><span id="æ ‡å‡†åŒ–">æ ‡å‡†åŒ–</span></h2><p>é€šè¿‡å¯¹åŸå§‹æ•°æ®è¿›è¡Œæ ‡å‡†åŒ–ï¼Œè½¬æ¢ä¸ºå‡å€¼ä¸º0æ ‡å‡†å·®ä¸º1çš„æ ‡å‡†æ­£æ€åˆ†å¸ƒçš„æ•°æ®<br>$$<br>\frac{x-mean}{\sigma}<br>$$</p><ul><li>mean ä¸ºç‰¹å¾çš„å¹³å‡å€¼</li><li>Ïƒ ä¸ºç‰¹å¾çš„æ ‡å‡†å·®</li></ul><p>æ•°æ®æ ‡å‡†åŒ–çš„APIå®ç°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">sklearn.preprocessing. StandardScaler()<br></code></pre></td></tr></table></figure><p>è°ƒç”¨ fit_transform(X) å°†ç‰¹å¾è¿›è¡Œå½’ä¸€åŒ–ç¼©æ”¾</p><hr><h1><span id="è¶…å‚æ•°é€‰æ‹©">è¶…å‚æ•°é€‰æ‹©</span></h1><h2><span id="äº¤å‰éªŒè¯">äº¤å‰éªŒè¯</span></h2><p>äº¤å‰éªŒè¯æ˜¯ä¸€ç§æ•°æ®é›†çš„åˆ†å‰²æ–¹æ³•ï¼Œå°†è®­ç»ƒé›†åˆ’åˆ†ä¸º n ä»½ï¼Œå…¶ä¸­ä¸€ä»½åšéªŒè¯é›†ã€å…¶ä»–n-1ä»½åšè®­ç»ƒé›†é›†</p><p><img src="assets/image-20260104194725724.png" alt="image-20260104194725724"></p><p><strong>äº¤å‰éªŒè¯æ³•åŸç†</strong>ï¼šå°†æ•°æ®é›†åˆ’åˆ†ä¸º cv=10 ä»½ï¼š</p><p>1.ç¬¬ä¸€æ¬¡ï¼šæŠŠç¬¬ä¸€ä»½æ•°æ®åšéªŒè¯é›†ï¼Œå…¶ä»–æ•°æ®åšè®­ç»ƒ</p><p>2.ç¬¬äºŒæ¬¡ï¼šæŠŠç¬¬äºŒä»½æ•°æ®åšéªŒè¯é›†ï¼Œå…¶ä»–æ•°æ®åšè®­ç»ƒ</p><p>3â€¦ ä»¥æ­¤ç±»æ¨ï¼Œæ€»å…±è®­ç»ƒ10æ¬¡ï¼Œè¯„ä¼°10æ¬¡ã€‚</p><p>4.ä½¿ç”¨è®­ç»ƒé›†+éªŒè¯é›†å¤šæ¬¡è¯„ä¼°æ¨¡å‹ï¼Œå–å¹³å‡å€¼åšäº¤å‰éªŒè¯ä¸ºæ¨¡å‹å¾—åˆ†</p><p>5.è‹¥k=5æ¨¡å‹å¾—åˆ†æœ€å¥½ï¼Œå†ä½¿ç”¨å…¨éƒ¨è®­ç»ƒé›†(è®­ç»ƒé›†+éªŒè¯é›†) å¯¹k=5æ¨¡å‹å†è®­ç»ƒä¸€è¾¹ï¼Œå†ä½¿ç”¨æµ‹è¯•é›†å¯¹k=5æ¨¡å‹åšè¯„ä¼°</p><h2><span id="ç½‘æ ¼æœç´¢æ³•">ç½‘æ ¼æœç´¢æ³•</span></h2><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªè¶…å‚æ•°ï¼š</p><ol><li><code>n_neighbors</code> = [3, 5, 7, 9]</li><li><code>weights</code> = [â€œuniformâ€, â€œdistanceâ€]</li></ol><p>æˆ‘ä»¬å°±æ˜¯åœ¨ç©·ä¸¾<strong>æ‰€æœ‰ç»„åˆ</strong>ï¼Œå¯ä»¥ç”»æˆè¿™æ ·ä¸€ä¸ªå°è¡¨æ ¼ï¼š</p><table><thead><tr><th>n_neighbors</th><th>weights</th><th>ç»„åˆç¼–å·</th></tr></thead><tbody><tr><td>3</td><td>uniform</td><td>1</td></tr><tr><td>3</td><td>distance</td><td>2</td></tr><tr><td>5</td><td>uniform</td><td>3</td></tr><tr><td>5</td><td>distance</td><td>4</td></tr><tr><td>7</td><td>uniform</td><td>5</td></tr><tr><td>7</td><td>distance</td><td>6</td></tr><tr><td>9</td><td>uniform</td><td>7</td></tr><tr><td>9</td><td>distance</td><td>8</td></tr></tbody></table><p>å¯ä»¥çœ‹å‡ºæˆ‘ä»¬çš„ç½‘æ ¼æœç´¢æ³•å°±æ˜¯å°†æ‰€æœ‰çš„å­˜åœ¨çš„è¶…å‚æ•°ç»„åˆè¿›è¡Œè®­ç»ƒ</p><p><strong>ä¼˜ç‚¹</strong>ï¼š</p><ul><li>ç®€å•ç›´è§‚ï¼Œæ˜“äºç†è§£å’Œå®ç°ã€‚</li><li>èƒ½å¤Ÿç³»ç»Ÿåœ°æ¢ç´¢è¶…å‚æ•°ç©ºé—´ã€‚</li></ul><p><strong>ç¼ºç‚¹</strong>ï¼š</p><ul><li>å½“è¶…å‚æ•°ç©ºé—´è¾ƒå¤§æ—¶ï¼Œè®¡ç®—æˆæœ¬éå¸¸é«˜ã€‚</li><li>å¯èƒ½æ— æ³•æ‰¾åˆ°å…¨å±€æœ€ä¼˜è§£ï¼Œå°¤å…¶æ˜¯åœ¨è¶…å‚æ•°ç©ºé—´ä¸è¿ç»­æˆ–å­˜åœ¨å¤šä¸ªå±€éƒ¨æœ€ä¼˜è§£æ—¶ã€‚</li></ul><p>äº¤å‰éªŒè¯ç½‘æ ¼æœç´¢çš„API:</p><p><img src="assets/image-20260104194858340.png" alt="image-20260104194858340"></p><h2><span id="è¿ç”¨æ¡ˆä¾‹">è¿ç”¨æ¡ˆä¾‹</span></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_iris          <span class="hljs-comment"># åŠ è½½é¸¢å°¾èŠ±æµ‹è¯•é›†çš„.</span><br><span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split, GridSearchCV    <span class="hljs-comment"># åˆ†å‰²è®­ç»ƒé›†å’Œæµ‹è¯•é›†çš„, ç½‘æ ¼æœç´¢çš„</span><br><span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler        <span class="hljs-comment"># æ•°æ®æ ‡å‡†åŒ–çš„</span><br><span class="hljs-keyword">from</span> sklearn.neighbors <span class="hljs-keyword">import</span> KNeighborsClassifier      <span class="hljs-comment"># KNNç®—æ³• åˆ†ç±»å¯¹è±¡</span><br><span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> accuracy_score              <span class="hljs-comment"># æ¨¡å‹è¯„ä¼°çš„, è®¡ç®—æ¨¡å‹é¢„æµ‹çš„å‡†ç¡®ç‡</span><br><br><br><span class="hljs-comment"># 1. è·å–æ•°æ®é›†.</span><br>iris_data = load_iris()<br><br><span class="hljs-comment"># 2. æ•°æ®åŸºæœ¬å¤„ç†-åˆ’åˆ†æ•°æ®é›†.</span><br>x_train, x_test, y_train, y_test = train_test_split(iris_data.data, iris_data.target, test_size=<span class="hljs-number">0.2</span>, random_state=<span class="hljs-number">22</span>)<br><br><span class="hljs-comment"># 3. æ•°æ®é›†é¢„å¤„ç†-æ•°æ®æ ‡å‡†åŒ–.</span><br>transfer = StandardScaler()<br>x_train = transfer.fit_transform(x_train)<br>x_test = transfer.transform(x_test)<br><br><span class="hljs-comment"># 4. æ¨¡å‹è®­ç»ƒ.</span><br><span class="hljs-comment"># 4.1 åˆ›å»ºä¼°è®¡å™¨å¯¹è±¡.</span><br>estimator = KNeighborsClassifier()<br><span class="hljs-comment"># 4.2 ä½¿ç”¨æ ¡éªŒéªŒè¯ç½‘æ ¼æœç´¢.  æŒ‡å®šå‚æ•°èŒƒå›´.</span><br>param_grid = &#123;<span class="hljs-string">&quot;n_neighbors&quot;</span>: <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)&#125;<br><span class="hljs-comment"># 4.3 å…·ä½“çš„ ç½‘æ ¼æœç´¢è¿‡ç¨‹ + äº¤å‰éªŒè¯.</span><br><span class="hljs-comment"># å‚1: ä¼°è®¡å™¨å¯¹è±¡, å‚2: å‚æ•°èŒƒå›´, å‚3: äº¤å‰éªŒè¯çš„æŠ˜æ•°.</span><br>estimator = GridSearchCV(estimator=estimator, param_grid=param_grid, cv=<span class="hljs-number">5</span>)<br><span class="hljs-comment"># å…·ä½“çš„æ¨¡å‹è®­ç»ƒè¿‡ç¨‹.</span><br>estimator.fit(x_train, y_train)<br><br><br><span class="hljs-comment"># 4.4 äº¤å‰éªŒè¯, ç½‘æ ¼æœç´¢ç»“æœæŸ¥çœ‹.</span><br><span class="hljs-built_in">print</span>(estimator.best_score_)       <span class="hljs-comment"># æ¨¡å‹åœ¨äº¤å‰éªŒè¯ä¸­, æ‰€æœ‰å‚æ•°ç»„åˆä¸­çš„æœ€é«˜å¹³å‡æµ‹è¯•å¾—åˆ†</span><br><span class="hljs-built_in">print</span>(estimator.best_estimator_)   <span class="hljs-comment"># æœ€ä¼˜çš„ä¼°è®¡å™¨å¯¹è±¡.</span><br><span class="hljs-built_in">print</span>(estimator.cv_results_)       <span class="hljs-comment"># æ¨¡å‹åœ¨äº¤å‰éªŒè¯ä¸­çš„ç»“æœ.</span><br><span class="hljs-built_in">print</span>(estimator.best_params_)      <span class="hljs-comment"># æ¨¡å‹åœ¨äº¤å‰éªŒè¯ä¸­çš„ç»“æœ.</span><br><br><br><span class="hljs-comment"># 5. å¾—åˆ°æœ€ä¼˜æ¨¡å‹å, å¯¹æ¨¡å‹é‡æ–°é¢„æµ‹.</span><br>estimator = KNeighborsClassifier(n_neighbors=<span class="hljs-number">6</span>)<br>estimator.fit(x_train, y_train)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;æ¨¡å‹è¯„ä¼°: <span class="hljs-subst">&#123;estimator.score(x_test, y_test)&#125;</span>&#x27;</span>)   <span class="hljs-comment"># å› ä¸ºæ•°æ®é‡å’Œç‰¹å¾çš„é—®é¢˜, è¯¥å€¼å¯èƒ½å°äºä¸Šè¿°çš„å¹³å‡æµ‹è¯•å¾—åˆ†.</span><br></code></pre></td></tr></table></figure><h1><span id="knn">KNN</span></h1><h2><span id="knnç®—æ³•å®šä¹‰">KNNç®—æ³•å®šä¹‰ï¼š</span></h2><p>K-è¿‘é‚»ç®—æ³•ï¼ˆK Nearest Neighborï¼Œç®€ç§°KNNï¼‰</p><p>KNNç®—æ³•æ€æƒ³ï¼šå¦‚æœä¸€ä¸ªæ ·æœ¬åœ¨ç‰¹å¾ç©ºé—´ä¸­çš„ k ä¸ªæœ€ç›¸ä¼¼çš„æ ·æœ¬ä¸­çš„å¤§å¤šæ•°å±äºæŸä¸€ä¸ªç±»åˆ«ï¼Œåˆ™è¯¥æ ·æœ¬ä¹Ÿå±äºè¿™ä¸ªç±»åˆ«</p><p>(å…¶å®å°±æ˜¯çœ‹ä½ å‘¨å›´æ ·æœ¬çš„ç‰¹å¾å‚æ•°è¿›è¡Œé€‰ä¸¾æˆ–åŠ æƒå¹³å‡æ¥åˆ¤æ–­ä½ å¤§æ¦‚ä¸ºä»€ä¹ˆæ ‡ç­¾)</p><p><strong>æ ·æœ¬ç›¸ä¼¼æ€§</strong>ï¼šæ ·æœ¬éƒ½æ˜¯å±äºä¸€ä¸ªä»»åŠ¡æ•°æ®é›†çš„ã€‚æ ·æœ¬è·ç¦»è¶Šè¿‘åˆ™è¶Šç›¸ä¼¼ã€‚</p><h2><span id="apiçš„ä»‹ç»">APIçš„ä»‹ç»</span></h2><p>KNNåˆ†ç±»APIï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">sklearn.neighbors.KNeighborsClassifier(n_neighbors=<span class="hljs-number">5</span>) <br></code></pre></td></tr></table></figure><ul><li>n_neighborsï¼šint,å¯é€‰ï¼ˆé»˜è®¤= 5ï¼‰ï¼Œk_neighborsæŸ¥è¯¢é»˜è®¤ä½¿ç”¨çš„é‚»å±…æ•°</li></ul><p>KNNå›å½’API:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">sklearn.neighbors.KNeighborsRegressor(n_neighbors=<span class="hljs-number">5</span>)<br></code></pre></td></tr></table></figure><h2><span id="è·ç¦»åº¦é‡æ–¹æ³•">è·ç¦»åº¦é‡æ–¹æ³•</span></h2><h3><span id="æ¬§å¼è·ç¦»">æ¬§å¼è·ç¦»</span></h3><p>$$<br>\sqrt(x_i^2-x_y^2)<br>$$</p><p><img src="assets/image-20260104162244244.png" alt="image-20260104162244244"></p><h3><span id="æ›¼å“ˆé¡¿è·ç¦»">æ›¼å“ˆé¡¿è·ç¦»</span></h3><p>ä¸ºå•¥å«æ›¼å“ˆé¡¿è·ç¦»å‘¢ï¼Ÿå…¶å®ä»–æœ‰ä¸ªåˆ«åå«åŸå¸‚è·ç¦»ï¼Œçº½çº¦æ›¼å“ˆé¡¿åŒºåŸå¸‚è¡—åŒºæ¯”è¾ƒæ–¹æ–¹æ­£æ­£ã€‚<br>$$<br>|x_i-y_i|<br>$$</p><p><img src="assets/image-20260104162439098.png" alt="image-20260104162439098"></p><h3><span id="åˆ‡æ¯”é›ªå¤«è·ç¦»">åˆ‡æ¯”é›ªå¤«è·ç¦»</span></h3><p>æ›¼å“ˆé¡¿è·ç¦»çš„å˜ç§</p><p><img src="assets/image-20260104163019077.png" alt="image-20260104163019077"></p><h3><span id="é—µæ°è·ç¦»">é—µæ°è·ç¦»</span></h3><p>å¯¹ä¸Šé¢ä¸‰ç§åº¦é‡æ–¹æ³•çš„ä¸€ä¸ªç»“åˆ</p><p><img src="assets/image-20260104163047059.png" alt="image-20260104163047059"></p><h2><span id="knnæ¡ˆä¾‹ä¹‹æ‰‹å†™æ•°å­—è¯†åˆ«">KNNæ¡ˆä¾‹ä¹‹æ‰‹å†™æ•°å­—è¯†åˆ«</span></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split<br><span class="hljs-keyword">from</span> sklearn.neighbors <span class="hljs-keyword">import</span> KNeighborsClassifier<br><span class="hljs-keyword">import</span> joblib<br><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> Counter<br><br><br><span class="hljs-comment"># 1. æ˜¾ç¤ºå›¾ç‰‡.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show_digit</span>(<span class="hljs-params">idx</span>):<br>    <span class="hljs-comment"># 1.1 åŠ è½½æ•°æ®.</span><br>    data = pd.read_csv(<span class="hljs-string">&#x27;æ‰‹å†™æ•°å­—è¯†åˆ«.csv&#x27;</span>)<br>    <span class="hljs-comment"># 1.2éæ³•å€¼æ ¡éªŒ.</span><br>    <span class="hljs-keyword">if</span> idx &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> idx &gt; <span class="hljs-built_in">len</span>(data) - <span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-comment"># 1.3 æ‰“å°æ•°æ®åŸºæœ¬ä¿¡æ¯</span><br>    x = data.iloc[:, <span class="hljs-number">1</span>:]<br>    y = data.iloc[:, <span class="hljs-number">0</span>]<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;æ•°æ®åŸºæœ¬ä¿¡æ¯: <span class="hljs-subst">&#123;x.shape&#125;</span>)&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;ç±»åˆ«æ•°æ®æ¯”ä¾‹: <span class="hljs-subst">&#123;Counter(y)&#125;</span>&#x27;</span>)<br><br>    <span class="hljs-comment"># æ˜¾ç¤ºå›¾ç‰‡</span><br>    <span class="hljs-comment"># 1.4 å°†æ•°æ®å½¢çŠ¶ä¿®æ”¹ä¸º: 28*28</span><br>    digit = x.iloc[idx].values.reshape(<span class="hljs-number">28</span>, <span class="hljs-number">28</span>)<br>    <span class="hljs-comment"># 1.5 å…³é—­åæ ‡è½´æ ‡ç­¾</span><br>    plt.axis(<span class="hljs-string">&#x27;off&#x27;</span>)<br>    <span class="hljs-comment"># 1.6 æ˜¾ç¤ºå›¾åƒ</span><br>    plt.imshow(digit, cmap=<span class="hljs-string">&#x27;gray&#x27;</span>)  <span class="hljs-comment"># ç°è‰²æ˜¾ç¤º</span><br>    plt.show()<br><br><br><span class="hljs-comment"># 2. è®­ç»ƒæ¨¡å‹.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">train_model</span>():<br>    <span class="hljs-comment"># 1. åŠ è½½æ•°æ®.</span><br>    data = pd.read_csv(<span class="hljs-string">&#x27;æ‰‹å†™æ•°å­—è¯†åˆ«.csv&#x27;</span>)<br>    x = data.iloc[:, <span class="hljs-number">1</span>:]<br>    y = data.iloc[:, <span class="hljs-number">0</span>]<br><br>    <span class="hljs-comment"># 2.æ•°æ®é¢„å¤„ç†, å½’ä¸€åŒ–.</span><br>    x = x / <span class="hljs-number">255</span><br><br>    <span class="hljs-comment"># 3. åˆ†å‰²è®­ç»ƒé›†å’Œæµ‹è¯•é›†.</span><br>    <span class="hljs-comment"># stratify: æŒ‰ç…§yçš„ç±»åˆ«æ¯”ä¾‹è¿›è¡Œåˆ†å‰²</span><br>    x_train, x_test, y_train, y_test = train_test_split(x, y, test_size=<span class="hljs-number">0.2</span>, stratify=y, random_state=<span class="hljs-number">21</span>)<br><br>    <span class="hljs-comment"># 4. è®­ç»ƒæ¨¡å‹</span><br>    estimator = KNeighborsClassifier(n_neighbors=<span class="hljs-number">3</span>)<br>    estimator.fit(x_train, y_train)<br><br>    <span class="hljs-comment"># 5. æ¨¡å‹è¯„ä¼°</span><br>    my_score = estimator.score(x_test, y_test)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;æµ‹è¯•é›†å‡†ç¡®ç‡ä¸º: <span class="hljs-subst">&#123;my_score:<span class="hljs-number">.2</span>f&#125;</span>&#x27;</span>)<br><br>    <span class="hljs-comment"># 6. æ¨¡å‹ä¿å­˜.</span><br>    joblib.dump(estimator, <span class="hljs-string">&#x27;model/knn.pth&#x27;</span>)<br><br><span class="hljs-comment"># 3. æµ‹è¯•æ¨¡å‹.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">use_model</span>():<br>    <span class="hljs-comment"># 1. è¯»å–å›¾ç‰‡</span><br>    img = plt.imread(<span class="hljs-string">&#x27;data/demo.png&#x27;</span>)   <span class="hljs-comment"># ç°åº¦å›¾, 28*28åƒç´ </span><br>    plt.imshow(img, cmap=<span class="hljs-string">&#x27;gray&#x27;</span>)<br>    plt.show()<br><br>    <span class="hljs-comment"># 2. åŠ è½½æ¨¡å‹.</span><br>    estimator = joblib.load(<span class="hljs-string">&#x27;model/knn.pth&#x27;</span>)<br><br>    <span class="hljs-comment"># 3. é¢„æµ‹å›¾ç‰‡.</span><br>    img = img.reshape(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>)  <span class="hljs-comment"># å½¢çŠ¶ä»: (28, 28) =&gt; (1, 784)</span><br>    <span class="hljs-comment"># print(img.shape)</span><br>    y_test = estimator.predict(img)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;æ‚¨ç»˜åˆ¶çš„æ•°å­—æ˜¯: <span class="hljs-subst">&#123;y_test&#125;</span>&#x27;</span>)<br><br><span class="hljs-comment"># åœ¨mainå‡½æ•°ä¸­æµ‹è¯•</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-comment"># 1. è°ƒç”¨å‡½æ•°, æŸ¥çœ‹å›¾ç‰‡.</span><br>    <span class="hljs-comment"># show_digit(0)</span><br>    <span class="hljs-comment"># show_digit(10)</span><br>    <span class="hljs-comment"># show_digit(100)</span><br><br>    <span class="hljs-comment"># 2. è®­ç»ƒæ¨¡å‹.</span><br>    <span class="hljs-comment"># train_model()</span><br><br>    <span class="hljs-comment"># 3. æµ‹è¯•æ¨¡å‹</span><br>    use_model()<br></code></pre></td></tr></table></figure><hr><h1><span id="çº¿æ€§å›å½’">çº¿æ€§å›å½’</span></h1><p>çº¿æ€§å›å½’(Linear regression)æ˜¯åˆ©ç”¨ <strong>å›å½’æ–¹ç¨‹(å‡½æ•°)</strong> å¯¹ <strong>ä¸€ä¸ªæˆ–å¤šä¸ªè‡ªå˜é‡(ç‰¹å¾å€¼)å’Œå› å˜é‡(ç›®æ ‡å€¼)ä¹‹é—´</strong> å…³ç³»è¿›è¡Œå»ºæ¨¡çš„ä¸€ç§åˆ†ææ–¹å¼ã€‚</p><p><img src="assets/image-20260104201013608.png" alt="image-20260104201013608"></p><h2><span id="æŸå¤±å‡½æ•°æœ€ä¼˜è§£mseä¸ºä¾‹å­">æŸå¤±å‡½æ•°æœ€ä¼˜è§£(MSEä¸ºä¾‹å­)</span></h2><p><img src="assets/image-20260104201841529.png" alt="image-20260104201841529"></p><p>æˆ‘ä»¬å¯ä»¥æ‹Ÿåˆæ— æ•°æ¡çº¿æ€§å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ ‡å‡†æ¥åˆ¤æ–­å“ªä¸ªçº¿æ€§å‡½æ•°æ˜¯æœ€å¥½çš„</p><p><strong>è¯¯å·®æ¦‚å¿µ</strong>ï¼šç”¨é¢„æµ‹å€¼y â€“ çœŸå®å€¼yå°±æ˜¯è¯¯å·®</p><p><strong>æŸå¤±å‡½æ•°</strong>ï¼šè¡¡é‡æ¯ä¸ªæ ·æœ¬é¢„æµ‹å€¼ä¸çœŸå®å€¼æ•ˆæœçš„å‡½æ•°</p><p>çº¢è‰²ç›´çº¿èƒ½æ›´å¥½çš„æ‹Ÿåˆæ‰€æœ‰ç‚¹â€ä¹Ÿå°±æ˜¯è¯¯å·®æœ€å°ï¼Œè¯¯å·®å’Œæœ€å°</p><h3><span id="ä¸€å…ƒçº¿æ€§æ–¹ç¨‹è§£æè§£">ä¸€å…ƒçº¿æ€§æ–¹ç¨‹è§£æè§£</span></h3><p><img src="assets/image-20260104202415777.png" alt="image-20260104202415777"></p><h3><span id="å¤šå…ƒæ–¹ç¨‹ç»„è§£">å¤šå…ƒæ–¹ç¨‹ç»„è§£</span></h3><p><img src="assets/image-20260104202522095.png" alt="image-20260104202522095"></p><h3><span id="æ¢¯åº¦ä¸‹é™æ³•">æ¢¯åº¦ä¸‹é™æ³•</span></h3><h4><span id="å®šä¹‰">å®šä¹‰</span></h4><p>â€¢ æ±‚è§£å‡½æ•°æå€¼è¿˜æœ‰æ›´é€šç”¨çš„æ–¹æ³•å°±æ˜¯æ¢¯åº¦ä¸‹é™æ³•ã€‚é¡¾åæ€ä¹‰:æ²¿ç€æ¢¯åº¦ä¸‹é™çš„æ–¹å‘æ±‚è§£æå°å€¼ â€¢ ä¸¾ä¸ªä¾‹å­:å¡åº¦æœ€é™¡ä¸‹å±±æ³•</p><p><img src="assets/image-20230901183007785.png" alt="image-20230901183007785"></p><ul><li>è¾“å…¥:åˆå§‹åŒ–ä½ç½®S;æ¯æ­¥è·ç¦»ä¸ºa ã€‚è¾“å‡º:ä»ä½ç½®Såˆ°è¾¾å±±åº•</li><li>æ­¥éª¤1:ä»¤åˆå§‹åŒ–ä½ç½®ä¸ºå±±çš„ä»»æ„ä½ç½®S</li><li>æ­¥éª¤2:åœ¨å½“å‰ä½ç½®ç¯é¡¾å››å‘¨ï¼Œå¦‚æœå››å‘¨éƒ½æ¯”Sé«˜è¿”å›S;å¦åˆ™æ‰§è¡Œæ­¥éª¤3</li><li>æ­¥éª¤3: åœ¨å½“å‰ä½ç½®ç¯é¡¾å››å‘¨ï¼Œå¯»æ‰¾å¡åº¦æœ€é™¡çš„æ–¹å‘ï¼Œä»¤å…¶ä¸ºxæ–¹å‘</li><li>æ­¥éª¤4:æ²¿ç€xæ–¹å‘å¾€ä¸‹èµ°ï¼Œé•¿åº¦ä¸ºaï¼Œåˆ°è¾¾æ–°çš„ä½ç½®Sâ€˜</li><li>æ­¥éª¤5:åœ¨Sâ€˜ä½ç½®ç¯é¡¾å››å‘¨ï¼Œå¦‚æœå››å‘¨éƒ½æ¯”Sâ€˜é«˜ï¼Œåˆ™è¿”å›Sâ€˜ã€‚å¦åˆ™è½¬åˆ°æ­¥éª¤3</li></ul><p>å°ç»“:é€šè¿‡å¾ªç¯è¿­ä»£çš„æ–¹æ³•ä¸æ–­æ›´æ–°ä½ç½®S (ç›¸å½“äºä¸æ–­æ›´æ–°æƒé‡å‚æ•°w)</p><p><img src="assets/image-20230901183020726.png" alt="image-20230901183020726"></p><p>æœ€ç»ˆæ‰¾åˆ°æœ€ä¼˜è§£ è¿™ä¸ªæ–¹æ³•å¯ç”¨æ¥æ±‚æŸå¤±å‡½æ•°æœ€ä¼˜è§£ï¼Œ æ¯”æ­£è§„æ–¹ç¨‹æ›´é€šç”¨</p><p><img src="assets/image-20230901183125661.png" alt="image-20230901183125661"></p><p><img src="assets/image-20230912163031832.png" alt="image-20230912163031832"></p><p><img src="assets/image-20230901183139728.png" alt="image-20230901183139728"></p><p><img src="assets/image-20230901183152966.png" alt="image-20230901183152966"></p><h4><span id="é“¶è¡Œä¿¡è´·æ¡ˆä¾‹">é“¶è¡Œä¿¡è´·æ¡ˆä¾‹</span></h4><p><img src="assets/image-20230901183222050.png" alt="image-20230901183222050"></p><p><img src="assets/image-20230901183240178.png" alt="image-20230901183240178"></p><p><img src="assets/image-20230901183301618.png" alt="image-20230901183301618"></p><p><img src="assets/image-20230901183315009.png" alt="image-20230901183315009"></p><h4><span id="æ¢¯åº¦ä¸‹é™ç®—æ³•åˆ†ç±»">æ¢¯åº¦ä¸‹é™ç®—æ³•åˆ†ç±»</span></h4><p><img src="assets/image-20230901183333299.png" alt="image-20230901183333299"></p><p><img src="assets/image-20230901183346878.png" alt="image-20230901183346878"></p><h4><span id="æ­£è§„æ–¹ç¨‹å’Œæ¢¯åº¦ä¸‹é™ç®—æ³•çš„å¯¹æ¯”">æ­£è§„æ–¹ç¨‹å’Œæ¢¯åº¦ä¸‹é™ç®—æ³•çš„å¯¹æ¯”</span></h4><p><img src="assets/image-20230901162716376.png" alt="image-20230901162716376"></p><h2><span id="å›å½’è¯„ä¼°æ–¹æ³•">å›å½’è¯„ä¼°æ–¹æ³•</span></h2><h3><span id="å¹³å‡ç»å¯¹è¯¯å·®">å¹³å‡ç»å¯¹è¯¯å·®</span></h3><p><strong>Mean Absolute Error (MAE)</strong><br>$$<br>MAE=\frac{1}{m}\sum_{i=1}^m|y_i-\hat{y}|<br>$$</p><ul><li>ä¸Šé¢çš„å…¬å¼ä¸­ï¼šn ä¸ºæ ·æœ¬æ•°é‡, y ä¸ºå®é™…å€¼, y_hat ä¸ºé¢„æµ‹å€¼</li><li>MAE è¶Šå°æ¨¡å‹é¢„æµ‹çº¦å‡†ç¡®</li></ul><p>Sklearn ä¸­MAEçš„API</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_absolute_error<br>mean_absolute_error(y_test,y_predict)<br></code></pre></td></tr></table></figure><h3><span id="å‡æ–¹è¯¯å·®">å‡æ–¹è¯¯å·®</span></h3><p><strong>Mean Squared Error (MSE)</strong><br>$$<br>MSE=\frac{1}{2m}\sum_{i=1}^m(y_i-\hat{y})^2<br>$$<br>Sklearn ä¸­MSEçš„API</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error<br>mean_squared_error(y_test,y_predict)<br></code></pre></td></tr></table></figure><h3><span id="å‡æ–¹æ ¹è¯¯å·®">å‡æ–¹æ ¹è¯¯å·®</span></h3><p><strong>Root Mean Squared Error (RMSE)</strong><br>$$<br>RMSE=\sqrt{\frac{1}{m}\sum_{i=1}^m(y_i-\hat{y})^2}<br>$$</p><table><thead><tr><th>æŒ‡æ ‡</th><th>å¯¹å¤§è¯¯å·®æ€åº¦</th><th>æ˜¯å¦æ•æ„Ÿå¼‚å¸¸å€¼</th><th>å•ä½</th><th>å¸¸è§åœºæ™¯</th></tr></thead><tbody><tr><td>MAE</td><td>æ¸©æŸ”</td><td>ä¸æ•æ„Ÿ</td><td>å’Œ y ä¸€æ ·</td><td>æ•°æ®å™ªå£°å¤§</td></tr><tr><td>MSE</td><td>å¾ˆç‹ </td><td>ææ•æ„Ÿ</td><td>yÂ²</td><td>è®­ç»ƒä¼˜åŒ–</td></tr><tr><td>RMSE</td><td>å¾ˆç‹ </td><td>ææ•æ„Ÿ</td><td>å’Œ y ä¸€æ ·</td><td>è¯„ä¼°æ¨¡å‹</td></tr></tbody></table><h2><span id="çº¿æ€§å›å½’æˆ¿ä»·é¢„æµ‹æ¡ˆä¾‹">çº¿æ€§å›å½’æˆ¿ä»·é¢„æµ‹æ¡ˆä¾‹</span></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 0.å¯¼åŒ…</span><br><span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_boston<br><span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split<br><span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler<br><span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LinearRegression,SGDRegressor<br><span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error<br><br><span class="hljs-comment"># 1.åŠ è½½æ•°æ®</span><br>boston = load_boston()<br><span class="hljs-comment"># print(boston)</span><br><br><span class="hljs-comment"># 2.æ•°æ®é›†åˆ’åˆ†</span><br>x_train,x_test,y_train,y_test =train_test_split(boston.data,boston.target,test_size=<span class="hljs-number">0.2</span>,random_state=<span class="hljs-number">22</span>)<br><br><span class="hljs-comment"># 3.æ ‡å‡†åŒ–</span><br>process=StandardScaler()<br>x_train=process.fit_transform(x_train)<br>x_test=process.transform(x_test)<br><br><span class="hljs-comment"># 4.æ¨¡å‹è®­ç»ƒ</span><br><span class="hljs-comment"># 4.1 å®ä¾‹åŒ–(æ­£è§„æ–¹ç¨‹)</span><br><span class="hljs-comment"># model =LinearRegression(fit_intercept=True)</span><br>model = SGDRegressor(learning_rate=<span class="hljs-string">&#x27;constant&#x27;</span>,eta0=<span class="hljs-number">0.01</span>)<br><span class="hljs-comment"># 4.2 fit</span><br>model.fit(x_train,y_train)<br><br><span class="hljs-comment"># print(model.coef_)</span><br><span class="hljs-comment"># print(model.intercept_)</span><br><span class="hljs-comment"># 5.é¢„æµ‹</span><br>y_predict=model.predict(x_test)<br><br><span class="hljs-built_in">print</span>(y_predict)<br><br><span class="hljs-comment"># 6.æ¨¡å‹è¯„ä¼°</span><br><br><span class="hljs-built_in">print</span>(mean_squared_error(y_test,y_predict))<br></code></pre></td></tr></table></figure><h1><span id="é€»è¾‘å›å½’">é€»è¾‘å›å½’</span></h1><p>ä¸»è¦æ˜¯åº”ç”¨äºäºŒåˆ†ç±»é—®é¢˜</p><h2><span id="æ•°å­¦æ¨¡å‹">æ•°å­¦æ¨¡å‹</span></h2><h3><span id="sigmoidå‡½æ•°">sigmoidå‡½æ•°</span></h3><p><img src="assets/image-20260105090907748.png" alt><br>$$<br>f(x)=\frac{1}{1+e^{wx+b}}\<br>f(x)â€™=f(x)(1-f(x))\<br>$$<br>æ•°å­¦æ€§è´¨:</p><p>æ˜¯å•è°ƒé€’å¢å‡½æ•°ï¼Œæ‹ç‚¹ä¸º(0,0.5)</p><h3><span id="æå¤§ä¼¼ç„¶ä¼°è®¡">æå¤§ä¼¼ç„¶ä¼°è®¡</span></h3><p>æ ¸å¿ƒæ€æƒ³ï¼š</p><p>è®¾æ¨¡å‹ä¸­å«æœ‰å¾…ä¼°å‚æ•°wï¼Œå¯ä»¥å–å¾ˆå¤šå€¼ã€‚å·²ç»çŸ¥é“äº†æ ·æœ¬è§‚æµ‹å€¼ï¼Œä»wçš„ä¸€åˆ‡å¯èƒ½å€¼ä¸­é€‰å‡ºä¸€ä¸ªä½¿è¯¥è§‚å¯Ÿå€¼å‡ºç°çš„æ¦‚ç‡ä¸ºæœ€å¤§çš„å€¼ï¼Œä½œä¸ºwå‚æ•°çš„ä¼°è®¡å€¼ï¼Œè¿™å°±æ˜¯æå¤§ä¼¼ç„¶ä¼°è®¡ã€‚ï¼ˆé¡¾åæ€ä¹‰ï¼šå°±æ˜¯çœ‹ä¸Šå»é‚£ä¸ªæ˜¯æœ€å¤§å¯èƒ½çš„æ„æ€ï¼‰</p><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><p>å‡è®¾æœ‰ä¸€æšä¸å‡åŒ€çš„ç¡¬å¸ï¼Œå‡ºç°æ­£é¢çš„æ¦‚ç‡å’Œåé¢çš„æ¦‚ç‡æ˜¯ä¸åŒçš„ã€‚å‡å®šå‡ºç°æ­£é¢çš„æ¦‚ç‡ä¸ºğœƒï¼Œ æŠ›äº†6æ¬¡å¾—åˆ°å¦‚ä¸‹ç°è±¡ D = {æ­£é¢ï¼Œåé¢ï¼Œåé¢ï¼Œæ­£é¢ï¼Œæ­£é¢ï¼Œæ­£é¢}ã€‚æ¯æ¬¡æŠ•æ·äº‹ä»¶éƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚ åˆ™æ ¹æ®äº§ç”Ÿçš„ç°è±¡Dï¼Œæ¥ä¼°è®¡å‚æ•°ğœƒæ˜¯å¤šå°‘?</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ğœƒ">P(D|ğœƒ) = P &#123;æ­£é¢ï¼Œåé¢ï¼Œåé¢ï¼Œæ­£é¢ï¼Œæ­£é¢ï¼Œæ­£é¢&#125;<br> = P(æ­£é¢|ğœƒ) P(åé¢|ğœƒ) P(åé¢|ğœƒ) P(æ­£é¢|ğœƒ) P(æ­£é¢|ğœƒ) P(æ­£é¢|ğœƒ)<br> =ğœƒ *(1-ğœƒ)*(1-ğœƒ)ğœƒ*ğœƒ*ğœƒ = ğœƒ^4(1 âˆ’ ğœƒ)^2<br></code></pre></td></tr></table></figure><p>é—®é¢˜è½¬æ¢ä¸ºæ±‚æå¤§å€¼æ—¶ğœƒæ˜¯å¤šå°‘</p><p><img src="assets/image-20260105091344262.png" alt="image-20260105091344262"></p><h3><span id="é€»è¾‘å›å½’åŸç†">é€»è¾‘å›å½’åŸç†</span></h3><p>é€»è¾‘å›å½’æ¦‚å¿µ Logistic Regression</p><p>â€¢ ä¸€ç§åˆ†ç±»æ¨¡å‹ï¼ŒæŠŠçº¿æ€§å›å½’çš„è¾“å‡ºï¼Œä½œä¸ºé€»è¾‘å›å½’çš„è¾“å…¥ã€‚</p><p>â€¢ è¾“å‡ºæ˜¯(0, 1)ä¹‹é—´çš„å€¼</p><p>â€¢ åŸºæœ¬æ€æƒ³</p><ol><li>åˆ©ç”¨çº¿æ€§æ¨¡å‹ f(x) = wx + b æ ¹æ®ç‰¹å¾çš„é‡è¦æ€§è®¡ç®—å‡ºä¸€ä¸ªå€¼</li><li>å†ä½¿ç”¨ sigmoid å‡½æ•°å°† f(x) çš„è¾“å‡ºå€¼æ˜ å°„ä¸ºæ¦‚ç‡å€¼<ol><li>è®¾ç½®é˜ˆå€¼(eg:0.5)ï¼Œè¾“å‡ºæ¦‚ç‡å€¼å¤§äº 0.5ï¼Œåˆ™å°†æœªçŸ¥æ ·æœ¬è¾“å‡ºä¸º 1 ç±»</li><li>å¦åˆ™è¾“å‡ºä¸º 0 ç±»</li></ol></li></ol><p>3.é€»è¾‘å›å½’çš„å‡è®¾å‡½æ•°<br>h(w) = sigmoid(wx + b )</p><p>çº¿æ€§å›å½’çš„è¾“å‡ºï¼Œä½œä¸ºé€»è¾‘å›å½’çš„è¾“å…¥</p><p><img src="assets/image-20260105091700535.png" alt="image-20260105091700535"></p><h2><span id="æŸå¤±å‡½æ•°">æŸå¤±å‡½æ•°</span></h2><p>$$<br>Loss(L)=-\sum_{i=1}^m(y_ilog(p_i)+(1-y_i)log(1-p_i))<br>$$</p><p><img src="assets/image-20230904151300483.png" alt="image-20230904151300483"></p><p><img src="assets/image-20230904151334262.png" alt="image-20230904151334262"></p><p><img src="assets/image-20230904151343779.png" alt="image-20230904151343779"></p><h2><span id="é€»è¾‘å›å½’ç”µä¿¡å®¢æˆ·æµå¤±é¢„æµ‹æ¡ˆä¾‹">é€»è¾‘å›å½’ç”µä¿¡å®¢æˆ·æµå¤±é¢„æµ‹æ¡ˆä¾‹</span></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns<br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br><span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split<br><span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LogisticRegression<br><span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> accuracy_score, roc_auc_score<br><br><br><span class="hljs-comment"># 1. å®šä¹‰å‡½æ•°, è¡¨ç¤º: æ•°æ®åŸºæœ¬å¤„ç†</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dm01_æ•°æ®åŸºæœ¬å¤„ç†</span>():<br>    <span class="hljs-comment"># 1. è¯»å–æ•°æ®, æŸ¥çœ‹æ•°æ®çš„åŸºæœ¬ä¿¡æ¯.</span><br>    churn_pd = pd.read_csv(<span class="hljs-string">&#x27;data/churn.csv&#x27;</span>)<br>    <span class="hljs-comment"># churn_pd.info()</span><br>    <span class="hljs-comment"># print(f&#x27;churn_pd.describe(): &#123;churn_pd.describe()&#125;&#x27;)</span><br>    <span class="hljs-comment"># print(f&#x27;churn_pd: &#123;churn_pd&#125;&#x27;)</span><br><br>    <span class="hljs-comment"># 2. å¤„ç†ç±»åˆ«å‹çš„æ•°æ®, ç±»åˆ«å‹æ•°æ®åš one-hotç¼–ç (çƒ­ç¼–ç ).</span><br>    churn_pd = pd.get_dummies(churn_pd)<br>    churn_pd.info()<br>    <span class="hljs-comment"># print(f&#x27;churn_pd: &#123;churn_pd&#125;&#x27;)</span><br><br>    <span class="hljs-comment"># 3. å»é™¤åˆ— Churn_No, gender_Male</span><br>    churn_pd.drop([<span class="hljs-string">&#x27;Churn_No&#x27;</span>, <span class="hljs-string">&#x27;gender_Male&#x27;</span>], axis=<span class="hljs-number">1</span>, inplace=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># æŒ‰åˆ—åˆ é™¤</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;churn_pd: <span class="hljs-subst">&#123;churn_pd&#125;</span>&#x27;</span>)<br><br>    <span class="hljs-comment"># 4. åˆ—æ ‡ç­¾é‡å‘½å, æ‰“å°åˆ—å</span><br>    churn_pd.rename(columns=&#123;<span class="hljs-string">&#x27;Churn_Yes&#x27;</span>: <span class="hljs-string">&#x27;flag&#x27;</span>&#125;, inplace=<span class="hljs-literal">True</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;åˆ—å: <span class="hljs-subst">&#123;churn_pd.columns&#125;</span>&#x27;</span>)<br><br>    <span class="hljs-comment"># 5. æŸ¥çœ‹æ ‡ç­¾çš„åˆ†å¸ƒæƒ…å†µ 0.26ç”¨æˆ·æµå¤±</span><br>    value_counts = churn_pd.flag.value_counts()<br>    <span class="hljs-built_in">print</span>(value_counts)<br><br><br><span class="hljs-comment"># 2. å®šä¹‰å‡½æ•°, è¡¨ç¤º: ç‰¹å¾ç­›é€‰</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dm02_ç‰¹å¾ç­›é€‰</span>():<br>    <span class="hljs-comment"># 1. è¯»å–æ•°æ®</span><br>    churn_pd = pd.read_csv(<span class="hljs-string">&#x27;data/churn.csv&#x27;</span>)<br>    <span class="hljs-comment"># 2. å¤„ç†ç±»åˆ«å‹çš„æ•°æ®, ç±»åˆ«å‹æ•°æ®åš one-hotç¼–ç (çƒ­ç¼–ç ).</span><br>    churn_pd = pd.get_dummies(churn_pd)<br>    <span class="hljs-comment"># 3. å»é™¤åˆ— Churn_No, gender_Male</span><br>    churn_pd.drop([<span class="hljs-string">&#x27;Churn_No&#x27;</span>, <span class="hljs-string">&#x27;gender_Male&#x27;</span>], axis=<span class="hljs-number">1</span>, inplace=<span class="hljs-literal">True</span>)<br>    <span class="hljs-comment"># 4. åˆ—æ ‡ç­¾é‡å‘½å</span><br>    churn_pd.rename(columns=&#123;<span class="hljs-string">&#x27;Churn_Yes&#x27;</span>: <span class="hljs-string">&#x27;flag&#x27;</span>&#125;, inplace=<span class="hljs-literal">True</span>)<br>    <span class="hljs-comment"># 5. æŸ¥çœ‹æ ‡ç­¾çš„åˆ†å¸ƒæƒ…å†µ</span><br>    value_counts = churn_pd.flag.value_counts()<br>    <span class="hljs-built_in">print</span>(value_counts)<br>    <span class="hljs-comment"># 6. æŸ¥çœ‹Contract_Month æ˜¯å¦é¢„ç­¾çº¦æµå¤±æƒ…å†µ</span><br>    sns.countplot(data=churn_pd, x=<span class="hljs-string">&#x27;Contract_Month&#x27;</span>, hue=<span class="hljs-string">&#x27;flag&#x27;</span>)<br>    plt.show()<br><br><br><span class="hljs-comment"># 3. å®šä¹‰å‡½æ•°, è¡¨ç¤º: æ¨¡å‹è®­ç»ƒ å’Œ è¯„æµ‹</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dm03_æ¨¡å‹è®­ç»ƒå’Œè¯„æµ‹</span>():<br>    <span class="hljs-comment"># 1. è¯»å–æ•°æ®</span><br>    churn_pd = pd.read_csv(<span class="hljs-string">&#x27;data/churn.csv&#x27;</span>)<br><br>    <span class="hljs-comment"># 2. æ•°æ®é¢„å¤„ç†</span><br>    <span class="hljs-comment"># 2.1 å¤„ç†ç±»åˆ«å‹çš„æ•°æ®, ç±»åˆ«å‹æ•°æ®åš one-hotç¼–ç (çƒ­ç¼–ç ).</span><br>    churn_pd = pd.get_dummies(churn_pd)<br>    <span class="hljs-comment"># 2.2 å»é™¤åˆ— Churn_No, gender_Male</span><br>    churn_pd.drop([<span class="hljs-string">&#x27;Churn_No&#x27;</span>, <span class="hljs-string">&#x27;gender_Male&#x27;</span>], axis=<span class="hljs-number">1</span>, inplace=<span class="hljs-literal">True</span>)<br>    <span class="hljs-comment"># 2.3 åˆ—æ ‡ç­¾é‡å‘½å</span><br>    churn_pd.rename(columns=&#123;<span class="hljs-string">&#x27;Churn_Yes&#x27;</span>: <span class="hljs-string">&#x27;flag&#x27;</span>&#125;, inplace=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-comment"># 3. ç‰¹å¾å¤„ç†.</span><br>    <span class="hljs-comment"># 3.1 æå–ç‰¹å¾å’Œæ ‡ç­¾</span><br>    x = churn_pd[[<span class="hljs-string">&#x27;Contract_Month&#x27;</span>, <span class="hljs-string">&#x27;internet_other&#x27;</span>, <span class="hljs-string">&#x27;PaymentElectronic&#x27;</span>]]<br>    y = churn_pd[<span class="hljs-string">&#x27;flag&#x27;</span>]<br>    <span class="hljs-comment"># 3.2 è®­ç»ƒé›†å’Œæµ‹è¯•é›†çš„åˆ†å‰²</span><br>    x_train, x_test, y_train, y_test = train_test_split(x, y, test_size=<span class="hljs-number">0.3</span>, random_state=<span class="hljs-number">21</span>)<br><br>    <span class="hljs-comment"># 4. æ¨¡å‹è®­ç»ƒ.</span><br>    estimator = LogisticRegression()<br>    estimator.fit(x_train, y_train)<br><br>    <span class="hljs-comment"># 5. æ¨¡å‹é¢„æµ‹</span><br>    y_predict = estimator.predict(x_test)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;é¢„æµ‹ç»“æœ: <span class="hljs-subst">&#123;y_predict&#125;</span>&#x27;</span>)<br><br>    <span class="hljs-comment"># 6. æ¨¡å‹è¯„ä¼°</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;å‡†ç¡®ç‡: <span class="hljs-subst">&#123;accuracy_score(y_test, y_predict)&#125;</span>&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;å‡†ç¡®ç‡: <span class="hljs-subst">&#123;estimator.score(x_test, y_test)&#125;</span>&#x27;</span>)<br><br>    <span class="hljs-comment"># è®¡ç®—AUCå€¼.</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;AUCå€¼: <span class="hljs-subst">&#123;roc_auc_score(y_test, y_predict)&#125;</span>&#x27;</span>)<br><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-comment"># dm01_æ•°æ®åŸºæœ¬å¤„ç†()</span><br>    <span class="hljs-comment"># dm02_ç‰¹å¾ç­›é€‰()</span><br>    dm03_æ¨¡å‹è®­ç»ƒå’Œè¯„æµ‹()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1&gt;ç‰¹å¾é¢„å¤„ç†&lt;/h1&gt;
&lt;p&gt;ç‰¹å¾é¢„å¤„ç†åˆ†ä¸ºæ ‡å‡†åŒ–å’Œå½’ä¸€åŒ–&lt;/p&gt;</summary>
    
    
    
    
    <category term="æœºå™¨å­¦ä¹ " scheme="https://garybyd.github.io/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>Mysqlæ ¸å¿ƒæ¡†æ¶</title>
    <link href="https://garybyd.github.io/posts/Mysql%E6%A0%B8%E5%BF%83%E6%A1%86%E6%9E%B6%E7%9F%A5%E8%AF%86/"/>
    <id>https://garybyd.github.io/posts/Mysql%E6%A0%B8%E5%BF%83%E6%A1%86%E6%9E%B6%E7%9F%A5%E8%AF%86/</id>
    <published>2025-08-18T13:53:33.000Z</published>
    <updated>2026-01-06T06:21:16.189Z</updated>
    
    <content type="html"><![CDATA[<h1><span id="mysqlæ ¸å¿ƒæ¡†æ¶">Mysqlæ ¸å¿ƒæ¡†æ¶</span></h1><p>æœ¬æ–‡æ—¨åœ¨æ¢³ç†å’Œç†è§£ MySQL çš„ä¸€äº›æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼Œå¹¶ç»“åˆå¸¸è§é¢è¯•é¢˜è¿›è¡Œæ€è€ƒå’Œæ€»ç»“ã€‚è¿™äº›å†…å®¹ä¸»è¦æ¥æºäºæˆ‘çš„ä¸ªäººå­¦ä¹ ä¸ç†è§£ã€‚</p><span id="more"></span><h2><span id="1-äº‹åŠ¡">1. äº‹åŠ¡</span></h2><h3><span id="æ¦‚å¿µ">æ¦‚å¿µ</span></h3><p>äº‹åŠ¡æŒ‡çš„æ˜¯<strong>æ»¡è¶³ ACID ç‰¹æ€§çš„ä¸€ç»„æ“ä½œ</strong>ï¼Œå¯ä»¥é€šè¿‡ Commit æäº¤ä¸€ä¸ªäº‹åŠ¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Rollback è¿›è¡Œå›æ»šã€‚</p><p>é‚£æŠ¹ä»€ä¹ˆæ˜¯ACIDå‘¢ï¼Ÿ</p><h4><span id="acid">ACID</span></h4><ol><li><strong>åŸå­æ€§ï¼ˆAtomicityï¼‰</strong></li></ol><p>â€‹äº‹åŠ¡è¢«è§†ä¸ºä¸å¯åˆ†å‰²çš„æœ€å°å•å…ƒï¼Œäº‹åŠ¡çš„æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æäº¤æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥å›æ»šã€‚</p><p>â€‹å›æ»šå¯ä»¥ç”¨å›æ»šæ—¥å¿—ï¼ˆ<code>Undo Log</code>ï¼‰æ¥å®ç°ï¼Œå›æ»šæ—¥å¿—è®°å½•ç€äº‹åŠ¡æ‰€æ‰§è¡Œçš„ä¿®æ”¹æ“ä½œï¼Œåœ¨å›æ»šæ—¶åå‘æ‰§è¡Œè¿™äº›ä¿®æ”¹æ“ä½œå³å¯ã€‚</p><ol start="2"><li><strong>ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰</strong></li></ol><p>â€‹æ•°æ®åº“åœ¨äº‹åŠ¡æ‰§è¡Œå‰åéƒ½ä¿æŒä¸€è‡´æ€§çŠ¶æ€ã€‚åœ¨ä¸€è‡´æ€§çŠ¶æ€ä¸‹ï¼Œæ‰€æœ‰äº‹åŠ¡å¯¹åŒä¸€ä¸ªæ•°æ®çš„è¯»å–ç»“æœéƒ½æ˜¯ç›¸åŒçš„ã€‚</p><p>â€‹æˆ‘ä¸ªäººç†è§£å°±æ˜¯è¿™ä¸ªæ‰§è¡Œç»“æœè¦åˆç†ï¼Œä¸èƒ½æˆ‘è½¬äº†ä½ 500ï¼Œä½ æ‹¿åˆ°äº†1000è¿™ç§çŠ¶æ€ã€‚</p><ol start="3"><li><strong>éš”ç¦»æ€§ï¼ˆIsolationï¼‰</strong></li></ol><p>â€‹ä¸€ä¸ªäº‹åŠ¡æ‰€åšçš„ä¿®æ”¹åœ¨æœ€ç»ˆæäº¤ä»¥å‰ï¼Œå¯¹å…¶å®ƒäº‹åŠ¡æ˜¯ä¸å¯è§çš„ã€‚</p><ol start="4"><li><strong>æŒä¹…æ€§ï¼ˆDurabilityï¼‰</strong></li></ol><p>â€‹ä¸€æ—¦äº‹åŠ¡æäº¤ï¼Œåˆ™å…¶æ‰€åšçš„ä¿®æ”¹å°†ä¼šæ°¸è¿œä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚å³ä½¿ç³»ç»Ÿå‘ç”Ÿå´©æºƒï¼Œäº‹åŠ¡æ‰§è¡Œçš„ç»“æœä¹Ÿä¸èƒ½ä¸¢å¤±ã€‚</p><p>â€‹ç³»ç»Ÿå‘ç”Ÿå´©æºƒå¯ä»¥ç”¨é‡åšæ—¥å¿—ï¼ˆÂ·Redo LogÂ·ï¼‰è¿›è¡Œæ¢å¤ï¼Œä»è€Œå®ç°æŒä¹…æ€§ã€‚ä¸å›æ»šæ—¥å¿—è®°å½•æ•°æ®çš„é€»è¾‘ä¿®æ”¹ä¸åŒï¼Œé‡åšæ—¥å¿—è®°å½•çš„æ˜¯æ•°æ®é¡µçš„ç‰©ç†ä¿®æ”¹ã€‚</p><p><strong>ä¸¾ä¸ªä¾‹å­:</strong></p><p>ä¾‹å¦‚ï¼ŒAå‘Bè½¬è´¦500å…ƒï¼Œè¿™ä¸ªæ“ä½œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥ï¼Œä½“ç°äº†åŸå­æ€§ã€‚è½¬è´¦è¿‡ç¨‹ä¸­æ•°æ®è¦ä¿æŒä¸€è‡´ï¼ŒAæ‰£é™¤äº†500å…ƒï¼ŒBå¿…é¡»å¢åŠ 500å…ƒã€‚éš”ç¦»æ€§ä½“ç°åœ¨Aå‘Bè½¬è´¦æ—¶ï¼Œä¸å—å…¶ä»–äº‹åŠ¡å¹²æ‰°ã€‚æŒä¹…æ€§ä½“ç°åœ¨äº‹åŠ¡æäº¤åï¼Œæ•°æ®è¦è¢«æŒä¹…åŒ–å­˜å‚¨ã€‚</p><p>äº‹åŠ¡çš„ ACID ç‰¹æ€§æ¦‚å¿µç®€å•ï¼Œä½†ä¸æ˜¯å¾ˆå¥½ç†è§£ï¼Œä¸»è¦æ˜¯å› ä¸ºè¿™å‡ ä¸ªç‰¹æ€§ä¸æ˜¯ä¸€ç§å¹³çº§å…³ç³»ï¼š</p><ul><li>åªæœ‰æ»¡è¶³ä¸€è‡´æ€§ï¼Œäº‹åŠ¡çš„æ‰§è¡Œç»“æœæ‰æ˜¯æ­£ç¡®çš„ã€‚</li><li>åœ¨æ— å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œäº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œéš”ç¦»æ€§ä¸€å®šèƒ½å¤Ÿæ»¡è¶³ã€‚æ­¤æ—¶åªè¦èƒ½æ»¡è¶³åŸå­æ€§ï¼Œå°±ä¸€å®šèƒ½æ»¡è¶³ä¸€è‡´æ€§ã€‚</li><li>åœ¨å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œå¤šä¸ªäº‹åŠ¡å¹¶è¡Œæ‰§è¡Œï¼Œäº‹åŠ¡ä¸ä»…è¦æ»¡è¶³åŸå­æ€§ï¼Œè¿˜éœ€è¦æ»¡è¶³éš”ç¦»æ€§ï¼Œæ‰èƒ½æ»¡è¶³ä¸€è‡´æ€§ã€‚</li><li>äº‹åŠ¡æ»¡è¶³æŒä¹…åŒ–æ˜¯ä¸ºäº†èƒ½åº”å¯¹ç³»ç»Ÿå´©æºƒçš„æƒ…å†µã€‚</li></ul><img src="/posts/Mysql%E6%A0%B8%E5%BF%83%E6%A1%86%E6%9E%B6%E7%9F%A5%E8%AF%86/image-20250818220457998.png" class title="image-20250818220457998"><p>åŸå­æ€§å’Œéš”ç¦»æ€§ç›´æ¥ä¿è¯ä¸€è‡´æ€§ï¼Œç®€ä»‹ä¿è¯æ‰§è¡Œç»“æœçš„æ­£ç¡®ã€‚è€Œä¸€è‡´æ€§æ˜¯è§‰å¾—æ‰§è¡Œç»“æœæ­£ç¡®çš„ç›´æ¥å› ç´ ã€‚</p><p>æŒä¹…æ€§ç”¨äºåº”å¯¹ç³»ç»Ÿçš„å´©æºƒï¼Œæé«˜æ•°æ®åº“çš„é«˜å¯ç”¨æ€§å’Œé²æ£’æ€§ã€‚</p><h2><span id="2-å¹¶å‘ä¸€è‡´æ€§é—®é¢˜">2. å¹¶å‘ä¸€è‡´æ€§é—®é¢˜</span></h2><p>æ³¨æ„wä¸ºwriteæ“ä½œ,rä¸ºreadæ“ä½œ</p><h4><span id="ä¸¢å¤±ä¿®æ”¹">ä¸¢å¤±ä¿®æ”¹</span></h4><table><thead><tr><th>T1</th><th>T2</th></tr></thead><tbody><tr><td>w a=10</td><td></td></tr><tr><td></td><td>w a=20</td></tr><tr><td>r a=20</td><td></td></tr><tr><td></td><td>r a=20</td></tr></tbody></table><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„T1çº¿ç¨‹å’ŒT2çº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„æ—¶å€™T1ä¸¢å¤±äº†åŸæ¥a=10çš„æ“ä½œç—•è¿¹ï¼ŒT2åæäº¤è¦†ç›–äº†T1çš„æäº¤ï¼Œä¼¼ä¹T1æ²¡æœ‰æ‰§è¡Œw a=10çš„æ“ä½œä¸€æ ·ï¼Œè¿™å°±æ˜¯&quot;ä¸¢å¤±ä¿®æ”¹&quot;ã€‚</p><h4><span id="è¯»è„æ•°æ®">è¯»è„æ•°æ®</span></h4><table><thead><tr><th>T1</th><th>T2</th></tr></thead><tbody><tr><td>r a=10</td><td></td></tr><tr><td>w a=20</td><td></td></tr><tr><td></td><td>r a=20</td></tr><tr><td>rollback</td><td></td></tr></tbody></table><p>T1,T2å¹¶å‘æ‰§è¡Œåœ¨å‰é¢éƒ½æ²¡é—®é¢˜ï¼Œå¯æ˜¯å½“T1rollbackæ“ä½œåæ•°æ®åº“é‡Œé¢çš„å€¼åˆå˜å›äº†10ï¼Œæ­¤æ—¶T2æ‹¿åˆ°å¹¶ä¸æ˜¯æ•°æ®åº“çœŸå®çš„æ•°æ®ï¼Œå¦‚æœæ‹¿ç€è¿™ä¸ªæ•°æ®æ‰§è¡Œæ”¯ä»˜æ“ä½œå¯æƒ³è€ŒçŸ¥ä¼šç»™æˆ‘ä»¬çš„ç³»ç»Ÿé€ æˆå¤šå¤§çš„æŸå¤±ã€‚</p><h4><span id="ä¸å¯é‡å¤è¯»">ä¸å¯é‡å¤è¯»</span></h4><table><thead><tr><th>T1</th><th>T2</th></tr></thead><tbody><tr><td></td><td>r a=10</td></tr><tr><td>w a=20</td><td></td></tr><tr><td></td><td>r a=20</td></tr></tbody></table><p>å…¶å®ä¸å¯é‡å¤è¯»å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­æˆ‘è¿›è¡Œä¸¤æ¬¡è¯»å–æ“ä½œç»“æœè·å¾—å€¼ä¸ç›¸åŒï¼Œä¹Ÿå¯èƒ½ä¼šå¯¹æˆ‘ä»¬çš„ç³»ç»Ÿé€ æˆå¾ˆå¤§çš„å›°æ‰°ã€‚</p><h4><span id="å¹»å½±è¯»å¹»è¯»">å¹»å½±è¯»(å¹»è¯»)</span></h4><table><thead><tr><th>T1</th><th>T2</th></tr></thead><tbody><tr><td>count(user_id) 1</td><td></td></tr><tr><td></td><td>delete(user_object)</td></tr><tr><td>count(user_id) 0</td><td></td></tr></tbody></table><p>å¹»è¯»çš„å‡ºç°åœºæ™¯ä¸»è¦åœ¨<code>èšåˆå‡½æ•°</code>ç»Ÿè®¡æ—¶å€™å‡ºç°çš„æ¦‚ç‡æ¯”è¾ƒå¤§ä¸€äº›ã€‚ä¸€ä¸ªäº‹åŠ¡ä¸‹çš„ä¸¤æ¬¡èšåˆæ“ä½œç«Ÿç„¶ä¸ç›¸åŒï¼Œå¦‚æœæ˜¯åœ¨ç§’æ€åœºæ™¯é‡Œé¢ï¼Œå¯èƒ½å°±é€ æˆäº†è¶…ä¹°è¶…å–é—®é¢˜ã€‚</p><hr><h2><span id="3-å°é”">3. å°é”</span></h2><h3><span id="é”çš„ç²’åº¦">é”çš„ç²’åº¦</span></h3><p>MySQLåœ¨ç²’åº¦ä¸Šåˆ†ç±»çš„è¯åˆ†ä¸ºè¡Œçº§é”ã€è¡¨çº§é”ã€é¡µé¢é”</p><ul><li>è¡¨çº§é”ï¼šå¼€é”€å°ï¼ŒåŠ é”å¿«ï¼›ä¸ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦å¤§ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€é«˜ï¼Œå¹¶å‘åº¦æœ€ä½ã€‚</li><li>è¡Œçº§é”ï¼šå¼€é”€å¤§ï¼ŒåŠ é”æ…¢ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦æœ€å°ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€ä½ï¼Œå¹¶å‘åº¦ä¹Ÿæœ€é«˜ã€‚</li><li>é¡µé¢é”ï¼šå¼€é”€å’ŒåŠ é”æ—¶é—´ç•Œäºè¡¨é”å’Œè¡Œé”ä¹‹é—´ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦ç•Œäºè¡¨é”å’Œè¡Œé”ä¹‹é—´ï¼Œå¹¶å‘åº¦ä¸€èˆ¬</li></ul><p>ä»æ€§èƒ½ä¸Šçœ‹çš„è¯ï¼Œé”çš„ç²’åº¦è¶Šç»†ï¼Œèƒ½å¤Ÿå¹¶å‘çš„çº¿ç¨‹æ•°é‡å°±è¶Šå¤šï¼Œæ€§èƒ½å°±è¶Šé«˜ã€‚åä¹‹åˆ™æ€§èƒ½è¶Šä½ã€‚æ‰€ä»¥ä»è¿™ä¸ªå±‚é¢ä¸Šè€ƒè™‘çš„è¡Œçº§é”çš„æ€§èƒ½æ˜¯é«˜äºæ ‡è®°é”çš„ã€‚</p><p><strong>ä¸‰ç§å¸¸ç”¨å¼•æ“çš„æ”¯æŒæƒ…å†µ</strong></p><table><thead><tr><th>InnoDB</th><th>MyISAM</th><th>MEMORY</th></tr></thead><tbody><tr><td>è¡Œçº§é”å’Œè¡¨çº§é”</td><td>æ”¯æŒè¡¨çº§é”</td><td>æ”¯æŒæ ‡è®°é”</td></tr></tbody></table><p>ä»è¿™ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥InnoDBåœ¨é”çš„æ€§èƒ½ä¸Šæ˜¯é«˜äºå…¶ä»–ä¸¤ä¸ªå­˜å‚¨å¼•æ“çš„ã€‚</p><hr><h4><span id="è¡¨çº§é”">è¡¨çº§é”</span></h4><h5><span id="åŸºæœ¬çš„ä¸¤å¤§ç±»è¡¨é”">åŸºæœ¬çš„ä¸¤å¤§ç±»è¡¨é”</span></h5><p>ï¼­ySQLçš„è¡¨é”æœ‰ä¸¤ç§æ¨¡å¼ï¼šè¡¨å…±äº«è¯»é”ï¼ˆTable Read Lockï¼‰å’Œè¡¨ç‹¬å å†™é”ï¼ˆTable Write Lockï¼‰</p><ul><li>è¡¨å…±äº«è¯»é” ï¼ˆTable Read Lockï¼‰ï¼šä¸ä¼šé˜»å¡å…¶ä»–ç”¨æˆ·å¯¹åŒä¸€è¡¨çš„è¯»è¯·æ±‚ï¼Œä½†ä¼šé˜»å¡å¯¹åŒä¸€è¡¨çš„å†™è¯·æ±‚ï¼›</li><li>è¡¨ç‹¬å å†™é” ï¼ˆTable Write Lockï¼‰ï¼šä¼šé˜»å¡å…¶ä»–ç”¨æˆ·å¯¹åŒä¸€è¡¨çš„è¯»å’Œå†™æ“ä½œï¼›</li></ul><p>å½“ç„¶æœ‰äº›å­˜å‚¨å¼•æ“è¿˜æ”¯æŒæ„å‘é”ï¼Œå¦‚æˆ‘ä»¬å¤§åé¼é¼çš„InnoDBã€‚</p><table><thead><tr><th>æ˜¯å¦é˜»å¡</th><th>è¯»é”</th><th>å†™é”</th></tr></thead><tbody><tr><td>è¯»é”</td><td>Y</td><td>N</td></tr><tr><td>å†™é”</td><td>N</td><td>N</td></tr></tbody></table><p><code>tipï¼šè¯»è¯»å…¼å®¹ï¼Œè¯»å†™é˜»å¡ï¼Œå†™å†™é˜»å¡</code></p><h4><span id="è¡Œçº§é”">è¡Œçº§é”</span></h4><h5><span id="åŸºæœ¬çš„ä¸¤å¤§ç±»è¡Œé”">åŸºæœ¬çš„ä¸¤å¤§ç±»è¡Œé”</span></h5><ol><li><strong>å…±äº«é”ï¼ˆS é”ï¼ŒShared Lockï¼‰</strong><ul><li>å…è®¸å¤šä¸ªäº‹åŠ¡åŒæ—¶è¯»ä¸€è¡Œï¼Œä½†ä¸èƒ½å†™ã€‚</li></ul></li><li><strong>æ’ä»–é”ï¼ˆX é”ï¼ŒExclusive Lockï¼‰</strong><ul><li>ä¸€ä¸ªäº‹åŠ¡è·å–æ’ä»–é”åï¼Œåˆ«äººæ—¢ä¸èƒ½è¯»ä¹Ÿä¸èƒ½å†™ï¼ˆè¯»æ˜¯æŒ‡åŠ é”çš„è¯»ï¼‰ã€‚</li><li>å¸¸è§åœ¨ <code>UPDATE</code>ã€<code>DELETE</code>ã€<code>INSERT</code> æ“ä½œé‡Œä¼šè‡ªåŠ¨åŠ ã€‚</li></ul></li></ol><h5><span id="innodb-ç‰¹æœ‰çš„å˜ç§è¡Œé”">InnoDB ç‰¹æœ‰çš„â€œå˜ç§â€è¡Œé”</span></h5><p>ä¸ºäº†å¤„ç†å¤æ‚çš„å¹¶å‘åœºæ™¯ï¼ŒInnoDB åœ¨åŸºæœ¬ S/X é”ä¸Šåˆæ‰©å±•å‡ºå‡ ç§ï¼š</p><ol><li><p><strong>è®°å½•é”ï¼ˆRecord Lockï¼‰</strong></p><ul><li>æœ€å¸¸è§çš„è¡Œé”ï¼Œå°±æ˜¯é”ä½æŸä¸€æ¡ç´¢å¼•è®°å½•ã€‚</li><li>å‰ææ˜¯æŸ¥è¯¢å¿…é¡»ç”¨åˆ°ç´¢å¼•ï¼Œå¦åˆ™å¯èƒ½å‡çº§æˆè¡¨é”ã€‚</li></ul></li><li><p><strong>é—´éš™é”ï¼ˆGap Lockï¼‰</strong></p><ul><li><p>é”ä½æŸä¸ªèŒƒå›´çš„â€œé—´éš™â€ï¼Œè€Œä¸æ˜¯å·²æœ‰çš„è¡Œã€‚</p></li><li><p>ç”¨æ¥é˜²æ­¢â€œå¹»è¯»â€ï¼ˆåˆ«äººæ’å…¥æ–°è¡Œå¯¼è‡´èŒƒå›´æŸ¥è¯¢ç»“æœå˜äº†ï¼‰ã€‚</p></li><li><p>ä¾‹å¦‚ï¼š</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs n1ql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">WHERE</span> age <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">20</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">30</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;<br></code></pre></td></tr></table></figure><p><code>FOR UPDATE</code> â†’ ç»™åŒ¹é…è¡ŒåŠ æ’ä»–é”ã€‚</p><p><code>BETWEEN 20 AND 30</code> â†’ é”ä½è¿™ä¸ªèŒƒå›´çš„è®°å½•ã€‚</p></li></ul></li><li><p><strong>ä¸´é”®é”ï¼ˆNext-Key Lockï¼‰</strong></p><ul><li>è®°å½•é” + é—´éš™é”çš„ç»„åˆï¼Œé”ä½â€œæŸä¸€æ¡è®°å½•åŠå…¶å‰é¢çš„é—´éš™â€ã€‚</li><li>è¿™æ˜¯ InnoDB åœ¨ <strong>å¯é‡å¤è¯»ï¼ˆRRï¼‰</strong> éš”ç¦»çº§åˆ«ä¸‹çš„é»˜è®¤æ¨¡å¼ï¼Œä¸»è¦å°±æ˜¯ä¸ºäº†é˜²æ­¢å¹»è¯»ã€‚</li></ul></li></ol><p><strong>InnoDBé»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨çš„å°±æ˜¯è¡Œé”ï¼Œå¦‚æœè¦è¡¨é”çš„è¯å¿…é¡»æ˜¾å¼åŠ é”ã€‚</strong></p><p><strong>InnoDBä¸MyISAMçš„æœ€å¤§ä¸åŒæœ‰ä¸¤ç‚¹</strong>ï¼š</p><ol><li>ä¸€æ˜¯<code>æ”¯æŒäº‹åŠ¡</code>ï¼ˆTRANSACTIONï¼‰ï¼›</li><li>äºŒæ˜¯é‡‡ç”¨äº†<code>è¡Œçº§é”</code>ã€‚</li></ol><p>è¡Œé”å®šæ˜¯å¯¹ç´¢å¼•è®°å½•çš„é”å®šã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> c1 <span class="hljs-keyword">FROM</span> t <span class="hljs-keyword">WHERE</span> c1 <span class="hljs-operator">=</span> <span class="hljs-number">10</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;<br></code></pre></td></tr></table></figure><p>é˜²æ­¢ä»»ä½•å…¶ä»–äº‹åŠ¡æ’å…¥ï¼Œæ›´æ–°æˆ–åˆ é™¤t.c1å€¼ä¸º10çš„è¡Œã€‚</p><p>MySQL çš„ <code>UPDATE</code> åœ¨å¹¶å‘æƒ…å†µä¸‹ï¼Œå¦‚æœæ˜¯ InnoDB å¼•æ“ï¼Œä¼šé€šè¿‡è¡Œçº§æ’ä»–é”é¿å…åŒä¸€è¡Œè¢«å¤šä¸ªäº‹åŠ¡åŒæ—¶ä¿®æ”¹ã€‚è¿™ä¹Ÿæ˜¯Mysqlå±‚é¢ä¸Šçš„è§£å†³è¶…ä¹°è¶…å–çš„ä¸€ç§æ‰‹æ®µæã€‚</p><h5><span id="è¡Œé”å‡çº§ä¸ºè¡¨é”"><strong>è¡Œé”å‡çº§ä¸ºè¡¨é”</strong></span></h5><p>è¡Œé”ä¹Ÿæœ‰å¯èƒ½å‡çº§æˆè¡¨é”ï¼Œå…·ä½“çš„æƒ…å†µï¼š</p><ol><li>ä¸é€‚ç”¨ç´¢å¼•çš„æƒ…å†µä¸‹åŠ é”</li><li>ä½¿ç”¨æ™®é€šç´¢å¼•çš„æƒ…å†µä¸‹åŠ é”ï¼ˆtips:æ™®é€šç´¢å¼•ä¸é™åˆ¶å€¼å•çº¯å»ºç«‹b+æ ‘æ¥åŠ å¿«æŸ¥è¯¢é€Ÿåº¦ï¼Œéšä¾¿æ’,å’±æ™®éè¯´çš„ç´¢å¼•ä¸€èˆ¬æ˜¯ä¸»é”®ç´¢å¼•å’Œå”¯ä¸€ç´¢å¼•æœ‰éé‡å¤çš„éœ€æ±‚)</li><li>èŒƒå›´æ€§æŸ¥è¯¢</li></ol><p><strong>æ€»ç»“è¡Œé”æ˜¯å»ºç«‹åœ¨ç´¢å¼•çš„åŸºç¡€ä¸Šçš„ï¼Œæ™®é€šç´¢å¼•çš„æ•°æ®é‡å¤ç‡è¿‡é«˜æˆ–å¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼Œè¡Œé”å‡çº§ä¸ºè¡¨é”</strong></p><h3><span id="å°é”çš„ç±»å‹">å°é”çš„ç±»å‹</span></h3><h4><span id="è¯»å†™é”">è¯»å†™é”</span></h4><ul><li>äº’æ–¥é”ï¼ˆExclusiveï¼‰ï¼Œç®€å†™ä¸º X é”ï¼Œåˆç§°å†™é”ã€‚</li><li>å…±äº«é”ï¼ˆSharedï¼‰ï¼Œç®€å†™ä¸º S é”ï¼Œåˆç§°è¯»é”ã€‚</li></ul><p>æœ‰ä»¥ä¸‹ä¸¤ä¸ªè§„å®šï¼š</p><ul><li>ä¸€ä¸ªäº‹åŠ¡å¯¹æ•°æ®å¯¹è±¡ A åŠ äº† X é”ï¼Œå°±å¯ä»¥å¯¹ A è¿›è¡Œè¯»å–å’Œæ›´æ–°ã€‚åŠ é”æœŸé—´å…¶å®ƒäº‹åŠ¡ä¸èƒ½å¯¹ A åŠ ä»»ä½•é”ã€‚</li><li>ä¸€ä¸ªäº‹åŠ¡å¯¹æ•°æ®å¯¹è±¡ A åŠ äº† S é”ï¼Œå¯ä»¥å¯¹ A è¿›è¡Œè¯»å–æ“ä½œï¼Œä½†æ˜¯ä¸èƒ½è¿›è¡Œæ›´æ–°æ“ä½œã€‚åŠ é”æœŸé—´å…¶å®ƒäº‹åŠ¡èƒ½å¯¹ A åŠ  S é”ï¼Œä½†æ˜¯ä¸èƒ½åŠ  X é”ã€‚</li></ul><table><thead><tr><th>æ˜¯å¦é˜»å¡</th><th>è¯»é”</th><th>å†™é”</th></tr></thead><tbody><tr><td>è¯»é”</td><td>Y</td><td>N</td></tr><tr><td>å†™é”</td><td>N</td><td>N</td></tr></tbody></table><p>ä¹Ÿå°±æ˜¯ä¸Šé¢è¡Œçº§é”é‡Œé¢çš„è§„å®š</p><h4><span id="æ„å‘é”">æ„å‘é”</span></h4><p>ä½¿ç”¨æ„å‘é”ï¼ˆIntention Locksï¼‰å¯ä»¥æ›´å®¹æ˜“åœ°æ”¯æŒå¤šç²’åº¦å°é”ã€‚</p><p>åœ¨å­˜åœ¨è¡Œçº§é”å’Œè¡¨çº§é”çš„æƒ…å†µä¸‹ï¼Œäº‹åŠ¡ T æƒ³è¦å¯¹è¡¨ A åŠ  X é”ï¼Œå°±éœ€è¦å…ˆæ£€æµ‹æ˜¯å¦æœ‰å…¶å®ƒäº‹åŠ¡å¯¹è¡¨ A æˆ–è€…è¡¨ A ä¸­çš„ä»»æ„ä¸€è¡ŒåŠ äº†é”ï¼Œé‚£ä¹ˆå°±éœ€è¦å¯¹è¡¨ A çš„æ¯ä¸€è¡Œéƒ½æ£€æµ‹ä¸€æ¬¡ï¼Œè¿™æ˜¯éå¸¸è€—æ—¶çš„ã€‚</p><p>æ„å‘é”åœ¨åŸæ¥çš„ X/S é”ä¹‹ä¸Šå¼•å…¥äº† <strong>IX/ISï¼ŒIX/IS éƒ½æ˜¯è¡¨é”</strong>ï¼Œç”¨æ¥è¡¨ç¤ºä¸€ä¸ªäº‹åŠ¡æƒ³è¦åœ¨è¡¨ä¸­çš„æŸä¸ªæ•°æ®è¡Œä¸ŠåŠ  X é”æˆ– S é”ã€‚æœ‰ä»¥ä¸‹ä¸¤ä¸ªè§„å®šï¼š</p><ul><li>ä¸€ä¸ªäº‹åŠ¡åœ¨è·å¾—æŸä¸ªæ•°æ®è¡Œå¯¹è±¡çš„ S é”ä¹‹å‰ï¼Œå¿…é¡»å…ˆè·å¾—è¡¨çš„ IS é”æˆ–è€…æ›´å¼ºçš„é”ï¼›</li><li>ä¸€ä¸ªäº‹åŠ¡åœ¨è·å¾—æŸä¸ªæ•°æ®è¡Œå¯¹è±¡çš„ X é”ä¹‹å‰ï¼Œå¿…é¡»å…ˆè·å¾—è¡¨çš„ IX é”ã€‚</li></ul><p>é€šè¿‡å¼•å…¥æ„å‘é”ï¼Œäº‹åŠ¡ T æƒ³è¦å¯¹è¡¨ A åŠ  X é”ï¼Œåªéœ€è¦å…ˆæ£€æµ‹æ˜¯å¦æœ‰å…¶å®ƒäº‹åŠ¡å¯¹è¡¨ A åŠ äº† X/IX/S/IS é”ï¼Œå¦‚æœåŠ äº†å°±è¡¨ç¤ºæœ‰å…¶å®ƒäº‹åŠ¡æ­£åœ¨ä½¿ç”¨è¿™ä¸ªè¡¨æˆ–è€…è¡¨ä¸­æŸä¸€è¡Œçš„é”ï¼Œå› æ­¤äº‹åŠ¡ T åŠ  X é”å¤±è´¥ã€‚</p><h2><span id="4-å°é”åè®®">4. å°é”åè®®</span></h2><p>ä¸€å…±æœ‰ä¸‰å±‚å°é”åè®®</p><h3><span id="ä¸€çº§å°é”åè®®">ä¸€çº§å°é”åè®®</span></h3><p>äº‹åŠ¡ T è¦ä¿®æ”¹æ•°æ® A æ—¶å¿…é¡»åŠ  X é”ï¼Œç›´åˆ° T ç»“æŸæ‰é‡Šæ”¾é”ã€‚</p><table><thead><tr><th>T1</th><th>T2</th></tr></thead><tbody><tr><td>lock-x a</td><td></td></tr><tr><td>w a=10</td><td>lock-x a</td></tr><tr><td>commit</td><td></td></tr><tr><td>unlock-x a</td><td></td></tr><tr><td></td><td>get lock-x</td></tr><tr><td></td><td>w a=20</td></tr><tr><td></td><td>commit</td></tr><tr><td></td><td>unlock-x a</td></tr></tbody></table><p>å¯ä»¥çœ‹åˆ°ï¼Œå› ä¸ºæ¯æ¬¡åªæœ‰ä¸€ä¸ªäº‹åŠ¡å¯ä»¥è¿›è¡Œå†™æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬çš„äº‹åŠ¡ä¿®æ”¹å°±ä¸ä¼šè¢«è¦†ç›–</p><h3><span id="äºŒçº§å°é”åè®®">äºŒçº§å°é”åè®®</span></h3><p>åœ¨ä¸€çº§çš„åŸºç¡€ä¸Šï¼Œè¦æ±‚è¯»å–æ•°æ® A æ—¶å¿…é¡»åŠ  S é”ï¼Œè¯»å–å®Œé©¬ä¸Šé‡Šæ”¾ S é”ã€‚</p><table><thead><tr><th>T1</th><th>T2</th></tr></thead><tbody><tr><td>lock-x a</td><td></td></tr><tr><td>r a=10</td><td></td></tr><tr><td>w a=20</td><td>lock-s a</td></tr><tr><td>rollback</td><td></td></tr><tr><td>unlock-x a</td><td></td></tr><tr><td></td><td>get lock-s</td></tr><tr><td></td><td>r a=10</td></tr><tr><td></td><td>unlock-s  a</td></tr></tbody></table><p>å¯ä»¥è§£å†³è¯»è„æ•°æ®é—®é¢˜ï¼Œå› ä¸ºå¦‚æœä¸€ä¸ªäº‹åŠ¡åœ¨å¯¹æ•°æ® A è¿›è¡Œä¿®æ”¹ï¼Œæ ¹æ® 1 çº§å°é”åè®®ï¼Œä¼šåŠ  X é”ï¼Œé‚£ä¹ˆå°±ä¸èƒ½å†åŠ  S é”äº†ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šè¯»å…¥æ•°æ®,ç”¨çš„è¯»å†™é˜»å¡æ¥è§£å†³</p><h3><span id="ä¸‰çº§å°é”åè®®">ä¸‰çº§å°é”åè®®</span></h3><p>åœ¨äºŒçº§çš„åŸºç¡€ä¸Šï¼Œè¦æ±‚è¯»å–æ•°æ® A æ—¶å¿…é¡»åŠ  S é”ï¼Œç›´åˆ°äº‹åŠ¡ç»“æŸäº†æ‰èƒ½é‡Šæ”¾ S é”ã€‚</p><table><thead><tr><th>T1</th><th>T2</th></tr></thead><tbody><tr><td>lock-x a</td><td></td></tr><tr><td>r a=10</td><td></td></tr><tr><td>r a=10</td><td>lock-x a</td></tr><tr><td>rollback</td><td></td></tr><tr><td>unlock-x a</td><td></td></tr><tr><td></td><td>get lock-x</td></tr><tr><td></td><td>w a=20</td></tr><tr><td></td><td>commit</td></tr><tr><td></td><td>unlock-x a</td></tr></tbody></table><p>å¯ä»¥è§£å†³ä¸å¯é‡å¤è¯»çš„é—®é¢˜ï¼Œå› ä¸ºè¯» A æ—¶ï¼Œå…¶å®ƒäº‹åŠ¡ä¸èƒ½å¯¹ A åŠ  X é”ï¼Œä»è€Œé¿å…äº†åœ¨è¯»çš„æœŸé—´æ•°æ®å‘ç”Ÿæ”¹å˜ã€‚</p><h3><span id="ä¸¤æ®µé”åè®®">ä¸¤æ®µé”åè®®</span></h3><p>åŠ é”å’Œè§£é”åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µè¿›è¡Œã€‚</p><p>å¯ä¸²è¡ŒåŒ–è°ƒåº¦æ˜¯æŒ‡ï¼Œé€šè¿‡å¹¶å‘æ§åˆ¶ï¼Œä½¿å¾—å¹¶å‘æ‰§è¡Œçš„äº‹åŠ¡ç»“æœä¸æŸä¸ªä¸²è¡Œæ‰§è¡Œçš„äº‹åŠ¡ç»“æœç›¸åŒã€‚ä¸²è¡Œæ‰§è¡Œçš„äº‹åŠ¡äº’ä¸å¹²æ‰°ï¼Œä¸ä¼šå‡ºç°å¹¶å‘ä¸€è‡´æ€§é—®é¢˜ã€‚</p><p>äº‹åŠ¡éµå¾ªä¸¤æ®µé”åè®®æ˜¯ä¿è¯å¯ä¸²è¡ŒåŒ–è°ƒåº¦çš„å……åˆ†æ¡ä»¶ã€‚ä¾‹å¦‚ä»¥ä¸‹æ“ä½œæ»¡è¶³ä¸¤æ®µé”åè®®ï¼Œå®ƒæ˜¯å¯ä¸²è¡ŒåŒ–è°ƒåº¦ã€‚</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">lock-x</span><span class="hljs-params">(A)</span></span>..<span class="hljs-selector-class">.lock-s</span>(B)..<span class="hljs-selector-class">.lock-s</span>(C)..<span class="hljs-selector-class">.unlock</span>(A)..<span class="hljs-selector-class">.unlock</span>(C)..<span class="hljs-selector-class">.unlock</span>(B)<br></code></pre></td></tr></table></figure><p>ä½†ä¸æ˜¯å¿…è¦æ¡ä»¶ï¼Œä¾‹å¦‚ä»¥ä¸‹æ“ä½œä¸æ»¡è¶³ä¸¤æ®µé”åè®®ï¼Œä½†å®ƒè¿˜æ˜¯å¯ä¸²è¡ŒåŒ–è°ƒåº¦ã€‚</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">lock-x</span><span class="hljs-params">(A)</span></span>..<span class="hljs-selector-class">.unlock</span>(A)..<span class="hljs-selector-class">.lock-s</span>(B)..<span class="hljs-selector-class">.unlock</span>(B)..<span class="hljs-selector-class">.lock-s</span>(C)..<span class="hljs-selector-class">.unlock</span>(C)<br></code></pre></td></tr></table></figure><p>MySQL çš„ InnoDB å­˜å‚¨å¼•æ“é‡‡ç”¨ä¸¤æ®µé”åè®®ï¼Œä¼šæ ¹æ®éš”ç¦»çº§åˆ«åœ¨éœ€è¦çš„æ—¶å€™è‡ªåŠ¨åŠ é”ï¼Œå¹¶ä¸”æ‰€æœ‰çš„é”éƒ½æ˜¯åœ¨åŒä¸€æ—¶åˆ»è¢«é‡Šæ”¾ï¼Œè¿™è¢«ç§°ä¸ºéšå¼é”å®šã€‚</p><p>InnoDB ä¹Ÿå¯ä»¥ä½¿ç”¨ç‰¹å®šçš„è¯­å¥è¿›è¡Œæ˜¾ç¤ºé”å®šï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> ... LOCK <span class="hljs-keyword">In</span> SHARE MODE; #åŠ è¯»é”<br><span class="hljs-keyword">SELECT</span> ... <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;#åŠ æ’ä»–é”<br></code></pre></td></tr></table></figure><h2><span id="5éš”ç¦»çº§åˆ«">5.éš”ç¦»çº§åˆ«</span></h2><h3><span id="æœªæäº¤è¯»read-uncommitted">æœªæäº¤è¯»ï¼ˆREAD UNCOMMITTEDï¼‰</span></h3><p>äº‹åŠ¡ä¸­çš„ä¿®æ”¹ï¼Œå³ä½¿æ²¡æœ‰æäº¤ï¼Œå¯¹å…¶å®ƒäº‹åŠ¡ä¹Ÿæ˜¯å¯è§çš„ã€‚</p><h3><span id="æäº¤è¯»read-committed">æäº¤è¯»ï¼ˆREAD COMMITTEDï¼‰</span></h3><p>ä¸€ä¸ªäº‹åŠ¡åªèƒ½è¯»å–å·²ç»æäº¤çš„äº‹åŠ¡æ‰€åšçš„ä¿®æ”¹ã€‚æ¢å¥è¯è¯´ï¼Œä¸€ä¸ªäº‹åŠ¡æ‰€åšçš„ä¿®æ”¹åœ¨æäº¤ä¹‹å‰å¯¹å…¶å®ƒäº‹åŠ¡æ˜¯ä¸å¯è§çš„ã€‚</p><p>å› ä¸ºåœ¨ä¸€ä¸ªäº‹åŠ¡æäº¤å‰çš„æ•°æ®æ˜¯å¯¹å…¶ä»–äº‹åŠ¡ä¸å¯è§çš„ï¼Œæ‰€ä»¥åœ¨æ•°æ®æ²¡æœ‰ç¡®å®šå­˜å…¥æ•°æ®åº“å‰æ˜¯ä¸ä¼šè¢«å…¶ä»–äº‹åŠ¡çœ‹è§çš„ï¼Œå› æ­¤è§£å†³äº†æ•°æ®è¢«è¯»åˆ°æ˜¯ä¿®æ”¹åçš„å€¼ï¼Œä½†æ˜¯å¦ä¸€ä¸ªäº‹åŠ¡rollbackä¿®æ”¹ï¼Œå¯¼è‡´äº‹åŠ¡ä¸­è¯»å–åˆ°çš„æ•°æ®ä¸æ•°æ®åº“ä¸­çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚å³ä¸ºè§£å†³äº†è„è¯»é—®é¢˜ã€‚</p><h3><span id="å¯é‡å¤è¯»repeatable-read">å¯é‡å¤è¯»ï¼ˆREPEATABLE READï¼‰</span></h3><p>ä¿è¯åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®çš„ç»“æœæ˜¯ä¸€æ ·çš„ã€‚</p><h3><span id="å¯ä¸²è¡ŒåŒ–serializable">å¯ä¸²è¡ŒåŒ–ï¼ˆSERIALIZABLEï¼‰</span></h3><p>å¼ºåˆ¶äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œè¿™æ ·å¤šä¸ªäº‹åŠ¡äº’ä¸å¹²æ‰°ï¼Œä¸ä¼šå‡ºç°å¹¶å‘ä¸€è‡´æ€§é—®é¢˜ã€‚</p><p>è¯¥éš”ç¦»çº§åˆ«éœ€è¦åŠ é”å®ç°ï¼Œå› ä¸ºè¦ä½¿ç”¨åŠ é”æœºåˆ¶ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯ä¿è¯äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œã€‚</p><p><strong>éš”ç¦»çº§åˆ«èƒ½è§£å†³çš„å¹¶å‘ä¸€è‡´æ€§é—®é¢˜</strong></p><table><thead><tr><th></th><th>è„è¯»</th><th>ä¸å¯é‡å¤è¯»</th><th>å¹»å½±è¯»</th></tr></thead><tbody><tr><td>æœªæäº¤è¯»</td><td>Ã—</td><td>Ã—</td><td>Ã—</td></tr><tr><td>æäº¤è¯»</td><td>âˆš</td><td>Ã—</td><td>Ã—</td></tr><tr><td>å¯é‡å¤åº¦</td><td>âˆš</td><td>âˆš</td><td>Ã—</td></tr><tr><td>å¯ä¸²è¡ŒåŒ–</td><td>âˆš</td><td>âˆš</td><td>âˆš</td></tr></tbody></table><hr><h2><span id="6-mvcc">6. MVCC</span></h2><p>å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMulti-Version Concurrency Control, MVCCï¼‰æ˜¯ MySQL çš„ <strong>InnoDB</strong> å­˜å‚¨å¼•æ“å®ç°éš”ç¦»çº§åˆ«çš„ä¸€ç§å…·ä½“æ–¹å¼ï¼Œç”¨äºå®ç°æäº¤è¯»å’Œå¯é‡å¤è¯»è¿™ä¸¤ç§éš”ç¦»çº§åˆ«ã€‚è€Œæœªæäº¤è¯»éš”ç¦»çº§åˆ«æ€»æ˜¯è¯»å–æœ€æ–°çš„æ•°æ®è¡Œï¼Œè¦æ±‚å¾ˆä½ï¼Œæ— éœ€ä½¿ç”¨ MVCCã€‚å¯ä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«éœ€è¦å¯¹æ‰€æœ‰è¯»å–çš„è¡Œéƒ½åŠ é”ï¼Œå•çº¯ä½¿ç”¨ MVCC æ— æ³•å®ç°ã€‚</p><h3><span id="åŸºæœ¬æ€æƒ³">åŸºæœ¬æ€æƒ³</span></h3><p>åœ¨å°é”ä¸€èŠ‚ä¸­æåˆ°ï¼ŒåŠ é”èƒ½è§£å†³å¤šä¸ªäº‹åŠ¡åŒæ—¶æ‰§è¡Œæ—¶å‡ºç°çš„å¹¶å‘ä¸€è‡´æ€§é—®é¢˜ã€‚åœ¨å®é™…åœºæ™¯ä¸­è¯»æ“ä½œå¾€å¾€å¤šäºå†™æ“ä½œï¼Œå› æ­¤åˆå¼•å…¥äº†è¯»å†™é”æ¥é¿å…ä¸å¿…è¦çš„åŠ é”æ“ä½œï¼Œä¾‹å¦‚è¯»å’Œè¯»æ²¡æœ‰äº’æ–¥å…³ç³»ã€‚è¯»å†™é”ä¸­è¯»å’Œå†™æ“ä½œä»ç„¶æ˜¯äº’æ–¥çš„ï¼Œè€Œ MVCC åˆ©ç”¨äº†å¤šç‰ˆæœ¬çš„æ€æƒ³ï¼Œå†™æ“ä½œæ›´æ–°æœ€æ–°çš„ç‰ˆæœ¬å¿«ç…§ï¼Œè€Œè¯»æ“ä½œå»è¯»æ—§ç‰ˆæœ¬å¿«ç…§ï¼Œæ²¡æœ‰äº’æ–¥å…³ç³»ï¼Œè¿™ä¸€ç‚¹å’Œ <strong>CopyOnWriteè¯»å†™åˆ†ç¦»</strong> ç±»ä¼¼ã€‚</p><p>åœ¨ MVCC ä¸­äº‹åŠ¡çš„ä¿®æ”¹æ“ä½œï¼ˆDELETEã€INSERTã€UPDATEï¼‰ä¼šä¸ºæ•°æ®è¡Œæ–°å¢ä¸€ä¸ªç‰ˆæœ¬å¿«ç…§ã€‚</p><p>è„è¯»å’Œä¸å¯é‡å¤è¯»æœ€æ ¹æœ¬çš„åŸå› æ˜¯äº‹åŠ¡è¯»å–åˆ°å…¶å®ƒäº‹åŠ¡æœªæäº¤çš„ä¿®æ”¹ã€‚åœ¨äº‹åŠ¡è¿›è¡Œè¯»å–æ“ä½œæ—¶ï¼Œä¸ºäº†è§£å†³è„è¯»å’Œä¸å¯é‡å¤è¯»é—®é¢˜ï¼ŒMVCC è§„å®šåªèƒ½è¯»å–å·²ç»æäº¤çš„å¿«ç…§ã€‚å½“ç„¶ä¸€ä¸ªäº‹åŠ¡å¯ä»¥è¯»å–è‡ªèº«æœªæäº¤çš„å¿«ç…§ï¼Œè¿™ä¸ç®—æ˜¯è„è¯»ã€‚å› ä¸ºæ²¡æœ‰ä½¿ç”¨ <code>START TRANSACTION</code> å°†ä¸Šé¢çš„æ“ä½œå½“æˆä¸€ä¸ªäº‹åŠ¡æ¥æ‰§è¡Œï¼Œæ ¹æ® MySQL çš„ AUTOCOMMIT æœºåˆ¶ï¼Œæ¯ä¸ªæ“ä½œéƒ½ä¼šè¢«å½“æˆä¸€ä¸ªäº‹åŠ¡æ¥æ‰§è¡Œï¼Œæ‰€ä»¥ä¸Šé¢çš„æ“ä½œæ€»å…±æ¶‰åŠåˆ°ä¸‰ä¸ªäº‹åŠ¡ã€‚å¿«ç…§ä¸­é™¤äº†è®°å½•äº‹åŠ¡ç‰ˆæœ¬å· TRX_ID å’Œæ“ä½œä¹‹å¤–ï¼Œè¿˜è®°å½•äº†ä¸€ä¸ª bit çš„ DEL å­—æ®µï¼Œç”¨äºæ ‡è®°æ˜¯å¦è¢«åˆ é™¤ã€‚</p><h3><span id="undo-æ—¥å¿—">Undo æ—¥å¿—</span></h3><p>MVCC çš„å¤šç‰ˆæœ¬æŒ‡çš„æ˜¯å¤šä¸ªç‰ˆæœ¬çš„å¿«ç…§ï¼Œå¿«ç…§å­˜å‚¨åœ¨ Undo æ—¥å¿—ä¸­ï¼Œè¯¥æ—¥å¿—é€šè¿‡å›æ»šæŒ‡é’ˆ ROLL_PTR æŠŠä¸€ä¸ªæ•°æ®è¡Œçš„æ‰€æœ‰å¿«ç…§è¿æ¥èµ·æ¥ã€‚</p><img src="/posts/Mysql%E6%A0%B8%E5%BF%83%E6%A1%86%E6%9E%B6%E7%9F%A5%E8%AF%86/image-20250818233437899.png" class title="image-20250818233437899"><p>ä¾‹å¦‚åœ¨ MySQL åˆ›å»ºä¸€ä¸ªè¡¨ tï¼ŒåŒ…å«ä¸»é”® id å’Œä¸€ä¸ªå­—æ®µ xã€‚æˆ‘ä»¬å…ˆæ’å…¥ä¸€ä¸ªæ•°æ®è¡Œï¼Œç„¶åå¯¹è¯¥æ•°æ®è¡Œæ‰§è¡Œä¸¤æ¬¡æ›´æ–°æ“ä½œã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">INSERT INTO</span> t(id, x) <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, &quot;a&quot;);<br><span class="hljs-keyword">UPDATE</span> t <span class="hljs-keyword">SET</span> x<span class="hljs-operator">=</span>&quot;b&quot; <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<br><span class="hljs-keyword">UPDATE</span> t <span class="hljs-keyword">SET</span> x<span class="hljs-operator">=</span>&quot;c&quot; <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><p>å› ä¸ºæ²¡æœ‰ä½¿ç”¨ <code>START TRANSACTION</code> å°†ä¸Šé¢çš„æ“ä½œå½“æˆä¸€ä¸ªäº‹åŠ¡æ¥æ‰§è¡Œï¼Œæ ¹æ® MySQL çš„ AUTOCOMMIT æœºåˆ¶ï¼Œæ¯ä¸ªæ“ä½œéƒ½ä¼šè¢«å½“æˆä¸€ä¸ªäº‹åŠ¡æ¥æ‰§è¡Œï¼Œæ‰€ä»¥ä¸Šé¢çš„æ“ä½œæ€»å…±æ¶‰åŠåˆ°ä¸‰ä¸ªäº‹åŠ¡ã€‚å¿«ç…§ä¸­é™¤äº†è®°å½•äº‹åŠ¡ç‰ˆæœ¬å· TRX_ID å’Œæ“ä½œä¹‹å¤–ï¼Œè¿˜è®°å½•äº†ä¸€ä¸ª bit çš„ DEL å­—æ®µï¼Œç”¨äºæ ‡è®°æ˜¯å¦è¢«åˆ é™¤ã€‚</p><img src="/posts/Mysql%E6%A0%B8%E5%BF%83%E6%A1%86%E6%9E%B6%E7%9F%A5%E8%AF%86/image-20250818232321292.png" class title="image-20250818232321292"><p>INSERTã€UPDATEã€DELETE æ“ä½œä¼šåˆ›å»ºä¸€ä¸ªæ—¥å¿—ï¼Œå¹¶å°†äº‹åŠ¡ç‰ˆæœ¬å· TRX_ID å†™å…¥ã€‚DELETE å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ UPDATEï¼Œè¿˜ä¼šé¢å¤–å°† DEL å­—æ®µè®¾ç½®ä¸º 1ã€‚</p><h3><span id="readview">ReadView</span></h3><p>MVCC ç»´æŠ¤äº†ä¸€ä¸ª ReadView ç»“æ„ï¼Œä¸»è¦åŒ…å«äº†å½“å‰ç³»ç»Ÿæœªæäº¤çš„äº‹åŠ¡åˆ—è¡¨ TRX_IDs {TRX_ID_1, TRX_ID_2, â€¦}ï¼Œè¿˜æœ‰è¯¥åˆ—è¡¨çš„æœ€å°å€¼ TRX_ID_MIN å’Œ TRX_ID_MAXã€‚</p><img src="/posts/Mysql%E6%A0%B8%E5%BF%83%E6%A1%86%E6%9E%B6%E7%9F%A5%E8%AF%86/image-20250818232339301.png" class title="image-20250818232339301"><p>åœ¨è¿›è¡Œ SELECT æ“ä½œæ—¶ï¼Œæ ¹æ®æ•°æ®è¡Œå¿«ç…§çš„ TRX_ID ä¸ TRX_ID_MIN å’Œ TRX_ID_MAX ä¹‹é—´çš„å…³ç³»ï¼Œä»è€Œåˆ¤æ–­æ•°æ®è¡Œå¿«ç…§æ˜¯å¦å¯ä»¥ä½¿ç”¨ï¼š</p><ul><li>TRX_ID &lt; TRX_ID_MINï¼Œè¡¨ç¤ºè¯¥æ•°æ®è¡Œå¿«ç…§æ—¶åœ¨å½“å‰æ‰€æœ‰æœªæäº¤äº‹åŠ¡ä¹‹å‰è¿›è¡Œæ›´æ”¹çš„ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ã€‚</li><li>TRX_ID &gt; TRX_ID_MAXï¼Œè¡¨ç¤ºè¯¥æ•°æ®è¡Œå¿«ç…§æ˜¯åœ¨äº‹åŠ¡å¯åŠ¨ä¹‹åè¢«æ›´æ”¹çš„ï¼Œå› æ­¤ä¸å¯ä½¿ç”¨ã€‚</li><li>TRX_ID_MIN &lt;= TRX_ID &lt;= TRX_ID_MAXï¼Œéœ€è¦æ ¹æ®éš”ç¦»çº§åˆ«å†è¿›è¡Œåˆ¤æ–­ï¼š<ul><li>æäº¤è¯»ï¼š<strong>è¯¥éš”ç¦»ç•Œåˆ«ä¸‹æ¯ä¸€æ¬¡æŸ¥è¯¢éƒ½è¦è¿›è¡Œä¸€æ¬¡å¿«ç…§è¯»(readView)æ“ä½œ</strong>ï¼Œå¦‚æœ TRX_ID åœ¨ TRX_IDs åˆ—è¡¨ä¸­ï¼Œè¡¨ç¤ºè¯¥æ•°æ®è¡Œå¿«ç…§å¯¹åº”çš„äº‹åŠ¡è¿˜æœªæäº¤ï¼Œåˆ™è¯¥å¿«ç…§ä¸å¯ä½¿ç”¨ã€‚å¦åˆ™è¡¨ç¤ºå·²ç»æäº¤ï¼Œå¯ä»¥ä½¿ç”¨ã€‚</li><li>å¯é‡å¤è¯»ï¼š**è¯¥éš”ç¦»ç•Œåˆ«ä¸‹äº‹åŠ¡å¼€å§‹çš„æ—¶å€™è¿›è¡Œä¸€æ¬¡å¿«ç…§è¯»æ“ä½œ(readView)è€Œä¸”åªè¿›è¡Œè¿™ä¸€æ¬¡ï¼Œ**å¦‚æœ TRX_ID åœ¨ TRX_IDs åˆ—è¡¨ä¸­å°±ä¸èƒ½ä½¿ç”¨ã€‚å› ä¸ºå¦‚æœå¯ä»¥ä½¿ç”¨çš„è¯ï¼Œé‚£ä¹ˆå…¶å®ƒäº‹åŠ¡ä¹Ÿå¯ä»¥è¯»åˆ°è¿™ä¸ªæ•°æ®è¡Œå¿«ç…§å¹¶è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆå½“å‰äº‹åŠ¡å†å»è¯»è¿™ä¸ªæ•°æ®è¡Œå¾—åˆ°çš„å€¼å°±ä¼šå‘ç”Ÿæ”¹å˜ï¼Œä¹Ÿå°±æ˜¯å‡ºç°äº†ä¸å¯é‡å¤è¯»é—®é¢˜ã€‚</li></ul></li></ul><p><strong>åœ¨æ•°æ®è¡Œå¿«ç…§ä¸å¯ä½¿ç”¨çš„æƒ…å†µä¸‹ï¼Œéœ€è¦æ²¿ç€ Undo Log çš„å›æ»šæŒ‡é’ˆ ROLL_PTR æ‰¾åˆ°ä¸‹ä¸€ä¸ªå¿«ç…§ï¼Œå†è¿›è¡Œä¸Šé¢çš„åˆ¤æ–­ã€‚</strong></p><h2><span id="7-èŒƒå¼">7. èŒƒå¼</span></h2><h3><span id="å‡½æ•°ä¾èµ–">å‡½æ•°ä¾èµ–</span></h3><p>è®° A-&gt;B è¡¨ç¤º A å‡½æ•°å†³å®š Bï¼Œä¹Ÿå¯ä»¥è¯´ B å‡½æ•°ä¾èµ–äº Aã€‚</p><p>å¦‚æœ {A1ï¼ŒA2ï¼Œâ€¦ ï¼ŒAn} æ˜¯å…³ç³»çš„ä¸€ä¸ªæˆ–å¤šä¸ªå±æ€§çš„é›†åˆï¼Œè¯¥é›†åˆå‡½æ•°å†³å®šäº†å…³ç³»çš„å…¶å®ƒæ‰€æœ‰å±æ€§å¹¶ä¸”æ˜¯æœ€å°çš„ï¼Œé‚£ä¹ˆè¯¥é›†åˆå°±ç§°ä¸ºé”®ç ã€‚</p><p>å¯¹äº A-&gt;Bï¼Œå¦‚æœèƒ½æ‰¾åˆ° A çš„çœŸå­é›† Aâ€™ï¼Œä½¿å¾— Aâ€™-&gt; Bï¼Œé‚£ä¹ˆ A-&gt;B å°±æ˜¯éƒ¨åˆ†å‡½æ•°ä¾èµ–ï¼Œå¦åˆ™å°±æ˜¯å®Œå…¨å‡½æ•°ä¾èµ–ã€‚</p><p>å¯¹äº A-&gt;Bï¼ŒB-&gt;Cï¼Œåˆ™ A-&gt;C æ˜¯ä¸€ä¸ªä¼ é€’å‡½æ•°ä¾èµ–ã€‚</p><h3><span id="å¼‚å¸¸">å¼‚å¸¸</span></h3><p>ä»¥ä¸‹çš„å­¦ç”Ÿè¯¾ç¨‹å…³ç³»çš„å‡½æ•°ä¾èµ–ä¸º {Sno, Cname} -&gt; {Sname, Sdept, Mname, Grade}ï¼Œé”®ç ä¸º {Sno, Cname}ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç¡®å®šå­¦ç”Ÿå’Œè¯¾ç¨‹ä¹‹åï¼Œå°±èƒ½ç¡®å®šå…¶å®ƒä¿¡æ¯ã€‚</p><table><thead><tr><th>Sno</th><th>Sname</th><th>Sdept</th><th>Mname</th><th>Cname</th><th>Grade</th></tr></thead><tbody><tr><td>1</td><td>å­¦ç”Ÿ-1</td><td>å­¦é™¢-1</td><td>é™¢é•¿-1</td><td>è¯¾ç¨‹-1</td><td>90</td></tr><tr><td>2</td><td>å­¦ç”Ÿ-2</td><td>å­¦é™¢-2</td><td>é™¢é•¿-2</td><td>è¯¾ç¨‹-2</td><td>80</td></tr><tr><td>2</td><td>å­¦ç”Ÿ-2</td><td>å­¦é™¢-2</td><td>é™¢é•¿-2</td><td>è¯¾ç¨‹-1</td><td>100</td></tr><tr><td>3</td><td>å­¦ç”Ÿ-3</td><td>å­¦é™¢-2</td><td>é™¢é•¿-2</td><td>è¯¾ç¨‹-2</td><td>95</td></tr></tbody></table><p>ä¸ç¬¦åˆèŒƒå¼çš„å…³ç³»ï¼Œä¼šäº§ç”Ÿå¾ˆå¤šå¼‚å¸¸ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å››ç§å¼‚å¸¸ï¼š</p><ul><li>å†—ä½™æ•°æ®ï¼šä¾‹å¦‚ <code>å­¦ç”Ÿ-2</code> å‡ºç°äº†ä¸¤æ¬¡ã€‚</li><li>ä¿®æ”¹å¼‚å¸¸ï¼šä¿®æ”¹äº†ä¸€ä¸ªè®°å½•ä¸­çš„ä¿¡æ¯ï¼Œä½†æ˜¯å¦ä¸€ä¸ªè®°å½•ä¸­ç›¸åŒçš„ä¿¡æ¯å´æ²¡æœ‰è¢«ä¿®æ”¹ã€‚</li><li>åˆ é™¤å¼‚å¸¸ï¼šåˆ é™¤ä¸€ä¸ªä¿¡æ¯ï¼Œé‚£ä¹ˆä¹Ÿä¼šä¸¢å¤±å…¶å®ƒä¿¡æ¯ã€‚ä¾‹å¦‚åˆ é™¤äº† <code>è¯¾ç¨‹-1</code> éœ€è¦åˆ é™¤ç¬¬ä¸€è¡Œå’Œç¬¬ä¸‰è¡Œï¼Œé‚£ä¹ˆ <code>å­¦ç”Ÿ-1</code> çš„ä¿¡æ¯å°±ä¼šä¸¢å¤±ã€‚</li><li>æ’å…¥å¼‚å¸¸ï¼šä¾‹å¦‚æƒ³è¦æ’å…¥ä¸€ä¸ªå­¦ç”Ÿçš„ä¿¡æ¯ï¼Œå¦‚æœè¿™ä¸ªå­¦ç”Ÿè¿˜æ²¡é€‰è¯¾ï¼Œé‚£ä¹ˆå°±æ— æ³•æ’å…¥ã€‚</li></ul><h3><span id="èŒƒå¼">èŒƒå¼</span></h3><p>èŒƒå¼ç†è®ºæ˜¯ä¸ºäº†è§£å†³ä»¥ä¸Šæåˆ°å››ç§å¼‚å¸¸ã€‚</p><p>é«˜çº§åˆ«èŒƒå¼çš„ä¾èµ–äºä½çº§åˆ«çš„èŒƒå¼ï¼Œ1NF æ˜¯æœ€ä½çº§åˆ«çš„èŒƒå¼ã€‚</p><h4><span id="1-ç¬¬ä¸€èŒƒå¼-1nf">1. ç¬¬ä¸€èŒƒå¼ (1NF)</span></h4><p>å±æ€§ä¸å¯åˆ†ã€‚</p><h4><span id="2-ç¬¬äºŒèŒƒå¼-2nf">2. ç¬¬äºŒèŒƒå¼ (2NF)</span></h4><p>æ¯ä¸ªéä¸»å±æ€§å®Œå…¨å‡½æ•°ä¾èµ–äºé”®ç ã€‚</p><p>å¯ä»¥é€šè¿‡åˆ†è§£æ¥æ»¡è¶³ã€‚</p><p><strong>åˆ†è§£å‰</strong></p><table><thead><tr><th>Sno</th><th>Sname</th><th>Sdept</th><th>Mname</th><th>Cname</th><th>Grade</th></tr></thead><tbody><tr><td>1</td><td>å­¦ç”Ÿ-1</td><td>å­¦é™¢-1</td><td>é™¢é•¿-1</td><td>è¯¾ç¨‹-1</td><td>90</td></tr><tr><td>2</td><td>å­¦ç”Ÿ-2</td><td>å­¦é™¢-2</td><td>é™¢é•¿-2</td><td>è¯¾ç¨‹-2</td><td>80</td></tr><tr><td>2</td><td>å­¦ç”Ÿ-2</td><td>å­¦é™¢-2</td><td>é™¢é•¿-2</td><td>è¯¾ç¨‹-1</td><td>100</td></tr><tr><td>3</td><td>å­¦ç”Ÿ-3</td><td>å­¦é™¢-2</td><td>é™¢é•¿-2</td><td>è¯¾ç¨‹-2</td><td>95</td></tr></tbody></table><p>ä»¥ä¸Šå­¦ç”Ÿè¯¾ç¨‹å…³ç³»ä¸­ï¼Œ{Sno, Cname} ä¸ºé”®ç ï¼Œæœ‰å¦‚ä¸‹å‡½æ•°ä¾èµ–ï¼š</p><ul><li>Sno -&gt; Sname, Sdept</li><li>Sdept -&gt; Mname</li><li>Sno, Cname-&gt; Grade</li></ul><p>Grade å®Œå…¨å‡½æ•°ä¾èµ–äºé”®ç ï¼Œå®ƒæ²¡æœ‰ä»»ä½•å†—ä½™æ•°æ®ï¼Œæ¯ä¸ªå­¦ç”Ÿçš„æ¯é—¨è¯¾éƒ½æœ‰ç‰¹å®šçš„æˆç»©ã€‚</p><p>Sname, Sdept å’Œ Mname éƒ½éƒ¨åˆ†ä¾èµ–äºé”®ç ï¼Œå½“ä¸€ä¸ªå­¦ç”Ÿé€‰ä¿®äº†å¤šé—¨è¯¾æ—¶ï¼Œè¿™äº›æ•°æ®å°±ä¼šå‡ºç°å¤šæ¬¡ï¼Œé€ æˆå¤§é‡å†—ä½™æ•°æ®ã€‚</p><p><strong>åˆ†è§£å</strong></p><p>å…³ç³»-1</p><table><thead><tr><th>Sno</th><th>Sname</th><th>Sdept</th><th>Mname</th></tr></thead><tbody><tr><td>1</td><td>å­¦ç”Ÿ-1</td><td>å­¦é™¢-1</td><td>é™¢é•¿-1</td></tr><tr><td>2</td><td>å­¦ç”Ÿ-2</td><td>å­¦é™¢-2</td><td>é™¢é•¿-2</td></tr><tr><td>3</td><td>å­¦ç”Ÿ-3</td><td>å­¦é™¢-2</td><td>é™¢é•¿-2</td></tr></tbody></table><p>æœ‰ä»¥ä¸‹å‡½æ•°ä¾èµ–ï¼š</p><ul><li>Sno -&gt; Sname, Sdept</li><li>Sdept -&gt; Mname</li></ul><p>å…³ç³»-2</p><table><thead><tr><th>Sno</th><th>Cname</th><th>Grade</th></tr></thead><tbody><tr><td>1</td><td>è¯¾ç¨‹-1</td><td>90</td></tr><tr><td>2</td><td>è¯¾ç¨‹-2</td><td>80</td></tr><tr><td>2</td><td>è¯¾ç¨‹-1</td><td>100</td></tr><tr><td>3</td><td>è¯¾ç¨‹-2</td><td>95</td></tr></tbody></table><p>æœ‰ä»¥ä¸‹å‡½æ•°ä¾èµ–ï¼š</p><ul><li>Sno, Cname -&gt; Grade</li></ul><h4><span id="3-ç¬¬ä¸‰èŒƒå¼-3nf">3. ç¬¬ä¸‰èŒƒå¼ (3NF)</span></h4><p>éä¸»å±æ€§ä¸ä¼ é€’å‡½æ•°ä¾èµ–äºé”®ç ã€‚</p><p>ä¸Šé¢çš„ å…³ç³»-1 ä¸­å­˜åœ¨ä»¥ä¸‹ä¼ é€’å‡½æ•°ä¾èµ–ï¼š</p><ul><li>Sno -&gt; Sdept -&gt; Mname</li></ul><p>å¯ä»¥è¿›è¡Œä»¥ä¸‹åˆ†è§£ï¼š</p><p>å…³ç³»-11</p><table><thead><tr><th>Sno</th><th>Sname</th><th>Sdept</th></tr></thead><tbody><tr><td>1</td><td>å­¦ç”Ÿ-1</td><td>å­¦é™¢-1</td></tr><tr><td>2</td><td>å­¦ç”Ÿ-2</td><td>å­¦é™¢-2</td></tr><tr><td>3</td><td>å­¦ç”Ÿ-3</td><td>å­¦é™¢-2</td></tr></tbody></table><p>å…³ç³»-12</p><table><thead><tr><th>Sdept</th><th>Mname</th></tr></thead><tbody><tr><td>å­¦é™¢-1</td><td>é™¢é•¿-1</td></tr><tr><td>å­¦é™¢-2</td><td>é™¢é•¿-2</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;h1&gt;Mysqlæ ¸å¿ƒæ¡†æ¶&lt;/h1&gt;
&lt;p&gt;æœ¬æ–‡æ—¨åœ¨æ¢³ç†å’Œç†è§£ MySQL çš„ä¸€äº›æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼Œå¹¶ç»“åˆå¸¸è§é¢è¯•é¢˜è¿›è¡Œæ€è€ƒå’Œæ€»ç»“ã€‚è¿™äº›å†…å®¹ä¸»è¦æ¥æºäºæˆ‘çš„ä¸ªäººå­¦ä¹ ä¸ç†è§£ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="mysqlæ•™ç¨‹" scheme="https://garybyd.github.io/categories/mysql%E6%95%99%E7%A8%8B/"/>
    
    
    <category term="mysql" scheme="https://garybyd.github.io/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>redisæŒä¹…åŒ–å’Œæ•°æ®æ·˜æ±°æ–¹æ¡ˆ</title>
    <link href="https://garybyd.github.io/posts/redis%E6%8C%81%E4%B9%85%E5%8C%96/"/>
    <id>https://garybyd.github.io/posts/redis%E6%8C%81%E4%B9%85%E5%8C%96/</id>
    <published>2025-05-18T05:01:07.000Z</published>
    <updated>2025-05-18T05:26:36.790Z</updated>
    
    <content type="html"><![CDATA[<h1><span id="redisæŒä¹…åŒ–æ–¹æ¡ˆ">RedisæŒä¹…åŒ–æ–¹æ¡ˆ</span></h1><h2><span id="rdb">RDB</span></h2><p>RDBå…¨ç§°Redis Database Backup fileï¼ˆRedisæ•°æ®å¤‡ä»½æ–‡ä»¶ï¼‰ï¼Œä¹Ÿè¢«å«åšRedisæ•°æ®å¿«ç…§ã€‚ç®€å•æ¥è¯´å°±æ˜¯æŠŠå†…å­˜ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½è®°å½•åˆ°ç£ç›˜ä¸­ã€‚å½“Rediså®ä¾‹æ•…éšœé‡å¯åï¼Œä»ç£ç›˜è¯»å–å¿«ç…§æ–‡ä»¶ï¼Œæ¢å¤æ•°æ®</p><img src="/posts/redis%E6%8C%81%E4%B9%85%E5%8C%96/image-20250518130322881.png" class title="image-20250518130322881"><p>Rediså†…éƒ¨æœ‰è§¦å‘RDBçš„æœºåˆ¶ï¼Œå¯ä»¥åœ¨redis.confæ–‡ä»¶ä¸­æ‰¾åˆ°ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 900ç§’å†…ï¼Œå¦‚æœè‡³å°‘æœ‰1ä¸ªkeyè¢«ä¿®æ”¹ï¼Œåˆ™æ‰§è¡Œbgsave </span><br>save 900 1  <br>save 300 10  <br>save 60 10000 <br></code></pre></td></tr></table></figure><h3><span id="rdbçš„æ‰§è¡ŒåŸç†">RDBçš„æ‰§è¡ŒåŸç†</span></h3><p>bgsaveå¼€å§‹æ—¶ä¼šforkä¸»è¿›ç¨‹å¾—åˆ°å­è¿›ç¨‹ï¼Œå­è¿›ç¨‹å…±äº«ä¸»è¿›ç¨‹çš„å†…å­˜æ•°æ®ã€‚å®Œæˆforkåè¯»å–å†…å­˜æ•°æ®å¹¶å†™å…¥ RDB æ–‡ä»¶ã€‚forké‡‡ç”¨çš„æ˜¯copy-on-writeæŠ€æœ¯ï¼š</p><p>å½“ä¸»è¿›ç¨‹æ‰§è¡Œè¯»æ“ä½œæ—¶ï¼Œè®¿é—®å…±äº«å†…å­˜ï¼›</p><p>å½“ä¸»è¿›ç¨‹æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œåˆ™ä¼šæ‹·è´ä¸€ä»½æ•°æ®ï¼Œæ‰§è¡Œå†™æ“ä½œã€‚</p><img src="/posts/redis%E6%8C%81%E4%B9%85%E5%8C%96/image-20250518130416755.png" class title="image-20250518130416755"><table><thead><tr><th>ä¼˜ç‚¹</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td>âœ¨ å†…å­˜æ•ˆç‡é«˜</td><td>åªåœ¨å†™æ“ä½œæ—¶æ‹·è´æ•°æ®ï¼Œä¸ä¼šæ•´å—å¤åˆ¶ï¼Œå¤§å¤§èŠ‚çœå†…å­˜</td></tr><tr><td>âœ¨ æœåŠ¡ä¸ä¸­æ–­</td><td>ä¸»è¿›ç¨‹æ­£å¸¸æœåŠ¡ï¼ŒRDB å¿«ç…§å¼‚æ­¥ç”Ÿæˆ</td></tr><tr><td>âœ¨ å¿«ç…§æ€§èƒ½å¥½</td><td>å­è¿›ç¨‹å†™ç£ç›˜ï¼Œé¿å…ä¸ä¸»çº¿ç¨‹äº‰èµ„æº</td></tr><tr><td>âœ¨ å¿«ç…§æ•°æ®ä¸€è‡´</td><td>åŸºäº fork æ—¶åˆ»çš„æ•°æ®ï¼Œå…·æœ‰ä¸€è‡´æ€§è§†å›¾</td></tr></tbody></table><p><strong>å¦‚æœç›´æ¥ç”¨saveå‘½ä»¤ä¼šé˜»å¡Redisä¸»çº¿ç¨‹ï¼Œæ€§èƒ½ä¸å¤ªå¥½</strong></p><h2><span id="aof">AOF</span></h2><p>AOFå…¨ç§°ä¸ºAppend Only Fileï¼ˆè¿½åŠ æ–‡ä»¶ï¼‰ã€‚Rediså¤„ç†çš„æ¯ä¸€ä¸ªå†™å‘½ä»¤éƒ½ä¼šè®°å½•åœ¨AOFæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åšæ˜¯å‘½ä»¤æ—¥å¿—æ–‡ä»¶ã€‚</p><img src="/posts/redis%E6%8C%81%E4%B9%85%E5%8C%96/image-20250518130555078.png" class title="image-20250518130555078"><p>AOFæ–‡ä»¶ä¼šè®°å½•æŒ‡ä»¤</p><h3><span id="aofçš„é…ç½®">AOFçš„é…ç½®</span></h3><p>AOFé»˜è®¤æ˜¯å…³é—­çš„ï¼Œéœ€è¦ä¿®æ”¹redis.confé…ç½®æ–‡ä»¶æ¥å¼€å¯AOFï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># æ˜¯å¦å¼€å¯AOFåŠŸèƒ½ï¼Œé»˜è®¤æ˜¯no</span><br>appendonly yes<br><span class="hljs-comment"># AOFæ–‡ä»¶çš„åç§°</span><br>appendfilename &quot;appendonly.aof&quot;<br></code></pre></td></tr></table></figure><p>AOFçš„å‘½ä»¤è®°å½•çš„é¢‘ç‡ä¹Ÿå¯ä»¥é€šè¿‡redis.confæ–‡ä»¶æ¥é…ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># è¡¨ç¤ºæ¯æ‰§è¡Œä¸€æ¬¡å†™å‘½ä»¤ï¼Œç«‹å³è®°å½•åˆ°AOFæ–‡ä»¶</span><br>appendfsync always <br><span class="hljs-comment"># å†™å‘½ä»¤æ‰§è¡Œå®Œå…ˆæ”¾å…¥AOFç¼“å†²åŒºï¼Œç„¶åè¡¨ç¤ºæ¯éš”1ç§’å°†ç¼“å†²åŒºæ•°æ®å†™åˆ°AOFæ–‡ä»¶ï¼Œæ˜¯é»˜è®¤æ–¹æ¡ˆ</span><br>appendfsync everysec <br><span class="hljs-comment"># å†™å‘½ä»¤æ‰§è¡Œå®Œå…ˆæ”¾å…¥AOFç¼“å†²åŒºï¼Œç”±æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶å°†ç¼“å†²åŒºå†…å®¹å†™å›ç£ç›˜</span><br>appendfsync no<br></code></pre></td></tr></table></figure><table><thead><tr><th><strong>é…ç½®é¡¹</strong></th><th><strong>åˆ·ç›˜æ—¶æœº</strong></th><th><strong>ä¼˜ç‚¹</strong></th><th><strong>ç¼ºç‚¹</strong></th></tr></thead><tbody><tr><td>Always</td><td>åŒæ­¥åˆ·ç›˜</td><td>å¯é æ€§é«˜ï¼Œå‡ ä¹ä¸ä¸¢æ•°æ®</td><td>æ€§èƒ½å½±å“å¤§</td></tr><tr><td>everysec</td><td>æ¯ç§’åˆ·ç›˜</td><td>æ€§èƒ½é€‚ä¸­</td><td>æœ€å¤šä¸¢å¤±1ç§’æ•°æ®</td></tr><tr><td>no</td><td>æ“ä½œç³»ç»Ÿæ§åˆ¶</td><td>æ€§èƒ½æœ€å¥½</td><td>å¯é æ€§è¾ƒå·®ï¼Œå¯èƒ½ä¸¢å¤±å¤§é‡æ•°æ®</td></tr></tbody></table><p>å› ä¸ºæ˜¯è®°å½•å‘½ä»¤ï¼ŒAOFæ–‡ä»¶ä¼šæ¯”RDBæ–‡ä»¶å¤§çš„å¤šã€‚è€Œä¸”AOFä¼šè®°å½•å¯¹åŒä¸€ä¸ªkeyçš„å¤šæ¬¡å†™æ“ä½œï¼Œä½†åªæœ‰æœ€åä¸€æ¬¡å†™æ“ä½œæ‰æœ‰æ„ä¹‰ã€‚é€šè¿‡æ‰§è¡Œbgrewriteaofå‘½ä»¤ï¼Œå¯ä»¥è®©AOFæ–‡ä»¶æ‰§è¡Œé‡å†™åŠŸèƒ½ï¼Œç”¨æœ€å°‘çš„å‘½ä»¤è¾¾åˆ°ç›¸åŒæ•ˆæœã€‚(å¹¶ä¸”æ–‡ä»¶ä¼šè¿›è¡Œå‹ç¼©ä¹±ç )</p><p>Redisä¹Ÿä¼šåœ¨è§¦å‘é˜ˆå€¼æ—¶è‡ªåŠ¨å»é‡å†™AOFæ–‡ä»¶ã€‚é˜ˆå€¼ä¹Ÿå¯ä»¥åœ¨redis.confä¸­é…ç½®ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># AOFæ–‡ä»¶æ¯”ä¸Šæ¬¡æ–‡ä»¶ å¢é•¿è¶…è¿‡å¤šå°‘ç™¾åˆ†æ¯”åˆ™è§¦å‘é‡å†™</span><br>auto-aof-rewrite-percentage 100<br><span class="hljs-comment"># AOFæ–‡ä»¶ä½“ç§¯æœ€å°å¤šå¤§ä»¥ä¸Šæ‰è§¦å‘é‡å†™</span><br>auto-aof-rewrite-min-size 64mb <br></code></pre></td></tr></table></figure><h2><span id="ä¸¤ç§æ–¹å¼çš„æ¯”è¾ƒ">ä¸¤ç§æ–¹å¼çš„æ¯”è¾ƒ</span></h2><table><thead><tr><th></th><th><strong>RDB</strong></th><th><strong>AOF</strong></th></tr></thead><tbody><tr><td>æŒä¹…åŒ–æ–¹å¼</td><td>å®šæ—¶å¯¹æ•´ä¸ªå†…å­˜åšå¿«ç…§</td><td>è®°å½•æ¯ä¸€æ¬¡æ‰§è¡Œçš„å‘½ä»¤</td></tr><tr><td>æ•°æ®å®Œæ•´æ€§</td><td>ä¸å®Œæ•´ï¼Œä¸¤æ¬¡å¤‡ä»½ä¹‹é—´ä¼šä¸¢å¤±</td><td>ç›¸å¯¹å®Œæ•´ï¼Œå–å†³äºåˆ·ç›˜ç­–ç•¥</td></tr><tr><td>æ–‡ä»¶å¤§å°</td><td>ä¼šæœ‰å‹ç¼©ï¼Œæ–‡ä»¶ä½“ç§¯å°</td><td>è®°å½•å‘½ä»¤ï¼Œæ–‡ä»¶ä½“ç§¯å¾ˆå¤§</td></tr><tr><td>å®•æœºæ¢å¤é€Ÿåº¦</td><td>å¾ˆå¿«</td><td>æ…¢</td></tr><tr><td>æ•°æ®æ¢å¤ä¼˜å…ˆçº§</td><td>ä½ï¼Œå› ä¸ºæ•°æ®å®Œæ•´æ€§ä¸å¦‚AOF</td><td>é«˜ï¼Œå› ä¸ºæ•°æ®å®Œæ•´æ€§æ›´é«˜</td></tr><tr><td>ç³»ç»Ÿèµ„æºå ç”¨</td><td>é«˜ï¼Œå¤§é‡CPUå’Œå†…å­˜æ¶ˆè€—</td><td>ä½ï¼Œä¸»è¦æ˜¯ç£ç›˜IOèµ„æºä½†AOFé‡å†™æ—¶ä¼šå ç”¨å¤§é‡CPUå’Œå†…å­˜èµ„æº</td></tr><tr><td>ä½¿ç”¨åœºæ™¯</td><td>å¯ä»¥å®¹å¿æ•°åˆ†é’Ÿçš„æ•°æ®ä¸¢å¤±ï¼Œè¿½æ±‚æ›´å¿«çš„å¯åŠ¨é€Ÿåº¦</td><td>å¯¹æ•°æ®å®‰å…¨æ€§è¦æ±‚è¾ƒé«˜å¸¸è§</td></tr></tbody></table><h1><span id="æ•°æ®æ·˜æ±°æ–¹æ¡ˆ">æ•°æ®æ·˜æ±°æ–¹æ¡ˆ</span></h1><h2><span id="æƒ°æ€§åˆ é™¤">æƒ°æ€§åˆ é™¤</span></h2><p>æƒ°æ€§åˆ é™¤ï¼šè®¾ç½®è¯¥keyè¿‡æœŸæ—¶é—´åï¼Œæˆ‘ä»¬ä¸å»ç®¡å®ƒï¼Œå½“éœ€è¦è¯¥keyæ—¶ï¼Œæˆ‘ä»¬åœ¨æ£€æŸ¥å…¶æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸï¼Œæˆ‘ä»¬å°±åˆ æ‰å®ƒï¼Œåä¹‹è¿”å›è¯¥key</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">set</span> name zhangsan  <br>get name   //å‘ç°nameè¿‡æœŸäº†ï¼Œç›´æ¥åˆ é™¤key<br></code></pre></td></tr></table></figure><p>ä¼˜ç‚¹ ï¼šå¯¹CPUå‹å¥½ï¼Œåªä¼šåœ¨ä½¿ç”¨è¯¥keyæ—¶æ‰ä¼šè¿›è¡Œè¿‡æœŸæ£€æŸ¥ï¼Œå¯¹äºå¾ˆå¤šç”¨ä¸åˆ°çš„keyä¸ç”¨æµªè´¹æ—¶é—´è¿›è¡Œè¿‡æœŸæ£€æŸ¥</p><p>ç¼ºç‚¹ ï¼šå¯¹å†…å­˜ä¸å‹å¥½ï¼Œå¦‚æœä¸€ä¸ªkeyå·²ç»è¿‡æœŸï¼Œä½†æ˜¯ä¸€ç›´æ²¡æœ‰ä½¿ç”¨ï¼Œé‚£ä¹ˆè¯¥keyå°±ä¼šä¸€ç›´å­˜åœ¨å†…å­˜ä¸­ï¼Œå†…å­˜æ°¸è¿œä¸ä¼šé‡Šæ”¾</p><h2><span id="å®šæœŸåˆ é™¤">å®šæœŸåˆ é™¤</span></h2><p>å®šæœŸåˆ é™¤ï¼šæ¯éš”ä¸€æ®µæ—¶é—´ï¼Œæˆ‘ä»¬å°±å¯¹ä¸€äº›keyè¿›è¡Œæ£€æŸ¥ï¼Œåˆ é™¤é‡Œé¢è¿‡æœŸçš„key(ä»ä¸€å®šæ•°é‡çš„æ•°æ®åº“ä¸­å–å‡ºä¸€å®šæ•°é‡çš„éšæœºkeyè¿›è¡Œæ£€æŸ¥ï¼Œå¹¶åˆ é™¤å…¶ä¸­çš„è¿‡æœŸkey)ã€‚</p><p><strong>å®šæœŸæ¸…ç†æœ‰ä¸¤ç§æ¨¡å¼ï¼š</strong></p><p>SLOWæ¨¡å¼æ˜¯å®šæ—¶ä»»åŠ¡ï¼Œæ‰§è¡Œé¢‘ç‡é»˜è®¤ä¸º10hzï¼Œæ¯æ¬¡ä¸è¶…è¿‡25msï¼Œä»¥é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶redis.conf çš„hz é€‰é¡¹æ¥è°ƒæ•´è¿™ä¸ªæ¬¡æ•°</p><p>FASTæ¨¡å¼æ‰§è¡Œé¢‘ç‡ä¸å›ºå®šï¼Œä½†ä¸¤æ¬¡é—´éš”ä¸ä½äº2msï¼Œæ¯æ¬¡è€—æ—¶ä¸è¶…è¿‡1ms</p><p><strong>ä¼˜ç‚¹</strong>ï¼šå¯ä»¥é€šè¿‡é™åˆ¶åˆ é™¤æ“ä½œæ‰§è¡Œçš„æ—¶é•¿å’Œé¢‘ç‡æ¥å‡å°‘åˆ é™¤æ“ä½œå¯¹ CPU çš„å½±å“ã€‚å¦å¤–å®šæœŸåˆ é™¤ï¼Œä¹Ÿèƒ½æœ‰æ•ˆé‡Šæ”¾è¿‡æœŸé”®å ç”¨çš„å†…å­˜ã€‚</p><p><strong>ç¼ºç‚¹</strong>ï¼šéš¾ä»¥ç¡®å®šåˆ é™¤æ“ä½œæ‰§è¡Œçš„æ—¶é•¿å’Œé¢‘ç‡ã€‚</p><p><strong>Redisçš„è¿‡æœŸåˆ é™¤ç­–ç•¥ï¼šæƒ°æ€§åˆ é™¤ + å®šæœŸåˆ é™¤ä¸¤ç§ç­–ç•¥è¿›è¡Œé…åˆä½¿ç”¨</strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;&lt;span id=&quot;redisæŒä¹…åŒ–æ–¹æ¡ˆ&quot;&gt;RedisæŒä¹…åŒ–æ–¹æ¡ˆ&lt;/span&gt;&lt;/h1&gt;
&lt;h2&gt;&lt;span id=&quot;rdb&quot;&gt;RDB&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;RDBå…¨ç§°Redis Database Backup fileï¼ˆRedisæ•°æ®å¤‡ä»½æ–‡ä»¶ï¼‰ï¼Œä¹Ÿè¢«å«åšRedi</summary>
      
    
    
    
    <category term="redisçš„é—®é¢˜æ–¹æ¡ˆ" scheme="https://garybyd.github.io/categories/redis%E7%9A%84%E9%97%AE%E9%A2%98%E6%96%B9%E6%A1%88/"/>
    
    
    <category term="redis" scheme="https://garybyd.github.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>redisè¯»å†™ä¸€è‡´é—®é¢˜</title>
    <link href="https://garybyd.github.io/posts/redis%E8%AF%BB%E5%86%99%E4%B8%80%E8%87%B4%E9%97%AE%E9%A2%98/"/>
    <id>https://garybyd.github.io/posts/redis%E8%AF%BB%E5%86%99%E4%B8%80%E8%87%B4%E9%97%AE%E9%A2%98/</id>
    <published>2025-05-18T03:11:31.000Z</published>
    <updated>2025-05-18T03:44:11.011Z</updated>
    
    <content type="html"><![CDATA[<h1><span id="redisè¯»å†™ä¸€è‡´é—®é¢˜">Redisè¯»å†™ä¸€è‡´é—®é¢˜</span></h1><p><strong>æ¡ä»¶:</strong></p><p>æ•°æ®åº“æ­¤æ—¶çš„æ•°æ®ä¸º10,redisæ­¤æ—¶çš„æ•°æ®ä¹Ÿä¸º10</p><p><strong>ä¸šåŠ¡æµç¨‹:</strong></p><p>æ“ä½œæ•°æ®åº“ä½¿å¾—æ•°æ®åº“çš„æ•°æ®ä¸º20ï¼Œåˆ é™¤redisé‡Œé¢çš„æ•°æ®ä¿è¯è¯»å†™ä¸€è‡´</p><h2><span id="å…ˆåˆ ç¼“å­˜å†æ“ä½œæ•°æ®åº“">å…ˆåˆ ç¼“å­˜ï¼Œå†æ“ä½œæ•°æ®åº“</span></h2><p>å‡ºç°è¯»å†™ä¸ä¸€è‡´æƒ…å†µ:</p><img src="/posts/redis%E8%AF%BB%E5%86%99%E4%B8%80%E8%87%B4%E9%97%AE%E9%A2%98/image-20250518111417673.png" class title="image-20250518111417673"><table><thead><tr><th>çº¿ç¨‹1(ä¸šåŠ¡)</th><th>çº¿ç¨‹2(å¹¶å‘çº¿ç¨‹)</th></tr></thead><tbody><tr><td>åˆ é™¤ç¼“å­˜</td><td></td></tr><tr><td></td><td>æŸ¥è¯¢ç¼“å­˜ï¼Œæ²¡æœ‰å‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“(æ•°æ®åº“æŸ¥åˆ°ä¸º10ï¼Œä¸‹ä¸€æ­¥å°†10å†™å…¥redis)</td></tr><tr><td></td><td>å°†10å†™å…¥ç¼“å­˜</td></tr><tr><td>æ›´æ–°æ•°æ®åº“ï¼Œå°†æ•°æ®åº“ä¸­çš„æ•°æ®æ”¹ä¸º20</td><td></td></tr></tbody></table><p>æœ€ç»ˆæƒ…å†µ</p><table><thead><tr><th>redisé‡Œé¢çš„æ•°æ®</th><th>æ•°æ®åº“é‡Œé¢çš„æ•°æ®</th></tr></thead><tbody><tr><td>10</td><td>20</td></tr></tbody></table><p>å‡ºç°æ•°æ®ä¸ä¸€è‡´æƒ…å†µ</p><h2><span id="å…ˆæ“ä½œæ•°æ®åº“å†åˆ é™¤ç¼“å­˜">å…ˆæ“ä½œæ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜</span></h2><img src="/posts/redis%E8%AF%BB%E5%86%99%E4%B8%80%E8%87%B4%E9%97%AE%E9%A2%98/image-20250518111907366.png" class title="image-20250518111907366"><table><thead><tr><th>çº¿ç¨‹1(å¹¶å‘çº¿ç¨‹)</th><th>çº¿ç¨‹2(ä¸šåŠ¡çº¿ç¨‹)</th></tr></thead><tbody><tr><td>æŸ¥è¯¢ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“(ä¸‹ä¸€æ­¥:å°†ç¼“å­˜æ›´æ–°ä¸º10)</td><td></td></tr><tr><td></td><td>æ›´æ–°æ•°æ®åº“ v=20</td></tr><tr><td></td><td>åˆ é™¤ç¼“å­˜</td></tr><tr><td>å†™å…¥ç¼“å­˜æ•°æ®10</td><td></td></tr></tbody></table><p>æœ€ç»ˆæƒ…å†µ:</p><table><thead><tr><th>redisæ•°æ®</th><th>æ•°æ®åº“æ•°æ®</th></tr></thead><tbody><tr><td>10</td><td>20</td></tr></tbody></table><h2><span id="ä¸¤ä¸ªæ–¹æ³•é€‰æ‹©åŸåˆ™">ä¸¤ä¸ªæ–¹æ³•é€‰æ‹©åŸåˆ™</span></h2><table><thead><tr><th>é€‚ç”¨ç­–ç•¥</th><th>å…¸å‹åœºæ™¯</th><th>æ˜¯å¦æ¨èä½¿ç”¨å»¶è¿ŸåŒåˆ </th></tr></thead><tbody><tr><td>å…ˆåˆ ç¼“å­˜ â†’ åæ›´æ–°æ•°æ®åº“</td><td>é«˜ä¸€è‡´æ€§ä¸šåŠ¡ï¼ˆä½™é¢ã€åº“å­˜ï¼‰</td><td>âœ… ä¸€å®šè¦å»¶è¿ŸåŒåˆ ï¼</td></tr><tr><td>å…ˆæ›´æ–°æ•°æ®åº“ â†’ ååˆ ç¼“å­˜</td><td>ä½ä¸€è‡´æ€§ä¸šåŠ¡ï¼ˆèµ„æ–™ã€æ–‡ç« å†…å®¹ï¼‰</td><td>âŒ å¯ä»¥ä¸ç”¨å»¶è¿ŸåŒåˆ </td></tr></tbody></table><h1><span id="è§£å†³æ–¹æ¡ˆåŒå†™ä¸€è‡´æ€§">è§£å†³æ–¹æ¡ˆ:åŒå†™ä¸€è‡´æ€§</span></h1><p>è¯»æ“ä½œæ²¡å•¥é—®é¢˜æŒ‰ç…§è€æµç¨‹</p><img src="/posts/redis%E8%AF%BB%E5%86%99%E4%B8%80%E8%87%B4%E9%97%AE%E9%A2%98/image-20250518112326510.png" class title="image-20250518112326510"><h2><span id="å»¶æ—¶åŒåˆ ">å»¶æ—¶åŒåˆ </span></h2><img src="/posts/redis%E8%AF%BB%E5%86%99%E4%B8%80%E8%87%B4%E9%97%AE%E9%A2%98/image-20250518112428502.png" class title="image-20250518112428502"><table><thead><tr><th>é—®é¢˜</th><th>ç­”æ¡ˆ</th></tr></thead><tbody><tr><td>å…ˆåˆ ç¼“å­˜è¿˜æ˜¯å…ˆæ”¹æ•°æ®åº“ï¼Ÿ</td><td><strong>å…ˆåˆ ç¼“å­˜ï¼</strong> é¿å…å¹¶å‘å†™å…¥æ—§å€¼</td></tr><tr><td>ä¸ºä»€ä¹ˆåˆ ä¸¤æ¬¡ï¼Ÿ</td><td>é˜²æ­¢â€œæ”¹åº“ä¹‹åï¼Œåˆæœ‰äººå†™äº†æ—§å€¼åˆ°ç¼“å­˜â€</td></tr><tr><td>ä¸ºä»€ä¹ˆè¦å»¶è¿Ÿåˆ ï¼Ÿ</td><td>ç»™å¹¶å‘çº¿ç¨‹ä¸€ä¸ªâ€œå†™å…¥è„ç¼“å­˜â€çš„æœºä¼šï¼Œç„¶åå†æ¸…ç†æ‰å®ƒ</td></tr></tbody></table><p>ç¼ºç‚¹:</p><table><thead><tr><th>é—®é¢˜ç‚¹</th><th>å»¶è¿ŸåŒåˆ è§£å†³å¾—äº†ä¹ˆï¼Ÿ</th><th>æ¨èæ”¹è¿›æ–¹å¼</th></tr></thead><tbody><tr><td>å¹¶å‘çª—å£å†™å…¥è„ç¼“å­˜</td><td>âŒ åªèƒ½åˆ æœ€åä¸€ä¸ª</td><td>åˆ†å¸ƒå¼é” + åŒåˆ  / MQ</td></tr><tr><td>å»¶è¿Ÿæ—¶é—´éš¾æ§åˆ¶</td><td>âŒ ä¸å¯é¢„æµ‹</td><td>MQ æˆ– Canal æœºåˆ¶æ›´ç²¾å‡†</td></tr><tr><td>å¼‚æ­¥åˆ é™¤å¤±è´¥é£é™©</td><td>âŒ ä¼šä¸¢å¤±åˆ é™¤</td><td>ä½¿ç”¨å¯é ä»»åŠ¡é˜Ÿåˆ— / Redis æŒä¹…åŒ–</td></tr><tr><td>æ“ä½œå¤æ‚ã€ä»£ç ç»´æŠ¤å›°éš¾</td><td>âŒ å®¹æ˜“é—æ¼ key</td><td>å°è£…ä¸­é—´ä»¶ã€ä½¿ç”¨ AOPç»Ÿä¸€å¤„ç†</td></tr></tbody></table><h2><span id="ç»™ä»–åŠ é”">ç»™ä»–åŠ é”</span></h2><h3><span id="è¯»å†™éƒ½åŠ é”">è¯»å†™éƒ½åŠ é”</span></h3><img src="/posts/redis%E8%AF%BB%E5%86%99%E4%B8%80%E8%87%B4%E9%97%AE%E9%A2%98/image-20250518113305286.png" class title="image-20250518113305286"><p>å¦‚å›¾ï¼Œç¨‹åºè¿è¡Œä¸²è¡ŒåŒ–ï¼Œæ€§èƒ½ä½</p><p><strong>å¼•å…¥å…±äº«é”å’Œæ’ä»–é”æœºåˆ¶</strong></p><p><strong>å…±äº«é”</strong>ï¼šè¯»é”readLockï¼ŒåŠ é”ä¹‹åï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥å…±äº«è¯»æ“ä½œ</p><p><strong>æ’ä»–é”</strong>ï¼šç‹¬å é”writeLockä¹Ÿå«ï¼ŒåŠ é”ä¹‹åï¼Œé˜»å¡å…¶ä»–çº¿ç¨‹è¯»å†™æ“ä½œ</p><img src="/posts/redis%E8%AF%BB%E5%86%99%E4%B8%80%E8%87%B4%E9%97%AE%E9%A2%98/image-20250518113420970.png" class title="image-20250518113420970"><p>ä»£ç Demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.redisson.api.RReadWriteLock;<br><span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;<br><span class="hljs-keyword">import</span> org.redisson.api.RLock;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedissonClient redissonClient;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedisService redisService;     <span class="hljs-comment">// ä½ å°è£…çš„ Redis å·¥å…·ç±»</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserRepository userRepository; <span class="hljs-comment">// ä½ æ“ä½œæ•°æ®åº“çš„ç±»</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserService</span><span class="hljs-params">(RedissonClient redissonClient, RedisService redisService, UserRepository userRepository)</span> &#123;<br>        <span class="hljs-built_in">this</span>.redissonClient = redissonClient;<br>        <span class="hljs-built_in">this</span>.redisService = redisService;<br>        <span class="hljs-built_in">this</span>.userRepository = userRepository;<br>    &#125;<br><br>    <span class="hljs-comment">// è¯»æ“ä½œï¼šåŠ â€œè¯»é”â€</span><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long userId)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;user:&quot;</span> + userId;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lock:user:&quot;</span> + userId;<br><br>        <span class="hljs-type">RReadWriteLock</span> <span class="hljs-variable">rwLock</span> <span class="hljs-operator">=</span> redissonClient.getReadWriteLock(lockKey);<br>        <span class="hljs-type">RLock</span> <span class="hljs-variable">readLock</span> <span class="hljs-operator">=</span> rwLock.readLock();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            readLock.lock(<span class="hljs-number">5</span>, TimeUnit.SECONDS); <span class="hljs-comment">// åŠ è¯»é”ï¼Œé˜²æ­¢åŒæ—¶å†™å…¥</span><br>            <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> redisService.get(key);  <span class="hljs-comment">// å…ˆæŸ¥ç¼“å­˜</span><br>            <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> user;<br>            &#125;<br><br>            <span class="hljs-comment">// ç¼“å­˜æœªå‘½ä¸­ â†’ æŸ¥æ•°æ®åº“å¹¶å›å†™ç¼“å­˜</span><br>            user = userRepository.findById(userId);<br>            <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) &#123;<br>                redisService.set(key, user, <span class="hljs-number">10</span>, TimeUnit.MINUTES);<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> user;<br><br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            readLock.unlock(); <span class="hljs-comment">// é‡Šæ”¾è¯»é”</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// å†™æ“ä½œï¼šåŠ â€œå†™é”â€</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> user.getId();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;user:&quot;</span> + userId;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lock:user:&quot;</span> + userId;<br><br>        <span class="hljs-type">RReadWriteLock</span> <span class="hljs-variable">rwLock</span> <span class="hljs-operator">=</span> redissonClient.getReadWriteLock(lockKey);<br>        <span class="hljs-type">RLock</span> <span class="hljs-variable">writeLock</span> <span class="hljs-operator">=</span> rwLock.writeLock();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            writeLock.lock(<span class="hljs-number">10</span>, TimeUnit.SECONDS); <span class="hljs-comment">// åŠ å†™é”ï¼Œé˜²æ­¢å¹¶å‘è¯»/å†™</span><br>            redisService.del(key);                <span class="hljs-comment">// åˆ é™¤ç¼“å­˜ï¼ˆç¬¬ä¸€æ¬¡ï¼‰</span><br>            userRepository.save(user);            <span class="hljs-comment">// æ›´æ–°æ•°æ®åº“</span><br>            <span class="hljs-comment">// ç¬¬äºŒæ¬¡åˆ é™¤å¯å»¶è¿Ÿåšï¼ˆé¿å…å¹¶å‘å†™å…¥æ—§å€¼ï¼‰</span><br>            Thread.sleep(<span class="hljs-number">500</span>);                    <span class="hljs-comment">// æ¨¡æ‹Ÿå»¶è¿Ÿ</span><br>            redisService.del(key);                <span class="hljs-comment">// å»¶è¿Ÿåˆ é™¤ï¼ˆç¬¬äºŒæ¬¡ï¼‰</span><br><br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            writeLock.unlock(); <span class="hljs-comment">// é‡Šæ”¾å†™é”</span><br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.redisson.api.RReadWriteLock;<br><span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;<br><span class="hljs-keyword">import</span> org.redisson.api.RLock;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedissonClient redissonClient;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedisService redisService;     <span class="hljs-comment">// ä½ å°è£…çš„ Redis å·¥å…·ç±»</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserRepository userRepository; <span class="hljs-comment">// ä½ æ“ä½œæ•°æ®åº“çš„ç±»</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserService</span><span class="hljs-params">(RedissonClient redissonClient, RedisService redisService, UserRepository userRepository)</span> &#123;<br>        <span class="hljs-built_in">this</span>.redissonClient = redissonClient;<br>        <span class="hljs-built_in">this</span>.redisService = redisService;<br>        <span class="hljs-built_in">this</span>.userRepository = userRepository;<br>    &#125;<br><br>    <span class="hljs-comment">// è¯»æ“ä½œï¼šåŠ â€œè¯»é”â€</span><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long userId)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;user:&quot;</span> + userId;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lock:user:&quot;</span> + userId;<br><br>        <span class="hljs-type">RReadWriteLock</span> <span class="hljs-variable">rwLock</span> <span class="hljs-operator">=</span> redissonClient.getReadWriteLock(lockKey);<br>        <span class="hljs-type">RLock</span> <span class="hljs-variable">readLock</span> <span class="hljs-operator">=</span> rwLock.readLock();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            readLock.lock(<span class="hljs-number">5</span>, TimeUnit.SECONDS); <span class="hljs-comment">// åŠ è¯»é”ï¼Œé˜²æ­¢åŒæ—¶å†™å…¥</span><br>            <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> redisService.get(key);  <span class="hljs-comment">// å…ˆæŸ¥ç¼“å­˜</span><br>            <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> user;<br>            &#125;<br><br>            <span class="hljs-comment">// ç¼“å­˜æœªå‘½ä¸­ â†’ æŸ¥æ•°æ®åº“å¹¶å›å†™ç¼“å­˜</span><br>            user = userRepository.findById(userId);<br>            <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) &#123;<br>                redisService.set(key, user, <span class="hljs-number">10</span>, TimeUnit.MINUTES);<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> user;<br><br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            readLock.unlock(); <span class="hljs-comment">// é‡Šæ”¾è¯»é”</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// å†™æ“ä½œï¼šåŠ â€œå†™é”â€</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> user.getId();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;user:&quot;</span> + userId;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lock:user:&quot;</span> + userId;<br><br>        <span class="hljs-type">RReadWriteLock</span> <span class="hljs-variable">rwLock</span> <span class="hljs-operator">=</span> redissonClient.getReadWriteLock(lockKey);<br>        <span class="hljs-type">RLock</span> <span class="hljs-variable">writeLock</span> <span class="hljs-operator">=</span> rwLock.writeLock();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            writeLock.lock(<span class="hljs-number">10</span>, TimeUnit.SECONDS); <span class="hljs-comment">// åŠ å†™é”ï¼Œé˜²æ­¢å¹¶å‘è¯»/å†™</span><br>            redisService.del(key);                <span class="hljs-comment">// åˆ é™¤ç¼“å­˜ï¼ˆç¬¬ä¸€æ¬¡ï¼‰</span><br>            userRepository.save(user);            <span class="hljs-comment">// æ›´æ–°æ•°æ®åº“</span><br>            <span class="hljs-comment">// ç¬¬äºŒæ¬¡åˆ é™¤å¯å»¶è¿Ÿåšï¼ˆé¿å…å¹¶å‘å†™å…¥æ—§å€¼ï¼‰</span><br>            Thread.sleep(<span class="hljs-number">500</span>);                    <span class="hljs-comment">// æ¨¡æ‹Ÿå»¶è¿Ÿ</span><br>            redisService.del(key);                <span class="hljs-comment">// å»¶è¿Ÿåˆ é™¤ï¼ˆç¬¬äºŒæ¬¡ï¼‰</span><br><br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            writeLock.unlock(); <span class="hljs-comment">// é‡Šæ”¾å†™é”</span><br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2><span id="ä¸­é—´ä»¶è§£å†³æ–¹æ¡ˆ">ä¸­é—´ä»¶è§£å†³æ–¹æ¡ˆ</span></h2><p>å¼‚æ­¥é€šçŸ¥ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§</p><img src="/posts/redis%E8%AF%BB%E5%86%99%E4%B8%80%E8%87%B4%E9%97%AE%E9%A2%98/image-20250518113738817.png" class title="image-20250518113738817"><img src="/posts/redis%E8%AF%BB%E5%86%99%E4%B8%80%E8%87%B4%E9%97%AE%E9%A2%98/image-20250518113751772.png" class title="image-20250518113751772"><p>canalæ˜¯åŸºäºmysqlçš„ä¸»ä»åŒæ­¥æ¥å®ç°çš„</p><p>äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆBINLOGï¼‰è®°å½•äº†æ‰€æœ‰çš„ DDLï¼ˆæ•°æ®å®šä¹‰è¯­è¨€ï¼‰è¯­å¥å’Œ DMLï¼ˆæ•°æ®æ“çºµè¯­è¨€ï¼‰è¯­å¥ï¼Œä½†ä¸åŒ…æ‹¬æ•°æ®æŸ¥è¯¢ï¼ˆSELECTã€SHOWï¼‰è¯­å¥ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;&lt;span id=&quot;redisè¯»å†™ä¸€è‡´é—®é¢˜&quot;&gt;Redisè¯»å†™ä¸€è‡´é—®é¢˜&lt;/span&gt;&lt;/h1&gt;
&lt;p&gt;&lt;strong&gt;æ¡ä»¶:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;æ•°æ®åº“æ­¤æ—¶çš„æ•°æ®ä¸º10,redisæ­¤æ—¶çš„æ•°æ®ä¹Ÿä¸º10&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¸šåŠ¡æµç¨‹:&lt;/strong&gt;&lt;/</summary>
      
    
    
    
    <category term="redisçš„é—®é¢˜æ–¹æ¡ˆ" scheme="https://garybyd.github.io/categories/redis%E7%9A%84%E9%97%AE%E9%A2%98%E6%96%B9%E6%A1%88/"/>
    
    
    <category term="redis" scheme="https://garybyd.github.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨luaä¼˜åŒ–ä¸€äººä¸€å•é—®é¢˜</title>
    <link href="https://garybyd.github.io/posts/%E4%BD%BF%E7%94%A8lua%E4%BC%98%E5%8C%96%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%95%E9%97%AE%E9%A2%98/"/>
    <id>https://garybyd.github.io/posts/%E4%BD%BF%E7%94%A8lua%E4%BC%98%E5%8C%96%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%95%E9%97%AE%E9%A2%98/</id>
    <published>2025-05-15T13:41:05.000Z</published>
    <updated>2025-05-15T14:11:45.374Z</updated>
    
    <content type="html"><![CDATA[<h1><span id="é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜">é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜</span></h1><img src="/posts/%E4%BD%BF%E7%94%A8lua%E4%BC%98%E5%8C%96%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%95%E9%97%AE%E9%A2%98/image-20250515215934565.png" class title="image-20250515215934565"><h2><span id="åˆ†å¸ƒå¼é”-åŸç†"><strong>åˆ†å¸ƒå¼é”-åŸç†</strong></span></h2><p><strong>ä¸å»ä½¿ç”¨jvmå†…éƒ¨çš„é”ç›‘è§†å™¨ï¼Œæˆ‘ä»¬è¦åœ¨å¤–éƒ¨å¼€ä¸€ä¸ªé”ç›‘è§†å™¨ï¼Œè®©å®ƒç›‘è§†æ‰€æœ‰çš„çº¿ç¨‹</strong></p><img src="/posts/%E4%BD%BF%E7%94%A8lua%E4%BC%98%E5%8C%96%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%95%E9%97%AE%E9%A2%98/image-20250515215945861.png" class title="image-20250515215945861"><h1><span id="luaè§£å†³">Luaè§£å†³ï¼</span></h1><p>è§£å†³è¿™ä¸ªé—®é¢˜ä¸»è¦æ˜¯è®©ä¸€ä¸ªç”¨æˆ·ä¸èƒ½åŒæ—¶åˆ›å»ºä¸¤ä¸ªè®¢å•(åœ¨ç¼“å­˜åˆ›å»ºå‰)</p><p>luaå¯ä»¥åœ¨ä¿è¯åŸå­æ€§redisæ‰§è¡Œçš„åŸå­æ€§ï¼Œæ‰€ä»¥å’±å¯ä»¥ç”¨ä»–è§£å†³ä¸€äººä¸€å•å¼•å‘çš„å¹¶å‘é—®é¢˜æ— éœ€åŠ é”</p><h2><span id="luaä»£ç é€»è¾‘">luaä»£ç é€»è¾‘</span></h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- å‚æ•°åˆ—è¡¨</span><br><span class="hljs-comment">-- ä¼˜æƒ å·id</span><br><span class="hljs-keyword">local</span> voucherId = ARGV[<span class="hljs-number">1</span>]<br><span class="hljs-comment">-- ç”¨æˆ·id</span><br><span class="hljs-keyword">local</span> userId = ARGV[<span class="hljs-number">2</span>]<br><br><span class="hljs-comment">-- æ•°æ®key</span><br><span class="hljs-comment">-- åº“å­˜key</span><br><span class="hljs-keyword">local</span> stockKey = <span class="hljs-string">&#x27;seckill:stock:&#x27;</span> .. voucherId<br><span class="hljs-comment">-- è®¢å•key</span><br><span class="hljs-keyword">local</span> orderKey = <span class="hljs-string">&#x27;seckill:order:&#x27;</span> .. voucherId<br><span class="hljs-built_in">print</span>(stockKey)<br><span class="hljs-built_in">print</span>(orderKey)<br><span class="hljs-comment">-- è„šæœ¬ä¸šåŠ¡</span><br><span class="hljs-comment">-- æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³</span><br><span class="hljs-keyword">if</span>(<span class="hljs-built_in">tonumber</span>(redis.call(<span class="hljs-string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">then</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ä¸‹å•</span><br><span class="hljs-keyword">if</span>(redis.call(<span class="hljs-string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="hljs-number">1</span>) <span class="hljs-keyword">then</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">-- æ‰£åº“å­˜</span><br>redis.call(<span class="hljs-string">&#x27;incrby&#x27;</span>, stockKey, <span class="hljs-number">-1</span>)<br><span class="hljs-comment">-- ä¸‹å•ä¿å­˜ç”¨æˆ·</span><br>redis.call(<span class="hljs-string">&#x27;sadd&#x27;</span>, orderKey, userId)<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br><br></code></pre></td></tr></table></figure><h2><span id="javaè°ƒç”¨ä»£ç é€»è¾‘">javaè°ƒç”¨ä»£ç é€»è¾‘</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> DefaultRedisScript&lt;Long&gt; SECKILL_SCRIPT;<br><br> <span class="hljs-keyword">static</span> &#123;<br>     SECKILL_SCRIPT = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;();<br>     SECKILL_SCRIPT.setLocation(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(<span class="hljs-string">&quot;seckill.lua&quot;</span>));<br>     SECKILL_SCRIPT.setResultType(Long.class);<br> &#125;<br> <span class="hljs-keyword">private</span> IVoucherOrderService proxy;<br> <span class="hljs-meta">@Override</span><br> <span class="hljs-meta">@Transactional</span><br> <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">seckillVoucher</span><span class="hljs-params">(Long voucherId)</span> &#123;<br>     <span class="hljs-comment">//è·å–ç”¨æˆ·</span><br>     <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>     System.out.println(<span class="hljs-string">&quot;userId = &quot;</span> + userId);<br>     System.out.println(<span class="hljs-string">&quot;voucherId = &quot;</span> + voucherId);<br>     <span class="hljs-comment">//æ‰§è¡Œluaè„šæœ¬</span><br>     <span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> stringRedisTemplate.execute(<br>             SECKILL_SCRIPT,<br>             Collections.emptyList(),<br>             voucherId.toString(),<br>             userId.toString()<br>             );<br>     <span class="hljs-comment">//åˆ¤æ–­ç»“æœæ˜¯å¦ä¸ºé›¶</span><br>     <span class="hljs-keyword">assert</span> result != <span class="hljs-literal">null</span>;<br>     <span class="hljs-type">int</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> result.intValue();<br>     <span class="hljs-keyword">if</span>(r!=<span class="hljs-number">0</span>)&#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-keyword">switch</span> (r) &#123;<br>             <span class="hljs-keyword">case</span> <span class="hljs-number">1</span> -&gt; Result.fail(<span class="hljs-string">&quot;åº“å­˜ä¸è¶³&quot;</span>);<br>             <span class="hljs-keyword">case</span> <span class="hljs-number">2</span> -&gt; Result.fail(<span class="hljs-string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);<br>             <span class="hljs-keyword">default</span> -&gt; Result.fail(<span class="hljs-string">&quot;ç³»ç»Ÿé”™è¯¯&quot;</span>);<br>         &#125;;<br>     &#125;<br>     <span class="hljs-type">long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> redisIdWorker.nextId(<span class="hljs-string">&quot;order&quot;</span>);<br>     <span class="hljs-comment">// ä¿å­˜é˜»å¡é˜Ÿåˆ—</span><br>     <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrder</span>();<br>     <span class="hljs-comment">//è®¢å•id</span><br>     voucherOrder.setId(orderId);<br>     <span class="hljs-comment">//ç”¨æˆ·id</span><br>     voucherOrder.setUserId(userId);<br>     <span class="hljs-comment">//ä»£é‡‘åˆ¸id</span><br>     voucherOrder.setVoucherId(voucherId);<br>     <span class="hljs-comment">//åŠ å…¥é˜»å¡é˜Ÿåˆ—</span><br>     orderTasks.add(voucherOrder);<br>     proxy = (IVoucherOrderService) AopContext.currentProxy();<br>     <span class="hljs-comment">//ä¸ä¸º0</span><br><br>     <span class="hljs-comment">//ä¸º0 æœ‰è´­ä¹°èµ„æ ¼ æŠŠä¸‹å•ä¿¡æ¯ä¿å­˜åˆ°é˜»å¡é˜Ÿåˆ—</span><br><br>     <span class="hljs-comment">//è¿”å›è®¢å•id</span><br>     <span class="hljs-keyword">return</span> Result.ok(orderId);<br> &#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;&lt;span id=&quot;é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜&quot;&gt;é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜&lt;/span&gt;&lt;/h1&gt;
&lt;img src=&quot;/posts/%E4%BD%BF%E7%94%A8lua%E4%BC%98%E5%8C%96%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%9</summary>
      
    
    
    
    <category term="redisçš„åº”ç”¨" scheme="https://garybyd.github.io/categories/redis%E7%9A%84%E5%BA%94%E7%94%A8/"/>
    
    
    <category term="redis" scheme="https://garybyd.github.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>redisè§£å†³å¸¸è§çš„ç§’æ€é—®é¢˜</title>
    <link href="https://garybyd.github.io/posts/redis%E8%A7%A3%E5%86%B3%E5%B8%B8%E8%A7%81%E7%9A%84%E7%A7%92%E6%9D%80%E9%97%AE%E9%A2%98/"/>
    <id>https://garybyd.github.io/posts/redis%E8%A7%A3%E5%86%B3%E5%B8%B8%E8%A7%81%E7%9A%84%E7%A7%92%E6%9D%80%E9%97%AE%E9%A2%98/</id>
    <published>2025-03-07T06:24:13.000Z</published>
    <updated>2025-03-07T08:05:06.302Z</updated>
    
    <content type="html"><![CDATA[<h1><span id="ç§’æ€é—®é¢˜">ç§’æ€é—®é¢˜</span></h1><span id="more"></span><p>æ¯ä¸ªåº—é“ºéƒ½å¯ä»¥å‘å¸ƒä¼˜æƒ åˆ¸ï¼Œä¿å­˜åˆ° tb_voucher è¡¨ä¸­ï¼›å½“ç”¨æˆ·æŠ¢è´­æ—¶ï¼Œç”Ÿæˆè®¢å•å¹¶ä¿å­˜åˆ° tb_voucher_order è¡¨ä¸­ã€‚</p><p>è®¢å•è¡¨å¦‚æœä½¿ç”¨æ•°æ®åº“è‡ªå¢ IDï¼Œä¼šå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š</p><ul><li>ID çš„è§„å¾‹å¤ªæ˜æ˜¾ï¼Œå®¹æ˜“æš´éœ²ä¿¡æ¯ã€‚</li><li>å•è¡¨æ•°æ®é‡çš„é™åˆ¶ï¼Œè®¢å•è¿‡å¤šæ—¶å•è¡¨å¾ˆéš¾å­˜å‚¨å¾—ä¸‹ã€‚æ•°æ®é‡è¿‡å¤§åéœ€è¦æ‹†åº“æ‹†è¡¨ï¼Œä½†æ‹†åˆ†è¡¨äº†ä¹‹åï¼Œå„è¡¨ä»é€»è¾‘ä¸Šæ˜¯åŒä¸€å¼ è¡¨ï¼Œæ‰€ä»¥ id ä¸èƒ½ä¸€æ ·ï¼Œ äºæ˜¯éœ€è¦ä¿è¯ ID çš„å”¯ä¸€æ€§ã€‚</li></ul><h2><span id="å…¨å±€å”¯ä¸€id">å…¨å±€å”¯ä¸€ID</span></h2><p>å…¨å±€å”¯ä¸€ ID çš„ç‰¹ç‚¹</p><ul><li>å”¯ä¸€æ€§ï¼šRedis ç‹¬ç«‹äºæ•°æ®åº“ä¹‹å¤–ï¼Œä¸è®ºæœ‰å¤šå°‘ä¸ªæ•°æ®åº“ã€å¤šå°‘å¼ è¡¨ï¼Œè®¿é—® Redis è·å–åˆ°çš„ ID å¯ä»¥ä¿è¯å”¯ä¸€ã€‚</li><li>é«˜å¯ç”¨ï¼šRedis é«˜å¯ç”¨ï¼ˆé›†ç¾¤ç­‰æ–¹æ¡ˆï¼‰ã€‚</li><li>é«˜æ€§èƒ½ï¼šRedis é€Ÿåº¦å¾ˆå¿«ã€‚</li><li>é€’å¢æ€§ï¼šä¾‹å¦‚ String çš„ INCR å‘½ä»¤ï¼Œå¯ä»¥ä¿è¯é€’å¢ã€‚</li><li>å®‰å…¨æ€§ï¼šä¸ºäº†å¢åŠ  ID çš„å®‰å…¨æ€§ï¼Œåœ¨ä½¿ç”¨ Redis è‡ªå¢æ•°å€¼çš„åŸºç¡€ä¸Šï¼Œåœ¨æ‹¼æ¥ä¸€äº›å…¶ä»–ä¿¡æ¯ã€‚</li></ul><p>å…¨å±€å”¯ä¸€ ID çš„ç»„æˆï¼ˆå­˜å‚¨æ•°å€¼ç±»å‹å ç”¨ç©ºé—´æ›´å°ï¼Œä½¿ç”¨ long å­˜å‚¨ï¼Œ8 byteï¼Œ64 bitï¼‰</p><img src="/posts/redis%E8%A7%A3%E5%86%B3%E5%B8%B8%E8%A7%81%E7%9A%84%E7%A7%92%E6%9D%80%E9%97%AE%E9%A2%98/image-20250307142854673.png" class title="image-20250307142854673"><ul><li><p>ç¬¦å·ä½ï¼š1 bitï¼Œæ°¸è¿œä¸º 0ï¼Œä»£è¡¨ ID æ˜¯æ­£æ•°ã€‚</p></li><li><p>æ—¶é—´æˆ³ï¼š31 bitï¼Œä»¥ç§’ä¸ºå•ä½ï¼Œå¯ä»¥ä½¿ç”¨ 69 å¹´ã€‚</p></li><li><p>åºåˆ—å·ï¼š32 bitï¼Œå½“å‰æ—¶é—´æˆ³å¯¹åº”çš„æ•°é‡ï¼Œä¹Ÿå°±æ˜¯æ¯ç§’å¯ä»¥å¯¹åº” 2^32 ä¸ªä¸åŒçš„ IDã€‚</p></li></ul><p><strong>Redis ID è‡ªå¢ç­–ç•¥</strong>ï¼šé€šè¿‡è®¾ç½®æ¯å¤©å­˜å…¥ä¸€ä¸ª Keyï¼Œæ–¹ä¾¿ç»Ÿè®¡è®¢å•æ•°é‡ï¼›ID æ„é€ ä¸º æ—¶é—´æˆ³ + è®¡æ•°å™¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisIdWorker</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æŒ‡å®šæ—¶é—´æˆ³ï¼ˆ2023å¹´1æœˆ1æ—¥ 0:0:00ï¼‰ LocalDateTime.of(2023, 1, 1, 0, 0, 0).toEpochSecond(ZoneOffset.UTC)</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">BEGIN_TIMESTAMP_2023</span> <span class="hljs-operator">=</span> <span class="hljs-number">1672531200L</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * åºåˆ—å·ä½æ•°</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BIT_COUNT</span> <span class="hljs-operator">=</span> <span class="hljs-number">32</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RedisIdWorker</span><span class="hljs-params">(StringRedisTemplate stringRedisTemplate)</span> &#123;<br>        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">nextId</span><span class="hljs-params">(String keyPrefix)</span> &#123;<br>        <span class="hljs-comment">// 1. æ—¶é—´æˆ³</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">timestamp</span> <span class="hljs-operator">=</span> LocalDateTime.now().toEpochSecond(ZoneOffset.UTC) - BEGIN_TIMESTAMP_2023;<br>        <span class="hljs-comment">// 2. ç”Ÿæˆåºåˆ—å·ï¼šè‡ªå¢ 1ï¼ŒKey ä¸å­˜åœ¨ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª Keyã€‚ï¼ˆå­˜å‚¨åˆ° Redis ä¸­çš„ Key ä¸º keyPrefix:dateï¼ŒValue ä¸ºè‡ªå¢çš„æ•°é‡ï¼‰</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">serialNumber</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().increment(keyPrefix + <span class="hljs-string">&quot;:&quot;</span> + DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;yyyy-MM-dd&quot;</span>).format(LocalDate.now()));<br>        <span class="hljs-comment">// 3. æ—¶é—´æˆ³å·¦ç§» 32 ä½ï¼Œåºåˆ—å·ä¸å³è¾¹çš„ 32 ä¸ª 0 è¿›è¡Œä¸è¿ç®—</span><br>        <span class="hljs-keyword">return</span> timestamp &lt;&lt; BIT_COUNT | serialNumber;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æµ‹è¯•(300ä¸ªçº¿ç¨‹ç”Ÿæˆå…±3wä¸ªid)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Resource</span><br><span class="hljs-keyword">private</span> RedisIdWorker redisIdWorker;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">ES</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">500</span>);<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testGloballyUniqueID</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// ç¨‹åºæ˜¯å¼‚æ­¥çš„ï¼Œåˆ†çº¿ç¨‹å…¨éƒ¨èµ°å®Œä¹‹åä¸»çº¿ç¨‹å†èµ°ï¼Œä½¿ç”¨ CountDownLatchï¼›å¦åˆ™å¼‚æ­¥ç¨‹åºæ²¡æœ‰æ‰§è¡Œå®Œæ—¶ä¸»çº¿ç¨‹å°±å·²ç»æ‰§è¡Œå®Œäº†</span><br>    <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">300</span>);<br>    <span class="hljs-type">Runnable</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> () -&gt; &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">globallyUniqueID</span> <span class="hljs-operator">=</span> redisIdWorker.nextId(<span class="hljs-string">&quot;sun&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;globallyUniqueID = &quot;</span> + globallyUniqueID);<br>        &#125;<br>        latch.countDown();<br>    &#125;;<br><br>    <span class="hljs-type">long</span> <span class="hljs-variable">begin</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">300</span>; i++) &#123;<br>        ES.submit(task);<br>    &#125;<br>    latch.await();<br>    <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    System.out.println(<span class="hljs-string">&quot;Execution Time: &quot;</span> + (end - begin));<br>&#125;<br><br></code></pre></td></tr></table></figure><h2><span id="æ·»åŠ ä¼˜æƒ å·">æ·»åŠ ä¼˜æƒ å·</span></h2><p>æ ¼å¼ç±»ä¼¼è¿™ç§é€»è¾‘å¤ªç®€å•äº†ç•¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<br>    <span class="hljs-string">&quot;shopId&quot;</span>:<span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;title&quot;</span>:<span class="hljs-string">&quot;100å…ƒä»£é‡‘åˆ¸&quot;</span>,<br>    <span class="hljs-string">&quot;subTitle&quot;</span>:<span class="hljs-string">&quot;å‘¨ä¸€è‡³å‘¨äº”å‡å¯ä½¿ç”¨&quot;</span>,<br>    <span class="hljs-string">&quot;rules&quot;</span>:<span class="hljs-string">&quot;å…¨åœºé€šç”¨\næ— éœ€é¢„çº¦\nå¯æ— é™å åŠ \nä¸å…‘ç°ã€ä¸æ‰¾é›¶\nä»…é™å ‚é£Ÿ&quot;</span>,<br>    <span class="hljs-string">&quot;payValue&quot;</span>:<span class="hljs-number">8000</span>,<br>    <span class="hljs-string">&quot;actualValue&quot;</span>:<span class="hljs-number">10000</span>,<br>    <span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;stock&quot;</span>:<span class="hljs-number">100</span>,<br>    <span class="hljs-string">&quot;beginTime&quot;</span>:<span class="hljs-string">&quot;2022-11-13T10:09:17&quot;</span>,<br>    <span class="hljs-string">&quot;endTime&quot;</span>:<span class="hljs-string">&quot;2022-11-13T22:10:17&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><h2><span id="ç§’æ€ä¸‹å•åŠŸèƒ½">ç§’æ€ä¸‹å•åŠŸèƒ½</span></h2><img src="/posts/redis%E8%A7%A3%E5%86%B3%E5%B8%B8%E8%A7%81%E7%9A%84%E7%A7%92%E6%9D%80%E9%97%AE%E9%A2%98/image-20250307144455414.png" class title="image-20250307144455414"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">seckillVoucher</span><span class="hljs-params">(Long voucherId)</span> &#123;<br>    <span class="hljs-comment">//1.æŸ¥è¯¢ä¼˜æƒ å·</span><br>    <span class="hljs-type">SeckillVoucher</span> <span class="hljs-variable">voucher</span> <span class="hljs-operator">=</span> seckillVoucherService.getById(voucherId);<br>    <span class="hljs-comment">//2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹ï¼Œæ˜¯å¦ç»“æŸ</span><br>    <span class="hljs-keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;ç§’æ€å°šæœªå¼€å§‹!&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(voucher.getEndTime().isBefore(LocalDateTime.now()))&#123;<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;ç§’æ€å·²ç»“æŸ!&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//3.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span><br>    <span class="hljs-keyword">if</span>(voucher.getStock()&lt;=<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;ä¼˜æƒ åˆ¸åº“å­˜ä¸è¶³!&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//4.æ‰£å‡åº“å­˜</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> seckillVoucherService.update()<br>            .setSql(<span class="hljs-string">&quot;stock = stock -1&quot;</span>)<br>            .eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId).update();<br>    <span class="hljs-comment">//5.åˆ›å»ºè®¢å•</span><br>    <span class="hljs-keyword">if</span>(!success)&#123;<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;ä¼˜æƒ åˆ¸åº“å­˜ä¸è¶³!&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//6.è¿”å›è®¢å•id</span><br>    <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrder</span>();<br>    <span class="hljs-comment">//6.1è®¢å•id</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> redisIdWorker.nextId(<span class="hljs-string">&quot;order&quot;</span>);<br>    voucherOrder.setId(orderId);<br>    <span class="hljs-comment">//6.2ç”¨æˆ·id</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    voucherOrder.setUserId(userId);<br>    <span class="hljs-comment">//6.3ä»£é‡‘åˆ¸id</span><br>    voucherOrder.setVoucherId(voucherId);<br><br>    <span class="hljs-comment">//7.è®¢å•å†™å…¥æ•°æ®åº“</span><br>    save(voucherOrder);<br>    <br>    <span class="hljs-comment">//8.è¿”å›è®¢å•Id</span><br>    <span class="hljs-keyword">return</span> Result.ok(orderId);<br>&#125;<br></code></pre></td></tr></table></figure><h3><span id="è¶…å–é—®é¢˜">è¶…å–é—®é¢˜</span></h3><p><strong>å‡è®¾åº“å­˜ä¸º 1ï¼Œæœ‰çº¿ç¨‹1ã€2ã€3ï¼Œæ—¶åˆ» t1ã€t2ã€t3ã€t4ã€‚</strong></p><ul><li><strong>t1</strong>ï¼šçº¿ç¨‹1 æŸ¥è¯¢åº“å­˜ï¼Œåº“å­˜ä¸º 1ï¼›</li><li><strong>t2</strong>ï¼šçº¿ç¨‹2ã€çº¿ç¨‹ 3 æŸ¥è¯¢åº“å­˜ï¼Œåº“å­˜ä¸º 1ï¼›</li><li><strong>t3</strong>ï¼šçº¿ç¨‹1 ä¸‹å•ï¼Œåº“å­˜æ‰£å‡ä¸º 0ã€‚</li><li><strong>t4</strong>ï¼šçº¿ç¨‹2 å’Œ çº¿ç¨‹3 ä¸‹å•ï¼Œåº“å­˜æ‰£å‡ä¸º -2ã€‚</li></ul><p>å…·ä½“å›¾ç¤º:</p><img src="/posts/redis%E8%A7%A3%E5%86%B3%E5%B8%B8%E8%A7%81%E7%9A%84%E7%A7%92%E6%9D%80%E9%97%AE%E9%A2%98/image-20250307144908831.png" class title="image-20250307144908831"><img src="/posts/redis%E8%A7%A3%E5%86%B3%E5%B8%B8%E8%A7%81%E7%9A%84%E7%A7%92%E6%9D%80%E9%97%AE%E9%A2%98/image-20250307145131525.png" class title="image-20250307145131525"><h2><span id="è§£å†³è¶…å–é—®é¢˜">è§£å†³è¶…å–é—®é¢˜</span></h2><h4><span id="æ‚²è§‚é”">æ‚²è§‚é”</span></h4><p>å¤ªç®€å•äº†ç›´æ¥åŠ é”ä¿è¯æ“ä½œæ•°æ®æ˜¯åŸå­æ“ä½œè¦ä¸²è¡Œæ‰§è¡Œ</p><h4><span id="ä¹è§‚é”">ä¹è§‚é”</span></h4><h5><span id="ç‰ˆæœ¬å·æ³•">ç‰ˆæœ¬å·æ³•:</span></h5><p>ä¸€èˆ¬æ˜¯åœ¨æ•°æ®åº“è¡¨ä¸­åŠ ä¸Šä¸€ä¸ª version å­—æ®µè¡¨ç¤º æ•°æ®è¢«ä¿®æ”¹çš„æ¬¡æ•°ã€‚æ•°æ®è¢«ä¿®æ”¹æ—¶ version å€¼åŠ  1ã€‚</p><ol><li><p>çº¿ç¨‹ A è¯»å–æ•°æ®ï¼ŒåŒæ—¶è¯»å–åˆ° version å€¼ã€‚</p></li><li><p>æäº¤æ›´æ–°æ—¶ï¼Œè‹¥åˆšæ‰è¯»åˆ°çš„ version å€¼æœªå‘ç”Ÿå˜åŒ–ï¼šåˆ™æäº¤æ›´æ–°å¹¶ä¸” version å€¼åŠ  1ã€‚</p></li><li><p>æäº¤æ›´æ–°æ—¶ï¼Œè‹¥åˆšæ‰è¯»åˆ°çš„ version å€¼å‘ç”Ÿäº†å˜åŒ–ï¼šæ”¾å¼ƒæ›´æ–°ï¼Œå¹¶é€šè¿‡æŠ¥é”™ã€è‡ªæ—‹é‡è¯•ç­‰æ–¹å¼è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†ã€‚</p></li></ol><img src="/posts/redis%E8%A7%A3%E5%86%B3%E5%B8%B8%E8%A7%81%E7%9A%84%E7%A7%92%E6%9D%80%E9%97%AE%E9%A2%98/image-20250307145426017.png" class title="image-20250307145426017"><h5><span id="casæ³•ç®€å•æ¥è¯´å°±æ˜¯ç›´æ¥æ‹¿åº“å­˜å½“ç‰ˆæœ¬å·">CASæ³•(ç®€å•æ¥è¯´å°±æ˜¯ç›´æ¥æ‹¿åº“å­˜å½“ç‰ˆæœ¬å·):</span></h5><p>CAS æ“ä½œéœ€è¦è¾“å…¥ä¸¤ä¸ªæ•°å€¼ï¼Œä¸€ä¸ªæ—§å€¼ï¼ˆæ“ä½œå‰çš„å€¼ï¼‰å’Œä¸€ä¸ªæ–°å€¼ï¼Œæ“ä½œæ—¶å…ˆæ¯”è¾ƒä¸‹åœ¨æ—§å€¼æœ‰æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œè‹¥æœªå‘ç”Ÿå˜åŒ–æ‰äº¤æ¢æˆæ–°å€¼ï¼Œå‘ç”Ÿäº†å˜åŒ–åˆ™ä¸äº¤æ¢ã€‚</p><p><strong>CAS æ˜¯åŸå­æ“ä½œï¼Œå¤šçº¿ç¨‹å¹¶å‘ä½¿ç”¨ CAS æ›´æ–°æ•°æ®æ—¶ï¼Œå¯ä»¥ä¸ä½¿ç”¨é”ã€‚åŸå­æ“ä½œæ˜¯æœ€å°çš„ä¸å¯æ‹†åˆ†çš„æ“ä½œï¼Œæ“ä½œä¸€æ—¦å¼€å§‹ï¼Œä¸èƒ½è¢«æ‰“æ–­ï¼Œç›´åˆ°æ“ä½œå®Œæˆã€‚ä¹Ÿå°±æ˜¯å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€å—å†…å­˜çš„æ“ä½œæ˜¯ä¸²è¡Œçš„ã€‚</strong></p><img src="/posts/redis%E8%A7%A3%E5%86%B3%E5%B8%B8%E8%A7%81%E7%9A%84%E7%A7%92%E6%9D%80%E9%97%AE%E9%A2%98/image-20250307145458923.png" class title="image-20250307145458923"><h2><span id="ä¸€äººä¸€å•é—®é¢˜">ä¸€äººä¸€å•é—®é¢˜</span></h2><img src="/posts/redis%E8%A7%A3%E5%86%B3%E5%B8%B8%E8%A7%81%E7%9A%84%E7%A7%92%E6%9D%80%E9%97%AE%E9%A2%98/image-20250307150243527.png" class><p>ä¸€äººä¸€å•é€»è¾‘:</p><ol><li>å‘é€ä¸‹å•è¯·æ±‚ï¼Œæäº¤ä¼˜æƒ åˆ¸ IDã€‚</li><li>ä¸‹å•å‰éœ€è¦åˆ¤æ–­ï¼š<strong>ç§’æ€æ˜¯å¦å¼€å§‹æˆ–ç»“æŸã€åº“å­˜æ˜¯å¦å……è¶³</strong>ã€‚</li><li>åº“å­˜å……è¶³ï¼š<strong>æ ¹æ®ä¼˜æƒ åˆ¸ ID å’Œç”¨æˆ· ID æŸ¥è¯¢è®¢å•ï¼Œåˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦è´­ä¹°è¿‡è¯¥ä¼˜æƒ åˆ¸</strong>ã€‚</li><li><strong>è¯¥ç”¨æˆ·å¯¹è¯¥ä¼˜æƒ åˆ¸çš„è®¢å•ä¸å­˜åœ¨æ—¶</strong>ï¼Œæ‰£å‡åº“å­˜ã€åˆ›å»ºè®¢å•ã€è¿”å›è®¢å• IDã€‚</li></ol><h3><span id="è§£å†³å¹¶å‘å®‰å…¨é—®é¢˜">è§£å†³å¹¶å‘å®‰å…¨é—®é¢˜</span></h3><ol><li>å•äººä¸‹å•ï¼ˆä¸€ä¸ªç”¨æˆ·ï¼‰ï¼Œé«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼šè¯¥ç”¨æˆ·çš„ 10 ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œåˆ° æŸ¥è¯¢è¯¥ç”¨æˆ· ID å’Œç§’æ€åˆ¸å¯¹åº”çš„è®¢å•æ•°é‡ï¼Œ10 ä¸ªçº¿ç¨‹æŸ¥è¯¢åˆ°çš„å€¼éƒ½ä¸º 0ï¼Œå³æœªä¸‹å•ã€‚äºæ˜¯ä¼šå‡ºç°ä¸€ä¸ªç”¨æˆ·ä¸‹ 10 å•çš„æƒ…å†µã€‚</li><li>**æ­¤å¤„ä»éœ€åŠ é”ï¼Œä¹è§‚é”é€‚åˆæ›´æ–°æ“ä½œï¼Œæ’å…¥æ“ä½œéœ€è¦é€‰æ‹©æ‚²è§‚é”ã€‚**è‹¥ç›´æ¥åœ¨æ–¹æ³•ä¸Šæ·»åŠ  synchronized å…³é”®å­—ï¼Œä¼šè®©é”çš„èŒƒå›´ï¼ˆç²’åº¦ï¼‰è¿‡å¤§ï¼Œå¯¼è‡´æ€§èƒ½è¾ƒå·®ã€‚å› æ­¤ï¼Œé‡‡ç”¨ ä¸€ä¸ªç”¨æˆ·ä¸€æŠŠé” çš„æ–¹å¼ã€‚</li></ol><p><strong><code>é—®é¢˜ï¼šèƒ½å¦ç”¨ä¹è§‚é”æ‰§è¡Œï¼Ÿ</code></strong></p><p><strong><code>ä¸èƒ½ï¼ŒåŸå› æ˜¯ä¹è§‚é”åªèƒ½æ“ä½œ(ä¿®æ”¹)å•ä¸ªå˜é‡ï¼Œè€Œåˆ›å»ºè®¢å•éœ€è¦æ“ä½œæ•°æ®åº“(éš¾ä»¥è·Ÿè¸ªçŠ¶æ€)</code></strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> CommonResult&lt;Long&gt; <span class="hljs-title function_">seckillVoucher</span><span class="hljs-params">(Long voucherId)</span> &#123;<br>    <span class="hljs-comment">// åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹æˆ–ç»“æŸã€åº“å­˜æ˜¯å¦å……è¶³ã€‚</span><br>    <span class="hljs-type">SeckillVoucher</span> <span class="hljs-variable">seckillVoucher</span> <span class="hljs-operator">=</span> seckillVoucherService.getById(voucherId);<br>    ThrowUtils.throwIf(seckillVoucher == <span class="hljs-literal">null</span>, ErrorCode.NOT_FOUND_ERROR);<br>    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();<br>    ThrowUtils.throwIf(now.isBefore(seckillVoucher.getBeginTime()), ErrorCode.OPERATION_ERROR, <span class="hljs-string">&quot;ç§’æ€å°šæœªå¼€å§‹&quot;</span>);<br>    ThrowUtils.throwIf(now.isAfter(seckillVoucher.getEndTime()), ErrorCode.OPERATION_ERROR, <span class="hljs-string">&quot;ç§’æ€å·²ç»ç»“æŸ&quot;</span>);<br>    ThrowUtils.throwIf(seckillVoucher.getStock() &lt; <span class="hljs-number">1</span>, ErrorCode.OPERATION_ERROR, <span class="hljs-string">&quot;åº“å­˜ä¸è¶³&quot;</span>);<br><br>    <span class="hljs-comment">// ä¸‹å•</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.createVoucherOrder(voucherId);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ä¸‹å•ï¼ˆè¶…å– - CASã€ä¸€äººä¸€å• - synchronizedï¼‰</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> CommonResult&lt;Long&gt; <span class="hljs-title function_">createVoucherOrder</span><span class="hljs-params">(Long voucherId)</span> &#123;<br>    <span class="hljs-comment">// 1. åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦ä¸‹è¿‡å•</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.lambdaQuery()<br>            .eq(VoucherOrder::getVoucherId, voucherId)<br>            .eq(VoucherOrder::getUserId, userId)<br>            .count();<br>    ThrowUtils.throwIf(count &gt; <span class="hljs-number">0</span>, ErrorCode.OPERATION_ERROR, <span class="hljs-string">&quot;ç¦æ­¢é‡å¤ä¸‹å•&quot;</span>);<br><br>    <span class="hljs-comment">// 2. æ‰£å‡åº“å­˜</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> seckillVoucherService.update()<br>                .setSql(<span class="hljs-string">&quot;stock = stock - 1&quot;</span>)<br>                .eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId)<br>                .gt(<span class="hljs-string">&quot;stock&quot;</span>, <span class="hljs-number">0</span>)<br>                .update();<br>    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR, <span class="hljs-string">&quot;ä¸‹å•å¤±è´¥&quot;</span>);<br><br>    <span class="hljs-comment">// 3. ä¸‹å•</span><br>    <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrder</span>();<br>    voucherOrder.setUserId(userId);<br>    voucherOrder.setId(redisIdWorker.nextId(<span class="hljs-string">&quot;seckillVoucherOrder&quot;</span>));<br>    voucherOrder.setVoucherId(voucherId);<br>    result = <span class="hljs-built_in">this</span>.save(voucherOrder);<br>    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR, <span class="hljs-string">&quot;ä¸‹å•å¤±è´¥&quot;</span>);<br>    <span class="hljs-keyword">return</span> CommonResult.success(voucherOrder.getId());<br>&#125;<br><br></code></pre></td></tr></table></figure><h3><span id="é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜">é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜</span></h3><img src="/posts/redis%E8%A7%A3%E5%86%B3%E5%B8%B8%E8%A7%81%E7%9A%84%E7%A7%92%E6%9D%80%E9%97%AE%E9%A2%98/image-20250307151540535.png" class title="image-20250307151540535"><h4><span id="åˆ†å¸ƒå¼é”-åŸç†"><strong>åˆ†å¸ƒå¼é”-åŸç†</strong></span></h4><p><strong>ä¸å»ä½¿ç”¨jvmå†…éƒ¨çš„é”ç›‘è§†å™¨ï¼Œæˆ‘ä»¬è¦åœ¨å¤–éƒ¨å¼€ä¸€ä¸ªé”ç›‘è§†å™¨ï¼Œè®©å®ƒç›‘è§†æ‰€æœ‰çš„çº¿ç¨‹</strong></p><img src="/posts/redis%E8%A7%A3%E5%86%B3%E5%B8%B8%E8%A7%81%E7%9A%84%E7%A7%92%E6%9D%80%E9%97%AE%E9%A2%98/image-20250307151802726.png" class title="image-20250307151802726"><p>å¸¸è§çš„åˆ†å¸ƒå¼é”</p><p><code>MySQL</code>ï¼šMySQL æœ¬èº«å¸¦æœ‰é”æœºåˆ¶ï¼Œä½†æ˜¯ç”±äº MySQL æ€§èƒ½ä¸€èˆ¬ï¼Œæ‰€ä»¥é‡‡ç”¨åˆ†å¸ƒå¼é”çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ MySQL ä½œä¸ºåˆ†å¸ƒå¼é”æ¯”è¾ƒå°‘è§ã€‚<br><code>Redis</code>ï¼šRedis ä½œä¸ºåˆ†å¸ƒå¼é”æ¯”è¾ƒå¸¸è§ï¼Œåˆ©ç”¨ setnx æ–¹æ³•ï¼Œå¦‚æœ Key æ’å…¥æˆåŠŸï¼Œåˆ™è¡¨ç¤ºè·å–åˆ°é”ï¼Œæ’å…¥å¤±è´¥åˆ™è¡¨ç¤ºæ— æ³•è·å–åˆ°é”ã€‚<br><code>Zookeeper</code>ï¼šZookeeper ä¹Ÿæ˜¯ä¼ä¸šçº§å¼€å‘ä¸­æ¯”è¾ƒå¥½çš„ä¸€ä¸ªå®ç°åˆ†å¸ƒå¼é”çš„æ–¹æ¡ˆã€‚</p><table><thead><tr><th></th><th>MySQL</th><th>Redis</th><th><strong>Zookeeper</strong></th></tr></thead><tbody><tr><td><strong>äº’æ–¥</strong></td><td><strong>åˆ©ç”¨ MySQL æœ¬èº«çš„äº’æ–¥é”æœºåˆ¶</strong></td><td><strong>åˆ©ç”¨ <code>setnx</code> äº’æ–¥å‘½ä»¤</strong></td><td><strong>åˆ©ç”¨èŠ‚ç‚¹çš„å”¯ä¸€æ€§å’Œæœ‰åºæ€§</strong></td></tr><tr><td><strong>é«˜å¯ç”¨</strong></td><td><strong>å¥½</strong></td><td><strong>å¥½</strong></td><td><strong>å¥½</strong></td></tr><tr><td><strong>é«˜æ€§èƒ½</strong></td><td><strong>ä¸€èˆ¬</strong></td><td><strong>å¥½</strong></td><td><strong>ä¸€èˆ¬</strong></td></tr><tr><td><strong>å®‰å…¨æ€§</strong></td><td><strong>æ–­å¼€é“¾æ¥ï¼Œè‡ªåŠ¨é‡Šæ”¾é”</strong></td><td><strong>åˆ©ç”¨é”è¶…æ—¶æ—¶é—´ï¼Œåˆ°æœŸé‡Šæ”¾</strong></td><td><strong>ä¸´æ—¶èŠ‚ç‚¹ï¼Œæ–­å¼€é“¾æ¥è‡ªåŠ¨é‡Šæ”¾</strong></td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"># æ·»åŠ é”ï¼ˆNX äº’æ–¥ã€EX è®¾ç½® TTL æ—¶é—´ï¼‰<br>SET lock thread1 NX EX <span class="hljs-number">10</span><br><br># æ‰‹åŠ¨é‡Šæ”¾é”<br>DEL lock<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DistributedLock</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è·å–é”ï¼ˆåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè·å–åˆ°é”ï¼‰</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> timeout   é”çš„è¶…æ—¶æ—¶é—´ï¼Œè¿‡æœŸåè‡ªåŠ¨é‡Šæ”¾</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span>          true ä»£è¡¨è·å–é”æˆåŠŸï¼›false ä»£è¡¨è·å–é”å¤±è´¥</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> timeout)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * é‡Šæ”¾é”</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleDistributedLock4Redis</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DistributedLock</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lock:&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SimpleDistributedLockBased4Redis</span><span class="hljs-params">(String name, StringRedisTemplate stringRedisTemplate)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> timeout)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">threadId</span> <span class="hljs-operator">=</span> Thread.currentThread().getId().toString();<br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue()<br>                .setIfAbsent(KEY_PREFIX + name, threadId, timeout, TimeUnit.SECONDS);<br>      <span class="hljs-comment">// result æ˜¯ Boolean ç±»å‹ï¼Œç›´æ¥è¿”å›å­˜åœ¨è‡ªåŠ¨æ‹†ç®±ï¼Œä¸ºé˜²æ­¢ç©ºæŒ‡é’ˆä¸ç›´æ¥è¿”å›</span><br>        <span class="hljs-keyword">return</span> Boolean.TRUE.equals(result);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> &#123;<br>        stringRedisTemplate.delete(KEY_PREFIX + name);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * VERSION3.0 - ç§’æ€ä¸‹å•ä¼˜æƒ åˆ¸ï¼ˆé€šè¿‡åˆ†å¸ƒå¼é”è§£å†³ä¸€äººä¸€å•é—®é¢˜ï¼‰</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> CommonResult&lt;Long&gt; <span class="hljs-title function_">seckillVoucher</span><span class="hljs-params">(Long voucherId)</span> &#123;<br>    <span class="hljs-comment">// åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹æˆ–ç»“æŸã€åº“å­˜æ˜¯å¦å……è¶³ã€‚</span><br>    ...<br><br>    <span class="hljs-comment">// ä¸‹å•</span><br>    <span class="hljs-type">SimpleDistributedLock4Redis</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDistributedLock4Redis</span>(<span class="hljs-string">&quot;order:&quot;</span> + UserHolder.getUser().getId(), stringRedisTemplate);<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">tryLock</span> <span class="hljs-operator">=</span> lock.tryLock(TTL_TWO);<br>    ThrowUtils.throwIf(!tryLock, ErrorCode.OPERATION_ERROR, <span class="hljs-string">&quot;ç¦æ­¢é‡å¤ä¸‹å•&quot;</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">VoucherOrderService</span> <span class="hljs-variable">voucherOrderService</span> <span class="hljs-operator">=</span> (VoucherOrderService) AopContext.currentProxy();<br>        <span class="hljs-keyword">return</span> voucherOrderService.createVoucherOrder(voucherId);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        lock.unlock();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3><span id="è¯¯åˆ é—®é¢˜">è¯¯åˆ é—®é¢˜</span></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"># çº¿ç¨‹ <span class="hljs-number">1</span> è·å–åˆ°é”åæ‰§è¡Œä¸šåŠ¡ï¼Œç¢°åˆ°äº†ä¸šåŠ¡é˜»å¡ã€‚<br>setnx lock:order:<span class="hljs-number">1</span> thread01<br><br># ä¸šåŠ¡é˜»å¡çš„æ—¶é—´è¶…è¿‡äº†è¯¥é”çš„ TTL æ—¶é—´ï¼Œè§¦å‘é”çš„è¶…æ—¶é‡Šæ”¾ã€‚è¶…æ—¶é‡Šæ”¾åï¼Œçº¿ç¨‹ <span class="hljs-number">2</span> è·å–åˆ°é”å¹¶æ‰§è¡Œä¸šåŠ¡ã€‚<br>setnx lock:order:<span class="hljs-number">1</span> thread02<br><br># çº¿ç¨‹ <span class="hljs-number">2</span> æ‰§è¡Œä¸šåŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹ <span class="hljs-number">1</span> çš„ä¸šåŠ¡æ‰§è¡Œå®Œæ¯•å¹¶ä¸”é‡Šæ”¾é”ï¼Œä½†æ˜¯é‡Šæ”¾çš„æ˜¯çº¿ç¨‹ <span class="hljs-number">2</span> è·å–åˆ°çš„é”ã€‚ï¼ˆçº¿ç¨‹ <span class="hljs-number">2</span>ï¼šä½  TM æ”¾æˆ‘é”æ˜¯å§ï¼ï¼‰<br>del lock:order:<span class="hljs-number">1</span><br><br># çº¿ç¨‹ <span class="hljs-number">3</span> è·å–åˆ°é”ï¼ˆæ­¤æ—¶çº¿ç¨‹ <span class="hljs-number">2</span> å’Œ <span class="hljs-number">3</span> å¹¶è¡Œæ‰§è¡Œä¸šåŠ¡ï¼‰<br>setnx lock:order:<span class="hljs-number">1</span> thread03<br><br></code></pre></td></tr></table></figure><img src="/posts/redis%E8%A7%A3%E5%86%B3%E5%B8%B8%E8%A7%81%E7%9A%84%E7%A7%92%E6%9D%80%E9%97%AE%E9%A2%98/image-20250307152223236.png" class title="image-20250307152223236"><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šåœ¨çº¿ç¨‹é‡Šæ”¾é”æ—¶ï¼Œåˆ¤æ–­å½“å‰è¿™æŠŠé”æ˜¯å¦å±äºè‡ªå·±ï¼Œå¦‚æœä¸å±äºè‡ªå·±ï¼Œå°±ä¸ä¼šè¿›è¡Œé”çš„é‡Šæ”¾ï¼ˆåˆ é™¤ï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"># çº¿ç¨‹ <span class="hljs-number">1</span> è·å–åˆ°é”åæ‰§è¡Œä¸šåŠ¡ï¼Œç¢°åˆ°äº†ä¸šåŠ¡é˜»å¡ã€‚<br>setnx lock:order:<span class="hljs-number">1</span> thread01<br><br># ä¸šåŠ¡é˜»å¡çš„æ—¶é—´è¶…è¿‡äº†è¯¥é”çš„ TTL æ—¶é—´ï¼Œè§¦å‘é”çš„è¶…æ—¶é‡Šæ”¾ã€‚è¶…æ—¶é‡Šæ”¾åï¼Œçº¿ç¨‹ <span class="hljs-number">2</span> è·å–åˆ°é”å¹¶æ‰§è¡Œä¸šåŠ¡ã€‚<br>setnx lock:order:<span class="hljs-number">1</span> thread02<br><br># çº¿ç¨‹ <span class="hljs-number">2</span> æ‰§è¡Œä¸šåŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹ <span class="hljs-number">1</span> çš„ä¸šåŠ¡æ‰§è¡Œå®Œæ¯•å¹¶ä¸”é‡Šæ”¾é”ã€‚ä½†æ˜¯çº¿ç¨‹ <span class="hljs-number">1</span> éœ€è¦åˆ¤æ–­è¿™æŠŠé”æ˜¯å¦å±äºè‡ªå·±ï¼Œä¸å±äºè‡ªå·±å°±ä¸ä¼šé‡Šæ”¾é”ã€‚<br># äºæ˜¯çº¿ç¨‹ <span class="hljs-number">2</span> ä¸€ç›´æŒæœ‰è¿™æŠŠé”ç›´åˆ°ä¸šåŠ¡æ‰§è¡Œç»“æŸåæ‰ä¼šé‡Šæ”¾ï¼Œå¹¶ä¸”åœ¨é‡Šæ”¾æ—¶ä¹Ÿéœ€è¦åˆ¤æ–­å½“å‰è¦é‡Šæ”¾çš„é”æ˜¯å¦å±äºè‡ªå·±ã€‚<br>del lock:order:<span class="hljs-number">1</span><br><br># çº¿ç¨‹ <span class="hljs-number">3</span> è·å–åˆ°é”å¹¶æ‰§è¡Œä¸šåŠ¡<br>setnx lock:order:<span class="hljs-number">1</span> thread03<br></code></pre></td></tr></table></figure><img src="/posts/redis%E8%A7%A3%E5%86%B3%E5%B8%B8%E8%A7%81%E7%9A%84%E7%A7%92%E6%9D%80%E9%97%AE%E9%A2%98/image-20250307152348573.png" class title="image-20250307152348573"><p>åŸºäº Redis çš„åˆ†å¸ƒå¼é”çš„å®ç°ï¼ˆè§£å†³è¯¯åˆ é—®é¢˜ï¼‰</p><ol><li><p>ç›¸è¾ƒäºæœ€å¼€å§‹åˆ†å¸ƒå¼é”çš„å®ç°ï¼Œåªéœ€è¦å¢åŠ ä¸€ä¸ªåŠŸèƒ½ï¼šé‡Šæ”¾é”æ—¶éœ€è¦åˆ¤æ–­å½“å‰é”æ˜¯å¦å±äºè‡ªå·±ã€‚ï¼ˆè€Œé›†ç¾¤ç¯å¢ƒä¸‹ä¸åŒ JVM ä¸­çš„çº¿ç¨‹ ID å¯èƒ½ç›¸åŒï¼Œå¢åŠ ä¸€ä¸ª UUID åŒºåˆ†ä¸åŒ JVMï¼‰</p></li><li><p>å› æ­¤é€šè¿‡åˆ†å¸ƒå¼é”å­˜å…¥ Redis ä¸­çš„çº¿ç¨‹æ ‡è¯†åŒ…æ‹¬ï¼š<strong>UUID (æœåŠ¡å™¨id)+ çº¿ç¨‹ ID(çº¿ç¨‹id)</strong>ã€‚UUID ç”¨äºåŒºåˆ†ä¸åŒæœåŠ¡å™¨ä¸­çº¿ç¨‹ ID ç›¸åŒçš„çº¿ç¨‹ï¼Œçº¿ç¨‹ ID ç”¨äºåŒºåˆ†ç›¸åŒæœåŠ¡å™¨çš„ä¸åŒçº¿ç¨‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleDistributedLockBasedOnRedis</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DistributedLock</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SimpleDistributedLockBasedOnRedis</span><span class="hljs-params">(String name, StringRedisTemplate stringRedisTemplate)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lock:&quot;</span>;<br><br>  <span class="hljs-comment">// ID_PREFIX åœ¨å½“å‰ JVM ä¸­æ˜¯ä¸å˜çš„ï¼Œä¸»è¦ç”¨äºåŒºåˆ†ä¸åŒ JVM</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ID_PREFIX</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString(<span class="hljs-literal">true</span>) + <span class="hljs-string">&quot;-&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è·å–é”</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> timeoutSeconds)</span> &#123;<br>      <span class="hljs-comment">// UUID ç”¨äºåŒºåˆ†ä¸åŒæœåŠ¡å™¨ä¸­çº¿ç¨‹ ID ç›¸åŒçš„çº¿ç¨‹ï¼›çº¿ç¨‹ ID ç”¨äºåŒºåˆ†åŒä¸€ä¸ªæœåŠ¡å™¨ä¸­çš„çº¿ç¨‹ã€‚</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">threadIdentifier</span> <span class="hljs-operator">=</span> ID_PREFIX + Thread.currentThread().getId();<br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">isSucceeded</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue()<br>                .setIfAbsent(KEY_PREFIX + name, threadIdentifier, timeoutSeconds, TimeUnit.SECONDS);<br>        <span class="hljs-keyword">return</span> Boolean.TRUE.equals(isSucceeded);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * é‡Šæ”¾é”ï¼ˆé‡Šæ”¾é”å‰é€šè¿‡åˆ¤æ–­ Redis ä¸­çš„çº¿ç¨‹æ ‡è¯†ä¸å½“å‰çº¿ç¨‹çš„çº¿ç¨‹æ ‡è¯†æ˜¯å¦ä¸€è‡´ï¼Œè§£å†³è¯¯åˆ é—®é¢˜ï¼‰</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// UUID ç”¨äºåŒºåˆ†ä¸åŒæœåŠ¡å™¨ä¸­çº¿ç¨‹ ID ç›¸åŒçš„çº¿ç¨‹ï¼›çº¿ç¨‹ ID ç”¨äºåŒºåˆ†åŒä¸€ä¸ªæœåŠ¡å™¨ä¸­çš„çº¿ç¨‹ã€‚</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">threadIdentifier</span> <span class="hljs-operator">=</span> THREAD_PREFIX + Thread.currentThread().getId();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">threadIdentifierFromRedis</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(KEY_PREFIX + name);<br>        <span class="hljs-comment">// æ¯”è¾ƒ Redis ä¸­çš„çº¿ç¨‹æ ‡è¯†ä¸å½“å‰çš„çº¿ç¨‹æ ‡è¯†æ˜¯å¦ä¸€è‡´</span><br>        <span class="hljs-keyword">if</span> (!StrUtil.equals(threadIdentifier, threadIdentifierFromRedis)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.OPERATION_ERROR, <span class="hljs-string">&quot;é‡Šæ”¾é”å¤±è´¥&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// é‡Šæ”¾é”æ ‡è¯†</span><br>        stringRedisTemplate.delete(KEY_PREFIX + name);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li></ol><h3><span id="ç”¨luaè„šæœ¬è§£å†³åŸå­æ€§é—®é¢˜">ç”¨Luaè„šæœ¬è§£å†³åŸå­æ€§é—®é¢˜</span></h3><p><strong>åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜</strong></p><ol><li><p>çº¿ç¨‹ 1 è·å–åˆ°é”å¹¶æ‰§è¡Œå®Œä¸šåŠ¡ï¼Œåˆ¤æ–­é”æ ‡è¯†ä¸€è‡´åé‡Šæ”¾é”ï¼Œ<strong>é‡Šæ”¾é”çš„è¿‡ç¨‹ä¸­é˜»å¡ï¼Œå¯¼è‡´é”æ²¡æœ‰é‡Šæ”¾æˆåŠŸï¼Œå¹¶ä¸”é˜»å¡çš„æ—¶é—´è¶…è¿‡äº†é”çš„ TTL é‡Šæ”¾ï¼Œå¯¼è‡´é”è‡ªåŠ¨é‡Šæ”¾ã€‚</strong></p></li><li><p>æ­¤æ—¶çº¿ç¨‹ 2 è·å–åˆ°é”ï¼Œæ‰§è¡Œä¸šåŠ¡ï¼›åœ¨çº¿ç¨‹ 2 æ‰§è¡Œä¸šåŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹ 1 å®Œæˆé‡Šæ”¾é”æ“ä½œã€‚</p></li><li><p><strong>ä¹‹åï¼Œçº¿ç¨‹ 3 è·å–åˆ°é”ï¼Œæ‰§è¡Œä¸šåŠ¡ï¼Œåˆä¸€æ¬¡å¯¼è‡´æ­¤æ—¶æœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶åœ¨å¹¶è¡Œæ‰§è¡Œä¸šåŠ¡</strong>ã€‚</p></li></ol><p>å› æ­¤ï¼Œéœ€è¦ä¿è¯ <strong><code>unlock()</code> æ–¹æ³•çš„åŸå­æ€§</strong>ï¼Œå³åˆ¤æ–­çº¿ç¨‹æ ‡è¯†çš„ä¸€è‡´æ€§å’Œé‡Šæ”¾é”è¿™ä¸¤ä¸ªæ“ä½œçš„åŸå­æ€§ã€‚</p><p><strong>Redis æä¾›äº† Lua è„šæœ¬åŠŸèƒ½ï¼Œåœ¨ä¸€ä¸ªè„šæœ¬ä¸­ç¼–å†™å¤šæ¡ Redis å‘½ä»¤ï¼Œç¡®ä¿ Redis å¤šæ¡å‘½ä»¤æ‰§è¡Œæ—¶çš„åŸå­æ€§ã€‚</strong></p><p>unlockæ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> DefaultRedisScript&lt;Long&gt; UNLOCK_SCRIPT;<br><br><span class="hljs-keyword">static</span>&#123;<span class="hljs-comment">//å†™æˆé™æ€ä»£ç å—ï¼Œç±»åŠ è½½å°±å¯ä»¥å®Œæˆåˆå§‹å®šä¹‰ï¼Œå°±ä¸ç”¨æ¯æ¬¡é‡Šæ”¾é”éƒ½å»åŠ è½½è¿™ä¸ªï¼Œæ€§èƒ½æé«˜å’¯</span><br>    UNLOCK_SCRIPT = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;();<br>    UNLOCK_SCRIPT.setLocation(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(<span class="hljs-string">&quot;unlock.lua&quot;</span>));<span class="hljs-comment">//è®¾ç½®è„šæœ¬ä½ç½®</span><br>    UNLOCK_SCRIPT.setResultType(Long.class);<br>&#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">//è°ƒç”¨luaè„šæœ¬</span><br>        stringRedisTemplate.execute(<br>                UNLOCK_SCRIPT,<br>                Collections.singletonList(KEY_PREFIX + name),<br>                ID_PREFIX + Thread.currentThread().getId()<br>        );<br>    &#125;<br><br></code></pre></td></tr></table></figure><p>Luaè„šæœ¬</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- é”çš„key</span><br><span class="hljs-comment">-- local key = KEYS[1]</span><br><span class="hljs-comment">-- å½“å‰çº¿ç¨‹æ ‡è¯†</span><br><span class="hljs-comment">-- local threadId = ARGV[1]</span><br><span class="hljs-comment">-- è·å–é”ä¸­çš„çº¿ç¨‹æ ‡è¯†</span><br><span class="hljs-keyword">if</span>(redis.call(<span class="hljs-string">&#x27;get&#x27;</span>,KEYS[<span class="hljs-number">1</span>]) == ARGV[<span class="hljs-number">1</span>]) <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> redis.call(<span class="hljs-string">&#x27;del&#x27;</span>,KEYS[<span class="hljs-number">1</span>])<br><span class="hljs-keyword">end</span> <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1&gt;ç§’æ€é—®é¢˜&lt;/h1&gt;</summary>
    
    
    
    <category term="redisçš„åº”ç”¨" scheme="https://garybyd.github.io/categories/redis%E7%9A%84%E5%BA%94%E7%94%A8/"/>
    
    
    <category term="redis" scheme="https://garybyd.github.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>redisç¼“å­˜çš„åº”ç”¨</title>
    <link href="https://garybyd.github.io/posts/redis%E7%BC%93%E5%AD%98%E7%9A%84%E5%BA%94%E7%94%A8/"/>
    <id>https://garybyd.github.io/posts/redis%E7%BC%93%E5%AD%98%E7%9A%84%E5%BA%94%E7%94%A8/</id>
    <published>2025-03-06T08:34:51.000Z</published>
    <updated>2025-03-07T08:14:46.464Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="ç®€å•çš„ç¼“å­˜ç­–ç•¥">ç®€å•çš„ç¼“å­˜ç­–ç•¥</span></h2><span id="more"></span><img src="/posts/redis%E7%BC%93%E5%AD%98%E7%9A%84%E5%BA%94%E7%94%A8/image-20250306163757455.png" class title="image-20250306163757455"><!-- more--><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShopServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;ShopMapper, Shop&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IShopService</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">querygetById</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-comment">//1.ä»Rediså†…æŸ¥è¯¢å•†å“ç¼“å­˜</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">shopJson</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);<br>        <span class="hljs-keyword">if</span>(StrUtil.isNotBlank(shopJson))&#123;<br>            <span class="hljs-comment">//æ‰‹åŠ¨ååºåˆ—åŒ–</span><br>            <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> JSONUtil.toBean(shopJson, Shop.class);<br>            <span class="hljs-keyword">return</span> Result.ok(shop);<br>        &#125;<br>        <span class="hljs-comment">//2.ä¸å­˜åœ¨å°±æ ¹æ®idæŸ¥è¯¢æ•°æ®åº“</span><br>        <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> getById(id);<br>        <span class="hljs-keyword">if</span>(shop==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;å•†æˆ·ä¸å­˜åœ¨ï¼&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">//3.æ•°æ®åº“æ•°æ®å†™å…¥Redis</span><br>        <span class="hljs-comment">//æ‰‹åŠ¨åºåˆ—åŒ–</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">shopStr</span> <span class="hljs-operator">=</span> JSONUtil.toJsonStr(shop);<br>        stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id,shopStr,CACHE_SHOP_TTL, TimeUnit.MINUTES);<br>        <span class="hljs-keyword">return</span> Result.ok(shop);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2><span id="ç¼“å­˜æ›´æ–°ç­–ç•¥">ç¼“å­˜æ›´æ–°ç­–ç•¥</span></h2><img src="/posts/redis%E7%BC%93%E5%AD%98%E7%9A%84%E5%BA%94%E7%94%A8/image-20250306163925900.png" class title="image-20250306163925900"><p>ç¼“å­˜æ›´æ–°ç­–ç•¥çš„æœ€ä½³æ–¹æ¡ˆï¼š</p><ol><li>ä½ä¸€è‡´æ€§éœ€æ±‚ï¼šä½¿ç”¨Redisè‡ªå¸¦çš„å†…å­˜æ·˜æ±°æœºåˆ¶</li><li>é«˜ä¸€è‡´æ€§éœ€æ±‚ï¼šä¸»åŠ¨æ›´æ–°ï¼Œè¶…æ—¶å‰”é™¤çš„æ–¹å¼ä½œä¸ºæ–—åœ°æ–¹æ¡ˆ<ul><li>è¯»æ“ä½œ<ul><li>ç¼“å­˜å‘½ä¸­å°±ç›´æ¥è¿”å›</li><li>ç¼“å­˜æœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“</li></ul></li><li>å†™æ“ä½œï¼š<ul><li>å…ˆå†™æ•°æ®åº“ï¼Œç„¶åå†åˆ é™¤ç¼“å­˜</li><li>è¦ç¡®ä¿æ•°æ®åº“ä¸ç¼“å­˜æ“ä½œçš„åŸå­æ€§</li></ul></li></ul></li></ol><p><code>æ“ä½œç¼“å­˜å’Œæ•°æ®åº“æ—¶éœ€è¦è€ƒè™‘çš„ä¸‰ä¸ªé—®é¢˜</code></p><ol><li>åˆ é™¤ç¼“å­˜è¿˜æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ<ul><li><strong>æ¯æ¬¡æ›´æ–°æ•°æ®åº“çš„åŒæ—¶æ›´æ–°ç¼“å­˜</strong>ï¼šè‹¥æ•°æ®åº“æ›´æ–°äº† 100 æ¬¡ï¼ŒæœŸé—´æ²¡æœ‰ä»»ä½•æŸ¥è¯¢è¯·æ±‚ï¼Œæ­¤æ—¶ç¼“å­˜çš„æ›´æ–°å°±æ˜¯æ— æ•ˆæ“ä½œã€‚</li><li><strong>æ•°æ®åº“æ›´æ–°å°±åˆ é™¤ç¼“å­˜</strong>ï¼šæ•°æ®åº“æ›´æ–°åç¼“å­˜è¢«åˆ é™¤ï¼Œæ­¤æ—¶æ•°æ®åº“æ— è®ºæ›´æ–°å¤šå°‘æ¬¡ï¼Œç¼“å­˜éƒ½ä¸ä¼šåšä»»ä½•æ“ä½œã€‚ç›´åˆ°æœ‰æŸ¥è¯¢è¯·æ±‚ï¼Œç¼“å­˜æ‰ä¼šå°†æ•°æ®åº“ä¸­çš„æ•°æ®å†™å…¥åˆ°ç¼“å­˜ä¸­ã€‚</li></ul></li><li>å¦‚ä½•ä¿è¯ç¼“å­˜å’Œæ•°æ®åº“çš„æ“ä½œåŒæ—¶æˆåŠŸæˆ–å¤±è´¥ï¼Ÿ<ul><li>å•ä½“ç³»ç»Ÿï¼šå°†ç¼“å­˜ä¸æ•°æ®åº“æ“ä½œæ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡ã€‚</li><li>åˆ†å¸ƒå¼ç³»ç»Ÿï¼šåˆ©ç”¨ TCC ç­‰åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆã€‚</li></ul></li><li>å…ˆæ“ä½œç¼“å­˜è¿˜æ˜¯å…ˆæ“ä½œæ•°æ®åº“ï¼Ÿ<ul><li><strong>å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ“ä½œæ•°æ®åº“</strong>ã€‚å‡è®¾ç¼“å­˜ä¸º 10ï¼Œæ•°æ®åº“ä¸º 10ã€‚ï¼ˆt1ã€t2ã€t3 ä»£è¡¨ä¸‰ä¸ªæ—¶åˆ»ï¼‰<ul><li>t1ï¼šçº¿ç¨‹ 1 åˆ é™¤ç¼“å­˜ï¼Œå¹¶æ›´æ–°æ•°æ®åº“ä¸º 20ã€‚t2ï¼šçº¿ç¨‹ 2 æŸ¥è¯¢ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“ä¸­æŸ¥è¯¢å¹¶å†™å…¥ç¼“å­˜ã€‚âœ”ï¸</li><li>t1ï¼šçº¿ç¨‹ 1 åˆ é™¤ç¼“å­˜ã€‚t2ï¼šçº¿ç¨‹ 2 æŸ¥è¯¢ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“ä¸­æŸ¥è¯¢å¹¶å†™å…¥ç¼“å­˜ã€‚t3ï¼šçº¿ç¨‹ t1 æ›´æ–°æ•°æ®åº“ä¸º 20ã€‚âŒ</li></ul></li><li>**å…ˆæ“ä½œæ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ã€‚**å‡è®¾ç¼“å­˜ä¸º 10ï¼Œæ•°æ®åº“ä¸º 10ã€‚ï¼ˆt1ã€t2ã€t3ã€t4 ä»£è¡¨å››ä¸ªæ—¶åˆ»ï¼‰<ul><li>t1ï¼šçº¿ç¨‹ 1 æ›´æ–°æ•°æ®åº“ä¸º 20ï¼Œåˆ é™¤ç¼“å­˜ã€‚t2ï¼šçº¿ç¨‹ 2 æŸ¥è¯¢ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“ä¸­æŸ¥è¯¢å¹¶å†™å…¥ç¼“å­˜ã€‚âœ”ï¸</li><li>t1ï¼šçº¿ç¨‹ 1 æŸ¥è¯¢ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“ä¸­æŸ¥è¯¢ã€‚t2ï¼šçº¿ç¨‹ 2 æ›´æ–°æ•°æ®åº“ä¸º 20ï¼Œåˆ é™¤ç¼“å­˜ã€‚t3ï¼šçº¿ç¨‹ 1 å†™å…¥ç¼“å­˜ã€‚âŒï¼ˆè¿™ç§æ–¹å¼å‡ºç°çš„æ¦‚ç‡å¾ˆå°ï¼Œç¼“å­˜å†™å…¥çš„é€Ÿåº¦å¾ˆå¿«ã€‚æ›´å¯èƒ½å‡ºç°çš„æƒ…å†µæ˜¯ï¼šçº¿ç¨‹ 1 å†™å…¥ç¼“å­˜åï¼Œçº¿ç¨‹ 2 æ›´æ–°æ•°æ®åº“ç„¶åå°†ç¼“å­˜åˆ é™¤ï¼‰</li></ul></li></ul></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">update</span><span class="hljs-params">(Shop shop)</span> &#123;<br>    <span class="hljs-keyword">if</span>(shop.getId()==<span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;åº—é“ºidä¸èƒ½ä¸ºç©º!&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//1.æ›´æ–°æ•°æ®åº“</span><br>    updateById(shop);<br>    <span class="hljs-comment">//2.åˆ é™¤ç¼“å­˜</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> CACHE_SHOP_KEY + shop.getId();<br>    stringRedisTemplate.delete(key);<br>    <span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br></code></pre></td></tr></table></figure><h2><span id="ç¼“å­˜ç©¿é€é—®é¢˜">ç¼“å­˜ç©¿é€é—®é¢˜</span></h2><img src="/posts/redis%E7%BC%93%E5%AD%98%E7%9A%84%E5%BA%94%E7%94%A8/image-20250306164904456.png" class title="image-20250306164904456"><h3><span id="ç¼“å­˜ç©ºå¯¹è±¡æ–¹æ¡ˆ">ç¼“å­˜ç©ºå¯¹è±¡æ–¹æ¡ˆ</span></h3><p>å®¢æˆ·ç«¯è¯·æ±‚çš„æ•°æ®åœ¨ Redis å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œä¸ºäº†é˜²æ­¢ä¸æ–­çš„è¯·æ±‚ï¼šå°† ç©ºå€¼ ç¼“å­˜åˆ° Redis ä¸­å¹¶ä¸”è®¾ç½® TTL æ—¶é—´åï¼Œè¿”å›ç»™è¯¥è¯·æ±‚ã€‚</p><ul><li><p>ç¼“å­˜ä¸­åŒ…å«è¿‡å¤šçš„ ç©ºå€¼ï¼Œä¼šé€ æˆé¢å¤–çš„å†…å­˜æ¶ˆè€—ã€‚ï¼ˆè®¾ç½® TTL å¯ä»¥ç¼“è§£ï¼‰</p></li><li><p>å¯èƒ½é€ æˆçŸ­æœŸçš„ä¸ä¸€è‡´ï¼šç¬¬ä¸€æ¬¡è¯·æ±‚çš„æ•°æ®åœ¨ Redis å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œç¼“å­˜ç©ºå¯¹è±¡åï¼Œæ•°æ®åº“ä¸­æ–°å¢äº†è¯¥è¯·æ±‚å¯¹åº”çš„æ•°æ®</p></li></ul><img src="/posts/redis%E7%BC%93%E5%AD%98%E7%9A%84%E5%BA%94%E7%94%A8/image-20250306164930772.png" class title="image-20250306164930772"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> CommonResult&lt;Shop&gt; <span class="hljs-title function_">getShopById</span><span class="hljs-params">(Long id)</span> &#123;<br>    ThrowUtils.throwIf(id == <span class="hljs-literal">null</span>, ErrorCode.PARAMS_ERROR);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">shopKey</span> <span class="hljs-operator">=</span> CACHE_SHOP_KEY + id;<br><br>    <span class="hljs-comment">// 1. å…ˆä» Redis ä¸­æŸ¥è¯¢æ•°æ®ï¼Œå­˜åœ¨åˆ™å°†å…¶è½¬æ¢ä¸º Java å¯¹è±¡åè¿”å›</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">shopJsonInRedis</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(shopKey);<br>    <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(shopJsonInRedis)) &#123;<br>        <span class="hljs-keyword">return</span> CommonResult.success(JSONUtil.toBean(shopJsonInRedis, Shop.class));<br>    &#125;<br>  <span class="hljs-comment">// å‘½ä¸­ç©ºå€¼</span><br><span class="hljs-keyword">if</span> (shopJsonInRedis != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.NOT_FOUND_ERROR, <span class="hljs-string">&quot;è¯¥å•†é“ºä¸å­˜åœ¨&quot;</span>);<br>&#125;<br><br>    <span class="hljs-comment">// 2. ä» Redis ä¸­æœªæŸ¥è¯¢åˆ°æ•°æ®ï¼Œåˆ™ä»æ•°æ®åº“ä¸­æŸ¥è¯¢</span><br>    <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getById(id);<br>    <br>    <span class="hljs-comment">// è‹¥æ•°æ®ä¸­ä¹ŸæŸ¥è¯¢ä¸åˆ°ï¼Œåˆ™ç¼“å­˜ç©ºå€¼åè¿”å›æç¤ºä¿¡æ¯</span><br>    <span class="hljs-keyword">if</span> (shop == <span class="hljs-literal">null</span>) &#123;<br>        stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, <span class="hljs-string">&quot;&quot;</span>, TTL_TWO, TimeUnit.MINUTES);<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.NOT_FOUND_ERROR, <span class="hljs-string">&quot;è¯¥å•†é“ºä¸å­˜åœ¨&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 3. å°†ä»æ•°æ®åº“ä¸­æŸ¥è¯¢åˆ°çš„æ•°æ®å­˜å…¥ Redis åè¿”å›</span><br>    stringRedisTemplate.opsForValue().set(shopKey, JSONUtil.toJsonStr(shop), TTL_TWO, TimeUnit.HOURS);<br>    <span class="hljs-keyword">return</span> CommonResult.success(shop);<br>&#125;<br><br></code></pre></td></tr></table></figure><h3><span id="å¸ƒéš†è¿‡æ»¤å™¨æ–¹æ¡ˆ">å¸ƒéš†è¿‡æ»¤å™¨æ–¹æ¡ˆ</span></h3><p><strong>å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloom Filterï¼‰</strong>ï¼šä¸€ä¸ªå¾ˆé•¿çš„äºŒè¿›åˆ¶æ•°ç»„ï¼ˆåˆå§‹åŒ–å€¼ä¸º 0ï¼‰ï¼Œé€šè¿‡ä¸€ç³»åˆ—çš„ Hash å‡½æ•°åˆ¤æ–­è¯¥æ•°æ®æ˜¯å¦å­˜åœ¨ã€‚ å¸ƒéš†è¿‡æ»¤å™¨çš„è¿è¡Œé€Ÿåº¦å¿«ã€å†…å­˜å ç”¨å°ï¼Œä½†æ˜¯å­˜åœ¨è¯¯åˆ¤çš„å¯èƒ½ã€‚</p><ol><li>å­˜å‚¨æ•°æ®æ—¶ç»è¿‡ n ä¸ª hash å‡½æ•°ï¼Œè®¡ç®—å‡º n ä¸ª hash å€¼ï¼Œhash å€¼æ˜ å°„åå¾—åˆ° n ä¸ªç´¢å¼•ï¼Œè®¾ç½®ç´¢å¼•å¤„çš„å€¼ä¸º 1ã€‚ï¼ˆè‹¥å½“å‰ç´¢å¼•å¤„å€¼å·²ç»ä¸º 1ï¼Œåˆ™ä¸éœ€è¦ä»»ä½•æ“ä½œï¼‰</li><li>æŸ¥è¯¢æ•°æ®æ—¶ä¹Ÿä¼šç»è¿‡ n ä¸ª hash å‡½æ•°ï¼Œè®¡ç®—å‡º n ä¸ª hash å€¼ï¼Œhash å€¼æ˜ å°„åå¾—åˆ° n ä¸ªç´¢å¼•ï¼Œåˆ¤æ–­ç´¢å¼•å¤„çš„å€¼æ˜¯å¦ä¸º 1ã€‚<ul><li>æŸ¥è¯¢ Anthonyï¼šç»è¿‡ hash ç®—æ³•å¾—åˆ°çš„ hash å€¼æ˜ å°„åæ•°ç»„ä¸‹æ ‡ä¸º 0ã€2ã€6ï¼Œä¸‹æ ‡å¯¹åº”çš„å€¼æ²¡æœ‰å…¨ä¸º 1ï¼Œæ•°ç»„ä¸­ä¸å­˜åœ¨è¯¥å…ƒç´ ã€‚</li><li>æŸ¥è¯¢ Cocoï¼šç»è¿‡ hash ç®—æ³•å¾—åˆ°çš„ hash å€¼æ˜ å°„åæ•°ç»„ä¸‹æ ‡ä¸º 0ã€2ã€6ï¼Œä¸‹æ ‡å¯¹åº”çš„å€¼éƒ½ä¸º 1ï¼Œæ•°ç»„ä¸­å¯èƒ½å­˜åœ¨è¯¥å…ƒç´ ã€‚</li></ul></li></ol><img src="/posts/redis%E7%BC%93%E5%AD%98%E7%9A%84%E5%BA%94%E7%94%A8/image-20250306165707756.png" class title="image-20250306165707756"><h2><span id="ç¼“å­˜é›ªå´©é—®é¢˜">ç¼“å­˜é›ªå´©é—®é¢˜ï¼š</span></h2><img src="/posts/redis%E7%BC%93%E5%AD%98%E7%9A%84%E5%BA%94%E7%94%A8/image-20250306170151397.png" class title="image-20250306170151397"><p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p><ul><li><strong>ç»™ä¸åŒçš„Keyçš„TTLæ·»åŠ éšæœºå€¼</strong></li><li><strong>åˆ©ç”¨Redisé›†ç¾¤æé«˜æœåŠ¡çš„å¯ç”¨æ€§</strong></li><li><strong>ç»™ç¼“å­˜ä¸šåŠ¡æ·»åŠ é™çº§é™æµç­–ç•¥</strong></li><li><strong>ç»™ä¸šåŠ¡æ·»åŠ å¤šçº§ç¼“å­˜</strong></li></ul><h2><span id="ç¼“å­˜å‡»ç©¿é—®é¢˜">ç¼“å­˜å‡»ç©¿é—®é¢˜</span></h2><p><strong>ç¼“å­˜å‡»ç©¿é—®é¢˜ï¼Œä¹Ÿå« çƒ­ç‚¹ Key é—®é¢˜ï¼›å°±æ˜¯ä¸€ä¸ªè¢« é«˜å¹¶å‘è®¿é—® å¹¶ä¸” ç¼“å­˜ä¸­ä¸šåŠ¡è¾ƒå¤æ‚çš„ Key çªç„¶å¤±æ•ˆï¼Œå¤§é‡çš„è¯·æ±‚åœ¨æçŸ­çš„æ—¶é—´å†…ä¸€èµ·è¯·æ±‚è¿™ä¸ª Key å¹¶ä¸”éƒ½æœªå‘½ä¸­ï¼Œæ— æ•°çš„è¯·æ±‚è®¿é—®åœ¨ç¬é—´æ‰“åˆ°æ•°æ®åº“ä¸Šï¼Œç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§çš„å†²å‡»ã€‚</strong></p><p><strong>ç¼“å­˜å‡»ç©¿æ•´ä½“è¿‡ç¨‹ï¼š</strong></p><ol><li>ä¸€ä¸ªçº¿ç¨‹æŸ¥è¯¢ç¼“å­˜ï¼Œæœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜ï¼ˆç¼“å­˜é‡å»ºä¸šåŠ¡æ¯”è¾ƒå¤æ‚ï¼Œæ—¶é—´é•¿ï¼‰ã€‚</li><li>åœ¨è¿™ä¸ªé‡å»ºç¼“å­˜çš„è¿‡ç¨‹ä¸­ï¼Œå¤§é‡çš„è¯·æ±‚ç©¿è¿‡ç¼“å­˜ç›´æ¥è¯·æ±‚æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜ï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</li></ol><p>è§£å†³æ–¹æ¡ˆï¼š<strong>äº’æ–¥é”(ä¸€è‡´æ€§)ã€é€»è¾‘è¿‡æœŸ(å¯ç”¨æ€§)</strong></p><img src="/posts/redis%E7%BC%93%E5%AD%98%E7%9A%84%E5%BA%94%E7%94%A8/image-20250306201047580.png" class title="image-20250306201047580"><h3><span id="äº’æ–¥é”æ–¹æ¡ˆ">äº’æ–¥é”æ–¹æ¡ˆ</span></h3><p>synchronized</p><ol><li>æŸ¥è¯¢ç¼“å­˜ï¼Œå­˜åœ¨åˆ™ç›´æ¥è¿”å›ã€‚</li><li>ä¸å­˜åœ¨ï¼šæ‰§è¡Œ synchronized ä»£ç å—ã€‚<ol><li>å…ˆæŸ¥ç¼“å­˜ï¼Œå­˜åœ¨åˆ™ç›´æ¥è¿”å›ã€‚ï¼ˆè‹¥å¤šä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°åŒæ­¥ä»£ç å—ï¼ŒæŸä¸ªçº¿ç¨‹æ‹¿åˆ°é”æŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜åï¼Œå…¶ä»–æ‹¿åˆ°é”è¿›æ¥çš„çº¿ç¨‹ç›´æ¥æŸ¥è¯¢ç¼“å­˜åè¿”å›ï¼Œé¿å…é‡å¤æŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜ï¼‰</li><li>æŸ¥è¯¢æ•°æ®åº“ï¼Œé‡å»ºç¼“å­˜ã€‚</li></ol></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SneakyThrows</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> CommonResult&lt;Shop&gt; <span class="hljs-title function_">getShopById</span><span class="hljs-params">(Long id)</span> &#123;<br>    ThrowUtils.throwIf(id == <span class="hljs-literal">null</span>, ErrorCode.PARAMS_ERROR);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">shopKey</span> <span class="hljs-operator">=</span> CACHE_SHOP_KEY + id;<br><br>    <span class="hljs-comment">// 1. å…ˆä» Redis ä¸­æŸ¥è¯¢æ•°æ®ï¼Œå­˜åœ¨åˆ™å°†å…¶è½¬æ¢ä¸º Java å¯¹è±¡åè¿”å›</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">shopJsonInRedis</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(shopKey);<br>    <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(shopJsonInRedis)) &#123;<br>        <span class="hljs-keyword">return</span> CommonResult.success(JSONUtil.toBean(shopJsonInRedis, Shop.class));<br>    &#125;<br>  <span class="hljs-comment">// å‘½ä¸­ç©ºå€¼</span><br><span class="hljs-keyword">if</span> (shopJsonInRedis != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.NOT_FOUND_ERROR, <span class="hljs-string">&quot;è¯¥å•†é“ºä¸å­˜åœ¨&quot;</span>);<br>&#125;<br><br>    <span class="hljs-comment">// 2. ä» Redis ä¸­æœªæŸ¥è¯¢åˆ°æ•°æ®ï¼Œåˆ™ä»æ•°æ®åº“ä¸­æŸ¥è¯¢ã€‚ï¼ˆsynchronizedï¼‰</span><br>    <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Shop</span>();<br>    <span class="hljs-keyword">synchronized</span> (ShopServiceImpl.class) &#123;<br>        <span class="hljs-comment">// 3. å†æ¬¡æŸ¥è¯¢ Redisï¼šè‹¥å¤šä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°åŒæ­¥ä»£ç å—ï¼ŒæŸä¸ªçº¿ç¨‹æ‹¿åˆ°é”æŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜åï¼Œå…¶ä»–æ‹¿åˆ°é”è¿›æ¥çš„çº¿ç¨‹ç›´æ¥æŸ¥è¯¢ç¼“å­˜åè¿”å›ï¼Œé¿å…é‡å¤æŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜ã€‚</span><br>        shopJsonInRedis = stringRedisTemplate.opsForValue().get(shopKey);<br>        <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(shopJsonInRedis)) &#123;<br>            <span class="hljs-keyword">return</span> CommonResult.success(JSONUtil.toBean(shopJsonInRedis, Shop.class));<br>        &#125;<br><br>        <span class="hljs-comment">// 4. æŸ¥è¯¢æ•°æ®åº“ï¼Œç¼“å­˜ç©ºå€¼é¿å…ç¼“å­˜ç©¿é€ï¼Œé‡å»ºç¼“å­˜ã€‚</span><br>        shop = <span class="hljs-built_in">this</span>.getById(id);<br>        <span class="hljs-keyword">if</span> (shop == <span class="hljs-literal">null</span>) &#123;<br>            stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, <span class="hljs-string">&quot;&quot;</span>, TTL_TWO, TimeUnit.MINUTES);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.NOT_FOUND_ERROR, <span class="hljs-string">&quot;è¯¥å•†é“ºä¸å­˜åœ¨&quot;</span>);<br>        &#125;<br>      <span class="hljs-comment">// æ¨¡æ‹Ÿç¼“å­˜é‡å»ºå»¶è¿Ÿ</span><br>        Thread.sleep(<span class="hljs-number">100</span>);<br>        stringRedisTemplate.opsForValue().set(shopKey, JSONUtil.toJsonStr(shop), TTL_TWO, TimeUnit.HOURS);<br>    &#125;<br>    <span class="hljs-keyword">return</span> CommonResult.success(shop);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”¨redisçš„setnxæ¥å……å½“åˆ†å¸ƒå¼é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * è·å–äº’æ–¥é”</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(String key)</span> &#123;<br>    <span class="hljs-type">Boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, <span class="hljs-string">&quot;1&quot;</span>, TTL_TWO, TimeUnit.SECONDS);<br>    <span class="hljs-keyword">return</span> Boolean.TRUE.equals(result);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * é‡Šæ”¾äº’æ–¥é”</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">(String key)</span> &#123;<br>    stringRedisTemplate.delete(key);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SneakyThrows</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> CommonResult&lt;Shop&gt; <span class="hljs-title function_">getShopById</span><span class="hljs-params">(Long id)</span> &#123;<br>    ThrowUtils.throwIf(id == <span class="hljs-literal">null</span>, ErrorCode.PARAMS_ERROR);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">shopKey</span> <span class="hljs-operator">=</span> CACHE_SHOP_KEY + id;<br>  <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> LOCK_SHOP_KEY + id;<br><br>    <span class="hljs-comment">// 1. å…ˆä» Redis ä¸­æŸ¥è¯¢æ•°æ®ï¼Œå­˜åœ¨åˆ™å°†å…¶è½¬æ¢ä¸º Java å¯¹è±¡åè¿”å›</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">shopJsonInRedis</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(shopKey);<br>    <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(shopJsonInRedis)) &#123;<br>        <span class="hljs-keyword">return</span> CommonResult.success(JSONUtil.toBean(shopJsonInRedis, Shop.class));<br>    &#125;<br>  <span class="hljs-comment">// å‘½ä¸­ç©ºå€¼</span><br><span class="hljs-keyword">if</span> (shopJsonInRedis != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.NOT_FOUND_ERROR, <span class="hljs-string">&quot;è¯¥å•†é“ºä¸å­˜åœ¨&quot;</span>);<br>&#125;<br><br>    <span class="hljs-comment">// 2. ä» Redis ä¸­æœªæŸ¥è¯¢åˆ°æ•°æ®ï¼Œå°è¯•è·å–é”åä»æ•°æ®åº“ä¸­æŸ¥è¯¢ã€‚</span><br>    <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Shop</span>();<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">tryLock</span> <span class="hljs-operator">=</span> tryLock(lockKey);<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 2.1 æœªè·å–åˆ°é”åˆ™ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•ï¼ˆé€šè¿‡é€’å½’è°ƒç”¨é‡è¯•ï¼‰</span><br>        <span class="hljs-keyword">if</span> (BooleanUtil.isFalse(tryLock)) &#123;<br>            Thread.sleep(<span class="hljs-number">50</span>);<br>            <span class="hljs-built_in">this</span>.getShopById(id);<br>        &#125;<br><br>        <span class="hljs-comment">// 2.2 è·å–åˆ°é”ï¼šæŸ¥è¯¢æ•°æ®åº“ã€ç¼“å­˜é‡å»ºã€‚</span><br>        <span class="hljs-keyword">if</span> (tryLock) &#123;<br>            <span class="hljs-comment">// 3. å†æ¬¡æŸ¥è¯¢ Redisï¼šè‹¥å¤šä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°è·å–é”å¤„ï¼ŒæŸä¸ªçº¿ç¨‹æ‹¿åˆ°é”æŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜åï¼Œå…¶ä»–æ‹¿åˆ°é”è¿›æ¥çš„çº¿ç¨‹ç›´æ¥æŸ¥è¯¢ç¼“å­˜åè¿”å›ï¼Œé¿å…é‡å¤æŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜ã€‚</span><br>            shopJsonInRedis = stringRedisTemplate.opsForValue().get(shopKey);<br>            <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(shopJsonInRedis)) &#123;<br>                <span class="hljs-keyword">return</span> CommonResult.success(JSONUtil.toBean(shopJsonInRedis, Shop.class));<br>            &#125;<br><br>            <span class="hljs-comment">// 4. æŸ¥è¯¢æ•°æ®åº“ï¼Œç¼“å­˜ç©ºå€¼é¿å…ç¼“å­˜ç©¿é€ï¼Œé‡å»ºç¼“å­˜ã€‚</span><br>            shop = <span class="hljs-built_in">this</span>.getById(id);<br>            <span class="hljs-keyword">if</span> (shop == <span class="hljs-literal">null</span>) &#123;<br>                stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, <span class="hljs-string">&quot;&quot;</span>, TTL_TWO, TimeUnit.MINUTES);<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.NOT_FOUND_ERROR, <span class="hljs-string">&quot;è¯¥å•†é“ºä¸å­˜åœ¨&quot;</span>);<br>            &#125;<br>          <span class="hljs-comment">// æ¨¡æ‹Ÿç¼“å­˜é‡å»ºå»¶è¿Ÿ</span><br>            Thread.sleep(<span class="hljs-number">100</span>);<br>            stringRedisTemplate.opsForValue().set(shopKey, JSONUtil.toJsonStr(shop), TTL_TWO, TimeUnit.HOURS);<br>        &#125;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-comment">// 5. é‡Šæ”¾é”</span><br>        unlock(lockKey);<br>    &#125;<br>    <span class="hljs-keyword">return</span> CommonResult.success(shop);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>é€»è¾‘è¿‡æœŸæ–¹æ¡ˆ</p><p>æ— éœ€è€ƒè™‘ç¼“å­˜é›ªå´©ï¼ˆRedis å®•æœºé™¤å¤–ï¼‰ã€ç¼“å­˜ç©¿é€é—®é¢˜ï¼šç¼“å­˜ä½•æ—¶è¿‡æœŸé€šè¿‡ä»£ç æ§åˆ¶è€Œé TTLã€‚éœ€è¦è¿›è¡Œæ•°æ®é¢„çƒ­ï¼Œç¼“å­˜æœªå‘½ä¸­æ—¶ç›´æ¥è¿”å›ç©ºã€‚</p><ol><li><p>å…ˆæŸ¥è¯¢ç¼“å­˜ï¼Œæœªå‘½ä¸­åˆ™ç›´æ¥è¿”å›ã€‚</p></li><li><p>å‘½ä¸­åˆ™åˆ¤æ–­ç¼“å­˜æ˜¯å¦è¿‡æœŸï¼Œæœªè¿‡æœŸåˆ™ç›´æ¥è¿”å›ã€‚</p></li><li><p>è¿‡æœŸï¼šè·å–é”ã€‚</p><ol><li>æœªè·å–åˆ°é”ï¼šç›´æ¥è¿”å›ã€‚</li><li>è·å–åˆ°é”ï¼šå¼€å¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹åç›´æ¥è¿”å›ï¼Œè¿™ä¸ªçº¿ç¨‹è´Ÿè´£é‡å»ºç¼“å­˜åé‡Šæ”¾é”ã€‚</li></ol></li></ol><p>å­˜å‚¨åˆ° Redis ä¸­çš„ Key æ°¸ä¹…æœ‰æ•ˆï¼Œè¿‡æœŸæ—¶é—´é€šè¿‡ä»£ç æ§åˆ¶è€Œé TTLã€‚Redis å­˜å‚¨çš„æ•°æ®éœ€è¦å¸¦ä¸Šä¸€ä¸ªé€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œå³ Shop å®ä½“ç±»ä¸­éœ€è¦ä¸€ä¸ªé€»è¾‘è¿‡æœŸæ—¶é—´å±æ€§ã€‚æ–°å»ºä¸€ä¸ª RedisDataï¼Œè¯¥ç±»åŒ…å«ä¸¤ä¸ªå±æ€§ expireTime å’Œ Dataï¼Œå¯¹åŸæ¥çš„ä»£ç æ²¡æœ‰å…¥ä¾µæ€§ã€‚</p><p><code>ç¼“å­˜é¢„çƒ­ï¼ˆå°†çƒ­ç‚¹æ•°æ®æå‰å­˜å‚¨åˆ° Redis ä¸­ï¼‰</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisData</span> &#123;<br>    <span class="hljs-keyword">private</span> LocalDateTime expireTime;<br>    <span class="hljs-keyword">private</span> Object data;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ç¼“å­˜é¢„çƒ­ï¼ˆå°†çƒ­ç‚¹æ•°æ®æå‰å­˜å‚¨åˆ° Redis ä¸­ï¼‰</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveHotDataIn2Redis</span><span class="hljs-params">(Long id, Long expireSeconds)</span> &#123;<br>    <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getById(id);<br>    ThrowUtils.throwIf(shop == <span class="hljs-literal">null</span>, ErrorCode.NOT_FOUND_ERROR, <span class="hljs-string">&quot;è¯¥æ•°æ®ä¸å­˜åœ¨&quot;</span>);<br>    <span class="hljs-type">RedisData</span> <span class="hljs-variable">redisData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisData</span>();<br>    redisData.setData(shop);<br>    redisData.setExpireTime(LocalDateTime.now().plusSeconds(expireSeconds));<br>    stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, JSONUtil.toJsonStr(redisData));<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"># Redis ä¸­å­˜å‚¨çš„æ•°æ®ä¼šå¤šä¸€ä¸ª expireTime çš„å€¼<br>&#123;<br>  <span class="hljs-string">&quot;expireTime&quot;</span>: <span class="hljs-number">1681660099861</span>,<br>  <span class="hljs-string">&quot;data&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;101èŒ¶é¤å…&quot;</span>,<br>    <span class="hljs-string">&quot;typeId&quot;</span>: <span class="hljs-number">1</span>,<br>    ...<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>é€»è¾‘è¿‡æœŸ</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ç¼“å­˜é¢„çƒ­ï¼ˆå°†çƒ­ç‚¹æ•°æ®æå‰å­˜å‚¨åˆ° Redis ä¸­ï¼‰</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveHotDataIn2Redis</span><span class="hljs-params">(Long id, Long expireSeconds)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getById(id);<br>    ThrowUtils.throwIf(shop == <span class="hljs-literal">null</span>, ErrorCode.NOT_FOUND_ERROR, <span class="hljs-string">&quot;è¯¥æ•°æ®ä¸å­˜åœ¨&quot;</span>);<br>    <span class="hljs-comment">// æ¨¡æ‹Ÿç¼“å­˜é‡å»ºå»¶è¿Ÿï¼Œè®©ä¸€éƒ¨åˆ†çº¿ç¨‹å…ˆæ‰§è¡Œå®Œæ¯•ï¼Œåœ¨æ­¤æœŸé—´ä¼šçŸ­æš‚çš„ä¸ä¸€è‡´</span><br>    Thread.sleep(<span class="hljs-number">200</span>);<br>    <span class="hljs-type">RedisData</span> <span class="hljs-variable">redisData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisData</span>();<br>    redisData.setData(shop);<br>    redisData.setExpireTime(LocalDateTime.now().plusSeconds(expireSeconds));<br>    stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, JSONUtil.toJsonStr(redisData));<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">ES</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br><br><span class="hljs-meta">@SneakyThrows</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> CommonResult&lt;Shop&gt; <span class="hljs-title function_">getShopById</span><span class="hljs-params">(Long id)</span> &#123;<br>    ThrowUtils.throwIf(id == <span class="hljs-literal">null</span>, ErrorCode.PARAMS_ERROR);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">shopKey</span> <span class="hljs-operator">=</span> CACHE_SHOP_KEY + id;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> LOCK_SHOP_KEY + id;<br>    <span class="hljs-comment">// 1. å…ˆä» Redis ä¸­æŸ¥è¯¢æ•°æ®ï¼Œæœªå‘½ä¸­åˆ™ç›´æ¥è¿”å›</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">redisDataJson</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(shopKey);<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(redisDataJson)) &#123;<br>        <span class="hljs-keyword">return</span> CommonResult.success(<span class="hljs-literal">null</span>);<br>    &#125;<br>    <span class="hljs-comment">// 2. åˆ¤æ–­æ˜¯å¦è¿‡æœŸï¼Œæœªè¿‡æœŸåˆ™ç›´æ¥è¿”å›</span><br>    <span class="hljs-type">RedisData</span> <span class="hljs-variable">redisData</span> <span class="hljs-operator">=</span> JSONUtil.toBean(redisDataJson, RedisData.class);<br>    <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> (JSONObject) redisData.getData();<br>    <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> JSONUtil.toBean(jsonObject, Shop.class);<br>    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">expireTime</span> <span class="hljs-operator">=</span> redisData.getExpireTime();<br>    <span class="hljs-keyword">if</span> (expireTime.isAfter(LocalDateTime.now())) &#123;<br>        <span class="hljs-keyword">return</span> CommonResult.success(shop);<br>    &#125;<br>    <span class="hljs-comment">// 3. æœªè·å–åˆ°é”ç›´æ¥è¿”å›</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">tryLock</span> <span class="hljs-operator">=</span> tryLock(lockKey);<br>    <span class="hljs-keyword">if</span> (BooleanUtil.isFalse(tryLock)) &#123;<br>        <span class="hljs-keyword">return</span> CommonResult.success(shop);<br>    &#125;<br>    <span class="hljs-comment">// 4. è·å–åˆ°é”ï¼šå¼€å¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹åè¿”å›æ—§æ•°æ®ã€‚ï¼ˆè¿™ä¸ªçº¿ç¨‹è´Ÿè´£æŸ¥è¯¢æ•°æ®åº“ã€é‡å»ºç¼“å­˜ï¼‰</span><br>    <span class="hljs-comment">// æ­¤å¤„æ— éœ€ DoubleCheckï¼Œå› ä¸ºæœªè·å–åˆ°é”ç›´æ¥è¿”å›æ—§æ•°æ®ï¼Œèƒ½ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°æ­¤å¤„</span><br>    ES.submit(() -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// æŸ¥è¯¢æ•°æ®åº“ã€é‡å»ºç¼“å­˜</span><br>            <span class="hljs-built_in">this</span>.saveHotDataIn2Redis(id, <span class="hljs-number">3600</span> * <span class="hljs-number">24L</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(e.getMessage());<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            unlock(lockKey);<br>        &#125;<br>    &#125;);<br>    <span class="hljs-keyword">return</span> CommonResult.success(shop);<br>&#125;<br><br></code></pre></td></tr></table></figure><h2><span id="æ€»ç»“redis-cacheå·¥å…·ç±»">æ€»ç»“Redis Cacheå·¥å…·ç±»ï¼š</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheClient</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">ES</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br>  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CacheClient</span><span class="hljs-params">(StringRedisTemplate stringRedisTemplate)</span> &#123;<br>        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è·å–é”</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, <span class="hljs-string">&quot;1&quot;</span>, TTL_TWO, TimeUnit.SECONDS);<br>        <span class="hljs-keyword">return</span> BooleanUtil.isTrue(result);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * é‡Šæ”¾é”</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">(String key)</span> &#123;<br>        stringRedisTemplate.delete(key);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ•°æ®é¢„çƒ­ï¼ˆå°†çƒ­ç‚¹æ•°æ®æå‰å­˜å‚¨åˆ° Redis ä¸­ï¼‰</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key        é¢„çƒ­æ•°æ®çš„ Key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> value      é¢„çƒ­æ•°æ®çš„ Value</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> expireTime é€»è¾‘è¿‡æœŸæ—¶é—´</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> timeUnit   æ—¶é—´å•ä½</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dataWarmUp</span><span class="hljs-params">(String key, Object value, Long expireTime, TimeUnit timeUnit)</span> &#123;<br>        <span class="hljs-type">RedisData</span> <span class="hljs-variable">redisData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisData</span>();<br>        redisData.setData(value);<br>        redisData.setExpireTime(LocalDateTime.now().plusSeconds(timeUnit.toSeconds(expireTime)));<br>        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å°† Java å¯¹è±¡åºåˆ—åŒ–ä¸º JSON å­˜å‚¨åˆ° Redis ä¸­å¹¶ä¸”è®¾ç½® TTL è¿‡æœŸæ—¶é—´</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key      String ç±»å‹çš„é”®</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> value    åºåˆ—åŒ–ä¸º JSON çš„å€¼</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> time     TTL è¿‡æœŸæ—¶é—´</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> timeUnit æ—¶é—´å•ä½</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String key, Object value, Long time, TimeUnit timeUnit)</span> &#123;<br>        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(value), time, timeUnit);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è§£å†³ç¼“å­˜ç©¿é€é—®ï¼ˆç¼“å­˜ç©ºå€¼ï¼‰</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> keyPrefix Key å‰ç¼€</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id        id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> type      å®ä½“ç±»å‹</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> function  æœ‰å‚æœ‰è¿”å›å€¼çš„å‡½æ•°</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> time      TTL è¿‡æœŸæ—¶é—´</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> timeUnit  æ—¶é—´å•ä½</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> &lt;R&gt;       å®ä½“ç±»å‹</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> &lt;ID&gt;      id ç±»å‹</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> è®¾ç½®æŸä¸ªå®ä½“ç±»çš„ç¼“å­˜ï¼Œå¹¶è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> &lt;R, ID&gt; R <span class="hljs-title function_">setWithCachePenetration</span><span class="hljs-params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; function, Long time, TimeUnit timeUnit)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> keyPrefix + id;<br><br>        <span class="hljs-comment">// 1. å…ˆä» Redis ä¸­æŸ¥è¯¢æ•°æ®ï¼Œå­˜åœ¨åˆ™å°†å…¶è½¬æ¢ä¸º Java å¯¹è±¡åè¿”å›</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">jsonStr</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>        <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(jsonStr)) &#123;<br>            <span class="hljs-keyword">return</span> JSONUtil.toBean(jsonStr, type);<br>        &#125;<br>        <span class="hljs-comment">// å‘½ä¸­ç©ºå€¼</span><br>        <span class="hljs-keyword">if</span> (jsonStr != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.NOT_FOUND_ERROR);<br>        &#125;<br><br>        <span class="hljs-comment">// 2. ä» Redis ä¸­æœªæŸ¥è¯¢åˆ°æ•°æ®ï¼Œåˆ™ä»æ•°æ®åº“ä¸­æŸ¥è¯¢</span><br>        <span class="hljs-type">R</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> function.apply(id);<br>        <span class="hljs-comment">// è‹¥æ•°æ®ä¸­ä¹ŸæŸ¥è¯¢ä¸åˆ°ï¼Œåˆ™ç¼“å­˜ç©ºå€¼åè¿”å›æç¤ºä¿¡æ¯</span><br>        <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>) &#123;<br>            stringRedisTemplate.opsForValue().set(key, <span class="hljs-string">&quot;&quot;</span>, TTL_TWO, TimeUnit.MINUTES);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.NOT_FOUND_ERROR);<br>        &#125;<br><br>        <span class="hljs-comment">// 3. å°†ä»æ•°æ®åº“ä¸­æŸ¥è¯¢åˆ°çš„æ•°æ®å­˜å…¥ Redis åè¿”å›</span><br>        <span class="hljs-built_in">this</span>.set(key, result, time, timeUnit);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜ï¼ˆsynchronizedï¼‰</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> &lt;R, ID&gt; R <span class="hljs-title function_">setWithCacheBreakdown4Synchronized</span><span class="hljs-params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; function, Long time, TimeUnit timeUnit)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> keyPrefix + id;<br><br>        <span class="hljs-comment">// 1. å…ˆä» Redis ä¸­æŸ¥è¯¢æ•°æ®ï¼Œå­˜åœ¨åˆ™å°†å…¶è½¬æ¢ä¸º Java å¯¹è±¡åè¿”å›</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">jsonStr</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>        <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(jsonStr)) &#123;<br>            <span class="hljs-keyword">return</span> JSONUtil.toBean(jsonStr, type);<br>        &#125;<br>        <span class="hljs-comment">// å‘½ä¸­ç©ºå€¼</span><br>        <span class="hljs-keyword">if</span> (jsonStr != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.NOT_FOUND_ERROR);<br>        &#125;<br><br>        <span class="hljs-comment">// 2. ä» Redis ä¸­æœªæŸ¥è¯¢åˆ°æ•°æ®ï¼Œåˆ™ä»æ•°æ®åº“ä¸­æŸ¥è¯¢ã€‚ï¼ˆsynchronizedï¼‰</span><br>        <span class="hljs-type">R</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">synchronized</span> (CacheClient.class) &#123;<br>            <span class="hljs-comment">// 3. å†æ¬¡æŸ¥è¯¢ Redisï¼šè‹¥å¤šä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°åŒæ­¥ä»£ç å—ï¼ŒæŸä¸ªçº¿ç¨‹æ‹¿åˆ°é”æŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜åï¼Œå…¶ä»–æ‹¿åˆ°é”è¿›æ¥çš„çº¿ç¨‹ç›´æ¥æŸ¥è¯¢ç¼“å­˜åè¿”å›ï¼Œé¿å…é‡å¤æŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜ã€‚</span><br>            jsonStr = stringRedisTemplate.opsForValue().get(key);<br>            <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(jsonStr)) &#123;<br>                <span class="hljs-keyword">return</span> JSONUtil.toBean(jsonStr, type);<br>            &#125;<br><br>            <span class="hljs-comment">// 4. æŸ¥è¯¢æ•°æ®åº“ã€ç¼“å­˜ç©ºå€¼é¿å…ç¼“å­˜ç©¿é€ã€é‡å»ºç¼“å­˜ã€‚</span><br>            result = function.apply(id);<br>            <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>) &#123;<br>                stringRedisTemplate.opsForValue().set(key, <span class="hljs-string">&quot;&quot;</span>, TTL_TWO, TimeUnit.MINUTES);<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.NOT_FOUND_ERROR);<br>            &#125;<br>            <span class="hljs-built_in">this</span>.set(key, result, time, timeUnit);<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>  <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜ï¼ˆsetnxï¼‰</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> &lt;R, ID&gt; R <span class="hljs-title function_">setWithCacheBreakdown4SetNx</span><span class="hljs-params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; function, Long time, TimeUnit timeUnit)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> keyPrefix + id;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> LOCK_SHOP_KEY + id;<br><br>        <span class="hljs-comment">// 1. å…ˆä» Redis ä¸­æŸ¥è¯¢æ•°æ®ï¼Œå­˜åœ¨åˆ™å°†å…¶è½¬æ¢ä¸º Java å¯¹è±¡åè¿”å›</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">jsonStr</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>        <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(jsonStr)) &#123;<br>            <span class="hljs-keyword">return</span> JSONUtil.toBean(jsonStr, type);<br>        &#125;<br>        <span class="hljs-comment">// å‘½ä¸­ç©ºå€¼</span><br>        <span class="hljs-keyword">if</span> (jsonStr != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.NOT_FOUND_ERROR);<br>        &#125;<br><br>        <span class="hljs-comment">// 2. ä» Redis ä¸­æœªæŸ¥è¯¢åˆ°æ•°æ®ï¼Œå°è¯•è·å–é”åä»æ•°æ®åº“ä¸­æŸ¥è¯¢ã€‚</span><br>        <span class="hljs-type">R</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">tryLock</span> <span class="hljs-operator">=</span> tryLock(lockKey);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 2.1 æœªè·å–åˆ°é”åˆ™ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•ï¼ˆé€šè¿‡é€’å½’è°ƒç”¨é‡è¯•ï¼‰</span><br>            <span class="hljs-keyword">if</span> (BooleanUtil.isFalse(tryLock)) &#123;<br>                Thread.sleep(<span class="hljs-number">50</span>);<br>                <span class="hljs-built_in">this</span>.setWithCacheBreakdown4SetNx(keyPrefix, id, type, function, time, timeUnit);<br>            &#125;<br>            <span class="hljs-comment">// 2.2 è·å–åˆ°é”ï¼šæŸ¥è¯¢æ•°æ®åº“ã€ç¼“å­˜é‡å»ºã€‚</span><br>            <span class="hljs-keyword">if</span> (tryLock) &#123;<br>                <span class="hljs-comment">// 3. å†æ¬¡æŸ¥è¯¢ Redisï¼šè‹¥å¤šä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°åŒæ­¥ä»£ç å—ï¼ŒæŸä¸ªçº¿ç¨‹æ‹¿åˆ°é”æŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜åï¼Œå…¶ä»–æ‹¿åˆ°é”è¿›æ¥çš„çº¿ç¨‹ç›´æ¥æŸ¥è¯¢ç¼“å­˜åè¿”å›ï¼Œé¿å…é‡å¤æŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜ã€‚</span><br>                jsonStr = stringRedisTemplate.opsForValue().get(key);<br>                <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(jsonStr)) &#123;<br>                    <span class="hljs-keyword">return</span> JSONUtil.toBean(jsonStr, type);<br>                &#125;<br><br>                <span class="hljs-comment">// 4. æŸ¥è¯¢æ•°æ®åº“ã€ç¼“å­˜ç©ºå€¼é¿å…ç¼“å­˜ç©¿é€ã€é‡å»ºç¼“å­˜ã€‚</span><br>                result = function.apply(id);<br>                <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>) &#123;<br>                    stringRedisTemplate.opsForValue().set(key, <span class="hljs-string">&quot;&quot;</span>, TTL_TWO, TimeUnit.MINUTES);<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.NOT_FOUND_ERROR);<br>                &#125;<br>                <span class="hljs-built_in">this</span>.set(key, result, time, timeUnit);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(e.getMessage());<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            unlock(lockKey);<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜ï¼ˆé€»è¾‘è¿‡æœŸæ—¶é—´ï¼‰</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> &lt;R, ID&gt; R <span class="hljs-title function_">setWithCacheBreakdown4LogicalExpiration</span><span class="hljs-params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; function, Long time, TimeUnit timeUnit)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> keyPrefix + id;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> LOCK_SHOP_KEY + id;<br><br>        <span class="hljs-comment">// 1. å…ˆä» Redis ä¸­æŸ¥è¯¢æ•°æ®ï¼Œæœªå‘½ä¸­åˆ™ç›´æ¥è¿”å›</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">jsonStr</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>        <span class="hljs-keyword">if</span> (StringUtils.isBlank(jsonStr)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 2. åˆ¤æ–­æ˜¯å¦è¿‡æœŸï¼Œæœªè¿‡æœŸåˆ™ç›´æ¥è¿”å›</span><br>        <span class="hljs-type">RedisData</span> <span class="hljs-variable">redisData</span> <span class="hljs-operator">=</span> JSONUtil.toBean(jsonStr, RedisData.class);<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> JSONUtil.parseObj(redisData.getData());<br>        <span class="hljs-type">R</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> JSONUtil.toBean(jsonObject, type);<br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">expireTime</span> <span class="hljs-operator">=</span> redisData.getExpireTime();<br>        <span class="hljs-keyword">if</span> (expireTime.isAfter(LocalDateTime.now())) &#123;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125;<br><br>        <span class="hljs-comment">// 3. æœªè·å–åˆ°é”ç›´æ¥è¿”å›</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">tryLock</span> <span class="hljs-operator">=</span> tryLock(lockKey);<br>        <span class="hljs-keyword">if</span> (BooleanUtil.isFalse(tryLock)) &#123;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125;<br><br>        <span class="hljs-comment">// 4. è·å–åˆ°é”ï¼šå¼€å¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹åè¿”å›æ—§æ•°æ®ã€‚ï¼ˆè¿™ä¸ªçº¿ç¨‹è´Ÿè´£æŸ¥è¯¢æ•°æ®åº“ã€é‡å»ºç¼“å­˜ï¼‰</span><br>        <span class="hljs-comment">// æ­¤å¤„æ— éœ€ DoubleCheckï¼Œå› ä¸ºæœªè·å–åˆ°é”ç›´æ¥è¿”å›æ—§æ•°æ®ï¼Œèƒ½ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°æ­¤å¤„</span><br>        ES.submit(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-built_in">this</span>.dataWarmUp(key, function.apply(id), time, timeUnit);<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                unlock(lockKey);<br>            &#125;<br>        &#125;);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2&gt;ç®€å•çš„ç¼“å­˜ç­–ç•¥&lt;/h2&gt;</summary>
    
    
    
    <category term="redisæ•™ç¨‹" scheme="https://garybyd.github.io/categories/redis%E6%95%99%E7%A8%8B/"/>
    
    
    <category term="redis" scheme="https://garybyd.github.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>redisåŸºç¡€ç»“æ„</title>
    <link href="https://garybyd.github.io/posts/redis%E5%9F%BA%E7%A1%80%E7%BB%93%E6%9E%84/"/>
    <id>https://garybyd.github.io/posts/redis%E5%9F%BA%E7%A1%80%E7%BB%93%E6%9E%84/</id>
    <published>2025-03-04T00:39:12.000Z</published>
    <updated>2025-03-07T08:12:27.836Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="rediså…¥é—¨">Rediså…¥é—¨</span></h2><p><strong>ï¼ˆNoSQL, Not Only SQLï¼‰ éå…³ç³»å‹æ•°æ®åº“</strong></p><span id="more"></span><img src="/posts/redis%E5%9F%BA%E7%A1%80%E7%BB%93%E6%9E%84/image-20250304085911096.png" class title="image-20250304085911096"><p><strong>å…³ç³»å‹æ•°æ®åº“</strong>ï¼šä»¥ è¡¨æ ¼ çš„å½¢å¼å­˜åœ¨ï¼Œä»¥ è¡Œå’Œåˆ— çš„å½¢å¼å­˜å–æ•°æ®ï¼Œä¸€ç³»åˆ—çš„è¡Œå’Œåˆ—è¢«ç§°ä¸ºè¡¨ï¼Œæ— æ•°å¼ è¡¨ç»„æˆäº† æ•°æ®åº“ã€‚æ”¯æŒå¤æ‚çš„ SQL æŸ¥è¯¢ï¼Œèƒ½å¤Ÿä½“ç°å‡ºæ•°æ®ä¹‹é—´ã€è¡¨ä¹‹é—´çš„å…³è”å…³ç³»ï¼›ä¹Ÿæ”¯æŒäº‹åŠ¡ï¼Œä¾¿äºæäº¤æˆ–è€…å›æ»šã€‚</p><p><strong>éå…³ç³»å‹æ•°æ®åº“</strong>ï¼šä»¥ key-value çš„å½¢å¼å­˜åœ¨ï¼Œå¯ä»¥æƒ³è±¡æˆç”µè¯æœ¬çš„å½¢å¼ï¼Œäººåï¼ˆkeyï¼‰å¯¹åº”ç”µè¯å·ç ï¼ˆvalueï¼‰ã€‚ä¸éœ€è¦å†™ä¸€äº›å¤æ‚çš„ SQL è¯­å¥ï¼Œä¸éœ€è¦ç»è¿‡ SQL çš„é‡é‡è§£æï¼Œæ€§èƒ½å¾ˆé«˜ï¼›å¯æ‰©å±•æ€§ä¹Ÿæ¯”è¾ƒå¼ºï¼Œæ•°æ®ä¹‹é—´æ²¡æœ‰è€¦åˆæ€§ï¼Œéœ€è¦æ–°åŠ å­—æ®µå°±ç›´æ¥å¢åŠ ä¸€ä¸ª key-value é”®å€¼å¯¹å³å¯ã€‚</p><p><strong>Redis æ˜¯ é€Ÿåº¦æå¿«çš„ã€åŸºäºå†…å­˜çš„ï¼Œé”®å€¼å‹ NoSQL æ•°æ®åº“ã€‚</strong></p><h3><span id="ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«"><strong>ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿ</strong></span></h3><ul><li><p><strong>å®Œå…¨åŸºäºå†…å­˜æ“ä½œ</strong>ã€‚</p></li><li><p><strong>ä½¿ç”¨éé˜»å¡çš„ IO å¤šè·¯å¤ç”¨æœºåˆ¶</strong>ã€‚</p></li><li><p><strong>æ•°æ®ç»“æ„ç®€å•ï¼Œå¯¹æ•°æ®æ“ä½œä¹Ÿç®€å•ã€‚</strong></p></li><li><p><strong>ä½¿ç”¨å•çº¿ç¨‹ï¼Œé¿å…äº†ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œç«äº‰äº§ç”Ÿçš„æ¶ˆè€—ã€‚</strong></p></li><li><p>æ”¯æŒå¤šç§æ•°æ®ç±»å‹ï¼ŒåŒ…æ‹¬ Stringã€Hashã€Listã€Setã€ZSet ç­‰ã€‚</p></li></ul><h3><span id="io-å¤šè·¯å¤ç”¨æœºåˆ¶">IO å¤šè·¯å¤ç”¨æœºåˆ¶</span></h3><p>Redis ä½¿ç”¨çš„æ˜¯ <strong>IO å¤šè·¯å¤ç”¨æœºåˆ¶</strong> æ¥å¤„ç† <strong>é«˜å¹¶å‘è¯·æ±‚</strong>ï¼Œè¿™ä½¿å¾—å®ƒèƒ½åœ¨ <strong>å•çº¿ç¨‹</strong> æ¨¡å¼ä¸‹ä»ç„¶ä¿æŒé«˜ååé‡ã€‚</p><hr><p>ğŸ”¹ <strong>Redis ä¸ºä»€ä¹ˆè¦ç”¨ IO å¤šè·¯å¤ç”¨ï¼Ÿ</strong></p><ul><li><strong>Redis æ˜¯å•çº¿ç¨‹çš„</strong>ï¼Œä½†ä»ç„¶èƒ½é«˜æ•ˆå¤„ç†å¤§é‡è¿æ¥ï¼Œè¿™ä¾èµ–äº IO å¤šè·¯å¤ç”¨ã€‚</li><li>ä¼ ç»Ÿçš„ <strong>é˜»å¡ IO</strong> æ–¹å¼ï¼Œæ¯æ¬¡åªèƒ½å¤„ç†ä¸€ä¸ªè¿æ¥ï¼Œæ€§èƒ½å—é™ã€‚</li><li>å¤šè·¯å¤ç”¨å¯ä»¥ <strong>åŒæ—¶ç›‘å¬å¤šä¸ªå®¢æˆ·ç«¯è¯·æ±‚</strong>ï¼Œåªå¤„ç†æ´»è·ƒè¿æ¥ï¼Œå‡å°‘ CPU ç©ºè½¬ã€‚</li></ul><hr><p>ğŸ”¹ <strong>Redis çš„ IO å¤šè·¯å¤ç”¨æœºåˆ¶</strong></p><p>Redis é‡‡ç”¨ <strong>epollï¼ˆLinuxï¼‰æˆ– selectï¼ˆWindowsï¼‰</strong> ä½œä¸º IO å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œä¸»è¦ä½¿ç”¨ <strong><code>aeEventLoop</code> äº‹ä»¶å¤„ç†æœºåˆ¶</strong>ï¼š</p><ol><li><strong>ä¸»çº¿ç¨‹é€šè¿‡ <code>epoll/select/kqueue</code> ç›‘å¬å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥</strong></li><li><strong>å½“æŸä¸ªè¿æ¥æœ‰æ•°æ®å¯è¯»ï¼ˆå¦‚å‘½ä»¤è¯·æ±‚ï¼‰ï¼ŒRedis è§¦å‘ç›¸åº”çš„å›è°ƒå‡½æ•°</strong></li><li><strong>å›è°ƒå‡½æ•°è¯»å–è¯·æ±‚ï¼Œå¤„ç†å‘½ä»¤ï¼Œè¿”å›ç»“æœ</strong></li><li><strong>ç»§ç»­ç›‘å¬æ–°çš„è¯·æ±‚ï¼Œä¸ä¼šé˜»å¡åœ¨æŸä¸ªè¯·æ±‚ä¸Š</strong></li></ol><p>Redis ä½¿ç”¨ <strong>äº‹ä»¶é©±åŠ¨æ¨¡å‹</strong>ï¼Œä¸»è¦æœ‰ï¼š</p><ul><li><strong>å¯è¯»äº‹ä»¶ï¼ˆAE_READABLEï¼‰</strong>ï¼šå½“å®¢æˆ·ç«¯æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚</li><li><strong>å¯å†™äº‹ä»¶ï¼ˆAE_WRITABLEï¼‰</strong>ï¼šå½“å®¢æˆ·ç«¯å¯ä»¥å†™æ•°æ®æ—¶è§¦å‘ã€‚</li><li><strong>æ–‡ä»¶äº‹ä»¶ï¼ˆFile Eventï¼‰</strong>ï¼šé€šè¿‡ <code>epoll</code> ç›‘å¬ <strong>å¤šä¸ª socket è¿æ¥</strong>ã€‚</li><li><strong>æ—¶é—´äº‹ä»¶ï¼ˆTime Eventï¼‰</strong>ï¼šç”¨äºå®šæ—¶ä»»åŠ¡ï¼ˆæ¯”å¦‚ key è¿‡æœŸæ£€æµ‹ï¼‰ã€‚</li></ul><hr><p>ğŸ”¹ <strong>Redis å¤šè·¯å¤ç”¨ç¤ºæ„å›¾</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">[å¤šä¸ªå®¢æˆ·ç«¯]<br>   â”‚<br>   â–¼<br>[epoll/select ç›‘å¬]<br>   â”‚<br>   â”œâ”€â”€ å®¢æˆ·ç«¯ A å¯è¯» -&gt; è§¦å‘å›è°ƒ -&gt; è¯»å–æ•°æ®<br>   â”œâ”€â”€ å®¢æˆ·ç«¯ B å¯å†™ -&gt; è§¦å‘å›è°ƒ -&gt; å‘é€æ•°æ®<br>   â”œâ”€â”€ å®¢æˆ·ç«¯ C å¯è¯» -&gt; è§¦å‘å›è°ƒ -&gt; è¯»å–æ•°æ®<br>   â”‚<br>   â–¼<br>[ä¸»çº¿ç¨‹æ‰§è¡Œ Redis å‘½ä»¤é€»è¾‘]<br></code></pre></td></tr></table></figure><h2><span id="redisçš„åŸºç¡€ç»“æ„ç±»å‹">Redisçš„åŸºç¡€ç»“æ„ç±»å‹</span></h2><h3><span id="keyç»“æ„">Keyç»“æ„</span></h3><p>è®© Redis çš„ key å½¢æˆå±‚çº§ç»“æ„ï¼Œä½¿ç”¨ <code>:</code> éš”å¼€ï¼š<code>é¡¹ç›®å:ä¸šåŠ¡å:ç±»å‹:id</code>ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json">set blog<span class="hljs-punctuation">:</span>user<span class="hljs-punctuation">:</span><span class="hljs-number">1</span> &#x27;<span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;Jack&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">22</span><span class="hljs-punctuation">&#125;</span>&#x27;<br>set blog<span class="hljs-punctuation">:</span>user<span class="hljs-punctuation">:</span><span class="hljs-number">2</span> &#x27;<span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;Mike&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">23</span><span class="hljs-punctuation">&#125;</span>&#x27;<br>set blog<span class="hljs-punctuation">:</span>article<span class="hljs-punctuation">:</span><span class="hljs-number">1</span> &#x27;<span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;Spring&quot;</span><span class="hljs-punctuation">&#125;</span>&#x27;<br></code></pre></td></tr></table></figure><h3><span id="stringç±»å‹">Stringç±»å‹</span></h3><table><thead><tr><th>Key</th><th>Value</th></tr></thead><tbody><tr><td>blog:user:1</td><td>â€˜{â€œidâ€:1, â€œnameâ€:â€œJackâ€, â€œageâ€:22}â€™</td></tr><tr><td>blog:user:2</td><td>â€˜{â€œidâ€:2, â€œnameâ€:â€œMikeâ€, â€œageâ€:23}â€™</td></tr></tbody></table><p><strong>åˆ†é…ç­–ç•¥ï¼š</strong></p><p>Java çš„ String æ˜¯ä¸å¯å˜çš„ï¼Œæ— æ³•ä¿®æ”¹ã€‚Redis çš„ String æ˜¯åŠ¨æ€çš„ï¼Œå¯ä»¥ä¿®æ”¹çš„ã€‚Redis çš„ String åœ¨å†…éƒ¨ç»“æ„å®ç°ä¸Šç±»ä¼¼äº Java çš„ ArrayListï¼Œé‡‡ç”¨é¢„åˆ†é…å†—ä½™ç©ºé—´çš„æ–¹å¼æ¥å‡å°‘å†…å­˜çš„é¢‘ç¹åˆ†é…ã€‚å¦‚å›¾æ‰€ç¤ºï¼Œå½“å‰å­—ç¬¦ä¸²å®é™…åˆ†é…çš„ç©ºé—´ä¸º capacityï¼Œä¸€èˆ¬é«˜äºå®é™…çš„å­—ç¬¦ä¸²é•¿åº¦ lenã€‚å½“å­—ç¬¦ä¸²é•¿åº¦å°äº 1M æ—¶ï¼Œæ‰©å®¹æ˜¯å¯¹ç°æœ‰ç©ºé—´çš„æˆå€å¢é•¿ï¼›å¦‚æœé•¿åº¦è¶…è¿‡ 1M æ—¶ï¼Œæ‰©å®¹ä¸€æ¬¡åªä¼šå¤šå¢åŠ  1M çš„ç©ºé—´ã€‚String çš„æœ€å¤§é•¿åº¦ä¸º 512Mã€‚</p><img src="/posts/redis%E5%9F%BA%E7%A1%80%E7%BB%93%E6%9E%84/image-20250304091313106.png" class title="image-20250304091313106"><h3><span id="hashç»“æ„">Hashç»“æ„</span></h3><img src="/posts/redis%E5%9F%BA%E7%A1%80%E7%BB%93%E6%9E%84/image-20250304101409849.png" class title="image-20250304101409849"><h3><span id="listç»“æ„">listç»“æ„</span></h3><p><strong>List ç±»ä¼¼ Java ä¸­çš„ LinkedListï¼Œå¯ä»¥çœ‹ä½œä¸€ä¸ªåŒå‘é“¾è¡¨ï¼ˆæœ‰åºå¯é‡å¤ï¼‰</strong>ã€‚ä½¿ç”¨ List å¯ä»¥å¯¹é“¾è¡¨çš„ä¸¤ç«¯è¿›è¡Œ push å’Œ pop æ“ä½œã€è¯»å–å•ä¸ªæˆ–å¤šä¸ªå…ƒç´ ã€æ ¹æ®å€¼æŸ¥æ‰¾æˆ–åˆ é™¤å…ƒç´ ã€æ”¯æŒæ­£å‘æ£€ç´¢å’Œåå‘æ£€ç´¢ã€‚</p><p><strong>æ ˆ</strong>ï¼šLPUSH + LPOP æˆ– RPUSH + RPOPã€‚</p><p><strong>é˜Ÿåˆ—</strong>ï¼šLPUSH + RPOP æˆ– RPUSH + LPOPã€‚</p><h3><span id="setç»“æ„">Setç»“æ„</span></h3><p><code>SADD key member [member ...]</code> ï¼šå‘ Set ä¸­æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ ã€‚</p><p><code>SMEMBERS key</code> ï¼šè·å–æŒ‡å®š Set ä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚</p><p><code>SISMEMBER key member</code> ï¼šåˆ¤æ–­ Set ä¸­æ˜¯å¦å­˜åœ¨æŒ‡å®šå…ƒç´ ã€‚</p><p><code>SCARD key </code>ï¼šè¿”å› Set ä¸­çš„å…ƒç´ ä¸ªæ•°ã€‚</p><p><code>SREM key member [member ...] </code> ï¼šç§»é™¤ Set ä¸­çš„æŒ‡å®šå…ƒç´ ã€‚</p><p><code>SINTER key [key ...]</code> ï¼šæ±‚ n ä¸ª key é—´çš„äº¤é›†ã€‚</p><p><code>SDIFF key [key ...]</code> ï¼šæ±‚ n ä¸ª key é—´çš„å·®é›†ã€‚</p><p><code>SUNION key [key ...]</code> ï¼šæ±‚ n ä¸ª key é—´çš„å¹¶é›†ã€‚</p><p><strong>Redis çš„ Set ç±»ä¼¼ HashSetï¼Œå¯ä»¥çœ‹ä½œä¸€ä¸ª value ä¸º null çš„ HashMapï¼›å…¶ç‰¹å¾ä¹Ÿä¸ HashSet ç±»ä¼¼ï¼šæ— åºä¸å¯é‡å¤ï¼Œæ”¯æŒ äº¤é›†ã€å¹¶é›†ã€å·®é›†ç­‰åŠŸèƒ½ã€‚</strong></p><h3><span id="zset">ZSet</span></h3><p><strong>Redis çš„ ZSet æ˜¯ä¸€ä¸ªå¯æ’åºçš„ Set é›†åˆï¼Œç±»ä¼¼ ZSetã€‚ZSet çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½å¸¦æœ‰ä¸€ä¸ª score å±æ€§ï¼Œå¯ä»¥åŸºäº score å±æ€§å¯¹å…ƒç´ æ’åºã€‚</strong></p><p><code>ZADD key [score member ...]</code> ï¼šä»¥ score ä¸ºæƒé‡å‘ ZSet ä¸­æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ ï¼Œå¦‚æœå­˜åœ¨åˆ™æ›´æ–° scoreã€‚</p><p><code>ZREM key member [member ...]</code> ï¼šåˆ é™¤ ZSet ä¸­çš„æŒ‡å®šå…ƒç´ ã€‚</p><p><code>ZCARD key</code> ï¼šè¿”å› ZSet ä¸­çš„å…ƒç´ ä¸ªæ•°ã€‚</p><p><code>ZSCORE key member </code>ï¼šè·å– ZSet ä¸­æŒ‡å®šå…ƒç´ çš„ score å€¼ã€‚</p><p><code>ZADD key [score member ...]</code> ï¼šä»¥ score ä¸ºæƒé‡å‘ ZSet ä¸­æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ ï¼Œå¦‚æœå­˜åœ¨åˆ™æ›´æ–° scoreã€‚</p><p><code>ZREM key member [member ...] </code>ï¼šåˆ é™¤ ZSet ä¸­çš„æŒ‡å®šå…ƒç´ ã€‚</p><p><code>ZCARD key</code> ï¼šè¿”å› ZSet ä¸­çš„å…ƒç´ ä¸ªæ•°ã€‚</p><p><code>ZSCORE key member</code> ï¼šè·å– ZSet ä¸­æŒ‡å®šå…ƒç´ çš„ score å€¼ã€‚</p><p><code>ZRANGEBYSCORE key min max</code> ï¼šæŒ‰ç…§ score æ’åºåï¼Œè·å– <strong>æŒ‡å®š score èŒƒå›´</strong> å†…çš„å…ƒç´ ã€‚</p><p><code>ZINTER numberKeys key [key ...] ï½œ ZDIFF numberKeys key [key ...] ï½œ ZUNION numberKeys key [key ...]</code> ï¼šæ±‚ n ä¸ª Zset çš„äº¤é›†ã€å·®é›†ã€å¹¶é›†ã€‚</p><h3><span id="redis-åŸºç¡€ç»“æ„åŠå…¶æ“ä½œæŒ‡ä»¤æ€»ç»“">Redis åŸºç¡€ç»“æ„åŠå…¶æ“ä½œæŒ‡ä»¤æ€»ç»“</span></h3><table><thead><tr><th><strong>åŸºç¡€ç»“æ„</strong></th><th><strong>æè¿°</strong></th><th><strong>å¸¸ç”¨æŒ‡ä»¤</strong></th><th><strong>ç¤ºä¾‹</strong></th></tr></thead><tbody><tr><td><strong>Stringï¼ˆå­—ç¬¦ä¸²ï¼‰</strong></td><td>æœ€åŸºæœ¬çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥å­˜å‚¨å­—ç¬¦ä¸²ã€æ•´æ•°æˆ–æµ®ç‚¹æ•°</td><td><code>SET</code>ã€<code>GET</code>ã€<code>INCR</code>ã€<code>DECR</code>ã€<code>APPEND</code>ã€<code>MSET</code>ã€<code>MGET</code></td><td><code>SET key value</code>ï¼Œ<code>GET key</code></td></tr><tr><td><strong>Listï¼ˆåˆ—è¡¨ï¼‰</strong></td><td>æœ‰åºé›†åˆï¼Œå…è®¸é‡å¤å…ƒç´ ï¼Œåº•å±‚ä¸ºåŒå‘é“¾è¡¨</td><td><code>LPUSH</code>ã€<code>RPUSH</code>ã€<code>LPOP</code>ã€<code>RPOP</code>ã€<code>LRANGE</code></td><td><code>LPUSH mylist A B C</code>ï¼Œ<code>LRANGE mylist 0 -1</code></td></tr><tr><td><strong>Setï¼ˆé›†åˆï¼‰</strong></td><td>æ— åºé›†åˆï¼Œä¸å…è®¸é‡å¤å…ƒç´ </td><td><code>SADD</code>ã€<code>SREM</code>ã€<code>SMEMBERS</code>ã€<code>SISMEMBER</code></td><td><code>SADD myset A B C</code>ï¼Œ<code>SMEMBERS myset</code></td></tr><tr><td><strong>Hashï¼ˆå“ˆå¸Œï¼‰</strong></td><td>ç±»ä¼¼äºå¯¹è±¡ï¼Œå­˜å‚¨é”®å€¼å¯¹</td><td><code>HSET</code>ã€<code>HGET</code>ã€<code>HGETALL</code>ã€<code>HDEL</code></td><td><code>HSET user name &quot;Alice&quot;</code>ï¼Œ<code>HGET user name</code></td></tr><tr><td><strong>ZSetï¼ˆæœ‰åºé›†åˆï¼‰</strong></td><td>å…·æœ‰æƒé‡ï¼ˆscoreï¼‰çš„é›†åˆï¼Œå…ƒç´ æŒ‰åˆ†æ•°æ’åº</td><td><code>ZADD</code>ã€<code>ZRANGE</code>ã€<code>ZREM</code>ã€<code>ZSCORE</code></td><td><code>ZADD myzset 1 A 2 B</code>ï¼Œ<code>ZRANGE myzset 0 -1</code></td></tr><tr><td><strong>Bitmapï¼ˆä½å›¾ï¼‰</strong></td><td>ä½çº§åˆ«çš„å­˜å‚¨ï¼Œç”¨äºé«˜æ•ˆå­˜å‚¨å’Œæ“ä½œäºŒè¿›åˆ¶æ•°æ®</td><td><code>SETBIT</code>ã€<code>GETBIT</code>ã€<code>BITCOUNT</code></td><td><code>SETBIT mybitmap 10 1</code>ï¼Œ<code>GETBIT mybitmap 10</code></td></tr><tr><td><strong>HyperLogLog</strong></td><td>è¿‘ä¼¼å»é‡è®¡æ•°ç»“æ„ï¼Œé€‚ç”¨äºå¤§æ•°æ®è®¡æ•°</td><td><code>PFADD</code>ã€<code>PFCOUNT</code></td><td><code>PFADD myhll A B C</code>ï¼Œ<code>PFCOUNT myhll</code></td></tr><tr><td><strong>Geoï¼ˆåœ°ç†ä½ç½®ï¼‰</strong></td><td>å­˜å‚¨ç»çº¬åº¦å¹¶è®¡ç®—åœ°ç†è·ç¦»</td><td><code>GEOADD</code>ã€<code>GEODIST</code>ã€<code>GEORADIUS</code></td><td><code>GEOADD mygeo 120.0 30.0 &quot;place1&quot;</code>ï¼Œ<code>GEODIST mygeo place1 place2</code></td></tr><tr><td><strong>Streamï¼ˆæµï¼‰</strong></td><td>å¯æŒä¹…åŒ–çš„æ¶ˆæ¯é˜Ÿåˆ—ç»“æ„</td><td><code>XADD</code>ã€<code>XLEN</code>ã€<code>XREAD</code></td><td><code>XADD mystream * name &quot;Alice&quot;</code>ï¼Œ<code>XREAD COUNT 1 STREAMS mystream 0</code></td></tr></tbody></table><p>è¿™äº›ç»“æ„å’ŒæŒ‡ä»¤åœ¨ä¸åŒçš„åº”ç”¨åœºæ™¯ä¸­æœ‰ä¸åŒçš„ä¼˜åŠ¿ï¼Œæ¯”å¦‚ <strong>String</strong> é€‚ç”¨äºç¼“å­˜æ•°æ®ï¼Œ<strong>List</strong> é€‚ç”¨äºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œ<strong>Set</strong> é€‚ç”¨äºå»é‡ï¼Œ<strong>ZSet</strong> é€‚ç”¨äºæ’è¡Œæ¦œï¼Œ<strong>Hash</strong> é€‚ç”¨äºå­˜å‚¨å¯¹è±¡ï¼Œ<strong>Bitmap</strong> é€‚ç”¨äºç”¨æˆ·ç­¾åˆ°æˆ–æ´»è·ƒè®°å½•ï¼Œ<strong>HyperLogLog</strong> é€‚ç”¨äºå¤§è§„æ¨¡æ•°æ®å»é‡ç»Ÿè®¡ï¼Œ<strong>Geo</strong> é€‚ç”¨äºåœ°ç†ä½ç½®å­˜å‚¨ï¼Œ<strong>Stream</strong> é€‚ç”¨äºäº‹ä»¶æµå’Œæ¶ˆæ¯é˜Ÿåˆ—ã€‚</p><h2><span id="javaå®¢æˆ·ç«¯è¿æ¥redis">javaå®¢æˆ·ç«¯è¿æ¥redis</span></h2><h3><span id="ä½¿ç”¨jedis">ä½¿ç”¨Jedis</span></h3><p>1.å¯¼å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>redis.clients<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jedis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.8.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>2.å»ºç«‹è¿æ¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JedisTest</span> &#123;<br>    <span class="hljs-keyword">private</span> Jedis jedis;<br><br>    <span class="hljs-meta">@BeforeEach</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUp</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">//1.å»ºç«‹è¿æ¥</span><br>        jedis = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">&quot;192.168.200.130&quot;</span>,<span class="hljs-number">6379</span>);<br>        <span class="hljs-comment">//2.è®¾ç½®å¯†ç </span><br>        jedis.auth(<span class="hljs-string">&quot;1234&quot;</span>);<br>        <span class="hljs-comment">//3.é€‰æ‹©åº“</span><br>        jedis.select(<span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testString</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> jedis.set(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;å°æ˜&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;result= &quot;</span> + result);<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> jedis.get(<span class="hljs-string">&quot;name&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;name= &quot;</span>+name);<br>    &#125;<br><br>    <span class="hljs-meta">@AfterEach</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">tearDown</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">if</span>(jedis!=<span class="hljs-literal">null</span>)&#123;<br>            jedis.close();<br>        &#125;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>3.jedisè¿æ¥æ± </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JedisConnectFactory</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> JedisPool jedisPool;<br><br>    <span class="hljs-keyword">static</span>&#123;<br>        <span class="hljs-comment">//é…ç½®è¿æ¥æ± </span><br>        <span class="hljs-type">JedisPoolConfig</span> <span class="hljs-variable">poolConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPoolConfig</span>();<br>        poolConfig.setMaxTotal(<span class="hljs-number">8</span>);<br>        poolConfig.setMaxIdle(<span class="hljs-number">8</span>);<br>        poolConfig.setMinIdle(<span class="hljs-number">0</span>);<br>        poolConfig.setMaxWait(Duration.ofMillis(<span class="hljs-number">1000</span>));<br>        jedisPool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPool</span>(poolConfig,<span class="hljs-string">&quot;192.168.200.130&quot;</span>,<span class="hljs-number">6379</span>,<span class="hljs-number">1000</span>,<span class="hljs-string">&quot;1234&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Jedis <span class="hljs-title function_">getJedis</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> jedisPool.getResource();<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>1ï¼‰ JedisConnectionFacotryï¼šå·¥å‚è®¾è®¡æ¨¡å¼æ˜¯å®é™…å¼€å‘ä¸­éå¸¸å¸¸ç”¨çš„ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å·¥å‚ï¼Œå»é™ä½ä»£çš„è€¦åˆï¼Œæ¯”å¦‚Springä¸­çš„Beançš„åˆ›å»ºï¼Œå°±ç”¨åˆ°äº†å·¥å‚è®¾è®¡æ¨¡å¼</p><p>2ï¼‰é™æ€ä»£ç å—ï¼šéšç€ç±»çš„åŠ è½½è€ŒåŠ è½½ï¼Œç¡®ä¿åªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œæˆ‘ä»¬åœ¨åŠ è½½å½“å‰å·¥å‚ç±»çš„æ—¶å€™ï¼Œå°±å¯ä»¥æ‰§è¡Œstaticçš„æ“ä½œå®Œæˆå¯¹ è¿æ¥æ± çš„åˆå§‹åŒ–</p><p>3ï¼‰æœ€åæä¾›è¿”å›è¿æ¥æ± ä¸­è¿æ¥çš„æ–¹æ³•.</p><h3><span id="ä½¿ç”¨springdataredisè¿æ¥">ä½¿ç”¨springDataRedisè¿æ¥</span></h3><img src="/posts/redis%E5%9F%BA%E7%A1%80%E7%BB%93%E6%9E%84/image-20250304102916188.png" class title="image-20250304102916188"><p>1.å¯¼å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--Redisä¾èµ–--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--è¿æ¥æ± ä¾èµ–--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-pool2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>2.é…ç½®è¿æ¥ä¿¡æ¯</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">1234</span><br>    <span class="hljs-attr">database:</span> <span class="hljs-number">0</span><br>    <span class="hljs-attr">lettuce:</span><br>      <span class="hljs-attr">pool:</span><br>        <span class="hljs-attr">max-active:</span> <span class="hljs-number">8</span> <span class="hljs-comment">#æœ€å¤§è¿æ¥æ•°</span><br>        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">8</span> <span class="hljs-comment">#æœ€å¤§ç©ºé—²è¿æ¥</span><br>        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">0</span> <span class="hljs-comment">#æœ€å°ç©ºé—²è¿æ¥</span><br>        <span class="hljs-attr">max-wait:</span> <span class="hljs-number">100</span> <span class="hljs-comment">#è¿æ¥ç­‰å¾…æ—¶é—´</span><br></code></pre></td></tr></table></figure><p>3.ç›´æ¥æ³¨å…¥RedisTemplateå‡ºç°çš„é—®é¢˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// è‡ªåŠ¨æ³¨å…¥çš„ `RedisTemplate` éœ€è¦åŠ ä¸Šæ³›å‹</span><br><span class="hljs-meta">@Resource</span><br><span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>  redisTemplate.opsForValue().set(<span class="hljs-string">&quot;k1&quot;</span>, <span class="hljs-string">&quot;v1&quot;</span>);<br>  Map&lt;String, String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>  map.put(<span class="hljs-string">&quot;k2&quot;</span>, <span class="hljs-string">&quot;v2&quot;</span>);<br>  map.put(<span class="hljs-string">&quot;k3&quot;</span>, <span class="hljs-string">&quot;v3&quot;</span>);<br>map.put(<span class="hljs-string">&quot;k4&quot;</span>, <span class="hljs-string">&quot;v4&quot;</span>);<br>  map.put(<span class="hljs-string">&quot;k5&quot;</span>, <span class="hljs-string">&quot;v5&quot;</span>);<br>  redisTemplate.opsForValue().multiSet(map);<br>redisTemplate.opsForValue().multiGet(Arrays.asList(<span class="hljs-string">&quot;k1&quot;</span>, <span class="hljs-string">&quot;k2&quot;</span>, <span class="hljs-string">&quot;k3&quot;</span>, <span class="hljs-string">&quot;k4&quot;</span>)).forEach(System.out::println);  <span class="hljs-comment">// v1 v2 v3 v4 v5</span><br>&#125;<br><br><span class="hljs-comment">//ç»“æœ</span><br># åœ¨ Redis ä¸­æŸ¥çœ‹é€šè¿‡ RedisTemplate æ’å…¥çš„æ•°æ®<br>&gt; keys *<br><span class="hljs-number">1</span>) <span class="hljs-string">&quot;\xac\xed\x00\x05t\x00\x02k1&quot;</span><br><span class="hljs-number">2</span>) <span class="hljs-string">&quot;\xac\xed\x00\x05t\x00\x02k2&quot;</span><br><span class="hljs-number">3</span>) <span class="hljs-string">&quot;\xac\xed\x00\x05t\x00\x02k3&quot;</span><br><span class="hljs-number">4</span>) <span class="hljs-string">&quot;\xac\xed\x00\x05t\x00\x02k4&quot;</span><br><span class="hljs-number">5</span>) <span class="hljs-string">&quot;\xac\xed\x00\x05t\x00\x02k5&quot;</span><br><br>&gt; get <span class="hljs-string">&quot;\xac\xed\x00\x05t\x00\x02k1&quot;</span><br><span class="hljs-string">&quot;\xac\xed\x00\x05t\x00\x02v1&quot;</span><br></code></pre></td></tr></table></figure><p><strong>RedisTemplate å­˜åœ¨çš„é—®é¢˜</strong></p><p>é€šè¿‡ä»¥ä¸Šæ“ä½œå¯ä»¥å‘ç°ï¼šRedisTemplate å¯ä»¥å°†ä»»æ„ç±»å‹çš„æ•°æ®å†™å…¥åˆ° Redis ä¸­ï¼Œåœ¨å†™å…¥å‰ä¼šå°†å…¶åºåˆ—åŒ–ä¸ºå­—èŠ‚å½¢å¼å­˜å‚¨ï¼Œåº•å±‚é»˜è®¤é‡‡ç”¨ <code>ObjectOutputStream</code> åºåˆ—åŒ–ã€‚</p><p>4.å› æ­¤æˆ‘ä»¬è¦é‡å†™ä»–çš„åºåˆ—åŒ–å·¥å…·</p><p>å¯¼å…¥ <code>jackson-databind</code> ä¾èµ–ï¼Œå¹¶ç¼–å†™é…ç½®ç±» <strong>RedisTemplateConfig</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisTemplateConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;<br>        <span class="hljs-comment">// åˆ›å»º RedisTemplate å¯¹è±¡</span><br>        RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();<br>        <span class="hljs-comment">// è®¾ç½®è¿æ¥å·¥å‚</span><br>        redisTemplate.setConnectionFactory(redisConnectionFactory);<br>        <span class="hljs-comment">// è®¾ç½®åºåˆ—åŒ–å·¥å…·</span><br>        <span class="hljs-type">GenericJackson2JsonRedisSerializer</span> <span class="hljs-variable">jsonRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericJackson2JsonRedisSerializer</span>();<br><br>        <span class="hljs-comment">// Key å’Œ HashKey é‡‡ç”¨ String åºåˆ—åŒ–ï¼ˆStringRedisSerializerï¼‰</span><br>        redisTemplate.setKeySerializer(RedisSerializer.string());<br>        redisTemplate.setHashKeySerializer(RedisSerializer.string());<br>      <br>        <span class="hljs-comment">// Value å’Œ HashValue é‡‡ç”¨ JSON åºåˆ—åŒ–ï¼ˆGenericJackson2JsonRedisSerializerï¼‰</span><br>        redisTemplate.setValueSerializer(jsonRedisSerializer);<br>        redisTemplate.setHashValueSerializer(jsonRedisSerializer);<br>        <br>        <span class="hljs-keyword">return</span> redisTemplate;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// è‡ªåŠ¨æ³¨å…¥çš„ `RedisTemplate` éœ€è¦åŠ ä¸Šæ³›å‹</span><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>    redisTemplate.opsForValue().set(<span class="hljs-string">&quot;k1&quot;</span>, <span class="hljs-string">&quot;v1&quot;</span>);<br>  redisTemplate.opsForValue().set(<span class="hljs-string">&quot;user:1&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;Jack&quot;</span>, <span class="hljs-number">21</span>));<br>&#125;<br><br></code></pre></td></tr></table></figure><p>é€šè¿‡ä»¥ä¸Šçš„æ–¹æ³•èƒ½å¤Ÿè§£å†³æ•°æ®åºåˆ—åŒ–æ—¶ <strong>å¯è¯»æ€§å·®ã€å†…å­˜å ç”¨å¤§</strong> çš„é—®é¢˜ã€‚</p><p>ä½†æ˜¯ JSON çš„åºåˆ—åŒ–æ–¹å¼ä»ç„¶å­˜åœ¨ä¸€äº›é—®é¢˜ï¼šä¸ºäº†ååºåˆ—åŒ–æ—¶çŸ¥é“å¯¹è±¡çš„ç±»å‹ï¼Œ<strong>JSON åºåˆ—åŒ–å™¨ä¼šå°†ç±»çš„ class ç±»å‹å†™å…¥ JSON ç»“æœï¼Œå­˜å…¥ Redis ä¸­ï¼Œä¼šå¸¦æ¥é¢å¤–çš„å†…å­˜å¼€é”€ã€‚</strong></p><p>5.ä½¿ç”¨StringRedisTemplate</p><p>ä¸ºäº†èŠ‚çœå†…å­˜ç©ºé—´ï¼ŒSpring æä¾›äº†ä¸€ä¸ª <strong>StringRedisTemplate</strong>ï¼Œå®ƒçš„ key å’Œ value çš„åºåˆ—åŒ–æ–¹å¼é»˜è®¤å°±æ˜¯ Stringï¼Œç»Ÿä¸€ä½¿ç”¨ String åºåˆ—åŒ–å™¨ã€‚</p><p>å½“éœ€è¦å­˜å‚¨ Java å¯¹è±¡æ—¶ï¼Œæ‰‹åŠ¨å®Œæˆå¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p><ol><li>ä½¿ç”¨ StringRedisTemplateã€‚</li><li>å†™å…¥æ•°æ®åˆ° Redis ä¸­ï¼Œæ‰‹åŠ¨å°†å¯¹è±¡åºåˆ—åŒ–ä¸º JSONã€‚</li><li>ä» Redis ä¸­è¯»å–æ•°æ®ï¼Œæ‰‹åŠ¨å°†è¯»å–åˆ°çš„ JSON ååºåˆ—åŒ–ä¸ºå¯¹è±¡ã€‚</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ttt</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> JsonProcessingException &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;Michael&quot;</span>, <span class="hljs-number">27</span>);<br>    <span class="hljs-comment">// æ‰‹åŠ¨åºåˆ—åŒ–</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> objectMapper.writeValueAsString(user);<br>    <span class="hljs-comment">// å†™å…¥æ•°æ®</span><br>    stringRedisTemplate.opsForValue().set(<span class="hljs-string">&quot;user:1&quot;</span>, json);<br>    <span class="hljs-comment">// è¯»å–æ•°æ®</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(<span class="hljs-string">&quot;user:1&quot;</span>);<br>    <span class="hljs-comment">// ååºåˆ—åŒ–</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">deserializedUser</span> <span class="hljs-operator">=</span> objectMapper.readValue(data, User.class);<br>    System.out.println(deserializedUser);<br>&#125;<br><span class="hljs-comment">//ç»“æœ</span><br>&#123;<br>  <span class="hljs-string">&quot;username&quot;</span>: <span class="hljs-string">&quot;Michael&quot;</span>,<br>  <span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">27</span><br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2&gt;Rediså…¥é—¨&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;ï¼ˆNoSQL, Not Only SQLï¼‰ éå…³ç³»å‹æ•°æ®åº“&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="redisç¬”è®°" scheme="https://garybyd.github.io/categories/redis%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="redis" scheme="https://garybyd.github.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Hexoå¸¸ç”¨æŒ‡ä»¤å¤§å…¨</title>
    <link href="https://garybyd.github.io/posts/Hexo%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4%E5%A4%A7%E5%85%A8/"/>
    <id>https://garybyd.github.io/posts/Hexo%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4%E5%A4%A7%E5%85%A8/</id>
    <published>2025-03-02T11:33:33.000Z</published>
    <updated>2025-03-07T08:15:07.684Z</updated>
    
    <content type="html"><![CDATA[<p><strong>Hexo å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥è¡¨</strong></p><span id="more"></span><table><thead><tr><th>å‘½ä»¤</th><th>åŠŸèƒ½</th><th>å¸¸ç”¨å‚æ•°/ç¤ºä¾‹</th></tr></thead><tbody><tr><td><strong>åˆå§‹åŒ–</strong></td><td></td><td></td></tr><tr><td><code>npm install -g hexo-cli</code></td><td>å…¨å±€å®‰è£…Hexoå‘½ä»¤è¡Œå·¥å…·</td><td></td></tr><tr><td><code>hexo init &lt;folder&gt;</code></td><td>åˆå§‹åŒ–åšå®¢é¡¹ç›®</td><td><code>hexo init myblog</code></td></tr><tr><td><code>npm install</code></td><td>å®‰è£…ä¾èµ–åŒ…ï¼ˆåœ¨é¡¹ç›®ç›®å½•æ‰§è¡Œï¼‰</td><td></td></tr><tr><td><strong>å†…å®¹ç®¡ç†</strong></td><td></td><td></td></tr><tr><td><code>hexo new &quot;æ ‡é¢˜&quot;</code></td><td>æ–°å»ºæ–‡ç« </td><td><code>hexo new &quot;Hello World&quot;</code></td></tr><tr><td><code>hexo new page &quot;åç§°&quot;</code></td><td>æ–°å»ºé¡µé¢</td><td><code>hexo new page &quot;about&quot;</code></td></tr><tr><td><code>hexo publish &lt;filename&gt;</code></td><td>å‘å¸ƒè‰ç¨¿</td><td><code>hexo publish draft/untitled.md</code></td></tr><tr><td><strong>ç”Ÿæˆä¸é¢„è§ˆ</strong></td><td></td><td></td></tr><tr><td><code>hexo generate</code></td><td>ç”Ÿæˆé™æ€æ–‡ä»¶ï¼ˆç®€å†™<code>hexo g</code>ï¼‰</td><td><code>hexo g --watch</code>ï¼ˆç›‘å¬æ–‡ä»¶å˜åŒ–ï¼‰</td></tr><tr><td><code>hexo server</code></td><td>å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨ï¼ˆç®€å†™<code>hexo s</code>ï¼‰</td><td><code>hexo s -p 5000</code>ï¼ˆæŒ‡å®šç«¯å£ï¼‰</td></tr><tr><td><code>hexo clean</code></td><td>æ¸…é™¤ç¼“å­˜å’Œç”Ÿæˆæ–‡ä»¶</td><td>å¸¸ä¸ç”Ÿæˆå‘½ä»¤ç»„åˆä½¿ç”¨</td></tr><tr><td><strong>éƒ¨ç½²</strong></td><td></td><td></td></tr><tr><td><code>npm install hexo-deployer-git --save</code></td><td>å®‰è£…Gitéƒ¨ç½²æ’ä»¶</td><td></td></tr><tr><td><code>hexo deploy</code></td><td>éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼ˆç®€å†™<code>hexo d</code>ï¼‰</td><td><code>hexo d --generate</code>ï¼ˆå…ˆç”Ÿæˆåéƒ¨ç½²ï¼‰</td></tr><tr><td><strong>ç»„åˆå‘½ä»¤</strong></td><td></td><td></td></tr><tr><td><code>hexo g -d</code></td><td>ç”Ÿæˆåç«‹å³éƒ¨ç½²</td><td>å¸¸ç”¨éƒ¨ç½²ç»„åˆ</td></tr><tr><td><code>hexo s -g</code></td><td>ç”Ÿæˆåå¯åŠ¨æœåŠ¡å™¨</td><td>å¼€å‘è°ƒè¯•å¸¸ç”¨</td></tr><tr><td><strong>é«˜çº§æ“ä½œ</strong></td><td></td><td></td></tr><tr><td><code>hexo list &lt;type&gt;</code></td><td>åˆ—å‡ºæ‰€æœ‰æ–‡ç« /é¡µé¢ç­‰</td><td><code>hexo list post</code></td></tr><tr><td><code>hexo version</code></td><td>æŸ¥çœ‹Hexoç‰ˆæœ¬</td><td></td></tr><tr><td><code>hexo --config custom.yml</code></td><td>ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶</td><td>å¤šç¯å¢ƒé…ç½®æ—¶ä½¿ç”¨</td></tr></tbody></table><p><strong>å…¸å‹å·¥ä½œæµç¤ºä¾‹</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. åˆ›å»ºæ–°æ–‡ç« </span><br>hexo new <span class="hljs-string">&quot;æ·±å…¥ç†è§£Hexoæ¶æ„&quot;</span><br><br><span class="hljs-comment"># 2. æœ¬åœ°å†™ä½œå¹¶é¢„è§ˆ</span><br>hexo clean &amp;&amp; hexo g &amp;&amp; hexo s<br><br><span class="hljs-comment"># 3. éƒ¨ç½²åˆ°GitHub</span><br>hexo clean &amp;&amp; hexo g -d<br></code></pre></td></tr></table></figure><hr><p><strong>é…ç½®æ³¨æ„è¦ç‚¹</strong></p><ol><li>éƒ¨ç½²é…ç½®ï¼ˆ<code>_config.yml</code>ï¼‰</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">deploy:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">git</span><br>  <span class="hljs-attr">repo:</span> <span class="hljs-string">https://github.com/ç”¨æˆ·å/ä»“åº“å.git</span><br>  <span class="hljs-attr">branch:</span> <span class="hljs-string">gh-pages</span><br></code></pre></td></tr></table></figure><ol start="2"><li>ä¸»é¢˜é…ç½®ç¤ºä¾‹</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">theme:</span> <span class="hljs-string">icarus</span>  <span class="hljs-comment"># éœ€å…ˆå®‰è£…ä¸»é¢˜åˆ°themesç›®å½•</span><br></code></pre></td></tr></table></figure><hr><p><strong>å¸¸ç”¨æ’ä»¶æ¨è</strong></p><table><thead><tr><th>æ’ä»¶</th><th>åŠŸèƒ½</th><th>å®‰è£…å‘½ä»¤</th></tr></thead><tbody><tr><td><code>hexo-abbrlink</code></td><td>ç”Ÿæˆæ°¸ä¹…é“¾æ¥</td><td><code>npm install hexo-abbrlink --save</code></td></tr><tr><td><code>hexo-all-minifier</code></td><td>å‹ç¼©é™æ€èµ„æº</td><td><code>npm install hexo-all-minifier --save</code></td></tr><tr><td><code>hexo-generator-search</code></td><td>æ·»åŠ æœ¬åœ°æœç´¢</td><td><code>npm install hexo-generator-search --save</code></td></tr></tbody></table><p>æŒæ¡è¿™äº›å‘½ä»¤å¯æå‡åšå®¢ç®¡ç†æ•ˆç‡ï¼Œå»ºè®®ç»“åˆ<code>--debug</code>å‚æ•°æ’æŸ¥é—®é¢˜ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">hexo g --debug  <span class="hljs-comment"># æ˜¾ç¤ºè¯¦ç»†ç”Ÿæˆæ—¥å¿—</span><br></code></pre></td></tr></table></figure><p>icarusæ•™ç¨‹:<a href="https://ppoffice.github.io/hexo-theme-icarus/categories/Widgets/">https://ppoffice.github.io/hexo-theme-icarus/categories/Widgets/</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;strong&gt;Hexo å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥è¡¨&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Hexoæ•™ç¨‹" scheme="https://garybyd.github.io/categories/Hexo%E6%95%99%E7%A8%8B/"/>
    
    
    <category term="Hexo" scheme="https://garybyd.github.io/tags/Hexo/"/>
    
  </entry>
  
</feed>
