{"posts":[{"title":"Hexoå¸¸ç”¨æŒ‡ä»¤å¤§å…¨","text":"Hexo å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥è¡¨ å‘½ä»¤ åŠŸèƒ½ å¸¸ç”¨å‚æ•°/ç¤ºä¾‹ åˆå§‹åŒ– npm install -g hexo-cli å…¨å±€å®‰è£…Hexoå‘½ä»¤è¡Œå·¥å…· hexo init &lt;folder&gt; åˆå§‹åŒ–åšå®¢é¡¹ç›® hexo init myblog npm install å®‰è£…ä¾èµ–åŒ…ï¼ˆåœ¨é¡¹ç›®ç›®å½•æ‰§è¡Œï¼‰ å†…å®¹ç®¡ç† hexo new &quot;æ ‡é¢˜&quot; æ–°å»ºæ–‡ç«  hexo new &quot;Hello World&quot; hexo new page &quot;åç§°&quot; æ–°å»ºé¡µé¢ hexo new page &quot;about&quot; hexo publish &lt;filename&gt; å‘å¸ƒè‰ç¨¿ hexo publish draft/untitled.md ç”Ÿæˆä¸é¢„è§ˆ hexo generate ç”Ÿæˆé™æ€æ–‡ä»¶ï¼ˆç®€å†™hexo gï¼‰ hexo g --watchï¼ˆç›‘å¬æ–‡ä»¶å˜åŒ–ï¼‰ hexo server å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨ï¼ˆç®€å†™hexo sï¼‰ hexo s -p 5000ï¼ˆæŒ‡å®šç«¯å£ï¼‰ hexo clean æ¸…é™¤ç¼“å­˜å’Œç”Ÿæˆæ–‡ä»¶ å¸¸ä¸ç”Ÿæˆå‘½ä»¤ç»„åˆä½¿ç”¨ éƒ¨ç½² npm install hexo-deployer-git --save å®‰è£…Gitéƒ¨ç½²æ’ä»¶ hexo deploy éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼ˆç®€å†™hexo dï¼‰ hexo d --generateï¼ˆå…ˆç”Ÿæˆåéƒ¨ç½²ï¼‰ ç»„åˆå‘½ä»¤ hexo g -d ç”Ÿæˆåç«‹å³éƒ¨ç½² å¸¸ç”¨éƒ¨ç½²ç»„åˆ hexo s -g ç”Ÿæˆåå¯åŠ¨æœåŠ¡å™¨ å¼€å‘è°ƒè¯•å¸¸ç”¨ é«˜çº§æ“ä½œ hexo list &lt;type&gt; åˆ—å‡ºæ‰€æœ‰æ–‡ç« /é¡µé¢ç­‰ hexo list post hexo version æŸ¥çœ‹Hexoç‰ˆæœ¬ hexo --config custom.yml ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ å¤šç¯å¢ƒé…ç½®æ—¶ä½¿ç”¨ å…¸å‹å·¥ä½œæµç¤ºä¾‹ 12345678# 1. åˆ›å»ºæ–°æ–‡ç« hexo new &quot;æ·±å…¥ç†è§£Hexoæ¶æ„&quot;# 2. æœ¬åœ°å†™ä½œå¹¶é¢„è§ˆhexo clean &amp;&amp; hexo g &amp;&amp; hexo s# 3. éƒ¨ç½²åˆ°GitHubhexo clean &amp;&amp; hexo g -d é…ç½®æ³¨æ„è¦ç‚¹ éƒ¨ç½²é…ç½®ï¼ˆ_config.ymlï¼‰ 1234deploy: type: git repo: https://github.com/ç”¨æˆ·å/ä»“åº“å.git branch: gh-pages ä¸»é¢˜é…ç½®ç¤ºä¾‹ 1theme: icarus # éœ€å…ˆå®‰è£…ä¸»é¢˜åˆ°themesç›®å½• å¸¸ç”¨æ’ä»¶æ¨è æ’ä»¶ åŠŸèƒ½ å®‰è£…å‘½ä»¤ hexo-abbrlink ç”Ÿæˆæ°¸ä¹…é“¾æ¥ npm install hexo-abbrlink --save hexo-all-minifier å‹ç¼©é™æ€èµ„æº npm install hexo-all-minifier --save hexo-generator-search æ·»åŠ æœ¬åœ°æœç´¢ npm install hexo-generator-search --save æŒæ¡è¿™äº›å‘½ä»¤å¯æå‡åšå®¢ç®¡ç†æ•ˆç‡ï¼Œå»ºè®®ç»“åˆ--debugå‚æ•°æ’æŸ¥é—®é¢˜ï¼š 1hexo g --debug # æ˜¾ç¤ºè¯¦ç»†ç”Ÿæˆæ—¥å¿— icarusæ•™ç¨‹:https://ppoffice.github.io/hexo-theme-icarus/categories/Widgets/","link":"/posts/Hexo%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4%E5%A4%A7%E5%85%A8/"},{"title":"redisç¼“å­˜çš„åº”ç”¨","text":"ç®€å•çš„ç¼“å­˜ç­–ç•¥ 12345678910111213141516171819202122232425262728@Servicepublic class ShopServiceImpl extends ServiceImpl&lt;ShopMapper, Shop&gt; implements IShopService { @Resource private StringRedisTemplate stringRedisTemplate; @Override public Result querygetById(Long id) { //1.ä»Rediså†…æŸ¥è¯¢å•†å“ç¼“å­˜ String shopJson = stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id); if(StrUtil.isNotBlank(shopJson)){ //æ‰‹åŠ¨ååºåˆ—åŒ– Shop shop = JSONUtil.toBean(shopJson, Shop.class); return Result.ok(shop); } //2.ä¸å­˜åœ¨å°±æ ¹æ®idæŸ¥è¯¢æ•°æ®åº“ Shop shop = getById(id); if(shop==null){ return Result.fail(&quot;å•†æˆ·ä¸å­˜åœ¨ï¼&quot;); } //3.æ•°æ®åº“æ•°æ®å†™å…¥Redis //æ‰‹åŠ¨åºåˆ—åŒ– String shopStr = JSONUtil.toJsonStr(shop); stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id,shopStr,CACHE_SHOP_TTL, TimeUnit.MINUTES); return Result.ok(shop); }} ç¼“å­˜æ›´æ–°ç­–ç•¥ ç¼“å­˜æ›´æ–°ç­–ç•¥çš„æœ€ä½³æ–¹æ¡ˆï¼š ä½ä¸€è‡´æ€§éœ€æ±‚ï¼šä½¿ç”¨Redisè‡ªå¸¦çš„å†…å­˜æ·˜æ±°æœºåˆ¶ é«˜ä¸€è‡´æ€§éœ€æ±‚ï¼šä¸»åŠ¨æ›´æ–°ï¼Œè¶…æ—¶å‰”é™¤çš„æ–¹å¼ä½œä¸ºæ–—åœ°æ–¹æ¡ˆ è¯»æ“ä½œ ç¼“å­˜å‘½ä¸­å°±ç›´æ¥è¿”å› ç¼“å­˜æœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ å†™æ“ä½œï¼š å…ˆå†™æ•°æ®åº“ï¼Œç„¶åå†åˆ é™¤ç¼“å­˜ è¦ç¡®ä¿æ•°æ®åº“ä¸ç¼“å­˜æ“ä½œçš„åŸå­æ€§ æ“ä½œç¼“å­˜å’Œæ•°æ®åº“æ—¶éœ€è¦è€ƒè™‘çš„ä¸‰ä¸ªé—®é¢˜ åˆ é™¤ç¼“å­˜è¿˜æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ æ¯æ¬¡æ›´æ–°æ•°æ®åº“çš„åŒæ—¶æ›´æ–°ç¼“å­˜ï¼šè‹¥æ•°æ®åº“æ›´æ–°äº† 100 æ¬¡ï¼ŒæœŸé—´æ²¡æœ‰ä»»ä½•æŸ¥è¯¢è¯·æ±‚ï¼Œæ­¤æ—¶ç¼“å­˜çš„æ›´æ–°å°±æ˜¯æ— æ•ˆæ“ä½œã€‚ æ•°æ®åº“æ›´æ–°å°±åˆ é™¤ç¼“å­˜ï¼šæ•°æ®åº“æ›´æ–°åç¼“å­˜è¢«åˆ é™¤ï¼Œæ­¤æ—¶æ•°æ®åº“æ— è®ºæ›´æ–°å¤šå°‘æ¬¡ï¼Œç¼“å­˜éƒ½ä¸ä¼šåšä»»ä½•æ“ä½œã€‚ç›´åˆ°æœ‰æŸ¥è¯¢è¯·æ±‚ï¼Œç¼“å­˜æ‰ä¼šå°†æ•°æ®åº“ä¸­çš„æ•°æ®å†™å…¥åˆ°ç¼“å­˜ä¸­ã€‚ å¦‚ä½•ä¿è¯ç¼“å­˜å’Œæ•°æ®åº“çš„æ“ä½œåŒæ—¶æˆåŠŸæˆ–å¤±è´¥ï¼Ÿ å•ä½“ç³»ç»Ÿï¼šå°†ç¼“å­˜ä¸æ•°æ®åº“æ“ä½œæ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡ã€‚ åˆ†å¸ƒå¼ç³»ç»Ÿï¼šåˆ©ç”¨ TCC ç­‰åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆã€‚ å…ˆæ“ä½œç¼“å­˜è¿˜æ˜¯å…ˆæ“ä½œæ•°æ®åº“ï¼Ÿ å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ“ä½œæ•°æ®åº“ã€‚å‡è®¾ç¼“å­˜ä¸º 10ï¼Œæ•°æ®åº“ä¸º 10ã€‚ï¼ˆt1ã€t2ã€t3 ä»£è¡¨ä¸‰ä¸ªæ—¶åˆ»ï¼‰ t1ï¼šçº¿ç¨‹ 1 åˆ é™¤ç¼“å­˜ï¼Œå¹¶æ›´æ–°æ•°æ®åº“ä¸º 20ã€‚t2ï¼šçº¿ç¨‹ 2 æŸ¥è¯¢ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“ä¸­æŸ¥è¯¢å¹¶å†™å…¥ç¼“å­˜ã€‚âœ”ï¸ t1ï¼šçº¿ç¨‹ 1 åˆ é™¤ç¼“å­˜ã€‚t2ï¼šçº¿ç¨‹ 2 æŸ¥è¯¢ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“ä¸­æŸ¥è¯¢å¹¶å†™å…¥ç¼“å­˜ã€‚t3ï¼šçº¿ç¨‹ t1 æ›´æ–°æ•°æ®åº“ä¸º 20ã€‚âŒ **å…ˆæ“ä½œæ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ã€‚**å‡è®¾ç¼“å­˜ä¸º 10ï¼Œæ•°æ®åº“ä¸º 10ã€‚ï¼ˆt1ã€t2ã€t3ã€t4 ä»£è¡¨å››ä¸ªæ—¶åˆ»ï¼‰ t1ï¼šçº¿ç¨‹ 1 æ›´æ–°æ•°æ®åº“ä¸º 20ï¼Œåˆ é™¤ç¼“å­˜ã€‚t2ï¼šçº¿ç¨‹ 2 æŸ¥è¯¢ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“ä¸­æŸ¥è¯¢å¹¶å†™å…¥ç¼“å­˜ã€‚âœ”ï¸ t1ï¼šçº¿ç¨‹ 1 æŸ¥è¯¢ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“ä¸­æŸ¥è¯¢ã€‚t2ï¼šçº¿ç¨‹ 2 æ›´æ–°æ•°æ®åº“ä¸º 20ï¼Œåˆ é™¤ç¼“å­˜ã€‚t3ï¼šçº¿ç¨‹ 1 å†™å…¥ç¼“å­˜ã€‚âŒï¼ˆè¿™ç§æ–¹å¼å‡ºç°çš„æ¦‚ç‡å¾ˆå°ï¼Œç¼“å­˜å†™å…¥çš„é€Ÿåº¦å¾ˆå¿«ã€‚æ›´å¯èƒ½å‡ºç°çš„æƒ…å†µæ˜¯ï¼šçº¿ç¨‹ 1 å†™å…¥ç¼“å­˜åï¼Œçº¿ç¨‹ 2 æ›´æ–°æ•°æ®åº“ç„¶åå°†ç¼“å­˜åˆ é™¤ï¼‰ 123456789101112@Overridepublic Result update(Shop shop) { if(shop.getId()==null){ return Result.fail(&quot;åº—é“ºidä¸èƒ½ä¸ºç©º!&quot;); } //1.æ›´æ–°æ•°æ®åº“ updateById(shop); //2.åˆ é™¤ç¼“å­˜ String key = CACHE_SHOP_KEY + shop.getId(); stringRedisTemplate.delete(key); return Result.ok();} ç¼“å­˜ç©¿é€é—®é¢˜ ç¼“å­˜ç©ºå¯¹è±¡æ–¹æ¡ˆ å®¢æˆ·ç«¯è¯·æ±‚çš„æ•°æ®åœ¨ Redis å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œä¸ºäº†é˜²æ­¢ä¸æ–­çš„è¯·æ±‚ï¼šå°† ç©ºå€¼ ç¼“å­˜åˆ° Redis ä¸­å¹¶ä¸”è®¾ç½® TTL æ—¶é—´åï¼Œè¿”å›ç»™è¯¥è¯·æ±‚ã€‚ ç¼“å­˜ä¸­åŒ…å«è¿‡å¤šçš„ ç©ºå€¼ï¼Œä¼šé€ æˆé¢å¤–çš„å†…å­˜æ¶ˆè€—ã€‚ï¼ˆè®¾ç½® TTL å¯ä»¥ç¼“è§£ï¼‰ å¯èƒ½é€ æˆçŸ­æœŸçš„ä¸ä¸€è‡´ï¼šç¬¬ä¸€æ¬¡è¯·æ±‚çš„æ•°æ®åœ¨ Redis å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œç¼“å­˜ç©ºå¯¹è±¡åï¼Œæ•°æ®åº“ä¸­æ–°å¢äº†è¯¥è¯·æ±‚å¯¹åº”çš„æ•°æ® 1234567891011121314151617181920212223242526272829@Overridepublic CommonResult&lt;Shop&gt; getShopById(Long id) { ThrowUtils.throwIf(id == null, ErrorCode.PARAMS_ERROR); String shopKey = CACHE_SHOP_KEY + id; // 1. å…ˆä» Redis ä¸­æŸ¥è¯¢æ•°æ®ï¼Œå­˜åœ¨åˆ™å°†å…¶è½¬æ¢ä¸º Java å¯¹è±¡åè¿”å› String shopJsonInRedis = stringRedisTemplate.opsForValue().get(shopKey); if (StringUtils.isNotBlank(shopJsonInRedis)) { return CommonResult.success(JSONUtil.toBean(shopJsonInRedis, Shop.class)); } // å‘½ä¸­ç©ºå€¼ if (shopJsonInRedis != null) { throw new BusinessException(ErrorCode.NOT_FOUND_ERROR, &quot;è¯¥å•†é“ºä¸å­˜åœ¨&quot;); } // 2. ä» Redis ä¸­æœªæŸ¥è¯¢åˆ°æ•°æ®ï¼Œåˆ™ä»æ•°æ®åº“ä¸­æŸ¥è¯¢ Shop shop = this.getById(id); // è‹¥æ•°æ®ä¸­ä¹ŸæŸ¥è¯¢ä¸åˆ°ï¼Œåˆ™ç¼“å­˜ç©ºå€¼åè¿”å›æç¤ºä¿¡æ¯ if (shop == null) { stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, &quot;&quot;, TTL_TWO, TimeUnit.MINUTES); throw new BusinessException(ErrorCode.NOT_FOUND_ERROR, &quot;è¯¥å•†é“ºä¸å­˜åœ¨&quot;); } // 3. å°†ä»æ•°æ®åº“ä¸­æŸ¥è¯¢åˆ°çš„æ•°æ®å­˜å…¥ Redis åè¿”å› stringRedisTemplate.opsForValue().set(shopKey, JSONUtil.toJsonStr(shop), TTL_TWO, TimeUnit.HOURS); return CommonResult.success(shop);} å¸ƒéš†è¿‡æ»¤å™¨æ–¹æ¡ˆ å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloom Filterï¼‰ï¼šä¸€ä¸ªå¾ˆé•¿çš„äºŒè¿›åˆ¶æ•°ç»„ï¼ˆåˆå§‹åŒ–å€¼ä¸º 0ï¼‰ï¼Œé€šè¿‡ä¸€ç³»åˆ—çš„ Hash å‡½æ•°åˆ¤æ–­è¯¥æ•°æ®æ˜¯å¦å­˜åœ¨ã€‚ å¸ƒéš†è¿‡æ»¤å™¨çš„è¿è¡Œé€Ÿåº¦å¿«ã€å†…å­˜å ç”¨å°ï¼Œä½†æ˜¯å­˜åœ¨è¯¯åˆ¤çš„å¯èƒ½ã€‚ å­˜å‚¨æ•°æ®æ—¶ç»è¿‡ n ä¸ª hash å‡½æ•°ï¼Œè®¡ç®—å‡º n ä¸ª hash å€¼ï¼Œhash å€¼æ˜ å°„åå¾—åˆ° n ä¸ªç´¢å¼•ï¼Œè®¾ç½®ç´¢å¼•å¤„çš„å€¼ä¸º 1ã€‚ï¼ˆè‹¥å½“å‰ç´¢å¼•å¤„å€¼å·²ç»ä¸º 1ï¼Œåˆ™ä¸éœ€è¦ä»»ä½•æ“ä½œï¼‰ æŸ¥è¯¢æ•°æ®æ—¶ä¹Ÿä¼šç»è¿‡ n ä¸ª hash å‡½æ•°ï¼Œè®¡ç®—å‡º n ä¸ª hash å€¼ï¼Œhash å€¼æ˜ å°„åå¾—åˆ° n ä¸ªç´¢å¼•ï¼Œåˆ¤æ–­ç´¢å¼•å¤„çš„å€¼æ˜¯å¦ä¸º 1ã€‚ æŸ¥è¯¢ Anthonyï¼šç»è¿‡ hash ç®—æ³•å¾—åˆ°çš„ hash å€¼æ˜ å°„åæ•°ç»„ä¸‹æ ‡ä¸º 0ã€2ã€6ï¼Œä¸‹æ ‡å¯¹åº”çš„å€¼æ²¡æœ‰å…¨ä¸º 1ï¼Œæ•°ç»„ä¸­ä¸å­˜åœ¨è¯¥å…ƒç´ ã€‚ æŸ¥è¯¢ Cocoï¼šç»è¿‡ hash ç®—æ³•å¾—åˆ°çš„ hash å€¼æ˜ å°„åæ•°ç»„ä¸‹æ ‡ä¸º 0ã€2ã€6ï¼Œä¸‹æ ‡å¯¹åº”çš„å€¼éƒ½ä¸º 1ï¼Œæ•°ç»„ä¸­å¯èƒ½å­˜åœ¨è¯¥å…ƒç´ ã€‚ ç¼“å­˜é›ªå´©é—®é¢˜ï¼š è§£å†³æ–¹æ¡ˆï¼š ç»™ä¸åŒçš„Keyçš„TTLæ·»åŠ éšæœºå€¼ åˆ©ç”¨Redisé›†ç¾¤æé«˜æœåŠ¡çš„å¯ç”¨æ€§ ç»™ç¼“å­˜ä¸šåŠ¡æ·»åŠ é™çº§é™æµç­–ç•¥ ç»™ä¸šåŠ¡æ·»åŠ å¤šçº§ç¼“å­˜ ç¼“å­˜å‡»ç©¿é—®é¢˜ ç¼“å­˜å‡»ç©¿é—®é¢˜ï¼Œä¹Ÿå« çƒ­ç‚¹ Key é—®é¢˜ï¼›å°±æ˜¯ä¸€ä¸ªè¢« é«˜å¹¶å‘è®¿é—® å¹¶ä¸” ç¼“å­˜ä¸­ä¸šåŠ¡è¾ƒå¤æ‚çš„ Key çªç„¶å¤±æ•ˆï¼Œå¤§é‡çš„è¯·æ±‚åœ¨æçŸ­çš„æ—¶é—´å†…ä¸€èµ·è¯·æ±‚è¿™ä¸ª Key å¹¶ä¸”éƒ½æœªå‘½ä¸­ï¼Œæ— æ•°çš„è¯·æ±‚è®¿é—®åœ¨ç¬é—´æ‰“åˆ°æ•°æ®åº“ä¸Šï¼Œç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§çš„å†²å‡»ã€‚ ç¼“å­˜å‡»ç©¿æ•´ä½“è¿‡ç¨‹ï¼š ä¸€ä¸ªçº¿ç¨‹æŸ¥è¯¢ç¼“å­˜ï¼Œæœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜ï¼ˆç¼“å­˜é‡å»ºä¸šåŠ¡æ¯”è¾ƒå¤æ‚ï¼Œæ—¶é—´é•¿ï¼‰ã€‚ åœ¨è¿™ä¸ªé‡å»ºç¼“å­˜çš„è¿‡ç¨‹ä¸­ï¼Œå¤§é‡çš„è¯·æ±‚ç©¿è¿‡ç¼“å­˜ç›´æ¥è¯·æ±‚æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜ï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚ è§£å†³æ–¹æ¡ˆï¼šäº’æ–¥é”(ä¸€è‡´æ€§)ã€é€»è¾‘è¿‡æœŸ(å¯ç”¨æ€§) äº’æ–¥é”æ–¹æ¡ˆ synchronized æŸ¥è¯¢ç¼“å­˜ï¼Œå­˜åœ¨åˆ™ç›´æ¥è¿”å›ã€‚ ä¸å­˜åœ¨ï¼šæ‰§è¡Œ synchronized ä»£ç å—ã€‚ å…ˆæŸ¥ç¼“å­˜ï¼Œå­˜åœ¨åˆ™ç›´æ¥è¿”å›ã€‚ï¼ˆè‹¥å¤šä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°åŒæ­¥ä»£ç å—ï¼ŒæŸä¸ªçº¿ç¨‹æ‹¿åˆ°é”æŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜åï¼Œå…¶ä»–æ‹¿åˆ°é”è¿›æ¥çš„çº¿ç¨‹ç›´æ¥æŸ¥è¯¢ç¼“å­˜åè¿”å›ï¼Œé¿å…é‡å¤æŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜ï¼‰ æŸ¥è¯¢æ•°æ®åº“ï¼Œé‡å»ºç¼“å­˜ã€‚ 12345678910111213141516171819202122232425262728293031323334353637@SneakyThrows@Overridepublic CommonResult&lt;Shop&gt; getShopById(Long id) { ThrowUtils.throwIf(id == null, ErrorCode.PARAMS_ERROR); String shopKey = CACHE_SHOP_KEY + id; // 1. å…ˆä» Redis ä¸­æŸ¥è¯¢æ•°æ®ï¼Œå­˜åœ¨åˆ™å°†å…¶è½¬æ¢ä¸º Java å¯¹è±¡åè¿”å› String shopJsonInRedis = stringRedisTemplate.opsForValue().get(shopKey); if (StringUtils.isNotBlank(shopJsonInRedis)) { return CommonResult.success(JSONUtil.toBean(shopJsonInRedis, Shop.class)); } // å‘½ä¸­ç©ºå€¼ if (shopJsonInRedis != null) { throw new BusinessException(ErrorCode.NOT_FOUND_ERROR, &quot;è¯¥å•†é“ºä¸å­˜åœ¨&quot;); } // 2. ä» Redis ä¸­æœªæŸ¥è¯¢åˆ°æ•°æ®ï¼Œåˆ™ä»æ•°æ®åº“ä¸­æŸ¥è¯¢ã€‚ï¼ˆsynchronizedï¼‰ Shop shop = new Shop(); synchronized (ShopServiceImpl.class) { // 3. å†æ¬¡æŸ¥è¯¢ Redisï¼šè‹¥å¤šä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°åŒæ­¥ä»£ç å—ï¼ŒæŸä¸ªçº¿ç¨‹æ‹¿åˆ°é”æŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜åï¼Œå…¶ä»–æ‹¿åˆ°é”è¿›æ¥çš„çº¿ç¨‹ç›´æ¥æŸ¥è¯¢ç¼“å­˜åè¿”å›ï¼Œé¿å…é‡å¤æŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜ã€‚ shopJsonInRedis = stringRedisTemplate.opsForValue().get(shopKey); if (StringUtils.isNotBlank(shopJsonInRedis)) { return CommonResult.success(JSONUtil.toBean(shopJsonInRedis, Shop.class)); } // 4. æŸ¥è¯¢æ•°æ®åº“ï¼Œç¼“å­˜ç©ºå€¼é¿å…ç¼“å­˜ç©¿é€ï¼Œé‡å»ºç¼“å­˜ã€‚ shop = this.getById(id); if (shop == null) { stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, &quot;&quot;, TTL_TWO, TimeUnit.MINUTES); throw new BusinessException(ErrorCode.NOT_FOUND_ERROR, &quot;è¯¥å•†é“ºä¸å­˜åœ¨&quot;); } // æ¨¡æ‹Ÿç¼“å­˜é‡å»ºå»¶è¿Ÿ Thread.sleep(100); stringRedisTemplate.opsForValue().set(shopKey, JSONUtil.toJsonStr(shop), TTL_TWO, TimeUnit.HOURS); } return CommonResult.success(shop);} ç”¨redisçš„setnxæ¥å……å½“åˆ†å¸ƒå¼é” 1234567891011121314/** * è·å–äº’æ–¥é” */public boolean tryLock(String key) { Boolean result = stringRedisTemplate.opsForValue().setIfAbsent(key, &quot;1&quot;, TTL_TWO, TimeUnit.SECONDS); return Boolean.TRUE.equals(result);}/** * é‡Šæ”¾äº’æ–¥é” */public void unlock(String key) { stringRedisTemplate.delete(key);} 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152@SneakyThrows@Overridepublic CommonResult&lt;Shop&gt; getShopById(Long id) { ThrowUtils.throwIf(id == null, ErrorCode.PARAMS_ERROR); String shopKey = CACHE_SHOP_KEY + id; String lockKey = LOCK_SHOP_KEY + id; // 1. å…ˆä» Redis ä¸­æŸ¥è¯¢æ•°æ®ï¼Œå­˜åœ¨åˆ™å°†å…¶è½¬æ¢ä¸º Java å¯¹è±¡åè¿”å› String shopJsonInRedis = stringRedisTemplate.opsForValue().get(shopKey); if (StringUtils.isNotBlank(shopJsonInRedis)) { return CommonResult.success(JSONUtil.toBean(shopJsonInRedis, Shop.class)); } // å‘½ä¸­ç©ºå€¼ if (shopJsonInRedis != null) { throw new BusinessException(ErrorCode.NOT_FOUND_ERROR, &quot;è¯¥å•†é“ºä¸å­˜åœ¨&quot;); } // 2. ä» Redis ä¸­æœªæŸ¥è¯¢åˆ°æ•°æ®ï¼Œå°è¯•è·å–é”åä»æ•°æ®åº“ä¸­æŸ¥è¯¢ã€‚ Shop shop = new Shop(); boolean tryLock = tryLock(lockKey); try { // 2.1 æœªè·å–åˆ°é”åˆ™ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•ï¼ˆé€šè¿‡é€’å½’è°ƒç”¨é‡è¯•ï¼‰ if (BooleanUtil.isFalse(tryLock)) { Thread.sleep(50); this.getShopById(id); } // 2.2 è·å–åˆ°é”ï¼šæŸ¥è¯¢æ•°æ®åº“ã€ç¼“å­˜é‡å»ºã€‚ if (tryLock) { // 3. å†æ¬¡æŸ¥è¯¢ Redisï¼šè‹¥å¤šä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°è·å–é”å¤„ï¼ŒæŸä¸ªçº¿ç¨‹æ‹¿åˆ°é”æŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜åï¼Œå…¶ä»–æ‹¿åˆ°é”è¿›æ¥çš„çº¿ç¨‹ç›´æ¥æŸ¥è¯¢ç¼“å­˜åè¿”å›ï¼Œé¿å…é‡å¤æŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜ã€‚ shopJsonInRedis = stringRedisTemplate.opsForValue().get(shopKey); if (StringUtils.isNotBlank(shopJsonInRedis)) { return CommonResult.success(JSONUtil.toBean(shopJsonInRedis, Shop.class)); } // 4. æŸ¥è¯¢æ•°æ®åº“ï¼Œç¼“å­˜ç©ºå€¼é¿å…ç¼“å­˜ç©¿é€ï¼Œé‡å»ºç¼“å­˜ã€‚ shop = this.getById(id); if (shop == null) { stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, &quot;&quot;, TTL_TWO, TimeUnit.MINUTES); throw new BusinessException(ErrorCode.NOT_FOUND_ERROR, &quot;è¯¥å•†é“ºä¸å­˜åœ¨&quot;); } // æ¨¡æ‹Ÿç¼“å­˜é‡å»ºå»¶è¿Ÿ Thread.sleep(100); stringRedisTemplate.opsForValue().set(shopKey, JSONUtil.toJsonStr(shop), TTL_TWO, TimeUnit.HOURS); } } finally { // 5. é‡Šæ”¾é” unlock(lockKey); } return CommonResult.success(shop);} é€»è¾‘è¿‡æœŸæ–¹æ¡ˆ æ— éœ€è€ƒè™‘ç¼“å­˜é›ªå´©ï¼ˆRedis å®•æœºé™¤å¤–ï¼‰ã€ç¼“å­˜ç©¿é€é—®é¢˜ï¼šç¼“å­˜ä½•æ—¶è¿‡æœŸé€šè¿‡ä»£ç æ§åˆ¶è€Œé TTLã€‚éœ€è¦è¿›è¡Œæ•°æ®é¢„çƒ­ï¼Œç¼“å­˜æœªå‘½ä¸­æ—¶ç›´æ¥è¿”å›ç©ºã€‚ å…ˆæŸ¥è¯¢ç¼“å­˜ï¼Œæœªå‘½ä¸­åˆ™ç›´æ¥è¿”å›ã€‚ å‘½ä¸­åˆ™åˆ¤æ–­ç¼“å­˜æ˜¯å¦è¿‡æœŸï¼Œæœªè¿‡æœŸåˆ™ç›´æ¥è¿”å›ã€‚ è¿‡æœŸï¼šè·å–é”ã€‚ æœªè·å–åˆ°é”ï¼šç›´æ¥è¿”å›ã€‚ è·å–åˆ°é”ï¼šå¼€å¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹åç›´æ¥è¿”å›ï¼Œè¿™ä¸ªçº¿ç¨‹è´Ÿè´£é‡å»ºç¼“å­˜åé‡Šæ”¾é”ã€‚ å­˜å‚¨åˆ° Redis ä¸­çš„ Key æ°¸ä¹…æœ‰æ•ˆï¼Œè¿‡æœŸæ—¶é—´é€šè¿‡ä»£ç æ§åˆ¶è€Œé TTLã€‚Redis å­˜å‚¨çš„æ•°æ®éœ€è¦å¸¦ä¸Šä¸€ä¸ªé€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œå³ Shop å®ä½“ç±»ä¸­éœ€è¦ä¸€ä¸ªé€»è¾‘è¿‡æœŸæ—¶é—´å±æ€§ã€‚æ–°å»ºä¸€ä¸ª RedisDataï¼Œè¯¥ç±»åŒ…å«ä¸¤ä¸ªå±æ€§ expireTime å’Œ Dataï¼Œå¯¹åŸæ¥çš„ä»£ç æ²¡æœ‰å…¥ä¾µæ€§ã€‚ ç¼“å­˜é¢„çƒ­ï¼ˆå°†çƒ­ç‚¹æ•°æ®æå‰å­˜å‚¨åˆ° Redis ä¸­ï¼‰ 123456@Datapublic class RedisData { private LocalDateTime expireTime; private Object data;} 123456789101112/** * ç¼“å­˜é¢„çƒ­ï¼ˆå°†çƒ­ç‚¹æ•°æ®æå‰å­˜å‚¨åˆ° Redis ä¸­ï¼‰ */public void saveHotDataIn2Redis(Long id, Long expireSeconds) { Shop shop = this.getById(id); ThrowUtils.throwIf(shop == null, ErrorCode.NOT_FOUND_ERROR, &quot;è¯¥æ•°æ®ä¸å­˜åœ¨&quot;); RedisData redisData = new RedisData(); redisData.setData(shop); redisData.setExpireTime(LocalDateTime.now().plusSeconds(expireSeconds)); stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, JSONUtil.toJsonStr(redisData));} 1234567891011# Redis ä¸­å­˜å‚¨çš„æ•°æ®ä¼šå¤šä¸€ä¸ª expireTime çš„å€¼{ &quot;expireTime&quot;: 1681660099861, &quot;data&quot;: { &quot;id&quot;: 1, &quot;name&quot;: &quot;101èŒ¶é¤å…&quot;, &quot;typeId&quot;: 1, ... }} é€»è¾‘è¿‡æœŸ 1234567891011121314/** * ç¼“å­˜é¢„çƒ­ï¼ˆå°†çƒ­ç‚¹æ•°æ®æå‰å­˜å‚¨åˆ° Redis ä¸­ï¼‰ */public void saveHotDataIn2Redis(Long id, Long expireSeconds) throws InterruptedException { Shop shop = this.getById(id); ThrowUtils.throwIf(shop == null, ErrorCode.NOT_FOUND_ERROR, &quot;è¯¥æ•°æ®ä¸å­˜åœ¨&quot;); // æ¨¡æ‹Ÿç¼“å­˜é‡å»ºå»¶è¿Ÿï¼Œè®©ä¸€éƒ¨åˆ†çº¿ç¨‹å…ˆæ‰§è¡Œå®Œæ¯•ï¼Œåœ¨æ­¤æœŸé—´ä¼šçŸ­æš‚çš„ä¸ä¸€è‡´ Thread.sleep(200); RedisData redisData = new RedisData(); redisData.setData(shop); redisData.setExpireTime(LocalDateTime.now().plusSeconds(expireSeconds)); stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, JSONUtil.toJsonStr(redisData));} 1234567891011121314151617181920212223242526272829303132333435363738394041private static final ExecutorService ES = Executors.newFixedThreadPool(10);@SneakyThrows@Overridepublic CommonResult&lt;Shop&gt; getShopById(Long id) { ThrowUtils.throwIf(id == null, ErrorCode.PARAMS_ERROR); String shopKey = CACHE_SHOP_KEY + id; String lockKey = LOCK_SHOP_KEY + id; // 1. å…ˆä» Redis ä¸­æŸ¥è¯¢æ•°æ®ï¼Œæœªå‘½ä¸­åˆ™ç›´æ¥è¿”å› String redisDataJson = stringRedisTemplate.opsForValue().get(shopKey); if (StringUtils.isBlank(redisDataJson)) { return CommonResult.success(null); } // 2. åˆ¤æ–­æ˜¯å¦è¿‡æœŸï¼Œæœªè¿‡æœŸåˆ™ç›´æ¥è¿”å› RedisData redisData = JSONUtil.toBean(redisDataJson, RedisData.class); JSONObject jsonObject = (JSONObject) redisData.getData(); Shop shop = JSONUtil.toBean(jsonObject, Shop.class); LocalDateTime expireTime = redisData.getExpireTime(); if (expireTime.isAfter(LocalDateTime.now())) { return CommonResult.success(shop); } // 3. æœªè·å–åˆ°é”ç›´æ¥è¿”å› boolean tryLock = tryLock(lockKey); if (BooleanUtil.isFalse(tryLock)) { return CommonResult.success(shop); } // 4. è·å–åˆ°é”ï¼šå¼€å¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹åè¿”å›æ—§æ•°æ®ã€‚ï¼ˆè¿™ä¸ªçº¿ç¨‹è´Ÿè´£æŸ¥è¯¢æ•°æ®åº“ã€é‡å»ºç¼“å­˜ï¼‰ // æ­¤å¤„æ— éœ€ DoubleCheckï¼Œå› ä¸ºæœªè·å–åˆ°é”ç›´æ¥è¿”å›æ—§æ•°æ®ï¼Œèƒ½ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°æ­¤å¤„ ES.submit(() -&gt; { try { // æŸ¥è¯¢æ•°æ®åº“ã€é‡å»ºç¼“å­˜ this.saveHotDataIn2Redis(id, 3600 * 24L); } catch (Exception e) { log.error(e.getMessage()); } finally { unlock(lockKey); } }); return CommonResult.success(shop);} æ€»ç»“Redis Cacheå·¥å…·ç±»ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219@Component@Slf4jpublic class CacheClient { private static final ExecutorService ES = Executors.newFixedThreadPool(10); private final StringRedisTemplate stringRedisTemplate; public CacheClient(StringRedisTemplate stringRedisTemplate) { this.stringRedisTemplate = stringRedisTemplate; } /** * è·å–é” */ public boolean tryLock(String key) { Boolean result = stringRedisTemplate.opsForValue().setIfAbsent(key, &quot;1&quot;, TTL_TWO, TimeUnit.SECONDS); return BooleanUtil.isTrue(result); } /** * é‡Šæ”¾é” */ public void unlock(String key) { stringRedisTemplate.delete(key); } /** * æ•°æ®é¢„çƒ­ï¼ˆå°†çƒ­ç‚¹æ•°æ®æå‰å­˜å‚¨åˆ° Redis ä¸­ï¼‰ * * @param key é¢„çƒ­æ•°æ®çš„ Key * @param value é¢„çƒ­æ•°æ®çš„ Value * @param expireTime é€»è¾‘è¿‡æœŸæ—¶é—´ * @param timeUnit æ—¶é—´å•ä½ */ public void dataWarmUp(String key, Object value, Long expireTime, TimeUnit timeUnit) { RedisData redisData = new RedisData(); redisData.setData(value); redisData.setExpireTime(LocalDateTime.now().plusSeconds(timeUnit.toSeconds(expireTime))); stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData)); } /** * å°† Java å¯¹è±¡åºåˆ—åŒ–ä¸º JSON å­˜å‚¨åˆ° Redis ä¸­å¹¶ä¸”è®¾ç½® TTL è¿‡æœŸæ—¶é—´ * * @param key String ç±»å‹çš„é”® * @param value åºåˆ—åŒ–ä¸º JSON çš„å€¼ * @param time TTL è¿‡æœŸæ—¶é—´ * @param timeUnit æ—¶é—´å•ä½ */ public void set(String key, Object value, Long time, TimeUnit timeUnit) { stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(value), time, timeUnit); } /** * è§£å†³ç¼“å­˜ç©¿é€é—®ï¼ˆç¼“å­˜ç©ºå€¼ï¼‰ * * @param keyPrefix Key å‰ç¼€ * @param id id * @param type å®ä½“ç±»å‹ * @param function æœ‰å‚æœ‰è¿”å›å€¼çš„å‡½æ•° * @param time TTL è¿‡æœŸæ—¶é—´ * @param timeUnit æ—¶é—´å•ä½ * @param &lt;R&gt; å®ä½“ç±»å‹ * @param &lt;ID&gt; id ç±»å‹ * @return è®¾ç½®æŸä¸ªå®ä½“ç±»çš„ç¼“å­˜ï¼Œå¹¶è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜ */ public &lt;R, ID&gt; R setWithCachePenetration(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; function, Long time, TimeUnit timeUnit) { String key = keyPrefix + id; // 1. å…ˆä» Redis ä¸­æŸ¥è¯¢æ•°æ®ï¼Œå­˜åœ¨åˆ™å°†å…¶è½¬æ¢ä¸º Java å¯¹è±¡åè¿”å› String jsonStr = stringRedisTemplate.opsForValue().get(key); if (StringUtils.isNotBlank(jsonStr)) { return JSONUtil.toBean(jsonStr, type); } // å‘½ä¸­ç©ºå€¼ if (jsonStr != null) { throw new BusinessException(ErrorCode.NOT_FOUND_ERROR); } // 2. ä» Redis ä¸­æœªæŸ¥è¯¢åˆ°æ•°æ®ï¼Œåˆ™ä»æ•°æ®åº“ä¸­æŸ¥è¯¢ R result = function.apply(id); // è‹¥æ•°æ®ä¸­ä¹ŸæŸ¥è¯¢ä¸åˆ°ï¼Œåˆ™ç¼“å­˜ç©ºå€¼åè¿”å›æç¤ºä¿¡æ¯ if (result == null) { stringRedisTemplate.opsForValue().set(key, &quot;&quot;, TTL_TWO, TimeUnit.MINUTES); throw new BusinessException(ErrorCode.NOT_FOUND_ERROR); } // 3. å°†ä»æ•°æ®åº“ä¸­æŸ¥è¯¢åˆ°çš„æ•°æ®å­˜å…¥ Redis åè¿”å› this.set(key, result, time, timeUnit); return result; } /** * è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜ï¼ˆsynchronizedï¼‰ */ public &lt;R, ID&gt; R setWithCacheBreakdown4Synchronized(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; function, Long time, TimeUnit timeUnit) { String key = keyPrefix + id; // 1. å…ˆä» Redis ä¸­æŸ¥è¯¢æ•°æ®ï¼Œå­˜åœ¨åˆ™å°†å…¶è½¬æ¢ä¸º Java å¯¹è±¡åè¿”å› String jsonStr = stringRedisTemplate.opsForValue().get(key); if (StringUtils.isNotBlank(jsonStr)) { return JSONUtil.toBean(jsonStr, type); } // å‘½ä¸­ç©ºå€¼ if (jsonStr != null) { throw new BusinessException(ErrorCode.NOT_FOUND_ERROR); } // 2. ä» Redis ä¸­æœªæŸ¥è¯¢åˆ°æ•°æ®ï¼Œåˆ™ä»æ•°æ®åº“ä¸­æŸ¥è¯¢ã€‚ï¼ˆsynchronizedï¼‰ R result = null; synchronized (CacheClient.class) { // 3. å†æ¬¡æŸ¥è¯¢ Redisï¼šè‹¥å¤šä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°åŒæ­¥ä»£ç å—ï¼ŒæŸä¸ªçº¿ç¨‹æ‹¿åˆ°é”æŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜åï¼Œå…¶ä»–æ‹¿åˆ°é”è¿›æ¥çš„çº¿ç¨‹ç›´æ¥æŸ¥è¯¢ç¼“å­˜åè¿”å›ï¼Œé¿å…é‡å¤æŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜ã€‚ jsonStr = stringRedisTemplate.opsForValue().get(key); if (StringUtils.isNotBlank(jsonStr)) { return JSONUtil.toBean(jsonStr, type); } // 4. æŸ¥è¯¢æ•°æ®åº“ã€ç¼“å­˜ç©ºå€¼é¿å…ç¼“å­˜ç©¿é€ã€é‡å»ºç¼“å­˜ã€‚ result = function.apply(id); if (result == null) { stringRedisTemplate.opsForValue().set(key, &quot;&quot;, TTL_TWO, TimeUnit.MINUTES); throw new BusinessException(ErrorCode.NOT_FOUND_ERROR); } this.set(key, result, time, timeUnit); } return result; } /** * è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜ï¼ˆsetnxï¼‰ */ public &lt;R, ID&gt; R setWithCacheBreakdown4SetNx(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; function, Long time, TimeUnit timeUnit) { String key = keyPrefix + id; String lockKey = LOCK_SHOP_KEY + id; // 1. å…ˆä» Redis ä¸­æŸ¥è¯¢æ•°æ®ï¼Œå­˜åœ¨åˆ™å°†å…¶è½¬æ¢ä¸º Java å¯¹è±¡åè¿”å› String jsonStr = stringRedisTemplate.opsForValue().get(key); if (StringUtils.isNotBlank(jsonStr)) { return JSONUtil.toBean(jsonStr, type); } // å‘½ä¸­ç©ºå€¼ if (jsonStr != null) { throw new BusinessException(ErrorCode.NOT_FOUND_ERROR); } // 2. ä» Redis ä¸­æœªæŸ¥è¯¢åˆ°æ•°æ®ï¼Œå°è¯•è·å–é”åä»æ•°æ®åº“ä¸­æŸ¥è¯¢ã€‚ R result = null; boolean tryLock = tryLock(lockKey); try { // 2.1 æœªè·å–åˆ°é”åˆ™ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•ï¼ˆé€šè¿‡é€’å½’è°ƒç”¨é‡è¯•ï¼‰ if (BooleanUtil.isFalse(tryLock)) { Thread.sleep(50); this.setWithCacheBreakdown4SetNx(keyPrefix, id, type, function, time, timeUnit); } // 2.2 è·å–åˆ°é”ï¼šæŸ¥è¯¢æ•°æ®åº“ã€ç¼“å­˜é‡å»ºã€‚ if (tryLock) { // 3. å†æ¬¡æŸ¥è¯¢ Redisï¼šè‹¥å¤šä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°åŒæ­¥ä»£ç å—ï¼ŒæŸä¸ªçº¿ç¨‹æ‹¿åˆ°é”æŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜åï¼Œå…¶ä»–æ‹¿åˆ°é”è¿›æ¥çš„çº¿ç¨‹ç›´æ¥æŸ¥è¯¢ç¼“å­˜åè¿”å›ï¼Œé¿å…é‡å¤æŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜ã€‚ jsonStr = stringRedisTemplate.opsForValue().get(key); if (StringUtils.isNotBlank(jsonStr)) { return JSONUtil.toBean(jsonStr, type); } // 4. æŸ¥è¯¢æ•°æ®åº“ã€ç¼“å­˜ç©ºå€¼é¿å…ç¼“å­˜ç©¿é€ã€é‡å»ºç¼“å­˜ã€‚ result = function.apply(id); if (result == null) { stringRedisTemplate.opsForValue().set(key, &quot;&quot;, TTL_TWO, TimeUnit.MINUTES); throw new BusinessException(ErrorCode.NOT_FOUND_ERROR); } this.set(key, result, time, timeUnit); } } catch (Exception e) { log.error(e.getMessage()); } finally { unlock(lockKey); } return result; } /** * è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜ï¼ˆé€»è¾‘è¿‡æœŸæ—¶é—´ï¼‰ */ public &lt;R, ID&gt; R setWithCacheBreakdown4LogicalExpiration(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; function, Long time, TimeUnit timeUnit) { String key = keyPrefix + id; String lockKey = LOCK_SHOP_KEY + id; // 1. å…ˆä» Redis ä¸­æŸ¥è¯¢æ•°æ®ï¼Œæœªå‘½ä¸­åˆ™ç›´æ¥è¿”å› String jsonStr = stringRedisTemplate.opsForValue().get(key); if (StringUtils.isBlank(jsonStr)) { return null; } // 2. åˆ¤æ–­æ˜¯å¦è¿‡æœŸï¼Œæœªè¿‡æœŸåˆ™ç›´æ¥è¿”å› RedisData redisData = JSONUtil.toBean(jsonStr, RedisData.class); JSONObject jsonObject = JSONUtil.parseObj(redisData.getData()); R result = JSONUtil.toBean(jsonObject, type); LocalDateTime expireTime = redisData.getExpireTime(); if (expireTime.isAfter(LocalDateTime.now())) { return result; } // 3. æœªè·å–åˆ°é”ç›´æ¥è¿”å› boolean tryLock = tryLock(lockKey); if (BooleanUtil.isFalse(tryLock)) { return result; } // 4. è·å–åˆ°é”ï¼šå¼€å¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹åè¿”å›æ—§æ•°æ®ã€‚ï¼ˆè¿™ä¸ªçº¿ç¨‹è´Ÿè´£æŸ¥è¯¢æ•°æ®åº“ã€é‡å»ºç¼“å­˜ï¼‰ // æ­¤å¤„æ— éœ€ DoubleCheckï¼Œå› ä¸ºæœªè·å–åˆ°é”ç›´æ¥è¿”å›æ—§æ•°æ®ï¼Œèƒ½ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°æ­¤å¤„ ES.submit(() -&gt; { try { this.dataWarmUp(key, function.apply(id), time, timeUnit); } finally { unlock(lockKey); } }); return result; }}","link":"/posts/redis%E7%BC%93%E5%AD%98%E7%9A%84%E5%BA%94%E7%94%A8/"},{"title":"redisåŸºç¡€ç»“æ„","text":"Rediså…¥é—¨ ï¼ˆNoSQL, Not Only SQLï¼‰ éå…³ç³»å‹æ•°æ®åº“ å…³ç³»å‹æ•°æ®åº“ï¼šä»¥ è¡¨æ ¼ çš„å½¢å¼å­˜åœ¨ï¼Œä»¥ è¡Œå’Œåˆ— çš„å½¢å¼å­˜å–æ•°æ®ï¼Œä¸€ç³»åˆ—çš„è¡Œå’Œåˆ—è¢«ç§°ä¸ºè¡¨ï¼Œæ— æ•°å¼ è¡¨ç»„æˆäº† æ•°æ®åº“ã€‚æ”¯æŒå¤æ‚çš„ SQL æŸ¥è¯¢ï¼Œèƒ½å¤Ÿä½“ç°å‡ºæ•°æ®ä¹‹é—´ã€è¡¨ä¹‹é—´çš„å…³è”å…³ç³»ï¼›ä¹Ÿæ”¯æŒäº‹åŠ¡ï¼Œä¾¿äºæäº¤æˆ–è€…å›æ»šã€‚ éå…³ç³»å‹æ•°æ®åº“ï¼šä»¥ key-value çš„å½¢å¼å­˜åœ¨ï¼Œå¯ä»¥æƒ³è±¡æˆç”µè¯æœ¬çš„å½¢å¼ï¼Œäººåï¼ˆkeyï¼‰å¯¹åº”ç”µè¯å·ç ï¼ˆvalueï¼‰ã€‚ä¸éœ€è¦å†™ä¸€äº›å¤æ‚çš„ SQL è¯­å¥ï¼Œä¸éœ€è¦ç»è¿‡ SQL çš„é‡é‡è§£æï¼Œæ€§èƒ½å¾ˆé«˜ï¼›å¯æ‰©å±•æ€§ä¹Ÿæ¯”è¾ƒå¼ºï¼Œæ•°æ®ä¹‹é—´æ²¡æœ‰è€¦åˆæ€§ï¼Œéœ€è¦æ–°åŠ å­—æ®µå°±ç›´æ¥å¢åŠ ä¸€ä¸ª key-value é”®å€¼å¯¹å³å¯ã€‚ Redis æ˜¯ é€Ÿåº¦æå¿«çš„ã€åŸºäºå†…å­˜çš„ï¼Œé”®å€¼å‹ NoSQL æ•°æ®åº“ã€‚ ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿ å®Œå…¨åŸºäºå†…å­˜æ“ä½œã€‚ ä½¿ç”¨éé˜»å¡çš„ IO å¤šè·¯å¤ç”¨æœºåˆ¶ã€‚ æ•°æ®ç»“æ„ç®€å•ï¼Œå¯¹æ•°æ®æ“ä½œä¹Ÿç®€å•ã€‚ ä½¿ç”¨å•çº¿ç¨‹ï¼Œé¿å…äº†ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œç«äº‰äº§ç”Ÿçš„æ¶ˆè€—ã€‚ æ”¯æŒå¤šç§æ•°æ®ç±»å‹ï¼ŒåŒ…æ‹¬ Stringã€Hashã€Listã€Setã€ZSet ç­‰ã€‚ IO å¤šè·¯å¤ç”¨æœºåˆ¶ Redis ä½¿ç”¨çš„æ˜¯ IO å¤šè·¯å¤ç”¨æœºåˆ¶ æ¥å¤„ç† é«˜å¹¶å‘è¯·æ±‚ï¼Œè¿™ä½¿å¾—å®ƒèƒ½åœ¨ å•çº¿ç¨‹ æ¨¡å¼ä¸‹ä»ç„¶ä¿æŒé«˜ååé‡ã€‚ ğŸ”¹ Redis ä¸ºä»€ä¹ˆè¦ç”¨ IO å¤šè·¯å¤ç”¨ï¼Ÿ Redis æ˜¯å•çº¿ç¨‹çš„ï¼Œä½†ä»ç„¶èƒ½é«˜æ•ˆå¤„ç†å¤§é‡è¿æ¥ï¼Œè¿™ä¾èµ–äº IO å¤šè·¯å¤ç”¨ã€‚ ä¼ ç»Ÿçš„ é˜»å¡ IO æ–¹å¼ï¼Œæ¯æ¬¡åªèƒ½å¤„ç†ä¸€ä¸ªè¿æ¥ï¼Œæ€§èƒ½å—é™ã€‚ å¤šè·¯å¤ç”¨å¯ä»¥ åŒæ—¶ç›‘å¬å¤šä¸ªå®¢æˆ·ç«¯è¯·æ±‚ï¼Œåªå¤„ç†æ´»è·ƒè¿æ¥ï¼Œå‡å°‘ CPU ç©ºè½¬ã€‚ ğŸ”¹ Redis çš„ IO å¤šè·¯å¤ç”¨æœºåˆ¶ Redis é‡‡ç”¨ epollï¼ˆLinuxï¼‰æˆ– selectï¼ˆWindowsï¼‰ ä½œä¸º IO å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œä¸»è¦ä½¿ç”¨ aeEventLoop äº‹ä»¶å¤„ç†æœºåˆ¶ï¼š ä¸»çº¿ç¨‹é€šè¿‡ epoll/select/kqueue ç›‘å¬å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥ å½“æŸä¸ªè¿æ¥æœ‰æ•°æ®å¯è¯»ï¼ˆå¦‚å‘½ä»¤è¯·æ±‚ï¼‰ï¼ŒRedis è§¦å‘ç›¸åº”çš„å›è°ƒå‡½æ•° å›è°ƒå‡½æ•°è¯»å–è¯·æ±‚ï¼Œå¤„ç†å‘½ä»¤ï¼Œè¿”å›ç»“æœ ç»§ç»­ç›‘å¬æ–°çš„è¯·æ±‚ï¼Œä¸ä¼šé˜»å¡åœ¨æŸä¸ªè¯·æ±‚ä¸Š Redis ä½¿ç”¨ äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œä¸»è¦æœ‰ï¼š å¯è¯»äº‹ä»¶ï¼ˆAE_READABLEï¼‰ï¼šå½“å®¢æˆ·ç«¯æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚ å¯å†™äº‹ä»¶ï¼ˆAE_WRITABLEï¼‰ï¼šå½“å®¢æˆ·ç«¯å¯ä»¥å†™æ•°æ®æ—¶è§¦å‘ã€‚ æ–‡ä»¶äº‹ä»¶ï¼ˆFile Eventï¼‰ï¼šé€šè¿‡ epoll ç›‘å¬ å¤šä¸ª socket è¿æ¥ã€‚ æ—¶é—´äº‹ä»¶ï¼ˆTime Eventï¼‰ï¼šç”¨äºå®šæ—¶ä»»åŠ¡ï¼ˆæ¯”å¦‚ key è¿‡æœŸæ£€æµ‹ï¼‰ã€‚ ğŸ”¹ Redis å¤šè·¯å¤ç”¨ç¤ºæ„å›¾ 1234567891011[å¤šä¸ªå®¢æˆ·ç«¯] â”‚ â–¼[epoll/select ç›‘å¬] â”‚ â”œâ”€â”€ å®¢æˆ·ç«¯ A å¯è¯» -&gt; è§¦å‘å›è°ƒ -&gt; è¯»å–æ•°æ® â”œâ”€â”€ å®¢æˆ·ç«¯ B å¯å†™ -&gt; è§¦å‘å›è°ƒ -&gt; å‘é€æ•°æ® â”œâ”€â”€ å®¢æˆ·ç«¯ C å¯è¯» -&gt; è§¦å‘å›è°ƒ -&gt; è¯»å–æ•°æ® â”‚ â–¼[ä¸»çº¿ç¨‹æ‰§è¡Œ Redis å‘½ä»¤é€»è¾‘] Redisçš„åŸºç¡€ç»“æ„ç±»å‹ Keyç»“æ„ è®© Redis çš„ key å½¢æˆå±‚çº§ç»“æ„ï¼Œä½¿ç”¨ : éš”å¼€ï¼šé¡¹ç›®å:ä¸šåŠ¡å:ç±»å‹:idã€‚ 123set blog:user:1 '{&quot;id&quot;:1, &quot;name&quot;:&quot;Jack&quot;, &quot;age&quot;:22}'set blog:user:2 '{&quot;id&quot;:2, &quot;name&quot;:&quot;Mike&quot;, &quot;age&quot;:23}'set blog:article:1 '{&quot;id&quot;:1, &quot;title&quot;:&quot;Spring&quot;}' Stringç±»å‹ Key Value blog:user:1 â€˜{â€œidâ€:1, â€œnameâ€:â€œJackâ€, â€œageâ€:22}â€™ blog:user:2 â€˜{â€œidâ€:2, â€œnameâ€:â€œMikeâ€, â€œageâ€:23}â€™ åˆ†é…ç­–ç•¥ï¼š Java çš„ String æ˜¯ä¸å¯å˜çš„ï¼Œæ— æ³•ä¿®æ”¹ã€‚Redis çš„ String æ˜¯åŠ¨æ€çš„ï¼Œå¯ä»¥ä¿®æ”¹çš„ã€‚Redis çš„ String åœ¨å†…éƒ¨ç»“æ„å®ç°ä¸Šç±»ä¼¼äº Java çš„ ArrayListï¼Œé‡‡ç”¨é¢„åˆ†é…å†—ä½™ç©ºé—´çš„æ–¹å¼æ¥å‡å°‘å†…å­˜çš„é¢‘ç¹åˆ†é…ã€‚å¦‚å›¾æ‰€ç¤ºï¼Œå½“å‰å­—ç¬¦ä¸²å®é™…åˆ†é…çš„ç©ºé—´ä¸º capacityï¼Œä¸€èˆ¬é«˜äºå®é™…çš„å­—ç¬¦ä¸²é•¿åº¦ lenã€‚å½“å­—ç¬¦ä¸²é•¿åº¦å°äº 1M æ—¶ï¼Œæ‰©å®¹æ˜¯å¯¹ç°æœ‰ç©ºé—´çš„æˆå€å¢é•¿ï¼›å¦‚æœé•¿åº¦è¶…è¿‡ 1M æ—¶ï¼Œæ‰©å®¹ä¸€æ¬¡åªä¼šå¤šå¢åŠ  1M çš„ç©ºé—´ã€‚String çš„æœ€å¤§é•¿åº¦ä¸º 512Mã€‚ Hashç»“æ„ listç»“æ„ List ç±»ä¼¼ Java ä¸­çš„ LinkedListï¼Œå¯ä»¥çœ‹ä½œä¸€ä¸ªåŒå‘é“¾è¡¨ï¼ˆæœ‰åºå¯é‡å¤ï¼‰ã€‚ä½¿ç”¨ List å¯ä»¥å¯¹é“¾è¡¨çš„ä¸¤ç«¯è¿›è¡Œ push å’Œ pop æ“ä½œã€è¯»å–å•ä¸ªæˆ–å¤šä¸ªå…ƒç´ ã€æ ¹æ®å€¼æŸ¥æ‰¾æˆ–åˆ é™¤å…ƒç´ ã€æ”¯æŒæ­£å‘æ£€ç´¢å’Œåå‘æ£€ç´¢ã€‚ æ ˆï¼šLPUSH + LPOP æˆ– RPUSH + RPOPã€‚ é˜Ÿåˆ—ï¼šLPUSH + RPOP æˆ– RPUSH + LPOPã€‚ Setç»“æ„ SADD key member [member ...] ï¼šå‘ Set ä¸­æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ ã€‚ SMEMBERS key ï¼šè·å–æŒ‡å®š Set ä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚ SISMEMBER key member ï¼šåˆ¤æ–­ Set ä¸­æ˜¯å¦å­˜åœ¨æŒ‡å®šå…ƒç´ ã€‚ SCARD key ï¼šè¿”å› Set ä¸­çš„å…ƒç´ ä¸ªæ•°ã€‚ SREM key member [member ...] ï¼šç§»é™¤ Set ä¸­çš„æŒ‡å®šå…ƒç´ ã€‚ SINTER key [key ...] ï¼šæ±‚ n ä¸ª key é—´çš„äº¤é›†ã€‚ SDIFF key [key ...] ï¼šæ±‚ n ä¸ª key é—´çš„å·®é›†ã€‚ SUNION key [key ...] ï¼šæ±‚ n ä¸ª key é—´çš„å¹¶é›†ã€‚ Redis çš„ Set ç±»ä¼¼ HashSetï¼Œå¯ä»¥çœ‹ä½œä¸€ä¸ª value ä¸º null çš„ HashMapï¼›å…¶ç‰¹å¾ä¹Ÿä¸ HashSet ç±»ä¼¼ï¼šæ— åºä¸å¯é‡å¤ï¼Œæ”¯æŒ äº¤é›†ã€å¹¶é›†ã€å·®é›†ç­‰åŠŸèƒ½ã€‚ ZSet Redis çš„ ZSet æ˜¯ä¸€ä¸ªå¯æ’åºçš„ Set é›†åˆï¼Œç±»ä¼¼ ZSetã€‚ZSet çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½å¸¦æœ‰ä¸€ä¸ª score å±æ€§ï¼Œå¯ä»¥åŸºäº score å±æ€§å¯¹å…ƒç´ æ’åºã€‚ ZADD key [score member ...] ï¼šä»¥ score ä¸ºæƒé‡å‘ ZSet ä¸­æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ ï¼Œå¦‚æœå­˜åœ¨åˆ™æ›´æ–° scoreã€‚ ZREM key member [member ...] ï¼šåˆ é™¤ ZSet ä¸­çš„æŒ‡å®šå…ƒç´ ã€‚ ZCARD key ï¼šè¿”å› ZSet ä¸­çš„å…ƒç´ ä¸ªæ•°ã€‚ ZSCORE key member ï¼šè·å– ZSet ä¸­æŒ‡å®šå…ƒç´ çš„ score å€¼ã€‚ ZADD key [score member ...] ï¼šä»¥ score ä¸ºæƒé‡å‘ ZSet ä¸­æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ ï¼Œå¦‚æœå­˜åœ¨åˆ™æ›´æ–° scoreã€‚ ZREM key member [member ...] ï¼šåˆ é™¤ ZSet ä¸­çš„æŒ‡å®šå…ƒç´ ã€‚ ZCARD key ï¼šè¿”å› ZSet ä¸­çš„å…ƒç´ ä¸ªæ•°ã€‚ ZSCORE key member ï¼šè·å– ZSet ä¸­æŒ‡å®šå…ƒç´ çš„ score å€¼ã€‚ ZRANGEBYSCORE key min max ï¼šæŒ‰ç…§ score æ’åºåï¼Œè·å– æŒ‡å®š score èŒƒå›´ å†…çš„å…ƒç´ ã€‚ ZINTER numberKeys key [key ...] ï½œ ZDIFF numberKeys key [key ...] ï½œ ZUNION numberKeys key [key ...] ï¼šæ±‚ n ä¸ª Zset çš„äº¤é›†ã€å·®é›†ã€å¹¶é›†ã€‚ Redis åŸºç¡€ç»“æ„åŠå…¶æ“ä½œæŒ‡ä»¤æ€»ç»“ åŸºç¡€ç»“æ„ æè¿° å¸¸ç”¨æŒ‡ä»¤ ç¤ºä¾‹ Stringï¼ˆå­—ç¬¦ä¸²ï¼‰ æœ€åŸºæœ¬çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥å­˜å‚¨å­—ç¬¦ä¸²ã€æ•´æ•°æˆ–æµ®ç‚¹æ•° SETã€GETã€INCRã€DECRã€APPENDã€MSETã€MGET SET key valueï¼ŒGET key Listï¼ˆåˆ—è¡¨ï¼‰ æœ‰åºé›†åˆï¼Œå…è®¸é‡å¤å…ƒç´ ï¼Œåº•å±‚ä¸ºåŒå‘é“¾è¡¨ LPUSHã€RPUSHã€LPOPã€RPOPã€LRANGE LPUSH mylist A B Cï¼ŒLRANGE mylist 0 -1 Setï¼ˆé›†åˆï¼‰ æ— åºé›†åˆï¼Œä¸å…è®¸é‡å¤å…ƒç´  SADDã€SREMã€SMEMBERSã€SISMEMBER SADD myset A B Cï¼ŒSMEMBERS myset Hashï¼ˆå“ˆå¸Œï¼‰ ç±»ä¼¼äºå¯¹è±¡ï¼Œå­˜å‚¨é”®å€¼å¯¹ HSETã€HGETã€HGETALLã€HDEL HSET user name &quot;Alice&quot;ï¼ŒHGET user name ZSetï¼ˆæœ‰åºé›†åˆï¼‰ å…·æœ‰æƒé‡ï¼ˆscoreï¼‰çš„é›†åˆï¼Œå…ƒç´ æŒ‰åˆ†æ•°æ’åº ZADDã€ZRANGEã€ZREMã€ZSCORE ZADD myzset 1 A 2 Bï¼ŒZRANGE myzset 0 -1 Bitmapï¼ˆä½å›¾ï¼‰ ä½çº§åˆ«çš„å­˜å‚¨ï¼Œç”¨äºé«˜æ•ˆå­˜å‚¨å’Œæ“ä½œäºŒè¿›åˆ¶æ•°æ® SETBITã€GETBITã€BITCOUNT SETBIT mybitmap 10 1ï¼ŒGETBIT mybitmap 10 HyperLogLog è¿‘ä¼¼å»é‡è®¡æ•°ç»“æ„ï¼Œé€‚ç”¨äºå¤§æ•°æ®è®¡æ•° PFADDã€PFCOUNT PFADD myhll A B Cï¼ŒPFCOUNT myhll Geoï¼ˆåœ°ç†ä½ç½®ï¼‰ å­˜å‚¨ç»çº¬åº¦å¹¶è®¡ç®—åœ°ç†è·ç¦» GEOADDã€GEODISTã€GEORADIUS GEOADD mygeo 120.0 30.0 &quot;place1&quot;ï¼ŒGEODIST mygeo place1 place2 Streamï¼ˆæµï¼‰ å¯æŒä¹…åŒ–çš„æ¶ˆæ¯é˜Ÿåˆ—ç»“æ„ XADDã€XLENã€XREAD XADD mystream * name &quot;Alice&quot;ï¼ŒXREAD COUNT 1 STREAMS mystream 0 è¿™äº›ç»“æ„å’ŒæŒ‡ä»¤åœ¨ä¸åŒçš„åº”ç”¨åœºæ™¯ä¸­æœ‰ä¸åŒçš„ä¼˜åŠ¿ï¼Œæ¯”å¦‚ String é€‚ç”¨äºç¼“å­˜æ•°æ®ï¼ŒList é€‚ç”¨äºæ¶ˆæ¯é˜Ÿåˆ—ï¼ŒSet é€‚ç”¨äºå»é‡ï¼ŒZSet é€‚ç”¨äºæ’è¡Œæ¦œï¼ŒHash é€‚ç”¨äºå­˜å‚¨å¯¹è±¡ï¼ŒBitmap é€‚ç”¨äºç”¨æˆ·ç­¾åˆ°æˆ–æ´»è·ƒè®°å½•ï¼ŒHyperLogLog é€‚ç”¨äºå¤§è§„æ¨¡æ•°æ®å»é‡ç»Ÿè®¡ï¼ŒGeo é€‚ç”¨äºåœ°ç†ä½ç½®å­˜å‚¨ï¼ŒStream é€‚ç”¨äºäº‹ä»¶æµå’Œæ¶ˆæ¯é˜Ÿåˆ—ã€‚ javaå®¢æˆ·ç«¯è¿æ¥redis ä½¿ç”¨Jedis 1.å¯¼å…¥ä¾èµ– 12345&lt;dependency&gt; &lt;groupId&gt;redis.clients&lt;/groupId&gt; &lt;artifactId&gt;jedis&lt;/artifactId&gt; &lt;version&gt;3.8.0&lt;/version&gt;&lt;/dependency&gt; 2.å»ºç«‹è¿æ¥ 12345678910111213141516171819202122232425262728293031public class JedisTest { private Jedis jedis; @BeforeEach void setUp(){ //1.å»ºç«‹è¿æ¥ jedis = new Jedis(&quot;192.168.200.130&quot;,6379); //2.è®¾ç½®å¯†ç  jedis.auth(&quot;1234&quot;); //3.é€‰æ‹©åº“ jedis.select(0); } @Test void testString(){ String result = jedis.set(&quot;name&quot;, &quot;å°æ˜&quot;); System.out.println(&quot;result= &quot; + result); String name = jedis.get(&quot;name&quot;); System.out.println(&quot;name= &quot;+name); } @AfterEach void tearDown(){ if(jedis!=null){ jedis.close(); } }} 3.jedisè¿æ¥æ±  12345678910111213141516171819public class JedisConnectFactory { private static final JedisPool jedisPool; static{ //é…ç½®è¿æ¥æ±  JedisPoolConfig poolConfig = new JedisPoolConfig(); poolConfig.setMaxTotal(8); poolConfig.setMaxIdle(8); poolConfig.setMinIdle(0); poolConfig.setMaxWait(Duration.ofMillis(1000)); jedisPool = new JedisPool(poolConfig,&quot;192.168.200.130&quot;,6379,1000,&quot;1234&quot;); } public static Jedis getJedis(){ return jedisPool.getResource(); }} 1ï¼‰ JedisConnectionFacotryï¼šå·¥å‚è®¾è®¡æ¨¡å¼æ˜¯å®é™…å¼€å‘ä¸­éå¸¸å¸¸ç”¨çš„ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å·¥å‚ï¼Œå»é™ä½ä»£çš„è€¦åˆï¼Œæ¯”å¦‚Springä¸­çš„Beançš„åˆ›å»ºï¼Œå°±ç”¨åˆ°äº†å·¥å‚è®¾è®¡æ¨¡å¼ 2ï¼‰é™æ€ä»£ç å—ï¼šéšç€ç±»çš„åŠ è½½è€ŒåŠ è½½ï¼Œç¡®ä¿åªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œæˆ‘ä»¬åœ¨åŠ è½½å½“å‰å·¥å‚ç±»çš„æ—¶å€™ï¼Œå°±å¯ä»¥æ‰§è¡Œstaticçš„æ“ä½œå®Œæˆå¯¹ è¿æ¥æ± çš„åˆå§‹åŒ– 3ï¼‰æœ€åæä¾›è¿”å›è¿æ¥æ± ä¸­è¿æ¥çš„æ–¹æ³•. ä½¿ç”¨springDataRedisè¿æ¥ 1.å¯¼å…¥ä¾èµ– 12345678910&lt;!--Redisä¾èµ–--&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;&lt;/dependency&gt;&lt;!--è¿æ¥æ± ä¾èµ–--&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.commons&lt;/groupId&gt; &lt;artifactId&gt;commons-pool2&lt;/artifactId&gt;&lt;/dependency&gt; 2.é…ç½®è¿æ¥ä¿¡æ¯ 123456789101112spring: redis: host: 192.168.200.130 port: 6379 password: 1234 database: 0 lettuce: pool: max-active: 8 #æœ€å¤§è¿æ¥æ•° max-idle: 8 #æœ€å¤§ç©ºé—²è¿æ¥ min-idle: 0 #æœ€å°ç©ºé—²è¿æ¥ max-wait: 100 #è¿æ¥ç­‰å¾…æ—¶é—´ 3.ç›´æ¥æ³¨å…¥RedisTemplateå‡ºç°çš„é—®é¢˜ 123456789101112131415161718192021222324252627// è‡ªåŠ¨æ³¨å…¥çš„ `RedisTemplate` éœ€è¦åŠ ä¸Šæ³›å‹@Resourceprivate RedisTemplate redisTemplate;@Testpublic void test() { redisTemplate.opsForValue().set(&quot;k1&quot;, &quot;v1&quot;); Map&lt;String, String&gt; map = new HashMap&lt;&gt;(); map.put(&quot;k2&quot;, &quot;v2&quot;); map.put(&quot;k3&quot;, &quot;v3&quot;); map.put(&quot;k4&quot;, &quot;v4&quot;); map.put(&quot;k5&quot;, &quot;v5&quot;); redisTemplate.opsForValue().multiSet(map); redisTemplate.opsForValue().multiGet(Arrays.asList(&quot;k1&quot;, &quot;k2&quot;, &quot;k3&quot;, &quot;k4&quot;)).forEach(System.out::println); // v1 v2 v3 v4 v5}//ç»“æœ# åœ¨ Redis ä¸­æŸ¥çœ‹é€šè¿‡ RedisTemplate æ’å…¥çš„æ•°æ®&gt; keys *1) &quot;\\xac\\xed\\x00\\x05t\\x00\\x02k1&quot;2) &quot;\\xac\\xed\\x00\\x05t\\x00\\x02k2&quot;3) &quot;\\xac\\xed\\x00\\x05t\\x00\\x02k3&quot;4) &quot;\\xac\\xed\\x00\\x05t\\x00\\x02k4&quot;5) &quot;\\xac\\xed\\x00\\x05t\\x00\\x02k5&quot;&gt; get &quot;\\xac\\xed\\x00\\x05t\\x00\\x02k1&quot;&quot;\\xac\\xed\\x00\\x05t\\x00\\x02v1&quot; RedisTemplate å­˜åœ¨çš„é—®é¢˜ é€šè¿‡ä»¥ä¸Šæ“ä½œå¯ä»¥å‘ç°ï¼šRedisTemplate å¯ä»¥å°†ä»»æ„ç±»å‹çš„æ•°æ®å†™å…¥åˆ° Redis ä¸­ï¼Œåœ¨å†™å…¥å‰ä¼šå°†å…¶åºåˆ—åŒ–ä¸ºå­—èŠ‚å½¢å¼å­˜å‚¨ï¼Œåº•å±‚é»˜è®¤é‡‡ç”¨ ObjectOutputStream åºåˆ—åŒ–ã€‚ 4.å› æ­¤æˆ‘ä»¬è¦é‡å†™ä»–çš„åºåˆ—åŒ–å·¥å…· å¯¼å…¥ jackson-databind ä¾èµ–ï¼Œå¹¶ç¼–å†™é…ç½®ç±» RedisTemplateConfigã€‚ 12345678910111213141516171819202122@Configurationpublic class RedisTemplateConfig { @Bean public RedisTemplate&lt;String, Object&gt; redisTemplate(RedisConnectionFactory redisConnectionFactory) { // åˆ›å»º RedisTemplate å¯¹è±¡ RedisTemplate&lt;String, Object&gt; redisTemplate = new RedisTemplate&lt;&gt;(); // è®¾ç½®è¿æ¥å·¥å‚ redisTemplate.setConnectionFactory(redisConnectionFactory); // è®¾ç½®åºåˆ—åŒ–å·¥å…· GenericJackson2JsonRedisSerializer jsonRedisSerializer = new GenericJackson2JsonRedisSerializer(); // Key å’Œ HashKey é‡‡ç”¨ String åºåˆ—åŒ–ï¼ˆStringRedisSerializerï¼‰ redisTemplate.setKeySerializer(RedisSerializer.string()); redisTemplate.setHashKeySerializer(RedisSerializer.string()); // Value å’Œ HashValue é‡‡ç”¨ JSON åºåˆ—åŒ–ï¼ˆGenericJackson2JsonRedisSerializerï¼‰ redisTemplate.setValueSerializer(jsonRedisSerializer); redisTemplate.setHashValueSerializer(jsonRedisSerializer); return redisTemplate; }} 12345678910// è‡ªåŠ¨æ³¨å…¥çš„ `RedisTemplate` éœ€è¦åŠ ä¸Šæ³›å‹@Autowiredprivate RedisTemplate&lt;String, Object&gt; redisTemplate;@Testpublic void test() { redisTemplate.opsForValue().set(&quot;k1&quot;, &quot;v1&quot;); redisTemplate.opsForValue().set(&quot;user:1&quot;, new User(&quot;Jack&quot;, 21));} é€šè¿‡ä»¥ä¸Šçš„æ–¹æ³•èƒ½å¤Ÿè§£å†³æ•°æ®åºåˆ—åŒ–æ—¶ å¯è¯»æ€§å·®ã€å†…å­˜å ç”¨å¤§ çš„é—®é¢˜ã€‚ ä½†æ˜¯ JSON çš„åºåˆ—åŒ–æ–¹å¼ä»ç„¶å­˜åœ¨ä¸€äº›é—®é¢˜ï¼šä¸ºäº†ååºåˆ—åŒ–æ—¶çŸ¥é“å¯¹è±¡çš„ç±»å‹ï¼ŒJSON åºåˆ—åŒ–å™¨ä¼šå°†ç±»çš„ class ç±»å‹å†™å…¥ JSON ç»“æœï¼Œå­˜å…¥ Redis ä¸­ï¼Œä¼šå¸¦æ¥é¢å¤–çš„å†…å­˜å¼€é”€ã€‚ 5.ä½¿ç”¨StringRedisTemplate ä¸ºäº†èŠ‚çœå†…å­˜ç©ºé—´ï¼ŒSpring æä¾›äº†ä¸€ä¸ª StringRedisTemplateï¼Œå®ƒçš„ key å’Œ value çš„åºåˆ—åŒ–æ–¹å¼é»˜è®¤å°±æ˜¯ Stringï¼Œç»Ÿä¸€ä½¿ç”¨ String åºåˆ—åŒ–å™¨ã€‚ å½“éœ€è¦å­˜å‚¨ Java å¯¹è±¡æ—¶ï¼Œæ‰‹åŠ¨å®Œæˆå¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚ ä½¿ç”¨ StringRedisTemplateã€‚ å†™å…¥æ•°æ®åˆ° Redis ä¸­ï¼Œæ‰‹åŠ¨å°†å¯¹è±¡åºåˆ—åŒ–ä¸º JSONã€‚ ä» Redis ä¸­è¯»å–æ•°æ®ï¼Œæ‰‹åŠ¨å°†è¯»å–åˆ°çš„ JSON ååºåˆ—åŒ–ä¸ºå¯¹è±¡ã€‚ 123456789101112131415161718192021222324@Autowiredprivate StringRedisTemplate stringRedisTemplate;private static final ObjectMapper objectMapper = new ObjectMapper();@Testpublic void ttt() throws JsonProcessingException { User user = new User(&quot;Michael&quot;, 27); // æ‰‹åŠ¨åºåˆ—åŒ– String json = objectMapper.writeValueAsString(user); // å†™å…¥æ•°æ® stringRedisTemplate.opsForValue().set(&quot;user:1&quot;, json); // è¯»å–æ•°æ® String data = stringRedisTemplate.opsForValue().get(&quot;user:1&quot;); // ååºåˆ—åŒ– User deserializedUser = objectMapper.readValue(data, User.class); System.out.println(deserializedUser);}//ç»“æœ{ &quot;username&quot;: &quot;Michael&quot;, &quot;age&quot;: 27}","link":"/posts/redis%E5%9F%BA%E7%A1%80%E7%BB%93%E6%9E%84/"},{"title":"redisè§£å†³å¸¸è§çš„ç§’æ€é—®é¢˜","text":"ç§’æ€é—®é¢˜ æ¯ä¸ªåº—é“ºéƒ½å¯ä»¥å‘å¸ƒä¼˜æƒ åˆ¸ï¼Œä¿å­˜åˆ° tb_voucher è¡¨ä¸­ï¼›å½“ç”¨æˆ·æŠ¢è´­æ—¶ï¼Œç”Ÿæˆè®¢å•å¹¶ä¿å­˜åˆ° tb_voucher_order è¡¨ä¸­ã€‚ è®¢å•è¡¨å¦‚æœä½¿ç”¨æ•°æ®åº“è‡ªå¢ IDï¼Œä¼šå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š ID çš„è§„å¾‹å¤ªæ˜æ˜¾ï¼Œå®¹æ˜“æš´éœ²ä¿¡æ¯ã€‚ å•è¡¨æ•°æ®é‡çš„é™åˆ¶ï¼Œè®¢å•è¿‡å¤šæ—¶å•è¡¨å¾ˆéš¾å­˜å‚¨å¾—ä¸‹ã€‚æ•°æ®é‡è¿‡å¤§åéœ€è¦æ‹†åº“æ‹†è¡¨ï¼Œä½†æ‹†åˆ†è¡¨äº†ä¹‹åï¼Œå„è¡¨ä»é€»è¾‘ä¸Šæ˜¯åŒä¸€å¼ è¡¨ï¼Œæ‰€ä»¥ id ä¸èƒ½ä¸€æ ·ï¼Œ äºæ˜¯éœ€è¦ä¿è¯ ID çš„å”¯ä¸€æ€§ã€‚ å…¨å±€å”¯ä¸€ID å…¨å±€å”¯ä¸€ ID çš„ç‰¹ç‚¹ å”¯ä¸€æ€§ï¼šRedis ç‹¬ç«‹äºæ•°æ®åº“ä¹‹å¤–ï¼Œä¸è®ºæœ‰å¤šå°‘ä¸ªæ•°æ®åº“ã€å¤šå°‘å¼ è¡¨ï¼Œè®¿é—® Redis è·å–åˆ°çš„ ID å¯ä»¥ä¿è¯å”¯ä¸€ã€‚ é«˜å¯ç”¨ï¼šRedis é«˜å¯ç”¨ï¼ˆé›†ç¾¤ç­‰æ–¹æ¡ˆï¼‰ã€‚ é«˜æ€§èƒ½ï¼šRedis é€Ÿåº¦å¾ˆå¿«ã€‚ é€’å¢æ€§ï¼šä¾‹å¦‚ String çš„ INCR å‘½ä»¤ï¼Œå¯ä»¥ä¿è¯é€’å¢ã€‚ å®‰å…¨æ€§ï¼šä¸ºäº†å¢åŠ  ID çš„å®‰å…¨æ€§ï¼Œåœ¨ä½¿ç”¨ Redis è‡ªå¢æ•°å€¼çš„åŸºç¡€ä¸Šï¼Œåœ¨æ‹¼æ¥ä¸€äº›å…¶ä»–ä¿¡æ¯ã€‚ å…¨å±€å”¯ä¸€ ID çš„ç»„æˆï¼ˆå­˜å‚¨æ•°å€¼ç±»å‹å ç”¨ç©ºé—´æ›´å°ï¼Œä½¿ç”¨ long å­˜å‚¨ï¼Œ8 byteï¼Œ64 bitï¼‰ ç¬¦å·ä½ï¼š1 bitï¼Œæ°¸è¿œä¸º 0ï¼Œä»£è¡¨ ID æ˜¯æ­£æ•°ã€‚ æ—¶é—´æˆ³ï¼š31 bitï¼Œä»¥ç§’ä¸ºå•ä½ï¼Œå¯ä»¥ä½¿ç”¨ 69 å¹´ã€‚ åºåˆ—å·ï¼š32 bitï¼Œå½“å‰æ—¶é—´æˆ³å¯¹åº”çš„æ•°é‡ï¼Œä¹Ÿå°±æ˜¯æ¯ç§’å¯ä»¥å¯¹åº” 2^32 ä¸ªä¸åŒçš„ IDã€‚ Redis ID è‡ªå¢ç­–ç•¥ï¼šé€šè¿‡è®¾ç½®æ¯å¤©å­˜å…¥ä¸€ä¸ª Keyï¼Œæ–¹ä¾¿ç»Ÿè®¡è®¢å•æ•°é‡ï¼›ID æ„é€ ä¸º æ—¶é—´æˆ³ + è®¡æ•°å™¨ã€‚ 123456789101112131415161718192021222324252627@Componentpublic class RedisIdWorker { /** * æŒ‡å®šæ—¶é—´æˆ³ï¼ˆ2023å¹´1æœˆ1æ—¥ 0:0:00ï¼‰ LocalDateTime.of(2023, 1, 1, 0, 0, 0).toEpochSecond(ZoneOffset.UTC) */ private static final long BEGIN_TIMESTAMP_2023 = 1672531200L; /** * åºåˆ—å·ä½æ•° */ private static final int BIT_COUNT = 32; private final StringRedisTemplate stringRedisTemplate; public RedisIdWorker(StringRedisTemplate stringRedisTemplate) { this.stringRedisTemplate = stringRedisTemplate; } public long nextId(String keyPrefix) { // 1. æ—¶é—´æˆ³ long timestamp = LocalDateTime.now().toEpochSecond(ZoneOffset.UTC) - BEGIN_TIMESTAMP_2023; // 2. ç”Ÿæˆåºåˆ—å·ï¼šè‡ªå¢ 1ï¼ŒKey ä¸å­˜åœ¨ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª Keyã€‚ï¼ˆå­˜å‚¨åˆ° Redis ä¸­çš„ Key ä¸º keyPrefix:dateï¼ŒValue ä¸ºè‡ªå¢çš„æ•°é‡ï¼‰ Long serialNumber = stringRedisTemplate.opsForValue().increment(keyPrefix + &quot;:&quot; + DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd&quot;).format(LocalDate.now())); // 3. æ—¶é—´æˆ³å·¦ç§» 32 ä½ï¼Œåºåˆ—å·ä¸å³è¾¹çš„ 32 ä¸ª 0 è¿›è¡Œä¸è¿ç®— return timestamp &lt;&lt; BIT_COUNT | serialNumber; }} æµ‹è¯•(300ä¸ªçº¿ç¨‹ç”Ÿæˆå…±3wä¸ªid) 1234567891011121314151617181920212223242526@Resourceprivate RedisIdWorker redisIdWorker;public static final ExecutorService ES = Executors.newFixedThreadPool(500);@Testvoid testGloballyUniqueID() throws Exception { // ç¨‹åºæ˜¯å¼‚æ­¥çš„ï¼Œåˆ†çº¿ç¨‹å…¨éƒ¨èµ°å®Œä¹‹åä¸»çº¿ç¨‹å†èµ°ï¼Œä½¿ç”¨ CountDownLatchï¼›å¦åˆ™å¼‚æ­¥ç¨‹åºæ²¡æœ‰æ‰§è¡Œå®Œæ—¶ä¸»çº¿ç¨‹å°±å·²ç»æ‰§è¡Œå®Œäº† CountDownLatch latch = new CountDownLatch(300); Runnable task = () -&gt; { for (int i = 0; i &lt; 100; i++) { long globallyUniqueID = redisIdWorker.nextId(&quot;sun&quot;); System.out.println(&quot;globallyUniqueID = &quot; + globallyUniqueID); } latch.countDown(); }; long begin = System.currentTimeMillis(); for (int i = 0; i &lt; 300; i++) { ES.submit(task); } latch.await(); long end = System.currentTimeMillis(); System.out.println(&quot;Execution Time: &quot; + (end - begin));} æ·»åŠ ä¼˜æƒ å· æ ¼å¼ç±»ä¼¼è¿™ç§é€»è¾‘å¤ªç®€å•äº†ç•¥ 123456789101112{ &quot;shopId&quot;:1, &quot;title&quot;:&quot;100å…ƒä»£é‡‘åˆ¸&quot;, &quot;subTitle&quot;:&quot;å‘¨ä¸€è‡³å‘¨äº”å‡å¯ä½¿ç”¨&quot;, &quot;rules&quot;:&quot;å…¨åœºé€šç”¨\\næ— éœ€é¢„çº¦\\nå¯æ— é™å åŠ \\nä¸å…‘ç°ã€ä¸æ‰¾é›¶\\nä»…é™å ‚é£Ÿ&quot;, &quot;payValue&quot;:8000, &quot;actualValue&quot;:10000, &quot;type&quot;:1, &quot;stock&quot;:100, &quot;beginTime&quot;:&quot;2022-11-13T10:09:17&quot;, &quot;endTime&quot;:&quot;2022-11-13T22:10:17&quot;} ç§’æ€ä¸‹å•åŠŸèƒ½ 1234567891011121314151617181920212223242526272829303132333435363738394041@Override@Transactionalpublic Result seckillVoucher(Long voucherId) { //1.æŸ¥è¯¢ä¼˜æƒ å· SeckillVoucher voucher = seckillVoucherService.getById(voucherId); //2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹ï¼Œæ˜¯å¦ç»“æŸ if (voucher.getBeginTime().isAfter(LocalDateTime.now())) { return Result.fail(&quot;ç§’æ€å°šæœªå¼€å§‹!&quot;); } if(voucher.getEndTime().isBefore(LocalDateTime.now())){ return Result.fail(&quot;ç§’æ€å·²ç»“æŸ!&quot;); } //3.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ if(voucher.getStock()&lt;=0){ return Result.fail(&quot;ä¼˜æƒ åˆ¸åº“å­˜ä¸è¶³!&quot;); } //4.æ‰£å‡åº“å­˜ boolean success = seckillVoucherService.update() .setSql(&quot;stock = stock -1&quot;) .eq(&quot;voucher_id&quot;, voucherId).update(); //5.åˆ›å»ºè®¢å• if(!success){ return Result.fail(&quot;ä¼˜æƒ åˆ¸åº“å­˜ä¸è¶³!&quot;); } //6.è¿”å›è®¢å•id VoucherOrder voucherOrder = new VoucherOrder(); //6.1è®¢å•id long orderId = redisIdWorker.nextId(&quot;order&quot;); voucherOrder.setId(orderId); //6.2ç”¨æˆ·id Long userId = UserHolder.getUser().getId(); voucherOrder.setUserId(userId); //6.3ä»£é‡‘åˆ¸id voucherOrder.setVoucherId(voucherId); //7.è®¢å•å†™å…¥æ•°æ®åº“ save(voucherOrder); //8.è¿”å›è®¢å•Id return Result.ok(orderId);} è¶…å–é—®é¢˜ å‡è®¾åº“å­˜ä¸º 1ï¼Œæœ‰çº¿ç¨‹1ã€2ã€3ï¼Œæ—¶åˆ» t1ã€t2ã€t3ã€t4ã€‚ t1ï¼šçº¿ç¨‹1 æŸ¥è¯¢åº“å­˜ï¼Œåº“å­˜ä¸º 1ï¼› t2ï¼šçº¿ç¨‹2ã€çº¿ç¨‹ 3 æŸ¥è¯¢åº“å­˜ï¼Œåº“å­˜ä¸º 1ï¼› t3ï¼šçº¿ç¨‹1 ä¸‹å•ï¼Œåº“å­˜æ‰£å‡ä¸º 0ã€‚ t4ï¼šçº¿ç¨‹2 å’Œ çº¿ç¨‹3 ä¸‹å•ï¼Œåº“å­˜æ‰£å‡ä¸º -2ã€‚ å…·ä½“å›¾ç¤º: è§£å†³è¶…å–é—®é¢˜ æ‚²è§‚é” å¤ªç®€å•äº†ç›´æ¥åŠ é”ä¿è¯æ“ä½œæ•°æ®æ˜¯åŸå­æ“ä½œè¦ä¸²è¡Œæ‰§è¡Œ ä¹è§‚é” ç‰ˆæœ¬å·æ³•: ä¸€èˆ¬æ˜¯åœ¨æ•°æ®åº“è¡¨ä¸­åŠ ä¸Šä¸€ä¸ª version å­—æ®µè¡¨ç¤º æ•°æ®è¢«ä¿®æ”¹çš„æ¬¡æ•°ã€‚æ•°æ®è¢«ä¿®æ”¹æ—¶ version å€¼åŠ  1ã€‚ çº¿ç¨‹ A è¯»å–æ•°æ®ï¼ŒåŒæ—¶è¯»å–åˆ° version å€¼ã€‚ æäº¤æ›´æ–°æ—¶ï¼Œè‹¥åˆšæ‰è¯»åˆ°çš„ version å€¼æœªå‘ç”Ÿå˜åŒ–ï¼šåˆ™æäº¤æ›´æ–°å¹¶ä¸” version å€¼åŠ  1ã€‚ æäº¤æ›´æ–°æ—¶ï¼Œè‹¥åˆšæ‰è¯»åˆ°çš„ version å€¼å‘ç”Ÿäº†å˜åŒ–ï¼šæ”¾å¼ƒæ›´æ–°ï¼Œå¹¶é€šè¿‡æŠ¥é”™ã€è‡ªæ—‹é‡è¯•ç­‰æ–¹å¼è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†ã€‚ CASæ³•(ç®€å•æ¥è¯´å°±æ˜¯ç›´æ¥æ‹¿åº“å­˜å½“ç‰ˆæœ¬å·): CAS æ“ä½œéœ€è¦è¾“å…¥ä¸¤ä¸ªæ•°å€¼ï¼Œä¸€ä¸ªæ—§å€¼ï¼ˆæ“ä½œå‰çš„å€¼ï¼‰å’Œä¸€ä¸ªæ–°å€¼ï¼Œæ“ä½œæ—¶å…ˆæ¯”è¾ƒä¸‹åœ¨æ—§å€¼æœ‰æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œè‹¥æœªå‘ç”Ÿå˜åŒ–æ‰äº¤æ¢æˆæ–°å€¼ï¼Œå‘ç”Ÿäº†å˜åŒ–åˆ™ä¸äº¤æ¢ã€‚ CAS æ˜¯åŸå­æ“ä½œï¼Œå¤šçº¿ç¨‹å¹¶å‘ä½¿ç”¨ CAS æ›´æ–°æ•°æ®æ—¶ï¼Œå¯ä»¥ä¸ä½¿ç”¨é”ã€‚åŸå­æ“ä½œæ˜¯æœ€å°çš„ä¸å¯æ‹†åˆ†çš„æ“ä½œï¼Œæ“ä½œä¸€æ—¦å¼€å§‹ï¼Œä¸èƒ½è¢«æ‰“æ–­ï¼Œç›´åˆ°æ“ä½œå®Œæˆã€‚ä¹Ÿå°±æ˜¯å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€å—å†…å­˜çš„æ“ä½œæ˜¯ä¸²è¡Œçš„ã€‚ ä¸€äººä¸€å•é—®é¢˜ ä¸€äººä¸€å•é€»è¾‘: å‘é€ä¸‹å•è¯·æ±‚ï¼Œæäº¤ä¼˜æƒ åˆ¸ IDã€‚ ä¸‹å•å‰éœ€è¦åˆ¤æ–­ï¼šç§’æ€æ˜¯å¦å¼€å§‹æˆ–ç»“æŸã€åº“å­˜æ˜¯å¦å……è¶³ã€‚ åº“å­˜å……è¶³ï¼šæ ¹æ®ä¼˜æƒ åˆ¸ ID å’Œç”¨æˆ· ID æŸ¥è¯¢è®¢å•ï¼Œåˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦è´­ä¹°è¿‡è¯¥ä¼˜æƒ åˆ¸ã€‚ è¯¥ç”¨æˆ·å¯¹è¯¥ä¼˜æƒ åˆ¸çš„è®¢å•ä¸å­˜åœ¨æ—¶ï¼Œæ‰£å‡åº“å­˜ã€åˆ›å»ºè®¢å•ã€è¿”å›è®¢å• IDã€‚ è§£å†³å¹¶å‘å®‰å…¨é—®é¢˜ å•äººä¸‹å•ï¼ˆä¸€ä¸ªç”¨æˆ·ï¼‰ï¼Œé«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼šè¯¥ç”¨æˆ·çš„ 10 ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œåˆ° æŸ¥è¯¢è¯¥ç”¨æˆ· ID å’Œç§’æ€åˆ¸å¯¹åº”çš„è®¢å•æ•°é‡ï¼Œ10 ä¸ªçº¿ç¨‹æŸ¥è¯¢åˆ°çš„å€¼éƒ½ä¸º 0ï¼Œå³æœªä¸‹å•ã€‚äºæ˜¯ä¼šå‡ºç°ä¸€ä¸ªç”¨æˆ·ä¸‹ 10 å•çš„æƒ…å†µã€‚ **æ­¤å¤„ä»éœ€åŠ é”ï¼Œä¹è§‚é”é€‚åˆæ›´æ–°æ“ä½œï¼Œæ’å…¥æ“ä½œéœ€è¦é€‰æ‹©æ‚²è§‚é”ã€‚**è‹¥ç›´æ¥åœ¨æ–¹æ³•ä¸Šæ·»åŠ  synchronized å…³é”®å­—ï¼Œä¼šè®©é”çš„èŒƒå›´ï¼ˆç²’åº¦ï¼‰è¿‡å¤§ï¼Œå¯¼è‡´æ€§èƒ½è¾ƒå·®ã€‚å› æ­¤ï¼Œé‡‡ç”¨ ä¸€ä¸ªç”¨æˆ·ä¸€æŠŠé” çš„æ–¹å¼ã€‚ é—®é¢˜ï¼šèƒ½å¦ç”¨ä¹è§‚é”æ‰§è¡Œï¼Ÿ ä¸èƒ½ï¼ŒåŸå› æ˜¯ä¹è§‚é”åªèƒ½æ“ä½œ(ä¿®æ”¹)å•ä¸ªå˜é‡ï¼Œè€Œåˆ›å»ºè®¢å•éœ€è¦æ“ä½œæ•°æ®åº“(éš¾ä»¥è·Ÿè¸ªçŠ¶æ€) 12345678910111213141516171819202122232425262728293031323334353637383940414243444546@Overridepublic CommonResult&lt;Long&gt; seckillVoucher(Long voucherId) { // åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹æˆ–ç»“æŸã€åº“å­˜æ˜¯å¦å……è¶³ã€‚ SeckillVoucher seckillVoucher = seckillVoucherService.getById(voucherId); ThrowUtils.throwIf(seckillVoucher == null, ErrorCode.NOT_FOUND_ERROR); LocalDateTime now = LocalDateTime.now(); ThrowUtils.throwIf(now.isBefore(seckillVoucher.getBeginTime()), ErrorCode.OPERATION_ERROR, &quot;ç§’æ€å°šæœªå¼€å§‹&quot;); ThrowUtils.throwIf(now.isAfter(seckillVoucher.getEndTime()), ErrorCode.OPERATION_ERROR, &quot;ç§’æ€å·²ç»ç»“æŸ&quot;); ThrowUtils.throwIf(seckillVoucher.getStock() &lt; 1, ErrorCode.OPERATION_ERROR, &quot;åº“å­˜ä¸è¶³&quot;); // ä¸‹å• return this.createVoucherOrder(voucherId);}/** * ä¸‹å•ï¼ˆè¶…å– - CASã€ä¸€äººä¸€å• - synchronizedï¼‰ */@Override@Transactionalpublic CommonResult&lt;Long&gt; createVoucherOrder(Long voucherId) { // 1. åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦ä¸‹è¿‡å• Long userId = UserHolder.getUser().getId(); Integer count = this.lambdaQuery() .eq(VoucherOrder::getVoucherId, voucherId) .eq(VoucherOrder::getUserId, userId) .count(); ThrowUtils.throwIf(count &gt; 0, ErrorCode.OPERATION_ERROR, &quot;ç¦æ­¢é‡å¤ä¸‹å•&quot;); // 2. æ‰£å‡åº“å­˜ boolean result = seckillVoucherService.update() .setSql(&quot;stock = stock - 1&quot;) .eq(&quot;voucher_id&quot;, voucherId) .gt(&quot;stock&quot;, 0) .update(); ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR, &quot;ä¸‹å•å¤±è´¥&quot;); // 3. ä¸‹å• VoucherOrder voucherOrder = new VoucherOrder(); voucherOrder.setUserId(userId); voucherOrder.setId(redisIdWorker.nextId(&quot;seckillVoucherOrder&quot;)); voucherOrder.setVoucherId(voucherId); result = this.save(voucherOrder); ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR, &quot;ä¸‹å•å¤±è´¥&quot;); return CommonResult.success(voucherOrder.getId());} é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜ åˆ†å¸ƒå¼é”-åŸç† ä¸å»ä½¿ç”¨jvmå†…éƒ¨çš„é”ç›‘è§†å™¨ï¼Œæˆ‘ä»¬è¦åœ¨å¤–éƒ¨å¼€ä¸€ä¸ªé”ç›‘è§†å™¨ï¼Œè®©å®ƒç›‘è§†æ‰€æœ‰çš„çº¿ç¨‹ å¸¸è§çš„åˆ†å¸ƒå¼é” MySQLï¼šMySQL æœ¬èº«å¸¦æœ‰é”æœºåˆ¶ï¼Œä½†æ˜¯ç”±äº MySQL æ€§èƒ½ä¸€èˆ¬ï¼Œæ‰€ä»¥é‡‡ç”¨åˆ†å¸ƒå¼é”çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ MySQL ä½œä¸ºåˆ†å¸ƒå¼é”æ¯”è¾ƒå°‘è§ã€‚ Redisï¼šRedis ä½œä¸ºåˆ†å¸ƒå¼é”æ¯”è¾ƒå¸¸è§ï¼Œåˆ©ç”¨ setnx æ–¹æ³•ï¼Œå¦‚æœ Key æ’å…¥æˆåŠŸï¼Œåˆ™è¡¨ç¤ºè·å–åˆ°é”ï¼Œæ’å…¥å¤±è´¥åˆ™è¡¨ç¤ºæ— æ³•è·å–åˆ°é”ã€‚ Zookeeperï¼šZookeeper ä¹Ÿæ˜¯ä¼ä¸šçº§å¼€å‘ä¸­æ¯”è¾ƒå¥½çš„ä¸€ä¸ªå®ç°åˆ†å¸ƒå¼é”çš„æ–¹æ¡ˆã€‚ MySQL Redis Zookeeper äº’æ–¥ åˆ©ç”¨ MySQL æœ¬èº«çš„äº’æ–¥é”æœºåˆ¶ åˆ©ç”¨ setnx äº’æ–¥å‘½ä»¤ åˆ©ç”¨èŠ‚ç‚¹çš„å”¯ä¸€æ€§å’Œæœ‰åºæ€§ é«˜å¯ç”¨ å¥½ å¥½ å¥½ é«˜æ€§èƒ½ ä¸€èˆ¬ å¥½ ä¸€èˆ¬ å®‰å…¨æ€§ æ–­å¼€é“¾æ¥ï¼Œè‡ªåŠ¨é‡Šæ”¾é” åˆ©ç”¨é”è¶…æ—¶æ—¶é—´ï¼Œåˆ°æœŸé‡Šæ”¾ ä¸´æ—¶èŠ‚ç‚¹ï¼Œæ–­å¼€é“¾æ¥è‡ªåŠ¨é‡Šæ”¾ 12345# æ·»åŠ é”ï¼ˆNX äº’æ–¥ã€EX è®¾ç½® TTL æ—¶é—´ï¼‰SET lock thread1 NX EX 10# æ‰‹åŠ¨é‡Šæ”¾é”DEL lock 123456789101112131415161718192021222324252627282930313233343536373839public interface DistributedLock { /** * è·å–é”ï¼ˆåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè·å–åˆ°é”ï¼‰ * @param timeout é”çš„è¶…æ—¶æ—¶é—´ï¼Œè¿‡æœŸåè‡ªåŠ¨é‡Šæ”¾ * @return true ä»£è¡¨è·å–é”æˆåŠŸï¼›false ä»£è¡¨è·å–é”å¤±è´¥ */ boolean tryLock(long timeout); /** * é‡Šæ”¾é” */ void unlock();}public class SimpleDistributedLock4Redis implements DistributedLock { private static final String KEY_PREFIX = &quot;lock:&quot;; private final String name; private final StringRedisTemplate stringRedisTemplate; public SimpleDistributedLockBased4Redis(String name, StringRedisTemplate stringRedisTemplate) { this.name = name; this.stringRedisTemplate = stringRedisTemplate; } @Override public boolean tryLock(long timeout) { String threadId = Thread.currentThread().getId().toString(); Boolean result = stringRedisTemplate.opsForValue() .setIfAbsent(KEY_PREFIX + name, threadId, timeout, TimeUnit.SECONDS); // result æ˜¯ Boolean ç±»å‹ï¼Œç›´æ¥è¿”å›å­˜åœ¨è‡ªåŠ¨æ‹†ç®±ï¼Œä¸ºé˜²æ­¢ç©ºæŒ‡é’ˆä¸ç›´æ¥è¿”å› return Boolean.TRUE.equals(result); } @Override public void unlock() { stringRedisTemplate.delete(KEY_PREFIX + name); }} 1234567891011121314151617181920/** * VERSION3.0 - ç§’æ€ä¸‹å•ä¼˜æƒ åˆ¸ï¼ˆé€šè¿‡åˆ†å¸ƒå¼é”è§£å†³ä¸€äººä¸€å•é—®é¢˜ï¼‰ */@Overridepublic CommonResult&lt;Long&gt; seckillVoucher(Long voucherId) { // åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹æˆ–ç»“æŸã€åº“å­˜æ˜¯å¦å……è¶³ã€‚ ... // ä¸‹å• SimpleDistributedLock4Redis lock = new SimpleDistributedLock4Redis(&quot;order:&quot; + UserHolder.getUser().getId(), stringRedisTemplate); boolean tryLock = lock.tryLock(TTL_TWO); ThrowUtils.throwIf(!tryLock, ErrorCode.OPERATION_ERROR, &quot;ç¦æ­¢é‡å¤ä¸‹å•&quot;); try { VoucherOrderService voucherOrderService = (VoucherOrderService) AopContext.currentProxy(); return voucherOrderService.createVoucherOrder(voucherId); } finally { lock.unlock(); }} è¯¯åˆ é—®é¢˜ 123456789101112# çº¿ç¨‹ 1 è·å–åˆ°é”åæ‰§è¡Œä¸šåŠ¡ï¼Œç¢°åˆ°äº†ä¸šåŠ¡é˜»å¡ã€‚setnx lock:order:1 thread01# ä¸šåŠ¡é˜»å¡çš„æ—¶é—´è¶…è¿‡äº†è¯¥é”çš„ TTL æ—¶é—´ï¼Œè§¦å‘é”çš„è¶…æ—¶é‡Šæ”¾ã€‚è¶…æ—¶é‡Šæ”¾åï¼Œçº¿ç¨‹ 2 è·å–åˆ°é”å¹¶æ‰§è¡Œä¸šåŠ¡ã€‚setnx lock:order:1 thread02# çº¿ç¨‹ 2 æ‰§è¡Œä¸šåŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹ 1 çš„ä¸šåŠ¡æ‰§è¡Œå®Œæ¯•å¹¶ä¸”é‡Šæ”¾é”ï¼Œä½†æ˜¯é‡Šæ”¾çš„æ˜¯çº¿ç¨‹ 2 è·å–åˆ°çš„é”ã€‚ï¼ˆçº¿ç¨‹ 2ï¼šä½  TM æ”¾æˆ‘é”æ˜¯å§ï¼ï¼‰del lock:order:1# çº¿ç¨‹ 3 è·å–åˆ°é”ï¼ˆæ­¤æ—¶çº¿ç¨‹ 2 å’Œ 3 å¹¶è¡Œæ‰§è¡Œä¸šåŠ¡ï¼‰setnx lock:order:1 thread03 è§£å†³æ–¹æ¡ˆï¼šåœ¨çº¿ç¨‹é‡Šæ”¾é”æ—¶ï¼Œåˆ¤æ–­å½“å‰è¿™æŠŠé”æ˜¯å¦å±äºè‡ªå·±ï¼Œå¦‚æœä¸å±äºè‡ªå·±ï¼Œå°±ä¸ä¼šè¿›è¡Œé”çš„é‡Šæ”¾ï¼ˆåˆ é™¤ï¼‰ã€‚ 123456789101112# çº¿ç¨‹ 1 è·å–åˆ°é”åæ‰§è¡Œä¸šåŠ¡ï¼Œç¢°åˆ°äº†ä¸šåŠ¡é˜»å¡ã€‚setnx lock:order:1 thread01# ä¸šåŠ¡é˜»å¡çš„æ—¶é—´è¶…è¿‡äº†è¯¥é”çš„ TTL æ—¶é—´ï¼Œè§¦å‘é”çš„è¶…æ—¶é‡Šæ”¾ã€‚è¶…æ—¶é‡Šæ”¾åï¼Œçº¿ç¨‹ 2 è·å–åˆ°é”å¹¶æ‰§è¡Œä¸šåŠ¡ã€‚setnx lock:order:1 thread02# çº¿ç¨‹ 2 æ‰§è¡Œä¸šåŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹ 1 çš„ä¸šåŠ¡æ‰§è¡Œå®Œæ¯•å¹¶ä¸”é‡Šæ”¾é”ã€‚ä½†æ˜¯çº¿ç¨‹ 1 éœ€è¦åˆ¤æ–­è¿™æŠŠé”æ˜¯å¦å±äºè‡ªå·±ï¼Œä¸å±äºè‡ªå·±å°±ä¸ä¼šé‡Šæ”¾é”ã€‚# äºæ˜¯çº¿ç¨‹ 2 ä¸€ç›´æŒæœ‰è¿™æŠŠé”ç›´åˆ°ä¸šåŠ¡æ‰§è¡Œç»“æŸåæ‰ä¼šé‡Šæ”¾ï¼Œå¹¶ä¸”åœ¨é‡Šæ”¾æ—¶ä¹Ÿéœ€è¦åˆ¤æ–­å½“å‰è¦é‡Šæ”¾çš„é”æ˜¯å¦å±äºè‡ªå·±ã€‚del lock:order:1# çº¿ç¨‹ 3 è·å–åˆ°é”å¹¶æ‰§è¡Œä¸šåŠ¡setnx lock:order:1 thread03 åŸºäº Redis çš„åˆ†å¸ƒå¼é”çš„å®ç°ï¼ˆè§£å†³è¯¯åˆ é—®é¢˜ï¼‰ ç›¸è¾ƒäºæœ€å¼€å§‹åˆ†å¸ƒå¼é”çš„å®ç°ï¼Œåªéœ€è¦å¢åŠ ä¸€ä¸ªåŠŸèƒ½ï¼šé‡Šæ”¾é”æ—¶éœ€è¦åˆ¤æ–­å½“å‰é”æ˜¯å¦å±äºè‡ªå·±ã€‚ï¼ˆè€Œé›†ç¾¤ç¯å¢ƒä¸‹ä¸åŒ JVM ä¸­çš„çº¿ç¨‹ ID å¯èƒ½ç›¸åŒï¼Œå¢åŠ ä¸€ä¸ª UUID åŒºåˆ†ä¸åŒ JVMï¼‰ å› æ­¤é€šè¿‡åˆ†å¸ƒå¼é”å­˜å…¥ Redis ä¸­çš„çº¿ç¨‹æ ‡è¯†åŒ…æ‹¬ï¼šUUID (æœåŠ¡å™¨id)+ çº¿ç¨‹ ID(çº¿ç¨‹id)ã€‚UUID ç”¨äºåŒºåˆ†ä¸åŒæœåŠ¡å™¨ä¸­çº¿ç¨‹ ID ç›¸åŒçš„çº¿ç¨‹ï¼Œçº¿ç¨‹ ID ç”¨äºåŒºåˆ†ç›¸åŒæœåŠ¡å™¨çš„ä¸åŒçº¿ç¨‹ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243public class SimpleDistributedLockBasedOnRedis implements DistributedLock { private String name; private StringRedisTemplate stringRedisTemplate; public SimpleDistributedLockBasedOnRedis(String name, StringRedisTemplate stringRedisTemplate) { this.name = name; this.stringRedisTemplate = stringRedisTemplate; } private static final String KEY_PREFIX = &quot;lock:&quot;; // ID_PREFIX åœ¨å½“å‰ JVM ä¸­æ˜¯ä¸å˜çš„ï¼Œä¸»è¦ç”¨äºåŒºåˆ†ä¸åŒ JVM private static final String ID_PREFIX = UUID.randomUUID().toString(true) + &quot;-&quot;; /** * è·å–é” */ @Override public boolean tryLock(long timeoutSeconds) { // UUID ç”¨äºåŒºåˆ†ä¸åŒæœåŠ¡å™¨ä¸­çº¿ç¨‹ ID ç›¸åŒçš„çº¿ç¨‹ï¼›çº¿ç¨‹ ID ç”¨äºåŒºåˆ†åŒä¸€ä¸ªæœåŠ¡å™¨ä¸­çš„çº¿ç¨‹ã€‚ String threadIdentifier = ID_PREFIX + Thread.currentThread().getId(); Boolean isSucceeded = stringRedisTemplate.opsForValue() .setIfAbsent(KEY_PREFIX + name, threadIdentifier, timeoutSeconds, TimeUnit.SECONDS); return Boolean.TRUE.equals(isSucceeded); } /** * é‡Šæ”¾é”ï¼ˆé‡Šæ”¾é”å‰é€šè¿‡åˆ¤æ–­ Redis ä¸­çš„çº¿ç¨‹æ ‡è¯†ä¸å½“å‰çº¿ç¨‹çš„çº¿ç¨‹æ ‡è¯†æ˜¯å¦ä¸€è‡´ï¼Œè§£å†³è¯¯åˆ é—®é¢˜ï¼‰ */ @Override public void unlock() { // UUID ç”¨äºåŒºåˆ†ä¸åŒæœåŠ¡å™¨ä¸­çº¿ç¨‹ ID ç›¸åŒçš„çº¿ç¨‹ï¼›çº¿ç¨‹ ID ç”¨äºåŒºåˆ†åŒä¸€ä¸ªæœåŠ¡å™¨ä¸­çš„çº¿ç¨‹ã€‚ String threadIdentifier = THREAD_PREFIX + Thread.currentThread().getId(); String threadIdentifierFromRedis = stringRedisTemplate.opsForValue().get(KEY_PREFIX + name); // æ¯”è¾ƒ Redis ä¸­çš„çº¿ç¨‹æ ‡è¯†ä¸å½“å‰çš„çº¿ç¨‹æ ‡è¯†æ˜¯å¦ä¸€è‡´ if (!StrUtil.equals(threadIdentifier, threadIdentifierFromRedis)) { throw new BusinessException(ErrorCode.OPERATION_ERROR, &quot;é‡Šæ”¾é”å¤±è´¥&quot;); } // é‡Šæ”¾é”æ ‡è¯† stringRedisTemplate.delete(KEY_PREFIX + name); }} ç”¨Luaè„šæœ¬è§£å†³åŸå­æ€§é—®é¢˜ åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜ çº¿ç¨‹ 1 è·å–åˆ°é”å¹¶æ‰§è¡Œå®Œä¸šåŠ¡ï¼Œåˆ¤æ–­é”æ ‡è¯†ä¸€è‡´åé‡Šæ”¾é”ï¼Œé‡Šæ”¾é”çš„è¿‡ç¨‹ä¸­é˜»å¡ï¼Œå¯¼è‡´é”æ²¡æœ‰é‡Šæ”¾æˆåŠŸï¼Œå¹¶ä¸”é˜»å¡çš„æ—¶é—´è¶…è¿‡äº†é”çš„ TTL é‡Šæ”¾ï¼Œå¯¼è‡´é”è‡ªåŠ¨é‡Šæ”¾ã€‚ æ­¤æ—¶çº¿ç¨‹ 2 è·å–åˆ°é”ï¼Œæ‰§è¡Œä¸šåŠ¡ï¼›åœ¨çº¿ç¨‹ 2 æ‰§è¡Œä¸šåŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹ 1 å®Œæˆé‡Šæ”¾é”æ“ä½œã€‚ ä¹‹åï¼Œçº¿ç¨‹ 3 è·å–åˆ°é”ï¼Œæ‰§è¡Œä¸šåŠ¡ï¼Œåˆä¸€æ¬¡å¯¼è‡´æ­¤æ—¶æœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶åœ¨å¹¶è¡Œæ‰§è¡Œä¸šåŠ¡ã€‚ å› æ­¤ï¼Œéœ€è¦ä¿è¯ unlock() æ–¹æ³•çš„åŸå­æ€§ï¼Œå³åˆ¤æ–­çº¿ç¨‹æ ‡è¯†çš„ä¸€è‡´æ€§å’Œé‡Šæ”¾é”è¿™ä¸¤ä¸ªæ“ä½œçš„åŸå­æ€§ã€‚ Redis æä¾›äº† Lua è„šæœ¬åŠŸèƒ½ï¼Œåœ¨ä¸€ä¸ªè„šæœ¬ä¸­ç¼–å†™å¤šæ¡ Redis å‘½ä»¤ï¼Œç¡®ä¿ Redis å¤šæ¡å‘½ä»¤æ‰§è¡Œæ—¶çš„åŸå­æ€§ã€‚ unlockæ“ä½œ 12345678910111213141516private static final DefaultRedisScript&lt;Long&gt; UNLOCK_SCRIPT;static{//å†™æˆé™æ€ä»£ç å—ï¼Œç±»åŠ è½½å°±å¯ä»¥å®Œæˆåˆå§‹å®šä¹‰ï¼Œå°±ä¸ç”¨æ¯æ¬¡é‡Šæ”¾é”éƒ½å»åŠ è½½è¿™ä¸ªï¼Œæ€§èƒ½æé«˜å’¯ UNLOCK_SCRIPT = new DefaultRedisScript&lt;&gt;(); UNLOCK_SCRIPT.setLocation(new ClassPathResource(&quot;unlock.lua&quot;));//è®¾ç½®è„šæœ¬ä½ç½® UNLOCK_SCRIPT.setResultType(Long.class);} public void unlock(){ //è°ƒç”¨luaè„šæœ¬ stringRedisTemplate.execute( UNLOCK_SCRIPT, Collections.singletonList(KEY_PREFIX + name), ID_PREFIX + Thread.currentThread().getId() ); } Luaè„šæœ¬ 12345678-- é”çš„key-- local key = KEYS[1]-- å½“å‰çº¿ç¨‹æ ‡è¯†-- local threadId = ARGV[1]-- è·å–é”ä¸­çš„çº¿ç¨‹æ ‡è¯†if(redis.call('get',KEYS[1]) == ARGV[1]) then return redis.call('del',KEYS[1])end return 0","link":"/posts/redis%E8%A7%A3%E5%86%B3%E5%B8%B8%E8%A7%81%E7%9A%84%E7%A7%92%E6%9D%80%E9%97%AE%E9%A2%98/"},{"title":"redisè¯»å†™ä¸€è‡´é—®é¢˜","text":"Redisè¯»å†™ä¸€è‡´é—®é¢˜ æ¡ä»¶: æ•°æ®åº“æ­¤æ—¶çš„æ•°æ®ä¸º10,redisæ­¤æ—¶çš„æ•°æ®ä¹Ÿä¸º10 ä¸šåŠ¡æµç¨‹: æ“ä½œæ•°æ®åº“ä½¿å¾—æ•°æ®åº“çš„æ•°æ®ä¸º20ï¼Œåˆ é™¤redisé‡Œé¢çš„æ•°æ®ä¿è¯è¯»å†™ä¸€è‡´ å…ˆåˆ ç¼“å­˜ï¼Œå†æ“ä½œæ•°æ®åº“ å‡ºç°è¯»å†™ä¸ä¸€è‡´æƒ…å†µ: çº¿ç¨‹1(ä¸šåŠ¡) çº¿ç¨‹2(å¹¶å‘çº¿ç¨‹) åˆ é™¤ç¼“å­˜ æŸ¥è¯¢ç¼“å­˜ï¼Œæ²¡æœ‰å‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“(æ•°æ®åº“æŸ¥åˆ°ä¸º10ï¼Œä¸‹ä¸€æ­¥å°†10å†™å…¥redis) å°†10å†™å…¥ç¼“å­˜ æ›´æ–°æ•°æ®åº“ï¼Œå°†æ•°æ®åº“ä¸­çš„æ•°æ®æ”¹ä¸º20 æœ€ç»ˆæƒ…å†µ redisé‡Œé¢çš„æ•°æ® æ•°æ®åº“é‡Œé¢çš„æ•°æ® 10 20 å‡ºç°æ•°æ®ä¸ä¸€è‡´æƒ…å†µ å…ˆæ“ä½œæ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ çº¿ç¨‹1(å¹¶å‘çº¿ç¨‹) çº¿ç¨‹2(ä¸šåŠ¡çº¿ç¨‹) æŸ¥è¯¢ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“(ä¸‹ä¸€æ­¥:å°†ç¼“å­˜æ›´æ–°ä¸º10) æ›´æ–°æ•°æ®åº“ v=20 åˆ é™¤ç¼“å­˜ å†™å…¥ç¼“å­˜æ•°æ®10 æœ€ç»ˆæƒ…å†µ: redisæ•°æ® æ•°æ®åº“æ•°æ® 10 20 ä¸¤ä¸ªæ–¹æ³•é€‰æ‹©åŸåˆ™ é€‚ç”¨ç­–ç•¥ å…¸å‹åœºæ™¯ æ˜¯å¦æ¨èä½¿ç”¨å»¶è¿ŸåŒåˆ  å…ˆåˆ ç¼“å­˜ â†’ åæ›´æ–°æ•°æ®åº“ é«˜ä¸€è‡´æ€§ä¸šåŠ¡ï¼ˆä½™é¢ã€åº“å­˜ï¼‰ âœ… ä¸€å®šè¦å»¶è¿ŸåŒåˆ ï¼ å…ˆæ›´æ–°æ•°æ®åº“ â†’ ååˆ ç¼“å­˜ ä½ä¸€è‡´æ€§ä¸šåŠ¡ï¼ˆèµ„æ–™ã€æ–‡ç« å†…å®¹ï¼‰ âŒ å¯ä»¥ä¸ç”¨å»¶è¿ŸåŒåˆ  è§£å†³æ–¹æ¡ˆ:åŒå†™ä¸€è‡´æ€§ è¯»æ“ä½œæ²¡å•¥é—®é¢˜æŒ‰ç…§è€æµç¨‹ å»¶æ—¶åŒåˆ  é—®é¢˜ ç­”æ¡ˆ å…ˆåˆ ç¼“å­˜è¿˜æ˜¯å…ˆæ”¹æ•°æ®åº“ï¼Ÿ å…ˆåˆ ç¼“å­˜ï¼ é¿å…å¹¶å‘å†™å…¥æ—§å€¼ ä¸ºä»€ä¹ˆåˆ ä¸¤æ¬¡ï¼Ÿ é˜²æ­¢â€œæ”¹åº“ä¹‹åï¼Œåˆæœ‰äººå†™äº†æ—§å€¼åˆ°ç¼“å­˜â€ ä¸ºä»€ä¹ˆè¦å»¶è¿Ÿåˆ ï¼Ÿ ç»™å¹¶å‘çº¿ç¨‹ä¸€ä¸ªâ€œå†™å…¥è„ç¼“å­˜â€çš„æœºä¼šï¼Œç„¶åå†æ¸…ç†æ‰å®ƒ ç¼ºç‚¹: é—®é¢˜ç‚¹ å»¶è¿ŸåŒåˆ è§£å†³å¾—äº†ä¹ˆï¼Ÿ æ¨èæ”¹è¿›æ–¹å¼ å¹¶å‘çª—å£å†™å…¥è„ç¼“å­˜ âŒ åªèƒ½åˆ æœ€åä¸€ä¸ª åˆ†å¸ƒå¼é” + åŒåˆ  / MQ å»¶è¿Ÿæ—¶é—´éš¾æ§åˆ¶ âŒ ä¸å¯é¢„æµ‹ MQ æˆ– Canal æœºåˆ¶æ›´ç²¾å‡† å¼‚æ­¥åˆ é™¤å¤±è´¥é£é™© âŒ ä¼šä¸¢å¤±åˆ é™¤ ä½¿ç”¨å¯é ä»»åŠ¡é˜Ÿåˆ— / Redis æŒä¹…åŒ– æ“ä½œå¤æ‚ã€ä»£ç ç»´æŠ¤å›°éš¾ âŒ å®¹æ˜“é—æ¼ key å°è£…ä¸­é—´ä»¶ã€ä½¿ç”¨ AOPç»Ÿä¸€å¤„ç† ç»™ä»–åŠ é” è¯»å†™éƒ½åŠ é” å¦‚å›¾ï¼Œç¨‹åºè¿è¡Œä¸²è¡ŒåŒ–ï¼Œæ€§èƒ½ä½ å¼•å…¥å…±äº«é”å’Œæ’ä»–é”æœºåˆ¶ å…±äº«é”ï¼šè¯»é”readLockï¼ŒåŠ é”ä¹‹åï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥å…±äº«è¯»æ“ä½œ æ’ä»–é”ï¼šç‹¬å é”writeLockä¹Ÿå«ï¼ŒåŠ é”ä¹‹åï¼Œé˜»å¡å…¶ä»–çº¿ç¨‹è¯»å†™æ“ä½œ ä»£ç Demo 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970import org.redisson.api.RReadWriteLock;import org.redisson.api.RedissonClient;import org.redisson.api.RLock;import java.util.concurrent.TimeUnit;public class UserService { private final RedissonClient redissonClient; private final RedisService redisService; // ä½ å°è£…çš„ Redis å·¥å…·ç±» private final UserRepository userRepository; // ä½ æ“ä½œæ•°æ®åº“çš„ç±» public UserService(RedissonClient redissonClient, RedisService redisService, UserRepository userRepository) { this.redissonClient = redissonClient; this.redisService = redisService; this.userRepository = userRepository; } // è¯»æ“ä½œï¼šåŠ â€œè¯»é”â€ public User getUserById(Long userId) { String key = &quot;user:&quot; + userId; String lockKey = &quot;lock:user:&quot; + userId; RReadWriteLock rwLock = redissonClient.getReadWriteLock(lockKey); RLock readLock = rwLock.readLock(); try { readLock.lock(5, TimeUnit.SECONDS); // åŠ è¯»é”ï¼Œé˜²æ­¢åŒæ—¶å†™å…¥ User user = redisService.get(key); // å…ˆæŸ¥ç¼“å­˜ if (user != null) { return user; } // ç¼“å­˜æœªå‘½ä¸­ â†’ æŸ¥æ•°æ®åº“å¹¶å›å†™ç¼“å­˜ user = userRepository.findById(userId); if (user != null) { redisService.set(key, user, 10, TimeUnit.MINUTES); } return user; } finally { readLock.unlock(); // é‡Šæ”¾è¯»é” } } // å†™æ“ä½œï¼šåŠ â€œå†™é”â€ public void updateUser(User user) { Long userId = user.getId(); String key = &quot;user:&quot; + userId; String lockKey = &quot;lock:user:&quot; + userId; RReadWriteLock rwLock = redissonClient.getReadWriteLock(lockKey); RLock writeLock = rwLock.writeLock(); try { writeLock.lock(10, TimeUnit.SECONDS); // åŠ å†™é”ï¼Œé˜²æ­¢å¹¶å‘è¯»/å†™ redisService.del(key); // åˆ é™¤ç¼“å­˜ï¼ˆç¬¬ä¸€æ¬¡ï¼‰ userRepository.save(user); // æ›´æ–°æ•°æ®åº“ // ç¬¬äºŒæ¬¡åˆ é™¤å¯å»¶è¿Ÿåšï¼ˆé¿å…å¹¶å‘å†™å…¥æ—§å€¼ï¼‰ Thread.sleep(500); // æ¨¡æ‹Ÿå»¶è¿Ÿ redisService.del(key); // å»¶è¿Ÿåˆ é™¤ï¼ˆç¬¬äºŒæ¬¡ï¼‰ } catch (InterruptedException e) { e.printStackTrace(); } finally { writeLock.unlock(); // é‡Šæ”¾å†™é” } }} 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970import org.redisson.api.RReadWriteLock;import org.redisson.api.RedissonClient;import org.redisson.api.RLock;import java.util.concurrent.TimeUnit;public class UserService { private final RedissonClient redissonClient; private final RedisService redisService; // ä½ å°è£…çš„ Redis å·¥å…·ç±» private final UserRepository userRepository; // ä½ æ“ä½œæ•°æ®åº“çš„ç±» public UserService(RedissonClient redissonClient, RedisService redisService, UserRepository userRepository) { this.redissonClient = redissonClient; this.redisService = redisService; this.userRepository = userRepository; } // è¯»æ“ä½œï¼šåŠ â€œè¯»é”â€ public User getUserById(Long userId) { String key = &quot;user:&quot; + userId; String lockKey = &quot;lock:user:&quot; + userId; RReadWriteLock rwLock = redissonClient.getReadWriteLock(lockKey); RLock readLock = rwLock.readLock(); try { readLock.lock(5, TimeUnit.SECONDS); // åŠ è¯»é”ï¼Œé˜²æ­¢åŒæ—¶å†™å…¥ User user = redisService.get(key); // å…ˆæŸ¥ç¼“å­˜ if (user != null) { return user; } // ç¼“å­˜æœªå‘½ä¸­ â†’ æŸ¥æ•°æ®åº“å¹¶å›å†™ç¼“å­˜ user = userRepository.findById(userId); if (user != null) { redisService.set(key, user, 10, TimeUnit.MINUTES); } return user; } finally { readLock.unlock(); // é‡Šæ”¾è¯»é” } } // å†™æ“ä½œï¼šåŠ â€œå†™é”â€ public void updateUser(User user) { Long userId = user.getId(); String key = &quot;user:&quot; + userId; String lockKey = &quot;lock:user:&quot; + userId; RReadWriteLock rwLock = redissonClient.getReadWriteLock(lockKey); RLock writeLock = rwLock.writeLock(); try { writeLock.lock(10, TimeUnit.SECONDS); // åŠ å†™é”ï¼Œé˜²æ­¢å¹¶å‘è¯»/å†™ redisService.del(key); // åˆ é™¤ç¼“å­˜ï¼ˆç¬¬ä¸€æ¬¡ï¼‰ userRepository.save(user); // æ›´æ–°æ•°æ®åº“ // ç¬¬äºŒæ¬¡åˆ é™¤å¯å»¶è¿Ÿåšï¼ˆé¿å…å¹¶å‘å†™å…¥æ—§å€¼ï¼‰ Thread.sleep(500); // æ¨¡æ‹Ÿå»¶è¿Ÿ redisService.del(key); // å»¶è¿Ÿåˆ é™¤ï¼ˆç¬¬äºŒæ¬¡ï¼‰ } catch (InterruptedException e) { e.printStackTrace(); } finally { writeLock.unlock(); // é‡Šæ”¾å†™é” } }} ä¸­é—´ä»¶è§£å†³æ–¹æ¡ˆ å¼‚æ­¥é€šçŸ¥ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ canalæ˜¯åŸºäºmysqlçš„ä¸»ä»åŒæ­¥æ¥å®ç°çš„ äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆBINLOGï¼‰è®°å½•äº†æ‰€æœ‰çš„ DDLï¼ˆæ•°æ®å®šä¹‰è¯­è¨€ï¼‰è¯­å¥å’Œ DMLï¼ˆæ•°æ®æ“çºµè¯­è¨€ï¼‰è¯­å¥ï¼Œä½†ä¸åŒ…æ‹¬æ•°æ®æŸ¥è¯¢ï¼ˆSELECTã€SHOWï¼‰è¯­å¥ã€‚","link":"/posts/redis%E8%AF%BB%E5%86%99%E4%B8%80%E8%87%B4%E9%97%AE%E9%A2%98/"},{"title":"ä½¿ç”¨luaä¼˜åŒ–ä¸€äººä¸€å•é—®é¢˜","text":"é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜ åˆ†å¸ƒå¼é”-åŸç† ä¸å»ä½¿ç”¨jvmå†…éƒ¨çš„é”ç›‘è§†å™¨ï¼Œæˆ‘ä»¬è¦åœ¨å¤–éƒ¨å¼€ä¸€ä¸ªé”ç›‘è§†å™¨ï¼Œè®©å®ƒç›‘è§†æ‰€æœ‰çš„çº¿ç¨‹ Luaè§£å†³ï¼ è§£å†³è¿™ä¸ªé—®é¢˜ä¸»è¦æ˜¯è®©ä¸€ä¸ªç”¨æˆ·ä¸èƒ½åŒæ—¶åˆ›å»ºä¸¤ä¸ªè®¢å•(åœ¨ç¼“å­˜åˆ›å»ºå‰) luaå¯ä»¥åœ¨ä¿è¯åŸå­æ€§redisæ‰§è¡Œçš„åŸå­æ€§ï¼Œæ‰€ä»¥å’±å¯ä»¥ç”¨ä»–è§£å†³ä¸€äººä¸€å•å¼•å‘çš„å¹¶å‘é—®é¢˜æ— éœ€åŠ é” luaä»£ç é€»è¾‘ 12345678910111213141516171819202122232425262728293031-- å‚æ•°åˆ—è¡¨-- ä¼˜æƒ å·idlocal voucherId = ARGV[1]-- ç”¨æˆ·idlocal userId = ARGV[2]-- æ•°æ®key-- åº“å­˜keylocal stockKey = 'seckill:stock:' .. voucherId-- è®¢å•keylocal orderKey = 'seckill:order:' .. voucherIdprint(stockKey)print(orderKey)-- è„šæœ¬ä¸šåŠ¡-- æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³if(tonumber(redis.call('get', stockKey)) &lt;= 0) then return 1end-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ä¸‹å•if(redis.call('sismember', orderKey, userId) == 1) then return 2end-- æ‰£åº“å­˜redis.call('incrby', stockKey, -1)-- ä¸‹å•ä¿å­˜ç”¨æˆ·redis.call('sadd', orderKey, userId)return 0 javaè°ƒç”¨ä»£ç é€»è¾‘ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051private static final DefaultRedisScript&lt;Long&gt; SECKILL_SCRIPT; static { SECKILL_SCRIPT = new DefaultRedisScript&lt;&gt;(); SECKILL_SCRIPT.setLocation(new ClassPathResource(&quot;seckill.lua&quot;)); SECKILL_SCRIPT.setResultType(Long.class); } private IVoucherOrderService proxy; @Override @Transactional public Result seckillVoucher(Long voucherId) { //è·å–ç”¨æˆ· Long userId = UserHolder.getUser().getId(); System.out.println(&quot;userId = &quot; + userId); System.out.println(&quot;voucherId = &quot; + voucherId); //æ‰§è¡Œluaè„šæœ¬ Long result = stringRedisTemplate.execute( SECKILL_SCRIPT, Collections.emptyList(), voucherId.toString(), userId.toString() ); //åˆ¤æ–­ç»“æœæ˜¯å¦ä¸ºé›¶ assert result != null; int r = result.intValue(); if(r!=0){ return switch (r) { case 1 -&gt; Result.fail(&quot;åº“å­˜ä¸è¶³&quot;); case 2 -&gt; Result.fail(&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;); default -&gt; Result.fail(&quot;ç³»ç»Ÿé”™è¯¯&quot;); }; } long orderId = redisIdWorker.nextId(&quot;order&quot;); // ä¿å­˜é˜»å¡é˜Ÿåˆ— VoucherOrder voucherOrder = new VoucherOrder(); //è®¢å•id voucherOrder.setId(orderId); //ç”¨æˆ·id voucherOrder.setUserId(userId); //ä»£é‡‘åˆ¸id voucherOrder.setVoucherId(voucherId); //åŠ å…¥é˜»å¡é˜Ÿåˆ— orderTasks.add(voucherOrder); proxy = (IVoucherOrderService) AopContext.currentProxy(); //ä¸ä¸º0 //ä¸º0 æœ‰è´­ä¹°èµ„æ ¼ æŠŠä¸‹å•ä¿¡æ¯ä¿å­˜åˆ°é˜»å¡é˜Ÿåˆ— //è¿”å›è®¢å•id return Result.ok(orderId); }","link":"/posts/%E4%BD%BF%E7%94%A8lua%E4%BC%98%E5%8C%96%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%95%E9%97%AE%E9%A2%98/"},{"title":"redisæŒä¹…åŒ–å’Œæ•°æ®æ·˜æ±°æ–¹æ¡ˆ","text":"RedisæŒä¹…åŒ–æ–¹æ¡ˆ RDB RDBå…¨ç§°Redis Database Backup fileï¼ˆRedisæ•°æ®å¤‡ä»½æ–‡ä»¶ï¼‰ï¼Œä¹Ÿè¢«å«åšRedisæ•°æ®å¿«ç…§ã€‚ç®€å•æ¥è¯´å°±æ˜¯æŠŠå†…å­˜ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½è®°å½•åˆ°ç£ç›˜ä¸­ã€‚å½“Rediså®ä¾‹æ•…éšœé‡å¯åï¼Œä»ç£ç›˜è¯»å–å¿«ç…§æ–‡ä»¶ï¼Œæ¢å¤æ•°æ® Rediså†…éƒ¨æœ‰è§¦å‘RDBçš„æœºåˆ¶ï¼Œå¯ä»¥åœ¨redis.confæ–‡ä»¶ä¸­æ‰¾åˆ°ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š 1234# 900ç§’å†…ï¼Œå¦‚æœè‡³å°‘æœ‰1ä¸ªkeyè¢«ä¿®æ”¹ï¼Œåˆ™æ‰§è¡Œbgsave save 900 1 save 300 10 save 60 10000 RDBçš„æ‰§è¡ŒåŸç† bgsaveå¼€å§‹æ—¶ä¼šforkä¸»è¿›ç¨‹å¾—åˆ°å­è¿›ç¨‹ï¼Œå­è¿›ç¨‹å…±äº«ä¸»è¿›ç¨‹çš„å†…å­˜æ•°æ®ã€‚å®Œæˆforkåè¯»å–å†…å­˜æ•°æ®å¹¶å†™å…¥ RDB æ–‡ä»¶ã€‚forké‡‡ç”¨çš„æ˜¯copy-on-writeæŠ€æœ¯ï¼š å½“ä¸»è¿›ç¨‹æ‰§è¡Œè¯»æ“ä½œæ—¶ï¼Œè®¿é—®å…±äº«å†…å­˜ï¼› å½“ä¸»è¿›ç¨‹æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œåˆ™ä¼šæ‹·è´ä¸€ä»½æ•°æ®ï¼Œæ‰§è¡Œå†™æ“ä½œã€‚ ä¼˜ç‚¹ è§£é‡Š âœ¨ å†…å­˜æ•ˆç‡é«˜ åªåœ¨å†™æ“ä½œæ—¶æ‹·è´æ•°æ®ï¼Œä¸ä¼šæ•´å—å¤åˆ¶ï¼Œå¤§å¤§èŠ‚çœå†…å­˜ âœ¨ æœåŠ¡ä¸ä¸­æ–­ ä¸»è¿›ç¨‹æ­£å¸¸æœåŠ¡ï¼ŒRDB å¿«ç…§å¼‚æ­¥ç”Ÿæˆ âœ¨ å¿«ç…§æ€§èƒ½å¥½ å­è¿›ç¨‹å†™ç£ç›˜ï¼Œé¿å…ä¸ä¸»çº¿ç¨‹äº‰èµ„æº âœ¨ å¿«ç…§æ•°æ®ä¸€è‡´ åŸºäº fork æ—¶åˆ»çš„æ•°æ®ï¼Œå…·æœ‰ä¸€è‡´æ€§è§†å›¾ å¦‚æœç›´æ¥ç”¨saveå‘½ä»¤ä¼šé˜»å¡Redisä¸»çº¿ç¨‹ï¼Œæ€§èƒ½ä¸å¤ªå¥½ AOF AOFå…¨ç§°ä¸ºAppend Only Fileï¼ˆè¿½åŠ æ–‡ä»¶ï¼‰ã€‚Rediså¤„ç†çš„æ¯ä¸€ä¸ªå†™å‘½ä»¤éƒ½ä¼šè®°å½•åœ¨AOFæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åšæ˜¯å‘½ä»¤æ—¥å¿—æ–‡ä»¶ã€‚ AOFæ–‡ä»¶ä¼šè®°å½•æŒ‡ä»¤ AOFçš„é…ç½® AOFé»˜è®¤æ˜¯å…³é—­çš„ï¼Œéœ€è¦ä¿®æ”¹redis.confé…ç½®æ–‡ä»¶æ¥å¼€å¯AOFï¼š 1234# æ˜¯å¦å¼€å¯AOFåŠŸèƒ½ï¼Œé»˜è®¤æ˜¯noappendonly yes# AOFæ–‡ä»¶çš„åç§°appendfilename &quot;appendonly.aof&quot; AOFçš„å‘½ä»¤è®°å½•çš„é¢‘ç‡ä¹Ÿå¯ä»¥é€šè¿‡redis.confæ–‡ä»¶æ¥é…ï¼š 123456# è¡¨ç¤ºæ¯æ‰§è¡Œä¸€æ¬¡å†™å‘½ä»¤ï¼Œç«‹å³è®°å½•åˆ°AOFæ–‡ä»¶appendfsync always # å†™å‘½ä»¤æ‰§è¡Œå®Œå…ˆæ”¾å…¥AOFç¼“å†²åŒºï¼Œç„¶åè¡¨ç¤ºæ¯éš”1ç§’å°†ç¼“å†²åŒºæ•°æ®å†™åˆ°AOFæ–‡ä»¶ï¼Œæ˜¯é»˜è®¤æ–¹æ¡ˆappendfsync everysec # å†™å‘½ä»¤æ‰§è¡Œå®Œå…ˆæ”¾å…¥AOFç¼“å†²åŒºï¼Œç”±æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶å°†ç¼“å†²åŒºå†…å®¹å†™å›ç£ç›˜appendfsync no é…ç½®é¡¹ åˆ·ç›˜æ—¶æœº ä¼˜ç‚¹ ç¼ºç‚¹ Always åŒæ­¥åˆ·ç›˜ å¯é æ€§é«˜ï¼Œå‡ ä¹ä¸ä¸¢æ•°æ® æ€§èƒ½å½±å“å¤§ everysec æ¯ç§’åˆ·ç›˜ æ€§èƒ½é€‚ä¸­ æœ€å¤šä¸¢å¤±1ç§’æ•°æ® no æ“ä½œç³»ç»Ÿæ§åˆ¶ æ€§èƒ½æœ€å¥½ å¯é æ€§è¾ƒå·®ï¼Œå¯èƒ½ä¸¢å¤±å¤§é‡æ•°æ® å› ä¸ºæ˜¯è®°å½•å‘½ä»¤ï¼ŒAOFæ–‡ä»¶ä¼šæ¯”RDBæ–‡ä»¶å¤§çš„å¤šã€‚è€Œä¸”AOFä¼šè®°å½•å¯¹åŒä¸€ä¸ªkeyçš„å¤šæ¬¡å†™æ“ä½œï¼Œä½†åªæœ‰æœ€åä¸€æ¬¡å†™æ“ä½œæ‰æœ‰æ„ä¹‰ã€‚é€šè¿‡æ‰§è¡Œbgrewriteaofå‘½ä»¤ï¼Œå¯ä»¥è®©AOFæ–‡ä»¶æ‰§è¡Œé‡å†™åŠŸèƒ½ï¼Œç”¨æœ€å°‘çš„å‘½ä»¤è¾¾åˆ°ç›¸åŒæ•ˆæœã€‚(å¹¶ä¸”æ–‡ä»¶ä¼šè¿›è¡Œå‹ç¼©ä¹±ç ) Redisä¹Ÿä¼šåœ¨è§¦å‘é˜ˆå€¼æ—¶è‡ªåŠ¨å»é‡å†™AOFæ–‡ä»¶ã€‚é˜ˆå€¼ä¹Ÿå¯ä»¥åœ¨redis.confä¸­é…ç½®ï¼š 1234# AOFæ–‡ä»¶æ¯”ä¸Šæ¬¡æ–‡ä»¶ å¢é•¿è¶…è¿‡å¤šå°‘ç™¾åˆ†æ¯”åˆ™è§¦å‘é‡å†™auto-aof-rewrite-percentage 100# AOFæ–‡ä»¶ä½“ç§¯æœ€å°å¤šå¤§ä»¥ä¸Šæ‰è§¦å‘é‡å†™auto-aof-rewrite-min-size 64mb ä¸¤ç§æ–¹å¼çš„æ¯”è¾ƒ RDB AOF æŒä¹…åŒ–æ–¹å¼ å®šæ—¶å¯¹æ•´ä¸ªå†…å­˜åšå¿«ç…§ è®°å½•æ¯ä¸€æ¬¡æ‰§è¡Œçš„å‘½ä»¤ æ•°æ®å®Œæ•´æ€§ ä¸å®Œæ•´ï¼Œä¸¤æ¬¡å¤‡ä»½ä¹‹é—´ä¼šä¸¢å¤± ç›¸å¯¹å®Œæ•´ï¼Œå–å†³äºåˆ·ç›˜ç­–ç•¥ æ–‡ä»¶å¤§å° ä¼šæœ‰å‹ç¼©ï¼Œæ–‡ä»¶ä½“ç§¯å° è®°å½•å‘½ä»¤ï¼Œæ–‡ä»¶ä½“ç§¯å¾ˆå¤§ å®•æœºæ¢å¤é€Ÿåº¦ å¾ˆå¿« æ…¢ æ•°æ®æ¢å¤ä¼˜å…ˆçº§ ä½ï¼Œå› ä¸ºæ•°æ®å®Œæ•´æ€§ä¸å¦‚AOF é«˜ï¼Œå› ä¸ºæ•°æ®å®Œæ•´æ€§æ›´é«˜ ç³»ç»Ÿèµ„æºå ç”¨ é«˜ï¼Œå¤§é‡CPUå’Œå†…å­˜æ¶ˆè€— ä½ï¼Œä¸»è¦æ˜¯ç£ç›˜IOèµ„æºä½†AOFé‡å†™æ—¶ä¼šå ç”¨å¤§é‡CPUå’Œå†…å­˜èµ„æº ä½¿ç”¨åœºæ™¯ å¯ä»¥å®¹å¿æ•°åˆ†é’Ÿçš„æ•°æ®ä¸¢å¤±ï¼Œè¿½æ±‚æ›´å¿«çš„å¯åŠ¨é€Ÿåº¦ å¯¹æ•°æ®å®‰å…¨æ€§è¦æ±‚è¾ƒé«˜å¸¸è§ æ•°æ®æ·˜æ±°æ–¹æ¡ˆ æƒ°æ€§åˆ é™¤ æƒ°æ€§åˆ é™¤ï¼šè®¾ç½®è¯¥keyè¿‡æœŸæ—¶é—´åï¼Œæˆ‘ä»¬ä¸å»ç®¡å®ƒï¼Œå½“éœ€è¦è¯¥keyæ—¶ï¼Œæˆ‘ä»¬åœ¨æ£€æŸ¥å…¶æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸï¼Œæˆ‘ä»¬å°±åˆ æ‰å®ƒï¼Œåä¹‹è¿”å›è¯¥key 12set name zhangsan get name //å‘ç°nameè¿‡æœŸäº†ï¼Œç›´æ¥åˆ é™¤key ä¼˜ç‚¹ ï¼šå¯¹CPUå‹å¥½ï¼Œåªä¼šåœ¨ä½¿ç”¨è¯¥keyæ—¶æ‰ä¼šè¿›è¡Œè¿‡æœŸæ£€æŸ¥ï¼Œå¯¹äºå¾ˆå¤šç”¨ä¸åˆ°çš„keyä¸ç”¨æµªè´¹æ—¶é—´è¿›è¡Œè¿‡æœŸæ£€æŸ¥ ç¼ºç‚¹ ï¼šå¯¹å†…å­˜ä¸å‹å¥½ï¼Œå¦‚æœä¸€ä¸ªkeyå·²ç»è¿‡æœŸï¼Œä½†æ˜¯ä¸€ç›´æ²¡æœ‰ä½¿ç”¨ï¼Œé‚£ä¹ˆè¯¥keyå°±ä¼šä¸€ç›´å­˜åœ¨å†…å­˜ä¸­ï¼Œå†…å­˜æ°¸è¿œä¸ä¼šé‡Šæ”¾ å®šæœŸåˆ é™¤ å®šæœŸåˆ é™¤ï¼šæ¯éš”ä¸€æ®µæ—¶é—´ï¼Œæˆ‘ä»¬å°±å¯¹ä¸€äº›keyè¿›è¡Œæ£€æŸ¥ï¼Œåˆ é™¤é‡Œé¢è¿‡æœŸçš„key(ä»ä¸€å®šæ•°é‡çš„æ•°æ®åº“ä¸­å–å‡ºä¸€å®šæ•°é‡çš„éšæœºkeyè¿›è¡Œæ£€æŸ¥ï¼Œå¹¶åˆ é™¤å…¶ä¸­çš„è¿‡æœŸkey)ã€‚ å®šæœŸæ¸…ç†æœ‰ä¸¤ç§æ¨¡å¼ï¼š SLOWæ¨¡å¼æ˜¯å®šæ—¶ä»»åŠ¡ï¼Œæ‰§è¡Œé¢‘ç‡é»˜è®¤ä¸º10hzï¼Œæ¯æ¬¡ä¸è¶…è¿‡25msï¼Œä»¥é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶redis.conf çš„hz é€‰é¡¹æ¥è°ƒæ•´è¿™ä¸ªæ¬¡æ•° FASTæ¨¡å¼æ‰§è¡Œé¢‘ç‡ä¸å›ºå®šï¼Œä½†ä¸¤æ¬¡é—´éš”ä¸ä½äº2msï¼Œæ¯æ¬¡è€—æ—¶ä¸è¶…è¿‡1ms ä¼˜ç‚¹ï¼šå¯ä»¥é€šè¿‡é™åˆ¶åˆ é™¤æ“ä½œæ‰§è¡Œçš„æ—¶é•¿å’Œé¢‘ç‡æ¥å‡å°‘åˆ é™¤æ“ä½œå¯¹ CPU çš„å½±å“ã€‚å¦å¤–å®šæœŸåˆ é™¤ï¼Œä¹Ÿèƒ½æœ‰æ•ˆé‡Šæ”¾è¿‡æœŸé”®å ç”¨çš„å†…å­˜ã€‚ ç¼ºç‚¹ï¼šéš¾ä»¥ç¡®å®šåˆ é™¤æ“ä½œæ‰§è¡Œçš„æ—¶é•¿å’Œé¢‘ç‡ã€‚ Redisçš„è¿‡æœŸåˆ é™¤ç­–ç•¥ï¼šæƒ°æ€§åˆ é™¤ + å®šæœŸåˆ é™¤ä¸¤ç§ç­–ç•¥è¿›è¡Œé…åˆä½¿ç”¨","link":"/posts/redis%E6%8C%81%E4%B9%85%E5%8C%96/"},{"title":"","text":"Mysqlæ ¸å¿ƒæ¡†æ¶ æœ¬æ–‡æ—¨åœ¨æ¢³ç†å’Œç†è§£ MySQL çš„ä¸€äº›æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼Œå¹¶ç»“åˆå¸¸è§é¢è¯•é¢˜è¿›è¡Œæ€è€ƒå’Œæ€»ç»“ã€‚è¿™äº›å†…å®¹ä¸»è¦æ¥æºäºæˆ‘çš„ä¸ªäººå­¦ä¹ ä¸ç†è§£ã€‚ 1. äº‹åŠ¡ æ¦‚å¿µ äº‹åŠ¡æŒ‡çš„æ˜¯æ»¡è¶³ ACID ç‰¹æ€§çš„ä¸€ç»„æ“ä½œï¼Œå¯ä»¥é€šè¿‡ Commit æäº¤ä¸€ä¸ªäº‹åŠ¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Rollback è¿›è¡Œå›æ»šã€‚ é‚£æŠ¹ä»€ä¹ˆæ˜¯ACIDå‘¢ï¼Ÿ ACID åŸå­æ€§ï¼ˆAtomicityï¼‰ â€‹ äº‹åŠ¡è¢«è§†ä¸ºä¸å¯åˆ†å‰²çš„æœ€å°å•å…ƒï¼Œäº‹åŠ¡çš„æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æäº¤æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥å›æ»šã€‚ â€‹ å›æ»šå¯ä»¥ç”¨å›æ»šæ—¥å¿—ï¼ˆUndo Logï¼‰æ¥å®ç°ï¼Œå›æ»šæ—¥å¿—è®°å½•ç€äº‹åŠ¡æ‰€æ‰§è¡Œçš„ä¿®æ”¹æ“ä½œï¼Œåœ¨å›æ»šæ—¶åå‘æ‰§è¡Œè¿™äº›ä¿®æ”¹æ“ä½œå³å¯ã€‚ ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ â€‹ æ•°æ®åº“åœ¨äº‹åŠ¡æ‰§è¡Œå‰åéƒ½ä¿æŒä¸€è‡´æ€§çŠ¶æ€ã€‚åœ¨ä¸€è‡´æ€§çŠ¶æ€ä¸‹ï¼Œæ‰€æœ‰äº‹åŠ¡å¯¹åŒä¸€ä¸ªæ•°æ®çš„è¯»å–ç»“æœéƒ½æ˜¯ç›¸åŒçš„ã€‚ â€‹ æˆ‘ä¸ªäººç†è§£å°±æ˜¯è¿™ä¸ªæ‰§è¡Œç»“æœè¦åˆç†ï¼Œä¸èƒ½æˆ‘è½¬äº†ä½ 500ï¼Œä½ æ‹¿åˆ°äº†1000è¿™ç§çŠ¶æ€ã€‚ éš”ç¦»æ€§ï¼ˆIsolationï¼‰ â€‹ ä¸€ä¸ªäº‹åŠ¡æ‰€åšçš„ä¿®æ”¹åœ¨æœ€ç»ˆæäº¤ä»¥å‰ï¼Œå¯¹å…¶å®ƒäº‹åŠ¡æ˜¯ä¸å¯è§çš„ã€‚ æŒä¹…æ€§ï¼ˆDurabilityï¼‰ â€‹ ä¸€æ—¦äº‹åŠ¡æäº¤ï¼Œåˆ™å…¶æ‰€åšçš„ä¿®æ”¹å°†ä¼šæ°¸è¿œä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚å³ä½¿ç³»ç»Ÿå‘ç”Ÿå´©æºƒï¼Œäº‹åŠ¡æ‰§è¡Œçš„ç»“æœä¹Ÿä¸èƒ½ä¸¢å¤±ã€‚ â€‹ ç³»ç»Ÿå‘ç”Ÿå´©æºƒå¯ä»¥ç”¨é‡åšæ—¥å¿—ï¼ˆÂ·Redo LogÂ·ï¼‰è¿›è¡Œæ¢å¤ï¼Œä»è€Œå®ç°æŒä¹…æ€§ã€‚ä¸å›æ»šæ—¥å¿—è®°å½•æ•°æ®çš„é€»è¾‘ä¿®æ”¹ä¸åŒï¼Œé‡åšæ—¥å¿—è®°å½•çš„æ˜¯æ•°æ®é¡µçš„ç‰©ç†ä¿®æ”¹ã€‚ ä¸¾ä¸ªä¾‹å­: ä¾‹å¦‚ï¼ŒAå‘Bè½¬è´¦500å…ƒï¼Œè¿™ä¸ªæ“ä½œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥ï¼Œä½“ç°äº†åŸå­æ€§ã€‚è½¬è´¦è¿‡ç¨‹ä¸­æ•°æ®è¦ä¿æŒä¸€è‡´ï¼ŒAæ‰£é™¤äº†500å…ƒï¼ŒBå¿…é¡»å¢åŠ 500å…ƒã€‚éš”ç¦»æ€§ä½“ç°åœ¨Aå‘Bè½¬è´¦æ—¶ï¼Œä¸å—å…¶ä»–äº‹åŠ¡å¹²æ‰°ã€‚æŒä¹…æ€§ä½“ç°åœ¨äº‹åŠ¡æäº¤åï¼Œæ•°æ®è¦è¢«æŒä¹…åŒ–å­˜å‚¨ã€‚ äº‹åŠ¡çš„ ACID ç‰¹æ€§æ¦‚å¿µç®€å•ï¼Œä½†ä¸æ˜¯å¾ˆå¥½ç†è§£ï¼Œä¸»è¦æ˜¯å› ä¸ºè¿™å‡ ä¸ªç‰¹æ€§ä¸æ˜¯ä¸€ç§å¹³çº§å…³ç³»ï¼š åªæœ‰æ»¡è¶³ä¸€è‡´æ€§ï¼Œäº‹åŠ¡çš„æ‰§è¡Œç»“æœæ‰æ˜¯æ­£ç¡®çš„ã€‚ åœ¨æ— å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œäº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œéš”ç¦»æ€§ä¸€å®šèƒ½å¤Ÿæ»¡è¶³ã€‚æ­¤æ—¶åªè¦èƒ½æ»¡è¶³åŸå­æ€§ï¼Œå°±ä¸€å®šèƒ½æ»¡è¶³ä¸€è‡´æ€§ã€‚ åœ¨å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œå¤šä¸ªäº‹åŠ¡å¹¶è¡Œæ‰§è¡Œï¼Œäº‹åŠ¡ä¸ä»…è¦æ»¡è¶³åŸå­æ€§ï¼Œè¿˜éœ€è¦æ»¡è¶³éš”ç¦»æ€§ï¼Œæ‰èƒ½æ»¡è¶³ä¸€è‡´æ€§ã€‚ äº‹åŠ¡æ»¡è¶³æŒä¹…åŒ–æ˜¯ä¸ºäº†èƒ½åº”å¯¹ç³»ç»Ÿå´©æºƒçš„æƒ…å†µã€‚ åŸå­æ€§å’Œéš”ç¦»æ€§ç›´æ¥ä¿è¯ä¸€è‡´æ€§ï¼Œç®€ä»‹ä¿è¯æ‰§è¡Œç»“æœçš„æ­£ç¡®ã€‚è€Œä¸€è‡´æ€§æ˜¯è§‰å¾—æ‰§è¡Œç»“æœæ­£ç¡®çš„ç›´æ¥å› ç´ ã€‚ æŒä¹…æ€§ç”¨äºåº”å¯¹ç³»ç»Ÿçš„å´©æºƒï¼Œæé«˜æ•°æ®åº“çš„é«˜å¯ç”¨æ€§å’Œé²æ£’æ€§ã€‚ 2. å¹¶å‘ä¸€è‡´æ€§é—®é¢˜ æ³¨æ„wä¸ºwriteæ“ä½œ,rä¸ºreadæ“ä½œ ä¸¢å¤±ä¿®æ”¹ T1 T2 w a=10 w a=20 r a=20 r a=20 å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„T1çº¿ç¨‹å’ŒT2çº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„æ—¶å€™T1ä¸¢å¤±äº†åŸæ¥a=10çš„æ“ä½œç—•è¿¹ï¼ŒT2åæäº¤è¦†ç›–äº†T1çš„æäº¤ï¼Œä¼¼ä¹T1æ²¡æœ‰æ‰§è¡Œw a=10çš„æ“ä½œä¸€æ ·ï¼Œè¿™å°±æ˜¯&quot;ä¸¢å¤±ä¿®æ”¹&quot;ã€‚ è¯»è„æ•°æ® T1 T2 r a=10 w a=20 r a=20 rollback T1,T2å¹¶å‘æ‰§è¡Œåœ¨å‰é¢éƒ½æ²¡é—®é¢˜ï¼Œå¯æ˜¯å½“T1rollbackæ“ä½œåæ•°æ®åº“é‡Œé¢çš„å€¼åˆå˜å›äº†10ï¼Œæ­¤æ—¶T2æ‹¿åˆ°å¹¶ä¸æ˜¯æ•°æ®åº“çœŸå®çš„æ•°æ®ï¼Œå¦‚æœæ‹¿ç€è¿™ä¸ªæ•°æ®æ‰§è¡Œæ”¯ä»˜æ“ä½œå¯æƒ³è€ŒçŸ¥ä¼šç»™æˆ‘ä»¬çš„ç³»ç»Ÿé€ æˆå¤šå¤§çš„æŸå¤±ã€‚ ä¸å¯é‡å¤è¯» T1 T2 r a=10 w a=20 r a=20 å…¶å®ä¸å¯é‡å¤è¯»å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­æˆ‘è¿›è¡Œä¸¤æ¬¡è¯»å–æ“ä½œç»“æœè·å¾—å€¼ä¸ç›¸åŒï¼Œä¹Ÿå¯èƒ½ä¼šå¯¹æˆ‘ä»¬çš„ç³»ç»Ÿé€ æˆå¾ˆå¤§çš„å›°æ‰°ã€‚ å¹»å½±è¯»(å¹»è¯») T1 T2 count(user_id) 1 delete(user_object) count(user_id) 0 å¹»è¯»çš„å‡ºç°åœºæ™¯ä¸»è¦åœ¨èšåˆå‡½æ•°ç»Ÿè®¡æ—¶å€™å‡ºç°çš„æ¦‚ç‡æ¯”è¾ƒå¤§ä¸€äº›ã€‚ä¸€ä¸ªäº‹åŠ¡ä¸‹çš„ä¸¤æ¬¡èšåˆæ“ä½œç«Ÿç„¶ä¸ç›¸åŒï¼Œå¦‚æœæ˜¯åœ¨ç§’æ€åœºæ™¯é‡Œé¢ï¼Œå¯èƒ½å°±é€ æˆäº†è¶…ä¹°è¶…å–é—®é¢˜ã€‚ 3. å°é” é”çš„ç²’åº¦ MySQLåœ¨ç²’åº¦ä¸Šåˆ†ç±»çš„è¯åˆ†ä¸ºè¡Œçº§é”ã€è¡¨çº§é”ã€é¡µé¢é” è¡¨çº§é”ï¼šå¼€é”€å°ï¼ŒåŠ é”å¿«ï¼›ä¸ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦å¤§ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€é«˜ï¼Œå¹¶å‘åº¦æœ€ä½ã€‚ è¡Œçº§é”ï¼šå¼€é”€å¤§ï¼ŒåŠ é”æ…¢ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦æœ€å°ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€ä½ï¼Œå¹¶å‘åº¦ä¹Ÿæœ€é«˜ã€‚ é¡µé¢é”ï¼šå¼€é”€å’ŒåŠ é”æ—¶é—´ç•Œäºè¡¨é”å’Œè¡Œé”ä¹‹é—´ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦ç•Œäºè¡¨é”å’Œè¡Œé”ä¹‹é—´ï¼Œå¹¶å‘åº¦ä¸€èˆ¬ ä»æ€§èƒ½ä¸Šçœ‹çš„è¯ï¼Œé”çš„ç²’åº¦è¶Šç»†ï¼Œèƒ½å¤Ÿå¹¶å‘çš„çº¿ç¨‹æ•°é‡å°±è¶Šå¤šï¼Œæ€§èƒ½å°±è¶Šé«˜ã€‚åä¹‹åˆ™æ€§èƒ½è¶Šä½ã€‚æ‰€ä»¥ä»è¿™ä¸ªå±‚é¢ä¸Šè€ƒè™‘çš„è¡Œçº§é”çš„æ€§èƒ½æ˜¯é«˜äºæ ‡è®°é”çš„ã€‚ ä¸‰ç§å¸¸ç”¨å¼•æ“çš„æ”¯æŒæƒ…å†µ InnoDB MyISAM MEMORY è¡Œçº§é”å’Œè¡¨çº§é” æ”¯æŒè¡¨çº§é” æ”¯æŒæ ‡è®°é” ä»è¿™ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥InnoDBåœ¨é”çš„æ€§èƒ½ä¸Šæ˜¯é«˜äºå…¶ä»–ä¸¤ä¸ªå­˜å‚¨å¼•æ“çš„ã€‚ è¡¨çº§é” åŸºæœ¬çš„ä¸¤å¤§ç±»è¡¨é” ï¼­ySQLçš„è¡¨é”æœ‰ä¸¤ç§æ¨¡å¼ï¼šè¡¨å…±äº«è¯»é”ï¼ˆTable Read Lockï¼‰å’Œè¡¨ç‹¬å å†™é”ï¼ˆTable Write Lockï¼‰ è¡¨å…±äº«è¯»é” ï¼ˆTable Read Lockï¼‰ï¼šä¸ä¼šé˜»å¡å…¶ä»–ç”¨æˆ·å¯¹åŒä¸€è¡¨çš„è¯»è¯·æ±‚ï¼Œä½†ä¼šé˜»å¡å¯¹åŒä¸€è¡¨çš„å†™è¯·æ±‚ï¼› è¡¨ç‹¬å å†™é” ï¼ˆTable Write Lockï¼‰ï¼šä¼šé˜»å¡å…¶ä»–ç”¨æˆ·å¯¹åŒä¸€è¡¨çš„è¯»å’Œå†™æ“ä½œï¼› å½“ç„¶æœ‰äº›å­˜å‚¨å¼•æ“è¿˜æ”¯æŒæ„å‘é”ï¼Œå¦‚æˆ‘ä»¬å¤§åé¼é¼çš„InnoDBã€‚ æ˜¯å¦é˜»å¡ è¯»é” å†™é” è¯»é” Y N å†™é” N N tipï¼šè¯»è¯»å…¼å®¹ï¼Œè¯»å†™é˜»å¡ï¼Œå†™å†™é˜»å¡ è¡Œçº§é” åŸºæœ¬çš„ä¸¤å¤§ç±»è¡Œé” å…±äº«é”ï¼ˆS é”ï¼ŒShared Lockï¼‰ å…è®¸å¤šä¸ªäº‹åŠ¡åŒæ—¶è¯»ä¸€è¡Œï¼Œä½†ä¸èƒ½å†™ã€‚ æ’ä»–é”ï¼ˆX é”ï¼ŒExclusive Lockï¼‰ ä¸€ä¸ªäº‹åŠ¡è·å–æ’ä»–é”åï¼Œåˆ«äººæ—¢ä¸èƒ½è¯»ä¹Ÿä¸èƒ½å†™ï¼ˆè¯»æ˜¯æŒ‡åŠ é”çš„è¯»ï¼‰ã€‚ å¸¸è§åœ¨ UPDATEã€DELETEã€INSERT æ“ä½œé‡Œä¼šè‡ªåŠ¨åŠ ã€‚ InnoDB ç‰¹æœ‰çš„â€œå˜ç§â€è¡Œé” ä¸ºäº†å¤„ç†å¤æ‚çš„å¹¶å‘åœºæ™¯ï¼ŒInnoDB åœ¨åŸºæœ¬ S/X é”ä¸Šåˆæ‰©å±•å‡ºå‡ ç§ï¼š è®°å½•é”ï¼ˆRecord Lockï¼‰ æœ€å¸¸è§çš„è¡Œé”ï¼Œå°±æ˜¯é”ä½æŸä¸€æ¡ç´¢å¼•è®°å½•ã€‚ å‰ææ˜¯æŸ¥è¯¢å¿…é¡»ç”¨åˆ°ç´¢å¼•ï¼Œå¦åˆ™å¯èƒ½å‡çº§æˆè¡¨é”ã€‚ é—´éš™é”ï¼ˆGap Lockï¼‰ é”ä½æŸä¸ªèŒƒå›´çš„â€œé—´éš™â€ï¼Œè€Œä¸æ˜¯å·²æœ‰çš„è¡Œã€‚ ç”¨æ¥é˜²æ­¢â€œå¹»è¯»â€ï¼ˆåˆ«äººæ’å…¥æ–°è¡Œå¯¼è‡´èŒƒå›´æŸ¥è¯¢ç»“æœå˜äº†ï¼‰ã€‚ ä¾‹å¦‚ï¼š 1SELECT * FROM user WHERE age BETWEEN 20 AND 30 FOR UPDATE; FOR UPDATE â†’ ç»™åŒ¹é…è¡ŒåŠ æ’ä»–é”ã€‚ BETWEEN 20 AND 30 â†’ é”ä½è¿™ä¸ªèŒƒå›´çš„è®°å½•ã€‚ ä¸´é”®é”ï¼ˆNext-Key Lockï¼‰ è®°å½•é” + é—´éš™é”çš„ç»„åˆï¼Œé”ä½â€œæŸä¸€æ¡è®°å½•åŠå…¶å‰é¢çš„é—´éš™â€ã€‚ è¿™æ˜¯ InnoDB åœ¨ å¯é‡å¤è¯»ï¼ˆRRï¼‰ éš”ç¦»çº§åˆ«ä¸‹çš„é»˜è®¤æ¨¡å¼ï¼Œä¸»è¦å°±æ˜¯ä¸ºäº†é˜²æ­¢å¹»è¯»ã€‚ InnoDBé»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨çš„å°±æ˜¯è¡Œé”ï¼Œå¦‚æœè¦è¡¨é”çš„è¯å¿…é¡»æ˜¾å¼åŠ é”ã€‚ InnoDBä¸MyISAMçš„æœ€å¤§ä¸åŒæœ‰ä¸¤ç‚¹ï¼š ä¸€æ˜¯æ”¯æŒäº‹åŠ¡ï¼ˆTRANSACTIONï¼‰ï¼› äºŒæ˜¯é‡‡ç”¨äº†è¡Œçº§é”ã€‚ è¡Œé”å®šæ˜¯å¯¹ç´¢å¼•è®°å½•çš„é”å®šã€‚ 1SELECT c1 FROM t WHERE c1 = 10 FOR UPDATE; é˜²æ­¢ä»»ä½•å…¶ä»–äº‹åŠ¡æ’å…¥ï¼Œæ›´æ–°æˆ–åˆ é™¤t.c1å€¼ä¸º10çš„è¡Œã€‚ MySQL çš„ UPDATE åœ¨å¹¶å‘æƒ…å†µä¸‹ï¼Œå¦‚æœæ˜¯ InnoDB å¼•æ“ï¼Œä¼šé€šè¿‡è¡Œçº§æ’ä»–é”é¿å…åŒä¸€è¡Œè¢«å¤šä¸ªäº‹åŠ¡åŒæ—¶ä¿®æ”¹ã€‚è¿™ä¹Ÿæ˜¯Mysqlå±‚é¢ä¸Šçš„è§£å†³è¶…ä¹°è¶…å–çš„ä¸€ç§æ‰‹æ®µæã€‚ è¡Œé”å‡çº§ä¸ºè¡¨é” è¡Œé”ä¹Ÿæœ‰å¯èƒ½å‡çº§æˆè¡¨é”ï¼Œå…·ä½“çš„æƒ…å†µï¼š ä¸é€‚ç”¨ç´¢å¼•çš„æƒ…å†µä¸‹åŠ é” ä½¿ç”¨æ™®é€šç´¢å¼•çš„æƒ…å†µä¸‹åŠ é”ï¼ˆtips:æ™®é€šç´¢å¼•ä¸é™åˆ¶å€¼å•çº¯å»ºç«‹b+æ ‘æ¥åŠ å¿«æŸ¥è¯¢é€Ÿåº¦ï¼Œéšä¾¿æ’,å’±æ™®éè¯´çš„ç´¢å¼•ä¸€èˆ¬æ˜¯ä¸»é”®ç´¢å¼•å’Œå”¯ä¸€ç´¢å¼•æœ‰éé‡å¤çš„éœ€æ±‚) èŒƒå›´æ€§æŸ¥è¯¢ æ€»ç»“è¡Œé”æ˜¯å»ºç«‹åœ¨ç´¢å¼•çš„åŸºç¡€ä¸Šçš„ï¼Œæ™®é€šç´¢å¼•çš„æ•°æ®é‡å¤ç‡è¿‡é«˜æˆ–å¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼Œè¡Œé”å‡çº§ä¸ºè¡¨é” å°é”çš„ç±»å‹ è¯»å†™é” äº’æ–¥é”ï¼ˆExclusiveï¼‰ï¼Œç®€å†™ä¸º X é”ï¼Œåˆç§°å†™é”ã€‚ å…±äº«é”ï¼ˆSharedï¼‰ï¼Œç®€å†™ä¸º S é”ï¼Œåˆç§°è¯»é”ã€‚ æœ‰ä»¥ä¸‹ä¸¤ä¸ªè§„å®šï¼š ä¸€ä¸ªäº‹åŠ¡å¯¹æ•°æ®å¯¹è±¡ A åŠ äº† X é”ï¼Œå°±å¯ä»¥å¯¹ A è¿›è¡Œè¯»å–å’Œæ›´æ–°ã€‚åŠ é”æœŸé—´å…¶å®ƒäº‹åŠ¡ä¸èƒ½å¯¹ A åŠ ä»»ä½•é”ã€‚ ä¸€ä¸ªäº‹åŠ¡å¯¹æ•°æ®å¯¹è±¡ A åŠ äº† S é”ï¼Œå¯ä»¥å¯¹ A è¿›è¡Œè¯»å–æ“ä½œï¼Œä½†æ˜¯ä¸èƒ½è¿›è¡Œæ›´æ–°æ“ä½œã€‚åŠ é”æœŸé—´å…¶å®ƒäº‹åŠ¡èƒ½å¯¹ A åŠ  S é”ï¼Œä½†æ˜¯ä¸èƒ½åŠ  X é”ã€‚ æ˜¯å¦é˜»å¡ è¯»é” å†™é” è¯»é” Y N å†™é” N N ä¹Ÿå°±æ˜¯ä¸Šé¢è¡Œçº§é”é‡Œé¢çš„è§„å®š æ„å‘é” ä½¿ç”¨æ„å‘é”ï¼ˆIntention Locksï¼‰å¯ä»¥æ›´å®¹æ˜“åœ°æ”¯æŒå¤šç²’åº¦å°é”ã€‚ åœ¨å­˜åœ¨è¡Œçº§é”å’Œè¡¨çº§é”çš„æƒ…å†µä¸‹ï¼Œäº‹åŠ¡ T æƒ³è¦å¯¹è¡¨ A åŠ  X é”ï¼Œå°±éœ€è¦å…ˆæ£€æµ‹æ˜¯å¦æœ‰å…¶å®ƒäº‹åŠ¡å¯¹è¡¨ A æˆ–è€…è¡¨ A ä¸­çš„ä»»æ„ä¸€è¡ŒåŠ äº†é”ï¼Œé‚£ä¹ˆå°±éœ€è¦å¯¹è¡¨ A çš„æ¯ä¸€è¡Œéƒ½æ£€æµ‹ä¸€æ¬¡ï¼Œè¿™æ˜¯éå¸¸è€—æ—¶çš„ã€‚ æ„å‘é”åœ¨åŸæ¥çš„ X/S é”ä¹‹ä¸Šå¼•å…¥äº† IX/ISï¼ŒIX/IS éƒ½æ˜¯è¡¨é”ï¼Œç”¨æ¥è¡¨ç¤ºä¸€ä¸ªäº‹åŠ¡æƒ³è¦åœ¨è¡¨ä¸­çš„æŸä¸ªæ•°æ®è¡Œä¸ŠåŠ  X é”æˆ– S é”ã€‚æœ‰ä»¥ä¸‹ä¸¤ä¸ªè§„å®šï¼š ä¸€ä¸ªäº‹åŠ¡åœ¨è·å¾—æŸä¸ªæ•°æ®è¡Œå¯¹è±¡çš„ S é”ä¹‹å‰ï¼Œå¿…é¡»å…ˆè·å¾—è¡¨çš„ IS é”æˆ–è€…æ›´å¼ºçš„é”ï¼› ä¸€ä¸ªäº‹åŠ¡åœ¨è·å¾—æŸä¸ªæ•°æ®è¡Œå¯¹è±¡çš„ X é”ä¹‹å‰ï¼Œå¿…é¡»å…ˆè·å¾—è¡¨çš„ IX é”ã€‚ é€šè¿‡å¼•å…¥æ„å‘é”ï¼Œäº‹åŠ¡ T æƒ³è¦å¯¹è¡¨ A åŠ  X é”ï¼Œåªéœ€è¦å…ˆæ£€æµ‹æ˜¯å¦æœ‰å…¶å®ƒäº‹åŠ¡å¯¹è¡¨ A åŠ äº† X/IX/S/IS é”ï¼Œå¦‚æœåŠ äº†å°±è¡¨ç¤ºæœ‰å…¶å®ƒäº‹åŠ¡æ­£åœ¨ä½¿ç”¨è¿™ä¸ªè¡¨æˆ–è€…è¡¨ä¸­æŸä¸€è¡Œçš„é”ï¼Œå› æ­¤äº‹åŠ¡ T åŠ  X é”å¤±è´¥ã€‚ 4. å°é”åè®® ä¸€å…±æœ‰ä¸‰å±‚å°é”åè®® ä¸€çº§å°é”åè®® äº‹åŠ¡ T è¦ä¿®æ”¹æ•°æ® A æ—¶å¿…é¡»åŠ  X é”ï¼Œç›´åˆ° T ç»“æŸæ‰é‡Šæ”¾é”ã€‚ T1 T2 lock-x a w a=10 lock-x a commit unlock-x a get lock-x w a=20 commit unlock-x a å¯ä»¥çœ‹åˆ°ï¼Œå› ä¸ºæ¯æ¬¡åªæœ‰ä¸€ä¸ªäº‹åŠ¡å¯ä»¥è¿›è¡Œå†™æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬çš„äº‹åŠ¡ä¿®æ”¹å°±ä¸ä¼šè¢«è¦†ç›– äºŒçº§å°é”åè®® åœ¨ä¸€çº§çš„åŸºç¡€ä¸Šï¼Œè¦æ±‚è¯»å–æ•°æ® A æ—¶å¿…é¡»åŠ  S é”ï¼Œè¯»å–å®Œé©¬ä¸Šé‡Šæ”¾ S é”ã€‚ T1 T2 lock-x a r a=10 w a=20 lock-s a rollback unlock-x a get lock-s r a=10 unlock-s a å¯ä»¥è§£å†³è¯»è„æ•°æ®é—®é¢˜ï¼Œå› ä¸ºå¦‚æœä¸€ä¸ªäº‹åŠ¡åœ¨å¯¹æ•°æ® A è¿›è¡Œä¿®æ”¹ï¼Œæ ¹æ® 1 çº§å°é”åè®®ï¼Œä¼šåŠ  X é”ï¼Œé‚£ä¹ˆå°±ä¸èƒ½å†åŠ  S é”äº†ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šè¯»å…¥æ•°æ®,ç”¨çš„è¯»å†™é˜»å¡æ¥è§£å†³ ä¸‰çº§å°é”åè®® åœ¨äºŒçº§çš„åŸºç¡€ä¸Šï¼Œè¦æ±‚è¯»å–æ•°æ® A æ—¶å¿…é¡»åŠ  S é”ï¼Œç›´åˆ°äº‹åŠ¡ç»“æŸäº†æ‰èƒ½é‡Šæ”¾ S é”ã€‚ T1 T2 lock-x a r a=10 r a=10 lock-x a rollback unlock-x a get lock-x w a=20 commit unlock-x a å¯ä»¥è§£å†³ä¸å¯é‡å¤è¯»çš„é—®é¢˜ï¼Œå› ä¸ºè¯» A æ—¶ï¼Œå…¶å®ƒäº‹åŠ¡ä¸èƒ½å¯¹ A åŠ  X é”ï¼Œä»è€Œé¿å…äº†åœ¨è¯»çš„æœŸé—´æ•°æ®å‘ç”Ÿæ”¹å˜ã€‚ ä¸¤æ®µé”åè®® åŠ é”å’Œè§£é”åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µè¿›è¡Œã€‚ å¯ä¸²è¡ŒåŒ–è°ƒåº¦æ˜¯æŒ‡ï¼Œé€šè¿‡å¹¶å‘æ§åˆ¶ï¼Œä½¿å¾—å¹¶å‘æ‰§è¡Œçš„äº‹åŠ¡ç»“æœä¸æŸä¸ªä¸²è¡Œæ‰§è¡Œçš„äº‹åŠ¡ç»“æœç›¸åŒã€‚ä¸²è¡Œæ‰§è¡Œçš„äº‹åŠ¡äº’ä¸å¹²æ‰°ï¼Œä¸ä¼šå‡ºç°å¹¶å‘ä¸€è‡´æ€§é—®é¢˜ã€‚ äº‹åŠ¡éµå¾ªä¸¤æ®µé”åè®®æ˜¯ä¿è¯å¯ä¸²è¡ŒåŒ–è°ƒåº¦çš„å……åˆ†æ¡ä»¶ã€‚ä¾‹å¦‚ä»¥ä¸‹æ“ä½œæ»¡è¶³ä¸¤æ®µé”åè®®ï¼Œå®ƒæ˜¯å¯ä¸²è¡ŒåŒ–è°ƒåº¦ã€‚ 1lock-x(A)...lock-s(B)...lock-s(C)...unlock(A)...unlock(C)...unlock(B) ä½†ä¸æ˜¯å¿…è¦æ¡ä»¶ï¼Œä¾‹å¦‚ä»¥ä¸‹æ“ä½œä¸æ»¡è¶³ä¸¤æ®µé”åè®®ï¼Œä½†å®ƒè¿˜æ˜¯å¯ä¸²è¡ŒåŒ–è°ƒåº¦ã€‚ 1lock-x(A)...unlock(A)...lock-s(B)...unlock(B)...lock-s(C)...unlock(C) MySQL çš„ InnoDB å­˜å‚¨å¼•æ“é‡‡ç”¨ä¸¤æ®µé”åè®®ï¼Œä¼šæ ¹æ®éš”ç¦»çº§åˆ«åœ¨éœ€è¦çš„æ—¶å€™è‡ªåŠ¨åŠ é”ï¼Œå¹¶ä¸”æ‰€æœ‰çš„é”éƒ½æ˜¯åœ¨åŒä¸€æ—¶åˆ»è¢«é‡Šæ”¾ï¼Œè¿™è¢«ç§°ä¸ºéšå¼é”å®šã€‚ InnoDB ä¹Ÿå¯ä»¥ä½¿ç”¨ç‰¹å®šçš„è¯­å¥è¿›è¡Œæ˜¾ç¤ºé”å®šï¼š 12SELECT ... LOCK In SHARE MODE; #åŠ è¯»é”SELECT ... FOR UPDATE;#åŠ æ’ä»–é” 5.éš”ç¦»çº§åˆ« æœªæäº¤è¯»ï¼ˆREAD UNCOMMITTEDï¼‰ äº‹åŠ¡ä¸­çš„ä¿®æ”¹ï¼Œå³ä½¿æ²¡æœ‰æäº¤ï¼Œå¯¹å…¶å®ƒäº‹åŠ¡ä¹Ÿæ˜¯å¯è§çš„ã€‚ æäº¤è¯»ï¼ˆREAD COMMITTEDï¼‰ ä¸€ä¸ªäº‹åŠ¡åªèƒ½è¯»å–å·²ç»æäº¤çš„äº‹åŠ¡æ‰€åšçš„ä¿®æ”¹ã€‚æ¢å¥è¯è¯´ï¼Œä¸€ä¸ªäº‹åŠ¡æ‰€åšçš„ä¿®æ”¹åœ¨æäº¤ä¹‹å‰å¯¹å…¶å®ƒäº‹åŠ¡æ˜¯ä¸å¯è§çš„ã€‚ å› ä¸ºåœ¨ä¸€ä¸ªäº‹åŠ¡æäº¤å‰çš„æ•°æ®æ˜¯å¯¹å…¶ä»–äº‹åŠ¡ä¸å¯è§çš„ï¼Œæ‰€ä»¥åœ¨æ•°æ®æ²¡æœ‰ç¡®å®šå­˜å…¥æ•°æ®åº“å‰æ˜¯ä¸ä¼šè¢«å…¶ä»–äº‹åŠ¡çœ‹è§çš„ï¼Œå› æ­¤è§£å†³äº†æ•°æ®è¢«è¯»åˆ°æ˜¯ä¿®æ”¹åçš„å€¼ï¼Œä½†æ˜¯å¦ä¸€ä¸ªäº‹åŠ¡rollbackä¿®æ”¹ï¼Œå¯¼è‡´äº‹åŠ¡ä¸­è¯»å–åˆ°çš„æ•°æ®ä¸æ•°æ®åº“ä¸­çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚å³ä¸ºè§£å†³äº†è„è¯»é—®é¢˜ã€‚ å¯é‡å¤è¯»ï¼ˆREPEATABLE READï¼‰ ä¿è¯åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®çš„ç»“æœæ˜¯ä¸€æ ·çš„ã€‚ å¯ä¸²è¡ŒåŒ–ï¼ˆSERIALIZABLEï¼‰ å¼ºåˆ¶äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œè¿™æ ·å¤šä¸ªäº‹åŠ¡äº’ä¸å¹²æ‰°ï¼Œä¸ä¼šå‡ºç°å¹¶å‘ä¸€è‡´æ€§é—®é¢˜ã€‚ è¯¥éš”ç¦»çº§åˆ«éœ€è¦åŠ é”å®ç°ï¼Œå› ä¸ºè¦ä½¿ç”¨åŠ é”æœºåˆ¶ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯ä¿è¯äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œã€‚ éš”ç¦»çº§åˆ«èƒ½è§£å†³çš„å¹¶å‘ä¸€è‡´æ€§é—®é¢˜ è„è¯» ä¸å¯é‡å¤è¯» å¹»å½±è¯» æœªæäº¤è¯» Ã— Ã— Ã— æäº¤è¯» âˆš Ã— Ã— å¯é‡å¤åº¦ âˆš âˆš Ã— å¯ä¸²è¡ŒåŒ– âˆš âˆš âˆš 6. MVCC å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMulti-Version Concurrency Control, MVCCï¼‰æ˜¯ MySQL çš„ InnoDB å­˜å‚¨å¼•æ“å®ç°éš”ç¦»çº§åˆ«çš„ä¸€ç§å…·ä½“æ–¹å¼ï¼Œç”¨äºå®ç°æäº¤è¯»å’Œå¯é‡å¤è¯»è¿™ä¸¤ç§éš”ç¦»çº§åˆ«ã€‚è€Œæœªæäº¤è¯»éš”ç¦»çº§åˆ«æ€»æ˜¯è¯»å–æœ€æ–°çš„æ•°æ®è¡Œï¼Œè¦æ±‚å¾ˆä½ï¼Œæ— éœ€ä½¿ç”¨ MVCCã€‚å¯ä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«éœ€è¦å¯¹æ‰€æœ‰è¯»å–çš„è¡Œéƒ½åŠ é”ï¼Œå•çº¯ä½¿ç”¨ MVCC æ— æ³•å®ç°ã€‚ åŸºæœ¬æ€æƒ³ åœ¨å°é”ä¸€èŠ‚ä¸­æåˆ°ï¼ŒåŠ é”èƒ½è§£å†³å¤šä¸ªäº‹åŠ¡åŒæ—¶æ‰§è¡Œæ—¶å‡ºç°çš„å¹¶å‘ä¸€è‡´æ€§é—®é¢˜ã€‚åœ¨å®é™…åœºæ™¯ä¸­è¯»æ“ä½œå¾€å¾€å¤šäºå†™æ“ä½œï¼Œå› æ­¤åˆå¼•å…¥äº†è¯»å†™é”æ¥é¿å…ä¸å¿…è¦çš„åŠ é”æ“ä½œï¼Œä¾‹å¦‚è¯»å’Œè¯»æ²¡æœ‰äº’æ–¥å…³ç³»ã€‚è¯»å†™é”ä¸­è¯»å’Œå†™æ“ä½œä»ç„¶æ˜¯äº’æ–¥çš„ï¼Œè€Œ MVCC åˆ©ç”¨äº†å¤šç‰ˆæœ¬çš„æ€æƒ³ï¼Œå†™æ“ä½œæ›´æ–°æœ€æ–°çš„ç‰ˆæœ¬å¿«ç…§ï¼Œè€Œè¯»æ“ä½œå»è¯»æ—§ç‰ˆæœ¬å¿«ç…§ï¼Œæ²¡æœ‰äº’æ–¥å…³ç³»ï¼Œè¿™ä¸€ç‚¹å’Œ CopyOnWriteè¯»å†™åˆ†ç¦» ç±»ä¼¼ã€‚ åœ¨ MVCC ä¸­äº‹åŠ¡çš„ä¿®æ”¹æ“ä½œï¼ˆDELETEã€INSERTã€UPDATEï¼‰ä¼šä¸ºæ•°æ®è¡Œæ–°å¢ä¸€ä¸ªç‰ˆæœ¬å¿«ç…§ã€‚ è„è¯»å’Œä¸å¯é‡å¤è¯»æœ€æ ¹æœ¬çš„åŸå› æ˜¯äº‹åŠ¡è¯»å–åˆ°å…¶å®ƒäº‹åŠ¡æœªæäº¤çš„ä¿®æ”¹ã€‚åœ¨äº‹åŠ¡è¿›è¡Œè¯»å–æ“ä½œæ—¶ï¼Œä¸ºäº†è§£å†³è„è¯»å’Œä¸å¯é‡å¤è¯»é—®é¢˜ï¼ŒMVCC è§„å®šåªèƒ½è¯»å–å·²ç»æäº¤çš„å¿«ç…§ã€‚å½“ç„¶ä¸€ä¸ªäº‹åŠ¡å¯ä»¥è¯»å–è‡ªèº«æœªæäº¤çš„å¿«ç…§ï¼Œè¿™ä¸ç®—æ˜¯è„è¯»ã€‚å› ä¸ºæ²¡æœ‰ä½¿ç”¨ START TRANSACTION å°†ä¸Šé¢çš„æ“ä½œå½“æˆä¸€ä¸ªäº‹åŠ¡æ¥æ‰§è¡Œï¼Œæ ¹æ® MySQL çš„ AUTOCOMMIT æœºåˆ¶ï¼Œæ¯ä¸ªæ“ä½œéƒ½ä¼šè¢«å½“æˆä¸€ä¸ªäº‹åŠ¡æ¥æ‰§è¡Œï¼Œæ‰€ä»¥ä¸Šé¢çš„æ“ä½œæ€»å…±æ¶‰åŠåˆ°ä¸‰ä¸ªäº‹åŠ¡ã€‚å¿«ç…§ä¸­é™¤äº†è®°å½•äº‹åŠ¡ç‰ˆæœ¬å· TRX_ID å’Œæ“ä½œä¹‹å¤–ï¼Œè¿˜è®°å½•äº†ä¸€ä¸ª bit çš„ DEL å­—æ®µï¼Œç”¨äºæ ‡è®°æ˜¯å¦è¢«åˆ é™¤ã€‚ Undo æ—¥å¿— MVCC çš„å¤šç‰ˆæœ¬æŒ‡çš„æ˜¯å¤šä¸ªç‰ˆæœ¬çš„å¿«ç…§ï¼Œå¿«ç…§å­˜å‚¨åœ¨ Undo æ—¥å¿—ä¸­ï¼Œè¯¥æ—¥å¿—é€šè¿‡å›æ»šæŒ‡é’ˆ ROLL_PTR æŠŠä¸€ä¸ªæ•°æ®è¡Œçš„æ‰€æœ‰å¿«ç…§è¿æ¥èµ·æ¥ã€‚ ä¾‹å¦‚åœ¨ MySQL åˆ›å»ºä¸€ä¸ªè¡¨ tï¼ŒåŒ…å«ä¸»é”® id å’Œä¸€ä¸ªå­—æ®µ xã€‚æˆ‘ä»¬å…ˆæ’å…¥ä¸€ä¸ªæ•°æ®è¡Œï¼Œç„¶åå¯¹è¯¥æ•°æ®è¡Œæ‰§è¡Œä¸¤æ¬¡æ›´æ–°æ“ä½œã€‚ 123INSERT INTO t(id, x) VALUES(1, &quot;a&quot;);UPDATE t SET x=&quot;b&quot; WHERE id=1;UPDATE t SET x=&quot;c&quot; WHERE id=1; å› ä¸ºæ²¡æœ‰ä½¿ç”¨ START TRANSACTION å°†ä¸Šé¢çš„æ“ä½œå½“æˆä¸€ä¸ªäº‹åŠ¡æ¥æ‰§è¡Œï¼Œæ ¹æ® MySQL çš„ AUTOCOMMIT æœºåˆ¶ï¼Œæ¯ä¸ªæ“ä½œéƒ½ä¼šè¢«å½“æˆä¸€ä¸ªäº‹åŠ¡æ¥æ‰§è¡Œï¼Œæ‰€ä»¥ä¸Šé¢çš„æ“ä½œæ€»å…±æ¶‰åŠåˆ°ä¸‰ä¸ªäº‹åŠ¡ã€‚å¿«ç…§ä¸­é™¤äº†è®°å½•äº‹åŠ¡ç‰ˆæœ¬å· TRX_ID å’Œæ“ä½œä¹‹å¤–ï¼Œè¿˜è®°å½•äº†ä¸€ä¸ª bit çš„ DEL å­—æ®µï¼Œç”¨äºæ ‡è®°æ˜¯å¦è¢«åˆ é™¤ã€‚ INSERTã€UPDATEã€DELETE æ“ä½œä¼šåˆ›å»ºä¸€ä¸ªæ—¥å¿—ï¼Œå¹¶å°†äº‹åŠ¡ç‰ˆæœ¬å· TRX_ID å†™å…¥ã€‚DELETE å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ UPDATEï¼Œè¿˜ä¼šé¢å¤–å°† DEL å­—æ®µè®¾ç½®ä¸º 1ã€‚ ReadView MVCC ç»´æŠ¤äº†ä¸€ä¸ª ReadView ç»“æ„ï¼Œä¸»è¦åŒ…å«äº†å½“å‰ç³»ç»Ÿæœªæäº¤çš„äº‹åŠ¡åˆ—è¡¨ TRX_IDs {TRX_ID_1, TRX_ID_2, â€¦}ï¼Œè¿˜æœ‰è¯¥åˆ—è¡¨çš„æœ€å°å€¼ TRX_ID_MIN å’Œ TRX_ID_MAXã€‚ åœ¨è¿›è¡Œ SELECT æ“ä½œæ—¶ï¼Œæ ¹æ®æ•°æ®è¡Œå¿«ç…§çš„ TRX_ID ä¸ TRX_ID_MIN å’Œ TRX_ID_MAX ä¹‹é—´çš„å…³ç³»ï¼Œä»è€Œåˆ¤æ–­æ•°æ®è¡Œå¿«ç…§æ˜¯å¦å¯ä»¥ä½¿ç”¨ï¼š TRX_ID &lt; TRX_ID_MINï¼Œè¡¨ç¤ºè¯¥æ•°æ®è¡Œå¿«ç…§æ—¶åœ¨å½“å‰æ‰€æœ‰æœªæäº¤äº‹åŠ¡ä¹‹å‰è¿›è¡Œæ›´æ”¹çš„ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ã€‚ TRX_ID &gt; TRX_ID_MAXï¼Œè¡¨ç¤ºè¯¥æ•°æ®è¡Œå¿«ç…§æ˜¯åœ¨äº‹åŠ¡å¯åŠ¨ä¹‹åè¢«æ›´æ”¹çš„ï¼Œå› æ­¤ä¸å¯ä½¿ç”¨ã€‚ TRX_ID_MIN &lt;= TRX_ID &lt;= TRX_ID_MAXï¼Œéœ€è¦æ ¹æ®éš”ç¦»çº§åˆ«å†è¿›è¡Œåˆ¤æ–­ï¼š æäº¤è¯»ï¼šè¯¥éš”ç¦»ç•Œåˆ«ä¸‹æ¯ä¸€æ¬¡æŸ¥è¯¢éƒ½è¦è¿›è¡Œä¸€æ¬¡å¿«ç…§è¯»(readView)æ“ä½œï¼Œå¦‚æœ TRX_ID åœ¨ TRX_IDs åˆ—è¡¨ä¸­ï¼Œè¡¨ç¤ºè¯¥æ•°æ®è¡Œå¿«ç…§å¯¹åº”çš„äº‹åŠ¡è¿˜æœªæäº¤ï¼Œåˆ™è¯¥å¿«ç…§ä¸å¯ä½¿ç”¨ã€‚å¦åˆ™è¡¨ç¤ºå·²ç»æäº¤ï¼Œå¯ä»¥ä½¿ç”¨ã€‚ å¯é‡å¤è¯»ï¼š**è¯¥éš”ç¦»ç•Œåˆ«ä¸‹äº‹åŠ¡å¼€å§‹çš„æ—¶å€™è¿›è¡Œä¸€æ¬¡å¿«ç…§è¯»æ“ä½œ(readView)è€Œä¸”åªè¿›è¡Œè¿™ä¸€æ¬¡ï¼Œ**å¦‚æœ TRX_ID åœ¨ TRX_IDs åˆ—è¡¨ä¸­å°±ä¸èƒ½ä½¿ç”¨ã€‚å› ä¸ºå¦‚æœå¯ä»¥ä½¿ç”¨çš„è¯ï¼Œé‚£ä¹ˆå…¶å®ƒäº‹åŠ¡ä¹Ÿå¯ä»¥è¯»åˆ°è¿™ä¸ªæ•°æ®è¡Œå¿«ç…§å¹¶è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆå½“å‰äº‹åŠ¡å†å»è¯»è¿™ä¸ªæ•°æ®è¡Œå¾—åˆ°çš„å€¼å°±ä¼šå‘ç”Ÿæ”¹å˜ï¼Œä¹Ÿå°±æ˜¯å‡ºç°äº†ä¸å¯é‡å¤è¯»é—®é¢˜ã€‚ åœ¨æ•°æ®è¡Œå¿«ç…§ä¸å¯ä½¿ç”¨çš„æƒ…å†µä¸‹ï¼Œéœ€è¦æ²¿ç€ Undo Log çš„å›æ»šæŒ‡é’ˆ ROLL_PTR æ‰¾åˆ°ä¸‹ä¸€ä¸ªå¿«ç…§ï¼Œå†è¿›è¡Œä¸Šé¢çš„åˆ¤æ–­ã€‚ 7. èŒƒå¼ å‡½æ•°ä¾èµ– è®° A-&gt;B è¡¨ç¤º A å‡½æ•°å†³å®š Bï¼Œä¹Ÿå¯ä»¥è¯´ B å‡½æ•°ä¾èµ–äº Aã€‚ å¦‚æœ {A1ï¼ŒA2ï¼Œâ€¦ ï¼ŒAn} æ˜¯å…³ç³»çš„ä¸€ä¸ªæˆ–å¤šä¸ªå±æ€§çš„é›†åˆï¼Œè¯¥é›†åˆå‡½æ•°å†³å®šäº†å…³ç³»çš„å…¶å®ƒæ‰€æœ‰å±æ€§å¹¶ä¸”æ˜¯æœ€å°çš„ï¼Œé‚£ä¹ˆè¯¥é›†åˆå°±ç§°ä¸ºé”®ç ã€‚ å¯¹äº A-&gt;Bï¼Œå¦‚æœèƒ½æ‰¾åˆ° A çš„çœŸå­é›† Aâ€™ï¼Œä½¿å¾— Aâ€™-&gt; Bï¼Œé‚£ä¹ˆ A-&gt;B å°±æ˜¯éƒ¨åˆ†å‡½æ•°ä¾èµ–ï¼Œå¦åˆ™å°±æ˜¯å®Œå…¨å‡½æ•°ä¾èµ–ã€‚ å¯¹äº A-&gt;Bï¼ŒB-&gt;Cï¼Œåˆ™ A-&gt;C æ˜¯ä¸€ä¸ªä¼ é€’å‡½æ•°ä¾èµ–ã€‚ å¼‚å¸¸ ä»¥ä¸‹çš„å­¦ç”Ÿè¯¾ç¨‹å…³ç³»çš„å‡½æ•°ä¾èµ–ä¸º {Sno, Cname} -&gt; {Sname, Sdept, Mname, Grade}ï¼Œé”®ç ä¸º {Sno, Cname}ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç¡®å®šå­¦ç”Ÿå’Œè¯¾ç¨‹ä¹‹åï¼Œå°±èƒ½ç¡®å®šå…¶å®ƒä¿¡æ¯ã€‚ Sno Sname Sdept Mname Cname Grade 1 å­¦ç”Ÿ-1 å­¦é™¢-1 é™¢é•¿-1 è¯¾ç¨‹-1 90 2 å­¦ç”Ÿ-2 å­¦é™¢-2 é™¢é•¿-2 è¯¾ç¨‹-2 80 2 å­¦ç”Ÿ-2 å­¦é™¢-2 é™¢é•¿-2 è¯¾ç¨‹-1 100 3 å­¦ç”Ÿ-3 å­¦é™¢-2 é™¢é•¿-2 è¯¾ç¨‹-2 95 ä¸ç¬¦åˆèŒƒå¼çš„å…³ç³»ï¼Œä¼šäº§ç”Ÿå¾ˆå¤šå¼‚å¸¸ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å››ç§å¼‚å¸¸ï¼š å†—ä½™æ•°æ®ï¼šä¾‹å¦‚ å­¦ç”Ÿ-2 å‡ºç°äº†ä¸¤æ¬¡ã€‚ ä¿®æ”¹å¼‚å¸¸ï¼šä¿®æ”¹äº†ä¸€ä¸ªè®°å½•ä¸­çš„ä¿¡æ¯ï¼Œä½†æ˜¯å¦ä¸€ä¸ªè®°å½•ä¸­ç›¸åŒçš„ä¿¡æ¯å´æ²¡æœ‰è¢«ä¿®æ”¹ã€‚ åˆ é™¤å¼‚å¸¸ï¼šåˆ é™¤ä¸€ä¸ªä¿¡æ¯ï¼Œé‚£ä¹ˆä¹Ÿä¼šä¸¢å¤±å…¶å®ƒä¿¡æ¯ã€‚ä¾‹å¦‚åˆ é™¤äº† è¯¾ç¨‹-1 éœ€è¦åˆ é™¤ç¬¬ä¸€è¡Œå’Œç¬¬ä¸‰è¡Œï¼Œé‚£ä¹ˆ å­¦ç”Ÿ-1 çš„ä¿¡æ¯å°±ä¼šä¸¢å¤±ã€‚ æ’å…¥å¼‚å¸¸ï¼šä¾‹å¦‚æƒ³è¦æ’å…¥ä¸€ä¸ªå­¦ç”Ÿçš„ä¿¡æ¯ï¼Œå¦‚æœè¿™ä¸ªå­¦ç”Ÿè¿˜æ²¡é€‰è¯¾ï¼Œé‚£ä¹ˆå°±æ— æ³•æ’å…¥ã€‚ èŒƒå¼ èŒƒå¼ç†è®ºæ˜¯ä¸ºäº†è§£å†³ä»¥ä¸Šæåˆ°å››ç§å¼‚å¸¸ã€‚ é«˜çº§åˆ«èŒƒå¼çš„ä¾èµ–äºä½çº§åˆ«çš„èŒƒå¼ï¼Œ1NF æ˜¯æœ€ä½çº§åˆ«çš„èŒƒå¼ã€‚ 1. ç¬¬ä¸€èŒƒå¼ (1NF) å±æ€§ä¸å¯åˆ†ã€‚ 2. ç¬¬äºŒèŒƒå¼ (2NF) æ¯ä¸ªéä¸»å±æ€§å®Œå…¨å‡½æ•°ä¾èµ–äºé”®ç ã€‚ å¯ä»¥é€šè¿‡åˆ†è§£æ¥æ»¡è¶³ã€‚ åˆ†è§£å‰ Sno Sname Sdept Mname Cname Grade 1 å­¦ç”Ÿ-1 å­¦é™¢-1 é™¢é•¿-1 è¯¾ç¨‹-1 90 2 å­¦ç”Ÿ-2 å­¦é™¢-2 é™¢é•¿-2 è¯¾ç¨‹-2 80 2 å­¦ç”Ÿ-2 å­¦é™¢-2 é™¢é•¿-2 è¯¾ç¨‹-1 100 3 å­¦ç”Ÿ-3 å­¦é™¢-2 é™¢é•¿-2 è¯¾ç¨‹-2 95 ä»¥ä¸Šå­¦ç”Ÿè¯¾ç¨‹å…³ç³»ä¸­ï¼Œ{Sno, Cname} ä¸ºé”®ç ï¼Œæœ‰å¦‚ä¸‹å‡½æ•°ä¾èµ–ï¼š Sno -&gt; Sname, Sdept Sdept -&gt; Mname Sno, Cname-&gt; Grade Grade å®Œå…¨å‡½æ•°ä¾èµ–äºé”®ç ï¼Œå®ƒæ²¡æœ‰ä»»ä½•å†—ä½™æ•°æ®ï¼Œæ¯ä¸ªå­¦ç”Ÿçš„æ¯é—¨è¯¾éƒ½æœ‰ç‰¹å®šçš„æˆç»©ã€‚ Sname, Sdept å’Œ Mname éƒ½éƒ¨åˆ†ä¾èµ–äºé”®ç ï¼Œå½“ä¸€ä¸ªå­¦ç”Ÿé€‰ä¿®äº†å¤šé—¨è¯¾æ—¶ï¼Œè¿™äº›æ•°æ®å°±ä¼šå‡ºç°å¤šæ¬¡ï¼Œé€ æˆå¤§é‡å†—ä½™æ•°æ®ã€‚ åˆ†è§£å å…³ç³»-1 Sno Sname Sdept Mname 1 å­¦ç”Ÿ-1 å­¦é™¢-1 é™¢é•¿-1 2 å­¦ç”Ÿ-2 å­¦é™¢-2 é™¢é•¿-2 3 å­¦ç”Ÿ-3 å­¦é™¢-2 é™¢é•¿-2 æœ‰ä»¥ä¸‹å‡½æ•°ä¾èµ–ï¼š Sno -&gt; Sname, Sdept Sdept -&gt; Mname å…³ç³»-2 Sno Cname Grade 1 è¯¾ç¨‹-1 90 2 è¯¾ç¨‹-2 80 2 è¯¾ç¨‹-1 100 3 è¯¾ç¨‹-2 95 æœ‰ä»¥ä¸‹å‡½æ•°ä¾èµ–ï¼š Sno, Cname -&gt; Grade 3. ç¬¬ä¸‰èŒƒå¼ (3NF) éä¸»å±æ€§ä¸ä¼ é€’å‡½æ•°ä¾èµ–äºé”®ç ã€‚ ä¸Šé¢çš„ å…³ç³»-1 ä¸­å­˜åœ¨ä»¥ä¸‹ä¼ é€’å‡½æ•°ä¾èµ–ï¼š Sno -&gt; Sdept -&gt; Mname å¯ä»¥è¿›è¡Œä»¥ä¸‹åˆ†è§£ï¼š å…³ç³»-11 Sno Sname Sdept 1 å­¦ç”Ÿ-1 å­¦é™¢-1 2 å­¦ç”Ÿ-2 å­¦é™¢-2 3 å­¦ç”Ÿ-3 å­¦é™¢-2 å…³ç³»-12 Sdept Mname å­¦é™¢-1 é™¢é•¿-1 å­¦é™¢-2 é™¢é•¿-2","link":"/posts/Mysql%E6%A0%B8%E5%BF%83%E6%A1%86%E6%9E%B6%E7%9F%A5%E8%AF%86/"}],"tags":[{"name":"Hexo","slug":"Hexo","link":"/tags/Hexo/"},{"name":"redis","slug":"redis","link":"/tags/redis/"}],"categories":[{"name":"Hexoæ•™ç¨‹","slug":"Hexoæ•™ç¨‹","link":"/categories/Hexo%E6%95%99%E7%A8%8B/"},{"name":"redisæ•™ç¨‹","slug":"redisæ•™ç¨‹","link":"/categories/redis%E6%95%99%E7%A8%8B/"},{"name":"redisç¬”è®°","slug":"redisç¬”è®°","link":"/categories/redis%E7%AC%94%E8%AE%B0/"},{"name":"redisçš„åº”ç”¨","slug":"redisçš„åº”ç”¨","link":"/categories/redis%E7%9A%84%E5%BA%94%E7%94%A8/"},{"name":"redisçš„é—®é¢˜æ–¹æ¡ˆ","slug":"redisçš„é—®é¢˜æ–¹æ¡ˆ","link":"/categories/redis%E7%9A%84%E9%97%AE%E9%A2%98%E6%96%B9%E6%A1%88/"}],"pages":[{"title":"categories","text":"","link":"/categories/index.html"}]}